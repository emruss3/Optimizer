const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabase-vendor-BeTA44qk.js","assets/map-vendor-ChI9isOj.js","assets/map-vendor--d70tv_y.css"])))=>i.map(i=>d[i]);
var pr=Object.defineProperty;var yr=(t,s,a)=>s in t?pr(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var vt=(t,s,a)=>yr(t,typeof s!="symbol"?s+"":s,a);import{c as Ba,R as re,r as f,j as e,L as dn,z as Nt,a as Et,S as It,X as fe,U as br,C as vr,b as hn,A as jr,M as Nr,d as Ge,e as ls,B as ye,f as Me,g as Ci,h as Ya,F as mn,i as pt,k as Zs,T as Ee,l as xn,P as De,D as Ye,m as lt,Z as Ze,n as qe,o as Xa,p as na,q as ve,s as Wa,t as ft,u as _e,v as ua,H as un,w as Rs,x as gn,y as Ot,E as wr,G as _r,I as Sr,J as Mr,K as Cr,N as Pr,O as kr,Q as Ar,V as Yt,W as ga,Y as Rt,_ as fn,$ as Ut,a0 as pn,a1 as Oe,a2 as Er,a3 as Rr,a4 as yn,a5 as Va,a6 as ra,a7 as Fr,a8 as la,a9 as Ir,aa as Gr,ab as zr,ac as Or,ad as bn,ae as $r,af as Tr,ag as Dr,ah as qr,ai as Ur,aj as Lr,ak as Ks,al as Br}from"./react-vendor-ZQIZOzmS.js";import{m as vn}from"./map-vendor-ChI9isOj.js";import{c as Yr,_ as jn}from"./supabase-vendor-BeTA44qk.js";import{p as Xr}from"./state-vendor-BPg30LFv.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function a(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=a(i);fetch(i.href,r)}})();const Ie=Ba((t,s)=>({openDrawer:null,setDrawer:a=>t({openDrawer:a}),closeDrawer:()=>t({openDrawer:null}),selectedParcel:null,setSelectedParcel:a=>t({selectedParcel:a}),filterModalOpen:!1,setFilterModal:a=>t({filterModalOpen:a}),filterMode:"all",colorMode:"zoning",zoningFilters:{activeZones:[]},selectionMode:"single",selectedParcelIds:[],setFilterMode:a=>t({filterMode:a}),setColorMode:a=>t({colorMode:a}),setZoningFilters:a=>t({zoningFilters:a}),setSelectionMode:a=>t({selectionMode:a}),addSelectedParcel:a=>t(n=>({selectedParcelIds:[...n.selectedParcelIds.filter(i=>i!==a),a]})),removeSelectedParcel:a=>t(n=>({selectedParcelIds:n.selectedParcelIds.filter(i=>i!==a)})),clearSelectedParcels:()=>t({selectedParcelIds:[]}),leftNavOpen:!1,setLeftNavOpen:a=>t({leftNavOpen:a}),isMobile:!1,setIsMobile:a=>t({isMobile:a}),commandPaletteOpen:!1,setCommandPalette:a=>t({commandPaletteOpen:a}),commentsOpen:!1,setCommentsOpen:a=>t({commentsOpen:a})})),Nn=()=>{const{openDrawer:t,setDrawer:s,closeDrawer:a,setFilterModal:n,setCommandPalette:i,commandPaletteOpen:r}=Ie();re.useEffect(()=>{const o=l=>{if(l.key==="Escape"){r?i(!1):Ie.getState().filterModalOpen?n(!1):a();return}if((l.metaKey||l.ctrlKey)&&l.key==="k"){l.preventDefault(),i(!0);return}if(l.key==="/"&&l.shiftKey&&l.code==="KeyC"){l.preventDefault(),Ie.getState().setCommentsOpen(!0);return}l.ctrlKey&&l.shiftKey&&(l.key==="["?(l.preventDefault(),s(t==="PROJECT"?"UNDERWRITING":"PROJECT")):l.key==="]"&&(l.preventDefault(),s(t==="UNDERWRITING"?"PROJECT":"UNDERWRITING")))};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[t,s,a,n,i,r])},Wr=Object.freeze(Object.defineProperty({__proto__:null,useKeyboardShortcuts:Nn,useUIStore:Ie},Symbol.toStringTag,{value:"Module"}));console.log("VITE_SUPABASE_URL:","https://okxrvetbzpoazrybhcqj.supabase.co");console.log("VITE_SUPABASE_ANON_KEY present:",!0);const Vr="https://okxrvetbzpoazrybhcqj.supabase.co",Hr="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reHJ2ZXRienBvYXpyeWJoY3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1ODkxNDcsImV4cCI6MjA2MjE2NTE0N30.diq6x_Kr5_GxPSHJT1gm54Jh2UTiGVrBNgxDmV3yMxI",me=Yr(Vr,Hr),Ve=Ba((t,s)=>({id:null,name:null,selectedParcels:new Set,isLoading:!1,error:null,set:(a,n=null)=>{const i=s().id;t({id:a,name:n,selectedParcels:new Set,error:null}),a&&me&&a!==i&&s().loadProjectParcels(a)},addParcel:async(a,n)=>{const i=s();if(console.log("ðŸ” addParcel called:",{parcelId:a,parcelData:n,activeProjectId:i.id,currentParcels:i.selectedParcels.size}),!i.id){console.warn("No active project - cannot add parcel");return}const r=String(a);if(i.selectedParcels.has(r)){console.log("Parcel already exists in project"),t({error:"Parcel already in project"}),setTimeout(()=>t({error:null}),3e3);return}const o=i.selectedParcels.size===0,l=new Set([...i.selectedParcels,r]);console.log("ðŸ” Adding parcel to project:",{pid:r,newParcelsSize:l.size}),t({selectedParcels:l,isLoading:!0,error:null});try{if(me){const{error:c}=await me.from("project_parcels").upsert({project_id:i.id,parcel_id:r,added_at:new Date().toISOString(),parcel_data:n||null});if(c)throw console.error("Supabase error:",c),c}if(t({isLoading:!1}),console.log("âœ… Parcel successfully added to project:",{pid:r,projectId:i.id}),t({error:"Parcel added to project âœ“"}),setTimeout(()=>t({error:null}),2500),o&&typeof window<"u"){const{useUIStore:c}=await jn(async()=>{const{useUIStore:d}=await Promise.resolve().then(()=>Wr);return{useUIStore:d}},void 0);c.getState().setDrawer("PROJECT")}}catch(c){console.error("Failed to add parcel:",c),t({selectedParcels:i.selectedParcels,isLoading:!1,error:`Failed to add parcel: ${c.message||"Unknown error"}`}),setTimeout(()=>t({error:null}),3e3)}},removeParcel:async a=>{const n=s();if(!n.id)return;const i=String(a),r=n.selectedParcels,o=new Set([...n.selectedParcels].filter(l=>l!==i));t({selectedParcels:o,isLoading:!0,error:null});try{if(me){const{error:l}=await me.from("project_parcels").delete().match({project_id:n.id,parcel_id:i});if(l)throw l}t({isLoading:!1}),t({error:"Parcel removed âœ“"}),setTimeout(()=>t({error:null}),2e3)}catch(l){console.error("Failed to remove parcel:",l),t({selectedParcels:r,isLoading:!1,error:`Failed to remove parcel: ${l.message||"Unknown error"}`}),setTimeout(()=>t({error:null}),4e3)}},clear:()=>{t({id:null,name:null,selectedParcels:new Set,isLoading:!1,error:null})},loadProjectParcels:async a=>{if(me)try{t({isLoading:!0});const{data:n,error:i}=await me.from("project_parcels").select("parcel_id").eq("project_id",a);if(i)throw i;const r=n?.map(o=>o.parcel_id)||[];t({selectedParcels:new Set(r),isLoading:!1})}catch{t({isLoading:!1,error:"Failed to load project parcels"}),setTimeout(()=>t({error:null}),3e3)}}})),Jr=t=>Array.from(t);function fa(){const{selectedParcels:t,id:s,name:a}=Ve(),n=f.useMemo(()=>t?t instanceof Set?Jr(t):Array.isArray(t)?t.filter(r=>r!=null).map(String):typeof t=="object"?Object.values(t??{}).filter(r=>r!=null).map(String):[]:[],[t]),i=f.useMemo(()=>({count:n.length,hasSelection:n.length>0,isEmpty:n.length===0,isSingle:n.length===1,isMultiple:n.length>1,map:r=>n.map(r),filter:r=>n.filter(r),forEach:r=>n.forEach(r),find:r=>n.find(r),includes:r=>n.includes(r),first:n[0]||null,last:n[n.length-1]||null,reduce:(r,o)=>n.reduce(r,o)}),[n]);return{parcelIds:n,selectedParcels:new Set(n),activeProjectId:s,activeProjectName:a,...i,raw:t}}const wn=()=>({role:"analyst",id:"user-1",name:"Demo User"}),Pi={viewer:1,analyst:2,manager:3,admin:4},Qs=(t,s)=>{const a=Pi[t];return s.some(n=>a>=Pi[n])};function es({roles:t,children:s,fallback:a,disabled:n=!1,tooltip:i}){const r=wn();return Qs(r.role,t)?n?e.jsx("div",{className:"opacity-50 pointer-events-none",children:s}):e.jsx(e.Fragment,{children:s}):a?e.jsx(e.Fragment,{children:a}):e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"opacity-50 pointer-events-none",children:s}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 rounded",children:e.jsxs("div",{className:"flex items-center space-x-1 text-gray-500",children:[e.jsx(dn,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-xs font-medium",children:[t.join("/")?.toUpperCase(),"+"]})]})}),i&&e.jsx("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50",children:i})]})}function _n(){const t=wn();return{user:t,hasRole:s=>Qs(t.role,s),isViewer:t.role==="viewer",isAnalyst:Qs(t.role,["analyst"]),isManager:Qs(t.role,["manager"]),isAdmin:t.role==="admin"}}function Zr({isOpen:t,onClose:s,projectId:a,projectName:n}){const{hasRole:i}=_n(),[r,o]=f.useState("share"),[l,c]=f.useState(""),[d,x]=f.useState("viewer"),[h,m]=f.useState(""),[p,y]=f.useState(!1),[v,u]=f.useState(null),[j,g]=f.useState(null),[S,b]=f.useState(!1),_=`${window.location.origin}/project/${a}`,w=async()=>{try{await navigator.clipboard.writeText(_),b(!0),setTimeout(()=>b(!1),2e3)}catch{g("Failed to copy link")}},k=async()=>{if(!l.trim()){g("Email address is required");return}if(!i(["manager"])){g("Only managers and admins can send invites");return}y(!0),g(null);try{const{error:T}=await me.from("project_members").insert({project_id:a,email:l.trim(),role:d,invited_by:"current-user-id",invited_at:new Date().toISOString(),status:"pending",message:h.trim()||null});if(T)throw T;const{error:P}=await me.functions.invoke("send-invite",{body:{email:l.trim(),projectId:a,projectName:n,role:d,inviteUrl:`${_}?invite=true`,message:h.trim()}});P&&console.warn("Email send failed:",P),u(`Invitation sent to ${l}`),c(""),m(""),setTimeout(()=>u(null),3e3)}catch(T){console.error("Invite error:",T),g(`Failed to send invitation: ${T.message}`)}finally{y(!1)}},$=()=>{c(""),x("viewer"),m(""),g(null),u(null),b(!1)},R=()=>{$(),s()};return e.jsx(Nt,{show:t,as:re.Fragment,children:e.jsxs(Et,{as:"div",className:"relative z-50",onClose:R,children:[e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-4 text-center",children:e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(Et.Panel,{className:"w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[e.jsxs(Et.Title,{as:"h3",className:"text-lg font-medium leading-6 text-gray-900 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(It,{className:"w-5 h-5"}),e.jsx("span",{children:"Share Project"})]}),e.jsx("button",{onClick:R,className:"p-1 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mt-4",children:e.jsx("p",{className:"text-sm text-gray-600",children:n})}),e.jsxs("div",{className:"flex mt-4 bg-gray-100 rounded-lg p-1",children:[e.jsxs("button",{onClick:()=>o("share"),className:`flex-1 flex items-center justify-center space-x-2 px-3 py-2 text-sm font-medium rounded-md transition-colors ${r==="share"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Share Link"})]}),e.jsxs("button",{onClick:()=>o("invite"),className:`flex-1 flex items-center justify-center space-x-2 px-3 py-2 text-sm font-medium rounded-md transition-colors ${r==="invite"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,disabled:!i(["manager"]),children:[e.jsx(br,{className:"w-4 h-4"}),e.jsx("span",{children:"Invite"})]})]}),r==="share"&&e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Project Link"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:_,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"}),e.jsx("button",{onClick:w,className:`px-3 py-2 rounded-lg font-medium transition-colors ${S?"bg-green-600 text-white":"bg-blue-600 text-white hover:bg-blue-700"}`,children:S?e.jsx(vr,{className:"w-4 h-4"}):e.jsx(hn,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Anyone with this link can view the project"})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-900 mb-1",children:"Sharing Permissions"}),e.jsxs("ul",{className:"text-xs text-blue-700 space-y-1",children:[e.jsx("li",{children:"â€¢ Viewers can see parcels and analysis"}),e.jsx("li",{children:"â€¢ Link sharing requires no sign-up"}),e.jsx("li",{children:"â€¢ Data is read-only for shared viewers"})]})]})]}),r==="invite"&&e.jsxs("div",{className:"mt-4 space-y-4",children:[i(["manager"])?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email Address"}),e.jsx("input",{type:"email",value:l,onChange:T=>c(T.target.value),placeholder:"colleague@company.com",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus-ring"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsxs("select",{value:d,onChange:T=>x(T.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus-ring",children:[e.jsx("option",{value:"viewer",children:"Viewer - Can view only"}),e.jsx("option",{value:"analyst",children:"Analyst - Can analyze and export"}),e.jsx("option",{value:"manager",children:"Manager - Can edit and invite"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Message (Optional)"}),e.jsx("textarea",{value:h,onChange:T=>m(T.target.value),placeholder:"Add a personal message...",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus-ring resize-none"})]})]}):e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(jr,{className:"w-4 h-4 text-yellow-600"}),e.jsx("p",{className:"text-sm text-yellow-800",children:"Only managers and admins can send invitations"})]})}),j&&e.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-700",children:j})}),v&&e.jsx("div",{className:"bg-green-50 border border-green-200 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-700",children:v})})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx("button",{onClick:R,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"Close"}),r==="invite"&&i(["manager"])&&e.jsxs("button",{onClick:k,disabled:p||!l.trim(),className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center space-x-2",children:[p?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(Nr,{className:"w-4 h-4"}),e.jsx("span",{children:p?"Sending...":"Send Invite"})]})]})]})})})})]})})}function Kr({onOpenUnifiedWorkspace:t,onOpenProjectWorkflow:s,onOpenSimpleProjectManager:a,onOpenConnectedProjectWorkflow:n,onOpenUnifiedProjectWorkflow:i,onOpenRealUnderwritingWorkflow:r,onOpenWorkflowAudit:o,onOpenWorkflowConnectionTest:l}){const{setDrawer:c,setFilterModal:d,openDrawer:x,setCommandPalette:h}=Ie(),{activeProjectId:m,activeProjectName:p}=fa(),{set:y,clear:v}=Ve(),[u,j]=re.useState(!1),[g,S]=re.useState(0),[b,_]=re.useState(!1);re.useEffect(()=>{S(m?Math.floor(Math.random()*5):0)},[m]);const[w,k]=re.useState(!1),$=[{id:"demo-1",name:"Demo Project"},{id:"nashville-dev",name:"Nashville Development"},{id:"mixed-use-23",name:"Mixed Use 2023"}],R=T=>{m===T.id?v():y(T.id,T.name),k(!1)};return e.jsxs("header",{className:"bg-white border-b border-gray-200 px-4 md:px-6 py-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3 min-w-0 flex-shrink-0",children:[e.jsx("div",{className:"bg-blue-600 p-2 rounded-lg",children:e.jsx(Ge,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Parcel Intelligence"}),e.jsx("p",{className:"text-sm text-gray-600 hidden sm:block",children:"Real Estate Investment Platform"})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-4 md:mx-8 hidden lg:block","data-testid":"desktop-search",children:e.jsxs("div",{className:"relative",children:[e.jsx(ls,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by address, parcel ID, or coordinates...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus-ring","aria-label":"Search parcels","data-testid":"search-input",onClick:()=>h(!0),readOnly:!0}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("kbd",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded",children:"âŒ˜K"})})]})}),e.jsxs("div",{className:"flex items-center space-x-1 md:space-x-3 flex-shrink-0 kpi-bar","data-testid":"header-actions",children:[e.jsxs("div",{className:"hidden md:flex items-center space-x-2 text-sm text-gray-600 flex-wrap",children:[e.jsx("span",{"data-testid":"location-indicator",children:m?`Active: ${p}`:"Nashville Metro"}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:"Real-time Data"})]}),e.jsx("div",{className:"hidden md:block w-px h-6 bg-gray-300 mx-2"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>k(!w),className:`flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium ${m?"bg-green-100 text-green-700 border border-green-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,"data-testid":"project-dropdown",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline","data-testid":"active-project-name",children:m?p:"Project"}),e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),w&&e.jsx("div",{className:"absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50","data-testid":"project-menu",children:e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 px-3 py-2 uppercase tracking-wider",children:"Select Project"}),$.map(T=>e.jsx("button",{onClick:()=>R(T),className:`w-full text-left px-3 py-2 text-sm rounded-md transition-colors ${m===T.id?"bg-green-100 text-green-700 font-medium":"text-gray-700 hover:bg-gray-100"}`,"data-testid":`project-${T.id}`,children:T.name},T.id)),e.jsx("hr",{className:"my-2"}),e.jsx("button",{onClick:()=>{v(),k(!1)},className:"w-full text-left px-3 py-2 text-sm rounded-md text-gray-500 hover:bg-gray-100","data-testid":"no-active-project",children:"No Active Project"})]})})]}),e.jsxs("button",{onClick:i,className:"flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium bg-green-600 text-white hover:bg-green-700","data-testid":"unified-project-workflow-button",title:"Open unified project workflow","aria-label":"Open unified project workflow",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"New Project"})]}),e.jsxs("button",{onClick:r,className:"flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium bg-purple-600 text-white hover:bg-purple-700","data-testid":"real-underwriting-workflow-button",title:"Open real underwriting workflow","aria-label":"Open real underwriting workflow",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"Underwriting"})]}),e.jsxs("button",{onClick:l,className:"flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium bg-gray-600 text-white hover:bg-gray-700","data-testid":"workflow-connection-test-button",title:"Test workflow connections","aria-label":"Test workflow connections",children:[e.jsx(Ci,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"Test"})]}),e.jsxs("button",{onClick:()=>c(x==="UNDERWRITING"?null:"UNDERWRITING"),className:`flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium ${x==="UNDERWRITING"?"bg-blue-100 text-blue-700":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,"data-testid":"analysis-button",title:"Financial analysis and underwriting","aria-label":"Open financial analysis",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"Analysis"})]}),m&&e.jsxs("button",{onClick:()=>c(x==="SCENARIO_COMPARE"?null:"SCENARIO_COMPARE"),className:`flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium ${x==="SCENARIO_COMPARE"?"bg-purple-100 text-purple-700":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,"data-testid":"scenario-compare-button",title:"Compare development scenarios",children:[e.jsx(Ya,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"Compare"})]}),m&&e.jsx(es,{roles:["manager"],children:e.jsxs("button",{onClick:()=>j(!0),className:"flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100","data-testid":"share-button",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm hidden md:inline",children:"Share"})]})}),e.jsxs("button",{onClick:()=>d(!0),className:"flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors","data-testid":"filters-button",children:[e.jsx(mn,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium hidden md:inline",children:"Filters"})]}),e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors focus-ring","aria-label":"Settings","data-testid":"header-settings",children:e.jsx(pt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>h(!0),className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors focus-ring","aria-label":"Command palette","data-testid":"command-palette-button",children:e.jsx(Ci,{className:"w-4 h-4"})}),m&&e.jsxs("button",{className:"relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors focus-ring","aria-label":"Comments","data-testid":"comments-button",children:[e.jsx(Zs,{className:"w-4 h-4"}),g>0&&e.jsx("div",{className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-medium",children:g>9?"9+":g})]}),e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors lg:hidden focus-ring","aria-label":"Toggle search","data-testid":"mobile-search-toggle",children:e.jsx(ls,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-4 lg:hidden hidden",id:"mobile-search","data-testid":"mobile-search",children:e.jsxs("div",{className:"relative",children:[e.jsx(ls,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by address, parcel ID, or coordinates...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent","data-testid":"mobile-search-input",onClick:()=>h(!0),readOnly:!0})]})}),m&&e.jsx(Zr,{isOpen:u,onClose:()=>j(!1),projectId:m,projectName:p||"Untitled Project"})]})}const Qr="pk.eyJ1IjoiZW1ydXNzMyIsImEiOiJjamlkcHY1aTAwY3I3M3FyeHAxc3Nia2VqIn0.mxsGEk2I8Ygkf3Q_zJKMcw";vn.accessToken=Qr;const Ca={longitude:-86.7816,latitude:36.1627,zoom:12},el="mapbox://styles/mapbox/light-v11";function ki(){return["case",["<",["to-number",["get","sqft"]],1e3],"#f87171",["<",["to-number",["get","sqft"]],2e3],"#fb923c",["<",["to-number",["get","sqft"]],5e3],"#60a5fa",["<",["to-number",["get","sqft"]],2e4],"#3b82f6","#1e3a8a"]}function Ai(){return["match",["slice",["to-string",["get","zoning"]],0,2],"RS","#22c55e","RM","#6366f1","MU","#ef4444","CS","#f59e0b","CN","#f59e0b","SP","#a855f7","AG","#10b981","#93a3b5"]}const tl=re.memo(function({onParcelClick:s,selectedParcelIds:a,activeProjectId:n,activeProjectName:i}){const r=f.useRef(null),o=f.useRef(null),[l,c]=re.useState(null),[d,x]=re.useState(null),{filterMode:h,zoningFilters:m}=Ie(),p=f.useMemo(()=>h==="large"?[">=",["to-number",["get","sqft"]],5e3]:h==="huge"?[">=",["to-number",["get","sqft"]],2e4]:!0,[h]),y=f.useMemo(()=>{const g=m?.activeZones??[];return g.length?["in",["to-string",["get","zoning"]],...g]:!0},[m?.activeZones]),v=f.useMemo(()=>["all",p,y],[p,y]);f.useEffect(()=>{if(r.current||!o.current)return;const g=new vn.Map({container:o.current,style:el,center:[Ca.longitude,Ca.latitude],zoom:Ca.zoom,maxZoom:17,transformRequest:S=>{if(S.includes("/functions/v1/mvt-parcels"))return{url:S}}});return g.on("load",()=>{g.getSource("parcels")||(g.addSource("parcels",{type:"vector",tiles:["https://okxrvetbzpoazrybhcqj.supabase.co/functions/v1/mvt-parcels?z={z}&x={x}&y={y}"],minzoom:10,maxzoom:17,promoteId:"ogc_fid"}),g.addLayer({id:"parcels-fill",type:"fill",source:"parcels","source-layer":"parcels",paint:{"fill-color":"#1d4ed8","fill-opacity":.15}}),g.addLayer({id:"parcels-outline",type:"line",source:"parcels","source-layer":"parcels",paint:{"line-color":["case",["boolean",["feature-state","inProject"],!1],"#f59e0b","#1d4ed8"],"line-width":1}}),g.on("mouseenter","parcels-fill",()=>g.getCanvas().style.cursor="pointer"),g.on("mouseleave","parcels-fill",()=>g.getCanvas().style.cursor=""),g.on("click","parcels-fill",async S=>{const b=S.features?.[0]??g.queryRenderedFeatures(S.point,{layers:["parcels-fill"]})[0],{setDrawer:_,setSelectedParcel:w}=Ie.getState(),{activeProjectId:k,addParcel:$}=Ve.getState();try{const{createClient:R}=await jn(async()=>{const{createClient:ce}=await import("./supabase-vendor-BeTA44qk.js").then(U=>U.i);return{createClient:ce}},__vite__mapDeps([0,1,2])),T=R("https://okxrvetbzpoazrybhcqj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reHJ2ZXRienBvYXpyeWJoY3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1ODkxNDcsImV4cCI6MjA2MjE2NTE0N30.diq6x_Kr5_GxPSHJT1gm54Jh2UTiGVrBNgxDmV3yMxI"),P=Number(b?.id??b?.properties?.ogc_fid);if(Number.isFinite(P)){const{data:ce,error:U}=await T.rpc("get_parcel_by_id",{p_ogc_fid:P});if(U)throw U;const q=Array.isArray(ce)?ce[0]:ce;if(!q)throw new Error("not found");k?(await $(String(P),q),_("PROJECT")):s(q);return}const{lng:I,lat:Y}=S.lngLat,{data:B,error:F}=await T.rpc("get_parcel_at_point",{lon:I,lat:Y});if(F)throw F;const J=Array.isArray(B)?B[0]:B;if(!J)return;k?(await $(String(J.ogc_fid),J),_("PROJECT")):s(J)}catch(R){console.error("parcel click failed",R)}}),g.on("click",S=>{const b=g.queryRenderedFeatures(S.point,{layers:["parcels-fill"]})[0];b&&(console.log("click â†’",{id:b.id,props:b.properties,source:b.source,sourceLayer:b.sourceLayer}),console.log("Available properties:",Object.keys(b.properties||{})))}))}),g.on("error",S=>{console.error("Map error:",S.error),S.error?.message?.includes("access token")?x("invalid-token"):x("general-error")}),r.current=g,()=>{r.current&&(r.current.remove(),r.current=null)}},[]);const u=f.useCallback(()=>{const g=r.current;if(!g||!g.getSource("parcels"))return;g.querySourceFeatures&&g.querySourceFeatures("parcels",{sourceLayer:"parcels"}).forEach(w=>{w.id&&g.setFeatureState({source:"parcels",sourceLayer:"parcels",id:w.id},{inProject:!1})});const S=Ve.getState().selectedParcels;(Array.isArray(S)?S:Array.from(S||[])).forEach(_=>{const w=parseInt(_);Number.isFinite(w)&&g.setFeatureState({source:"parcels",sourceLayer:"parcels",id:w},{inProject:!0})})},[]);f.useEffect(()=>{const g=r.current;g&&g.isStyleLoaded()?u():g&&g.once("styledata",u);const S=Ve.subscribe(b=>b.selectedParcels,u);return()=>S()},[u]),f.useEffect(()=>{const g=()=>r.current?.resize();return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]),f.useEffect(()=>{const g=Ie.subscribe(S=>S.openDrawer,(S,b)=>{S!==b&&S!==null&&setTimeout(()=>{r.current&&r.current.resize()},150)});return()=>g()},[]),f.useEffect(()=>{const g=r.current;if(!g)return;const S=()=>{if(!g.getLayer("parcels-fill")){setTimeout(S,100);return}const _=Ie.getState().colorMode;g.setPaintProperty("parcels-fill","fill-color",_==="zoning"?Ai():ki())};g.isStyleLoaded()?S():g.once("style.load",S);const b=Ie.subscribe(_=>_.colorMode,_=>{g.getLayer("parcels-fill")&&g.setPaintProperty("parcels-fill","fill-color",_==="zoning"?Ai():ki())});return()=>b()},[]);const j=f.useCallback(()=>{const g=r.current;g&&["parcels-fill","parcels-outline"].forEach(S=>{g.getLayer(S)&&g.setFilter(S,v)})},[v]);return f.useEffect(()=>{j()},[j]),f.useEffect(()=>{const g=o.current;if(!g)return;const S=()=>{const w=g.clientHeight||0;w<1?c(`Map container has zero height. Container height: ${w}px`):c(null)},b=requestAnimationFrame(()=>requestAnimationFrame(S)),_=new ResizeObserver(S);return _.observe(g),()=>{cancelAnimationFrame(b),_.disconnect()}},[]),l?e.jsx("div",{className:"flex-1 flex items-center justify-center bg-red-50",children:e.jsxs("div",{className:"text-center p-8 max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-800 mb-2",children:"Map Container Issue"}),e.jsx("p",{className:"text-red-700 mb-4",children:l})]})}):d==="invalid-token"?e.jsx("div",{className:"flex-1 flex items-center justify-center bg-red-50",children:e.jsxs("div",{className:"text-center p-8 max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-800 mb-2",children:"Invalid Mapbox Token"}),e.jsx("p",{className:"text-red-700 mb-4",children:"Your Mapbox access token is invalid or expired."})]})}):e.jsx("div",{ref:o,className:"relative w-full h-full flex-1 min-h-0",style:{minHeight:200},"data-testid":"map-container","data-e2e":"map-canvas"})});function sl(){const[t,s]=f.useState(!1),[a,n]=f.useState([]),[i,r]=f.useState(new Map),o=f.useCallback(async(x,h)=>{if(h)return h;if(!x||x.length===0||!me)return null;const m=x.map(y=>y.id),p=m.sort().join("|");if(i.has(p))return i.get(p);try{const{data:y,error:v}=await me.rpc("get_assemblage_geometry",{parcel_ids:m});if(v)throw v;const u={geometry:y[0]?.geometry,totalAcres:y[0]?.total_acres||0,totalSqft:y[0]?.total_sqft||0,zoningMix:y[0]?.zoning_mix||{},boundaryCoordinates:y[0]?.boundary_coordinates||""};return r(j=>new Map(j).set(p,u)),u}catch(y){return console.error("Error getting assemblage geometry:",y),null}},[i]),l=f.useCallback(async x=>{if(!x.length||!me)return null;try{const h=x.map(y=>y.id),{data:m,error:p}=await me.rpc("calculate_unified_constraints",{parcel_ids:h});if(p)throw p;return{maxFAR:m[0]?.max_far||3,maxHeight:m[0]?.max_height_ft||45,maxCoverage:m[0]?.max_coverage_pct||40,setbacks:m[0]?.setbacks||{front:25,rear:20,side:10},limitingFactor:m[0]?.limiting_factor||"Unknown",buildableAreaSqft:m[0]?.buildable_area_sqft||0}}catch(h){return console.error("Error calculating constraints:",h),null}},[]),c=f.useCallback(async(x,h=15)=>{if(!Array.isArray(x)||!x.length||!me)return[];s(!0);try{const m=x.map(u=>u.id),{data:p,error:y}=await me.rpc("optimize_yield_scenarios",{parcel_ids:m,target_irr:h});if(y)throw y;const v=p?.map(u=>({scenarioName:u.scenario_name,farUtilization:u.far_utilization,heightUtilization:u.height_utilization,coverageUtilization:u.coverage_utilization,estimatedUnits:u.estimated_units,estimatedIRR:u.estimated_irr,estimatedROI:u.estimated_roi,constraintAnalysis:u.constraint_analysis}))||[];return n(v),v}catch(m){return console.error("Error optimizing scenarios:",m),[]}finally{s(!1)}},[]),d=f.useCallback(async(x,h)=>{if(!x.length)return null;const[m,p]=await Promise.all([o(x),l(x)]);if(!m||!p)return null;const y=Math.min(h.targetFAR,p.maxFAR),v=Math.min(h.targetHeight,p.maxHeight),u=Math.min(h.targetCoverage,p.maxCoverage),j=Math.min(m.totalSqft*(u/100),p.buildableAreaSqft),g=m.totalSqft*y,S=Math.floor(v/12),b=j*S,_=Math.min(g,b),w=Math.ceil(_/j),k=w*12,$=_/m.totalSqft,R=Math.floor(m.totalAcres*(h.unitsPerAcre||25)),T=Math.ceil(R*(h.parkingRatio||1.2));return{footprint:j,totalGSF:_,height:k,stories:w,units:R,parkingSpaces:T,coverage:j/m.totalSqft*100,far:$,buildableArea:p.buildableAreaSqft,openSpaceArea:Math.max(m.totalSqft*.15,R*100),parkingArea:T*300,amenitySpace:Math.max(2e3,R*50),averageUnitSize:_/R,constructionCost:_*180*1.3,estimatedValue:R*35e4,roiProjection:al(_,R,m.totalAcres),constraintAnalysis:{farUtilization:$/p.maxFAR*100,heightUtilization:k/p.maxHeight*100,coverageUtilization:j/m.totalSqft*100/p.maxCoverage*100,limitingFactor:p.limitingFactor}}},[o,l]);return{getAssemblageGeometry:o,calculateUnifiedConstraints:l,optimizeYieldScenarios:c,calculateLiveMassing:d,isOptimizing:t,optimizationResults:a,clearCache:()=>r(new Map)}}function al(t,s,a){const n=t*180*1.3,i=s*35e4,r=a*5e5;return(i-n-r)/(n+r)*100}const il=re.memo(function({parcelIds:s}){const{optimizeYieldScenarios:a,isOptimizing:n}=sl(),{activeProjectId:i}=fa();if(!i||s.length===0)return null;const r=async()=>{try{const o=s.map(l=>({id:l,parcelnumb:`PARCEL-${l}`,address:`Address ${l}`,deededacreage:1,sqft:43560,zoning:"RM15",geometry:{},landval:5e5,parval:6e5}));await a(o)}catch(o){console.error("Optimization error:",o)}};return e.jsx("div",{className:"absolute top-20 right-4 z-20",children:e.jsxs("button",{onClick:r,disabled:n,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors shadow-lg ${n?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:[n?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"}):e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{children:n?"Optimizing...":`Optimize ${s.length===1?"Site":"Assemblage"}`})]})})}),nl=re.memo(function({onParcelClick:s}){const{activeProjectId:a,activeProjectName:n,parcelIds:i}=fa();return e.jsxs("div",{className:"w-full h-full min-h-0 relative",children:[e.jsx(tl,{onParcelClick:s,selectedParcelIds:i,activeProjectId:a,activeProjectName:n}),e.jsx(il,{parcelIds:i})]})});function rl({onParcelClick:t,activeProjectName:s}){return e.jsx("div",{className:"w-full h-full min-w-0 min-h-0 flex-1 flex flex-col",style:{height:"100%"},children:e.jsx(nl,{onParcelClick:t,activeProjectName:s})})}const kt=t=>Number.isFinite(t)?t:0;function Ys(t,s){let a=0,n=0;for(const i of s)a+=i/Math.pow(1+t,n++);return a}function ll(t,s=200,a=1e-7){const n=t.some(d=>d<0),i=t.some(d=>d>0);if(!n||!i)return NaN;let r=-.9999,o=10,l=Ys(r,t),c=Ys(o,t);if(l*c>0&&(o=100,c=Ys(o,t),l*c>0))return NaN;for(let d=0;d<s;d++){const x=(r+o)/2,h=Ys(x,t);if(Math.abs(h)<a)return x;l*h<0?(o=x,c=h):(r=x,l=h)}return(r+o)/2}function ol(t,s,a){const n=new Array(Math.max(a+1,2)).fill(0);return n[0]=-t,n[a]=s,n}function cl(t){const{land_cost:s=0,hard_cost:a=0,soft_cost:n=0,contingency:i=0,loan_amount:r=0,revenue:o=0,development_months:l=18}=t,c=s+a+n+i,d=Math.max(c-r,0),x=o-c,h=Math.max(o-r,0),m=ol(d,h,Math.max(1,l)),p=ll(m),y=Number.isFinite(p)?Math.pow(1+p,12)-1:NaN,v=c>0?x/c:NaN,u=d>0?h/d:NaN,j=d>0?x/d:NaN;return{total_cost:kt(c),equity_required:kt(d),profit:kt(x),irr_annual_pct:kt(y*100),irr_monthly_pct:kt(p*100),yield_on_cost_pct:kt(v*100),equity_multiple:kt(u),cash_on_cash_pct:kt(j*100)}}const Ei={RS5:{land_cost_per_acre:4e5,hard_cost_per_sf:160,sale_price_per_unit:28e4,rent_per_unit_per_month:1400},"RS7.5":{land_cost_per_acre:45e4,hard_cost_per_sf:165,sale_price_per_unit:32e4,rent_per_unit_per_month:1600},RS10:{land_cost_per_acre:5e5,hard_cost_per_sf:170,sale_price_per_unit:35e4,rent_per_unit_per_month:1800},RS15:{land_cost_per_acre:55e4,hard_cost_per_sf:175,sale_price_per_unit:38e4,rent_per_unit_per_month:2e3},RS20:{land_cost_per_acre:6e5,hard_cost_per_sf:180,sale_price_per_unit:42e4,rent_per_unit_per_month:2200},R6:{land_cost_per_acre:8e5,hard_cost_per_sf:150,sale_price_per_unit:25e4,rent_per_unit_per_month:1500},R8:{land_cost_per_acre:9e5,hard_cost_per_sf:160,sale_price_per_unit:28e4,rent_per_unit_per_month:1650},R10:{land_cost_per_acre:1e6,hard_cost_per_sf:170,sale_price_per_unit:32e4,rent_per_unit_per_month:1800},R15:{land_cost_per_acre:12e5,hard_cost_per_sf:180,sale_price_per_unit:35e4,rent_per_unit_per_month:2e3},R20:{land_cost_per_acre:14e5,hard_cost_per_sf:190,sale_price_per_unit:38e4,rent_per_unit_per_month:2200},RM2:{land_cost_per_acre:1e6,hard_cost_per_sf:180,sale_price_per_unit:32e4,rent_per_unit_per_month:1800},RM4:{land_cost_per_acre:12e5,hard_cost_per_sf:190,sale_price_per_unit:35e4,rent_per_unit_per_month:2e3},RM6:{land_cost_per_acre:14e5,hard_cost_per_sf:200,sale_price_per_unit:38e4,rent_per_unit_per_month:2200},RM9:{land_cost_per_acre:16e5,hard_cost_per_sf:210,sale_price_per_unit:42e4,rent_per_unit_per_month:2400},RM15:{land_cost_per_acre:18e5,hard_cost_per_sf:220,sale_price_per_unit:45e4,rent_per_unit_per_month:2600},RM20:{land_cost_per_acre:2e6,hard_cost_per_sf:230,sale_price_per_unit:5e5,rent_per_unit_per_month:2800},CN:{land_cost_per_acre:15e5,hard_cost_per_sf:200,sale_price_per_sf:300,rent_per_sf_per_month:2.5},CR:{land_cost_per_acre:18e5,hard_cost_per_sf:220,sale_price_per_sf:350,rent_per_sf_per_month:3},CS:{land_cost_per_acre:22e5,hard_cost_per_sf:240,sale_price_per_sf:400,rent_per_sf_per_month:3.5},CA:{land_cost_per_acre:28e5,hard_cost_per_sf:260,sale_price_per_sf:450,rent_per_sf_per_month:4},default:{land_cost_per_acre:5e5,hard_cost_per_sf:180,sale_price_per_unit:35e4,rent_per_unit_per_month:1800}};function dl(t){return Ei[t]||Ei.default}const js=[{id:"hard_construction",label:"Hard Construction Costs & Demo",basis:"per_sf",value:275,category:"HARD"},{id:"site_work",label:"Site Work",basis:"fixed",value:3e5,category:"SITE"},{id:"permit_tap",label:"Permit & Tap Fees",basis:"per_unit",value:3500,category:"FEES"},{id:"amenities",label:"Amenities",basis:"per_sf",value:15,category:"HARD"},{id:"legal",label:"Legal",basis:"fixed",value:65e3,category:"SOFT"},{id:"architecture",label:"Architecture",basis:"percent_of_hard",value:.035,category:"SOFT"},{id:"civil",label:"Civil Engineer",basis:"fixed",value:85e3,category:"SOFT"},{id:"survey_env",label:"Survey & Environmental",basis:"fixed",value:45e3,category:"SOFT"},{id:"title_escrow",label:"Title & Escrow",basis:"fixed",value:3e4,category:"SOFT"},{id:"taxes",label:"Real Estate Taxes (pre-CO)",basis:"fixed",value:4e4,category:"SOFT"},{id:"insurance",label:"Insurance",basis:"fixed",value:55e3,category:"SOFT"},{id:"dev_fee",label:"Development Fee",basis:"percent_of_hard",value:.04,category:"SOFT"},{id:"closing_misc",label:"Closing Cost & Fees",basis:"fixed",value:25e3,category:"SOFT"},{id:"consultants",label:"Consultants & Pro Fees",basis:"fixed",value:6e4,category:"SOFT"},{id:"op_loss",label:"Op Loss",basis:"fixed",value:5e4,category:"SOFT"},{id:"marketing_ffe",label:"Marketing & FF&E",basis:"per_unit",value:2500,category:"SOFT"},{id:"misc",label:"Misc",basis:"fixed",value:25e3,category:"SOFT"},{id:"contingency",label:"Contingency",basis:"percent_of_hard",value:.07,category:"CONT"}];function Ri(t,s){switch(t.basis){case"fixed":return t.value;case"per_sf":return t.value*(s.buildableSf||0);case"per_unit":return t.value*(s.units||0);case"percent_of_hard":return t.value*(s.hardSubtotalExCont||0);case"percent_of_tdc":return t.value*(s.tdcBeforeFee||0);default:return 0}}function Sn(t,s){const a=new Set(["hard_construction","site_work","permit_tap","amenities"]);let n=0;for(const h of t)a.has(h.id)&&(n+=Ri(h,{hardSubtotalExCont:0,tdcBeforeFee:0,buildableSf:s.buildableSf,units:s.units,keys:s.keys}));let i=n;const r=[];function o(h){const m=Ri(h,{hardSubtotalExCont:n,tdcBeforeFee:i,buildableSf:s.buildableSf,units:s.units,keys:s.keys});r.push({id:h.id,label:h.label,amount:m,category:h.category}),i+=m}const l=["hard_construction","site_work","amenities","permit_tap","legal","architecture","civil","survey_env","title_escrow","taxes","insurance","dev_fee","closing_misc","consultants","op_loss","marketing_ffe","misc","contingency"],c=new Map(t.map(h=>[h.id,h]));for(const h of l){const m=c.get(h);m&&o(m)}for(const h of t)l.includes(h.id)||o(h);const d={HARD:0,SITE:0,FEES:0,SOFT:0,CONT:0,FIN:0};for(const h of r)d[h.category]+=h.amount;const x=Object.values(d).reduce((h,m)=>h+m,0);return{items:r,subtotals:d,tdc:x}}function hl({program:t,onChange:s,onTotalCostChange:a}){const[n,i]=f.useState(js),[r,o]=f.useState(!1),l=f.useMemo(()=>{const u=Sn(n,t);return a?.(u.tdc),u},[n,t,a]),c=(u,j)=>{const g=n.slice();g[u]={...g[u],...j},i(g),s?.(g)},d=()=>{const u={id:`custom_${Date.now()}`,label:"Custom Item",basis:"fixed",value:0,category:"SOFT"},j=[...n,u];i(j),s?.(j)},x=u=>{const j=n.filter((g,S)=>S!==u);i(j),s?.(j)},h=()=>{i(js),s?.(js)},m=u=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(u),p=u=>u.basis==="percent_of_hard"||u.basis==="percent_of_tdc"?(u.value*100).toFixed(2)+"%":u.value.toLocaleString(),y=u=>{switch(u){case"HARD":return"bg-blue-50 border-blue-200";case"SITE":return"bg-green-50 border-green-200";case"FEES":return"bg-yellow-50 border-yellow-200";case"SOFT":return"bg-purple-50 border-purple-200";case"CONT":return"bg-red-50 border-red-200";case"FIN":return"bg-gray-50 border-gray-200";default:return"bg-gray-50 border-gray-200"}},v=u=>{switch(u){case"HARD":return e.jsx(qe,{className:"w-4 h-4"});case"SITE":return e.jsx(Ze,{className:"w-4 h-4"});case"FEES":return e.jsx(Ye,{className:"w-4 h-4"});case"SOFT":return e.jsx(Me,{className:"w-4 h-4"});case"CONT":return e.jsx(lt,{className:"w-4 h-4"});case"FIN":return e.jsx(Ye,{className:"w-4 h-4"});default:return e.jsx(Ye,{className:"w-4 h-4"})}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 flex items-center space-x-2",children:[e.jsx(Me,{className:"w-5 h-5"}),e.jsx("span",{children:"Development Cost Breakdown"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>o(!r),className:"px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",children:r?"Simple View":"Advanced"}),e.jsx("button",{onClick:h,className:"px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-colors",children:"Reset"})]})]}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Buildable SF:"}),e.jsx("div",{className:"font-semibold",children:t.buildableSf.toLocaleString()})]}),t.units&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Units:"}),e.jsx("div",{className:"font-semibold",children:t.units})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Lot Size:"}),e.jsxs("div",{className:"font-semibold",children:[Math.round(t.lotSqft/43560*100)/100," ac"]})]})]})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-12 gap-2 text-xs font-semibold text-gray-700 uppercase tracking-wider",children:[e.jsx("div",{className:"col-span-4",children:"Item"}),e.jsx("div",{className:"col-span-2",children:"Basis"}),e.jsx("div",{className:"col-span-2",children:"Value"}),e.jsx("div",{className:"col-span-3 text-right",children:"Amount"}),e.jsx("div",{className:"col-span-1"})]})}),e.jsx("div",{className:"divide-y divide-gray-200 max-h-96 overflow-y-auto",children:n.map((u,j)=>e.jsx("div",{className:`px-4 py-3 ${y(u.category)}`,children:e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsxs("div",{className:"col-span-4 flex items-center space-x-2",children:[v(u.category),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:u.label}),e.jsx("div",{className:"text-xs text-gray-500",children:u.category})]}),u.locked&&e.jsx(dn,{className:"w-3 h-3 text-gray-400"})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("select",{value:u.basis,onChange:g=>c(j,{basis:g.target.value}),className:"w-full text-xs border border-gray-300 rounded px-2 py-1 focus-ring",disabled:u.locked,children:[e.jsx("option",{value:"fixed",children:"Fixed $"}),e.jsx("option",{value:"per_sf",children:"$ / SF"}),e.jsx("option",{value:"per_unit",children:"$ / Unit"}),e.jsx("option",{value:"percent_of_hard",children:"% of Hard"}),e.jsx("option",{value:"percent_of_tdc",children:"% of TDC"})]})}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("input",{type:"number",step:u.basis.includes("percent")?"0.001":u.basis==="per_sf"?"1":"1000",value:u.value,onChange:g=>c(j,{value:Number(g.target.value)}),className:"w-full text-xs border border-gray-300 rounded px-2 py-1 focus-ring tabular-nums",disabled:u.locked}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:p(u)})]}),e.jsx("div",{className:"col-span-3 text-right",children:e.jsx("div",{className:"text-sm font-semibold text-gray-900 tabular-nums",children:m(l.items.find(g=>g.id===u.id)?.amount||0)})}),e.jsx("div",{className:"col-span-1 flex justify-end",children:r&&!u.locked&&e.jsx("button",{onClick:()=>x(j),className:"p-1 text-gray-400 hover:text-red-600 rounded",title:"Remove item",children:e.jsx(xn,{className:"w-4 h-4"})})})]})},u.id))}),r&&e.jsx("div",{className:"p-3 border-t border-gray-200 bg-gray-50",children:e.jsxs("button",{onClick:d,className:"flex items-center space-x-2 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add Custom Line Item"})]})})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Cost Summary"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Hard Construction + Demo:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.HARD)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Site Work:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.SITE)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Permit & Tap Fees:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.FEES)})]}),e.jsxs("div",{className:"flex justify-between text-sm border-t pt-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total Soft Costs:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.SOFT)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Contingency:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.CONT)})]}),l.subtotals.FIN>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Interest & Financing:"}),e.jsx("span",{className:"font-medium tabular-nums",children:m(l.subtotals.FIN)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t-2 pt-3",children:[e.jsx("span",{children:"Total Development Cost (TDC):"}),e.jsx("span",{className:"tabular-nums",children:m(l.tdc)})]})]})]}),e.jsx("div",{className:"text-xs text-gray-500",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:["Buildable: ",t.buildableSf.toLocaleString()," SF"]}),t.units&&e.jsxs("span",{children:["Units: ",t.units]}),t.keys&&e.jsxs("span",{children:["Keys: ",t.keys]})]})})]})}function ml(t,s,a){const[n,i]=f.useState(js),[r,o]=f.useState(!1),[l,c]=f.useState(!1);f.useEffect(()=>{},[t,s]);const d=f.useMemo(()=>Sn(n,a),[n,a]);return{lineItems:n,breakdown:d,loading:r,saving:l,updateLineItems:h=>{i(h),setTimeout(()=>{},500)},saveCostOverrides:()=>Promise.resolve(),resetToDefaults:()=>{i(js)}}}function xl(t){if(t.zoning_type)switch(t.zoning_type.toLowerCase()){case"residential":return t.zoning_subtype?.toLowerCase().includes("single")?"Single-Family":t.zoning_subtype?.toLowerCase().includes("multi")?"Multi-Family":t.zoning_subtype?.toLowerCase().includes("townhouse")?"Townhouse":"Multi-Family";case"commercial":return"Commercial";case"industrial":return"Industrial";case"mixed-use":return"Mixed-Use";case"agricultural":return"Agricultural";default:return"General"}const s=t.zoning||"";return s.startsWith("RS")?"Single-Family":s.startsWith("R")?"Multi-Family":s.startsWith("RM")?"Mixed-Use":s.startsWith("C")?"Commercial":s.startsWith("MU")?"Mixed-Use":"General"}const ul=re.memo(function({parcel:s,onClose:a}){const[n,i]=f.useState(null),[r,o]=f.useState({}),[l,c]=f.useState(!1),[d,x]=f.useState("for-sale"),[h,m]=f.useState(!1),[p,y]=f.useState(!1),[v,u]=f.useState(null),j=f.useMemo(()=>{const P=s.deeded_acres||s.deededacreage||s.gisacre||0,I=s.sqft||P*43560,Y=I*2,B=Math.floor(P*25);return{lotSqft:I,buildableSf:Y,units:B}},[s]),{breakdown:g,updateLineItems:S}=ml(null,String(s.ogc_fid),j);f.useEffect(()=>{s?.zoning&&_(s)},[s?.zoning]);const b=f.useMemo(()=>{if(!n||!s||l)return null;try{const P={...n,...r},I=s.deeded_acres||s.deededacreage||s.gisacre||0,Y=s.sqft||I*43560,B=I*P.land_cost_per_acre,F=Y*P.hard_cost_per_sf*2,J=F*(P.soft_cost_percentage/100),ce=(F+J)*(P.contingency_percentage/100),q=(v||B+F+J+ce)*(P.loan_to_cost/100);let z=0;d==="for-sale"?z=Math.floor(I*25)*P.sale_price_per_unit:z=Y*P.rent_per_sf_per_month*12*2*(1-P.vacancy_rate/100)*(1-P.operating_expense_ratio/100)/(P.cap_rate/100);const O={land_cost:B,hard_cost:F,soft_cost:J,contingency:ce,loan_amount:q,revenue:z,development_months:P.development_months};return cl(O)}catch(P){return console.error("Error calculating metrics:",P),null}},[n,r,d,s,l,v]),_=async P=>{c(!0);try{const I=dl(P.zoning),Y={use_type:xl(P),land_cost_per_acre:I.land_cost_per_acre||5e5,hard_cost_per_sf:I.hard_cost_per_sf||180,soft_cost_percentage:20,contingency_percentage:10,loan_to_cost:75,interest_rate:7.5,rent_per_sf_per_month:1.8,sale_price_per_sf:320,rent_per_unit_per_month:I.rent_per_unit_per_month||1800,sale_price_per_unit:I.sale_price_per_unit||35e4,vacancy_rate:5,operating_expense_ratio:35,cap_rate:5.5,development_months:18,lease_up_months:6};i(Y),o({})}catch(I){console.error("Error loading default costs:",I),i({use_type:"General",land_cost_per_acre:5e5,hard_cost_per_sf:180,soft_cost_percentage:20,contingency_percentage:10,loan_to_cost:75,interest_rate:7.5,rent_per_sf_per_month:1.8,sale_price_per_sf:320,rent_per_unit_per_month:1800,sale_price_per_unit:35e4,vacancy_rate:5,operating_expense_ratio:35,cap_rate:5.5,development_months:18,lease_up_months:6})}finally{c(!1)}},w=(P,I)=>{o(Y=>({...Y,[P]:I}))},k=async()=>{if(s){m(!0);try{const{data:P,error:I}=await me.functions.invoke("pdf-export",{body:{projectData:{name:`Parcel ${s.parcelnumb}`,parcel:s,metrics:b,costs:{...n,...r}},reportType:"underwriting"}});if(I)throw I;const Y=document.createElement("a");Y.href=URL.createObjectURL(new Blob([P],{type:"application/pdf"})),Y.download=`parcel-${s.parcelnumb}-underwriting.pdf`,Y.click()}catch(P){console.error("PDF export error:",P)}finally{m(!1)}}},$=P=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(P),R=P=>`${P.toFixed(1)}%`,T=P=>P>=20?"text-green-600":P>=15?"text-blue-600":P>=10?"text-yellow-600":"text-red-600";return s?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 bg-gray-50 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 flex items-center space-x-2",children:[e.jsx(Me,{className:"w-5 h-5"}),e.jsx("span",{children:"Underwriting Analysis"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("button",{className:"p-1 text-gray-400 hover:text-blue-600 rounded",title:"Recalculate",children:e.jsx(Xa,{className:"w-4 h-4"})})})]}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[s.address," â€¢ ",s.parcelnumb," â€¢ ",s.zoning,s.zoning_type&&e.jsxs("span",{className:"ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded",children:[s.zoning_type,s.zoning_subtype&&` - ${s.zoning_subtype}`]})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(s.deeded_acres||s.deededacreage||s.gisacre||0).toFixed(2)," acres â€¢",(s.sqft||0).toLocaleString()," sq ft"]})]})]}),e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>x("for-sale"),className:`flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors ${d==="for-sale"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"For-Sale"}),e.jsx("button",{onClick:()=>x("rental"),className:`flex-1 px-3 py-2 text-sm font-medium rounded-md transition-colors ${d==="rental"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Rental"})]})}),(s.zoning_type||s.max_far||s.max_density_du_per_acre)&&e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ee,{className:"w-5 h-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-gray-900",children:"Zoning Constraints"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.max_far&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Max FAR:"}),e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:s.max_far})]}),s.max_density_du_per_acre&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Max Density:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[s.max_density_du_per_acre," DU/acre"]})]}),s.max_building_height_ft&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Max Height:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[s.max_building_height_ft," ft"]})]}),s.max_coverage_pct&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Max Coverage:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[s.max_coverage_pct,"%"]})]}),s.min_lot_area_sq_ft&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Min Lot Area:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[s.min_lot_area_sq_ft.toLocaleString()," sq ft"]})]}),s.min_front_setback_ft&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Front Setback:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[s.min_front_setback_ft," ft"]})]})]}),s.permitted_land_uses&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-gray-600 text-sm font-medium mb-2",children:"Permitted Uses:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(s.permitted_land_uses).slice(0,3).map(([P,I])=>e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded",children:[P,": ",Array.isArray(I)?I.slice(0,2).join(", "):I]},P))})]})]}),b&&e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Financial Results"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg text-center",children:[e.jsx("div",{className:`text-2xl font-bold ${T(b.irr_annual_pct)}`,"data-e2e":"irr-cell",children:R(b.irr_annual_pct)}),e.jsx("div",{className:"text-xs text-gray-600",children:"IRR"})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:R(b.yield_on_cost_pct)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Yield on Cost"})]}),e.jsxs("div",{className:"bg-purple-50 p-3 rounded-lg text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[b.equity_multiple.toFixed(2),"x"]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Equity Multiple"})]}),e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:R(b.cash_on_cash_pct)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Cash-on-Cash"})]})]})]}),n&&e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:"Cost Assumptions"}),e.jsxs("div",{className:"text-xs text-blue-600",children:["Default: ",n.use_type]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Hard Cost ($/SF)"}),e.jsx("input",{type:"number",value:r.hard_cost_per_sf??n.hard_cost_per_sf,onChange:P=>w("hard_cost_per_sf",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:"10"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Interest Rate (%)"}),e.jsx("input",{type:"number",value:r.interest_rate??n.interest_rate,onChange:P=>w("interest_rate",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:"0.1"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:d==="for-sale"?"Sale Price/Unit":"Rent/Unit/Month"}),e.jsx("input",{type:"number",value:d==="for-sale"?r.sale_price_per_unit??n.sale_price_per_unit:r.rent_per_unit_per_month??n.rent_per_unit_per_month,onChange:P=>w(d==="for-sale"?"sale_price_per_unit":"rent_per_unit_per_month",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:d==="for-sale"?"10000":"50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Loan-to-Cost (%)"}),e.jsx("input",{type:"number",value:r.loan_to_cost??n.loan_to_cost,onChange:P=>w("loan_to_cost",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:"5",min:"0",max:"95"})]})]}),d==="rental"&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Vacancy Rate (%)"}),e.jsx("input",{type:"number",value:r.vacancy_rate??n.vacancy_rate,onChange:P=>w("vacancy_rate",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:"0.5"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Cap Rate (%)"}),e.jsx("input",{type:"number",value:r.cap_rate??n.cap_rate,onChange:P=>w("cap_rate",parseFloat(P.target.value)),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus-ring",step:"0.25"})]})]})]})]}),b&&e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Cost Breakdown"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Development Cost:"}),e.jsx("span",{className:"font-medium",children:$(b.total_cost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Equity Required:"}),e.jsx("span",{className:"font-medium",children:$(b.equity_required)})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2",children:[e.jsx("span",{className:"text-gray-600",children:"Estimated Profit:"}),e.jsx("span",{className:`font-semibold ${b.profit>0?"text-green-600":"text-red-600"}`,children:$(b.profit)})]})]})]}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("button",{onClick:k,disabled:h||!b,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 transition-colors flex items-center justify-center space-x-2",children:[h?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(na,{className:"w-4 h-4"}),e.jsx("span",{children:h?"Generating PDF...":"Export PDF Report"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{onClick:()=>y(!p),className:"flex items-center space-x-2 text-sm font-medium text-blue-600 hover:text-blue-700",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsxs("span",{children:[p?"Hide":"Show"," Detailed Cost Breakdown"]})]}),g&&e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["TDC: ",$(g.tdc)]})]}),p&&e.jsx(hl,{program:j,onChange:S,onTotalCostChange:u})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>window.location.reload(),className:"bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center space-x-1",children:[e.jsx(Me,{className:"w-3 h-3"}),e.jsx("span",{className:"text-sm",children:"Recalculate"})]}),e.jsx("button",{className:"border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm",children:"Save to Project"})]})]}),l&&e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Loading cost data..."})]})})]}):null});class gl{constructor(s,a){vt(this,"marketData");vt(this,"costData");this.marketData=s,this.costData=a}safeParseNumber(s){if(s==null||s==="")return;const a=Number(s);if(!(isNaN(a)||!isFinite(a))&&!(a<0&&Math.abs(a)>1e3))return a}async analyzeHBU(s){console.log("Raw parcel data received:",s);const a={zoning_id:s.zoning_id,zoning:s.zoning,zoning_description:s.zoning_description,zoning_type:s.zoning_type,zoning_subtype:s.zoning_subtype,zoning_objective:s.zoning_objective,zoning_code_link:s.zoning_code_link,permitted_land_uses:s.permitted_land_uses,permitted_land_uses_as_of_right:s.permitted_land_uses_as_of_right,permitted_land_uses_conditional:s.permitted_land_uses_conditional,min_lot_area_sq_ft:this.safeParseNumber(s.min_lot_area_sq_ft),min_lot_width_ft:this.safeParseNumber(s.min_lot_width_ft),max_building_height_ft:this.safeParseNumber(s.max_building_height_ft),max_far:this.safeParseNumber(s.max_far),min_front_setback_ft:this.safeParseNumber(s.min_front_setback_ft),min_rear_setback_ft:this.safeParseNumber(s.min_rear_setback_ft),min_side_setback_ft:this.safeParseNumber(s.min_side_setback_ft),max_coverage_pct:this.safeParseNumber(s.max_coverage_pct),max_impervious_coverage_pct:this.safeParseNumber(s.max_impervious_coverage_pct),min_landscaped_space_pct:this.safeParseNumber(s.min_landscaped_space_pct),min_open_space_pct:this.safeParseNumber(s.min_open_space_pct),max_density_du_per_acre:this.safeParseNumber(s.max_density_du_per_acre),zoning_data_date:s.zoning_data_date,municipality_id:s.municipality_id,municipality_name:s.municipality_name,geoid:s.geoid};console.log("Processed zoning data:",a),!a.zoning&&!a.zoning_type&&(console.warn("No zoning data found, using fallback analysis"),a.zoning=s.zoning||"Unknown",a.zoning_type="Residential");const n=this.identifyFeasibleUses(a);console.log("Feasible uses identified:",n),n.length===0&&(console.warn("No feasible uses found, adding default residential use"),n.push("Single Family"));const i=await this.analyzeMarketFactors(s);console.log("Market factors analyzed:",i);const r=await this.calculateAlternatives(s,n);console.log("Alternatives calculated:",r);const o=this.identifyConstraints(a),l=this.determineRecommendedUse(r),c=this.calculateConfidence(r,i);return{recommendedUse:l,confidence:c,alternatives:r,constraints:o,marketFactors:i,financialProjections:this.generateFinancialProjections(l,r),analysisDate:new Date,analyst:"System"}}identifyFeasibleUses(s){const a=[];if(s.permitted_land_uses)try{typeof s.permitted_land_uses=="object"?Object.keys(s.permitted_land_uses).forEach(n=>{const i=s.permitted_land_uses[n];Array.isArray(i)?i.forEach(r=>{this.isFeasibleUse(r,s)&&a.push(r)}):typeof i=="string"&&this.isFeasibleUse(i,s)&&a.push(i)}):typeof s.permitted_land_uses=="string"&&s.permitted_land_uses.split(",").map(i=>i.trim()).forEach(i=>{this.isFeasibleUse(i,s)&&a.push(i)})}catch(n){console.warn("Error processing permitted_land_uses:",n)}if(s.zoning_type){const n=this.getUsesByZoningType(s.zoning_type);if(a.push(...n),s.zoning_subtype){const i=this.getUsesByZoningSubtype(s.zoning_subtype);a.push(...i)}}if(s.zoning_objective){const n=this.getUsesByZoningObjective(s.zoning_objective);a.push(...n)}return[...new Set(a)]}isFeasibleUse(s,a){const n=a.max_density_du_per_acre||0;if(this.getRequiredDensity(s)>n&&n>0)return!1;const r=a.max_far||0;if(this.getRequiredFAR(s)>r&&r>0)return!1;const l=a.max_building_height_ft||0;return!(this.getRequiredHeight(s)>l&&l>0)}getUsesByZoningType(s){return{Residential:["Single Family","Multi-Family","Townhouse","Apartment"],Commercial:["Retail","Office","Restaurant","Hotel"],Industrial:["Warehouse","Manufacturing","Distribution"],"Mixed-Use":["Mixed-Use Residential","Mixed-Use Commercial"],Agricultural:["Farming","Ranch","Vineyard"],"Special Purpose":["Institutional","Recreation","Open Space"]}[s]||[]}getUsesByZoningSubtype(s){return{"Single Family":["Single Family","Townhouse"],"Multi-Family":["Multi-Family","Apartment"],"Mixed-Use Residential":["Mixed-Use Residential","Apartment","Retail"],"Mixed-Use Commercial":["Mixed-Use Commercial","Office","Retail"],"High-Density Residential":["Apartment","Multi-Family"],"Low-Density Residential":["Single Family","Townhouse"],Office:["Office","Professional Services"],Retail:["Retail","Restaurant","Service"],Industrial:["Warehouse","Manufacturing","Distribution"]}[s]||[]}getUsesByZoningObjective(s){return{"Residential Development":["Single Family","Multi-Family","Apartment"],"Commercial Development":["Retail","Office","Restaurant"],"Mixed-Use Development":["Mixed-Use Residential","Mixed-Use Commercial"],"Industrial Development":["Warehouse","Manufacturing"],"Transit-Oriented Development":["Mixed-Use Residential","Mixed-Use Commercial"],"Affordable Housing":["Multi-Family","Apartment"],"Urban Infill":["Mixed-Use Residential","Mixed-Use Commercial"]}[s]||[]}getRequiredDensity(s){return{"Single Family":2,"Multi-Family":20,Townhouse:15,Apartment:30,Retail:0,Office:0,Warehouse:0}[s]||0}getRequiredFAR(s){return{"Single Family":.3,"Multi-Family":2,Townhouse:1.5,Apartment:3,Retail:1,Office:2.5,Warehouse:1.5}[s]||0}getRequiredHeight(s){return{"Single Family":35,"Multi-Family":60,Townhouse:45,Apartment:90,Retail:30,Office:120,Warehouse:40}[s]||0}async analyzeMarketFactors(s){const a=[];return a.push({factor:"Location Desirability",impact:"positive",weight:.3,description:"Prime location with good access and amenities"}),a.push({factor:"Market Demand",impact:"positive",weight:.25,description:"Strong demand for development in this area"}),s.zoning_data?.zoning_type==="Mixed-Use"&&a.push({factor:"Zoning Flexibility",impact:"positive",weight:.2,description:"Mixed-use zoning allows multiple development options"}),a.push({factor:"Infrastructure",impact:"positive",weight:.15,description:"Good infrastructure and utilities available"}),a.push({factor:"Market Competition",impact:"neutral",weight:.1,description:"Moderate competition in the market"}),a}async calculateAlternatives(s,a){const n=[];for(const i of a){const r=await this.calculateAlternative(s,i);n.push(r)}return n.sort((i,r)=>r.netPresentValue-i.netPresentValue)}async calculateAlternative(s,a){const n=this.getRequiredDensity(a),i=this.getRequiredFAR(a),r=this.getRequiredHeight(a),o=s.sqft||0,l=o*i,c=n>0?Math.floor(o/43560*n):0,d=s.parval||0,x=l*this.getCostPerSqFt(a),h=x*.25,m=(x+h)*.1,p=d+x+h+m,y=this.estimateRevenue(a,l,c),v=y-p,u=this.calculateIRR(p,y,3),j=this.calculatePaybackPeriod(p,y);return{use:a,density:n,height:r,estimatedValue:y,developmentCost:p,netPresentValue:v,internalRateOfReturn:u,paybackPeriod:j,confidence:this.calculateUseConfidence(a,s),constraints:this.identifyUseConstraints(a,s.zoning_data),marketFactors:this.identifyUseMarketFactors(a,s)}}getCostPerSqFt(s){return{"Single Family":150,"Multi-Family":200,Townhouse:180,Apartment:220,Retail:180,Office:250,Warehouse:120}[s]||200}estimateRevenue(s,a,n){const i=this.getPricePerSqFt(s),r=this.getPricePerUnit(s);return n>0?n*r:a*i}getPricePerSqFt(s){return{"Single Family":300,"Multi-Family":400,Townhouse:350,Apartment:450,Retail:200,Office:300,Warehouse:150}[s]||300}getPricePerUnit(s){return{"Single Family":5e5,"Multi-Family":3e5,Townhouse:4e5,Apartment:25e4}[s]||3e5}calculateIRR(s,a,n){return s<=0?0:Math.pow(a/s,1/n)-1}calculatePaybackPeriod(s,a){return a<=0?1/0:s/a}calculateUseConfidence(s,a){let n=50;if(a.zoning_data?.zoning_type){const i=this.getZoningTypeMatch(s,a.zoning_data.zoning_type);n+=i*20}return n+=15,n+=10,n+=5,Math.min(n,100)}getZoningTypeMatch(s,a){return({Residential:["Single Family","Multi-Family","Townhouse","Apartment"],Commercial:["Retail","Office","Restaurant","Hotel"],Industrial:["Warehouse","Manufacturing"],"Mixed-Use":["Mixed-Use Residential","Mixed-Use Commercial"]}[a]||[]).includes(s)?1:0}identifyUseConstraints(s,a){const n=[];return a.max_density_du_per_acre&&this.getRequiredDensity(s)>a.max_density_du_per_acre&&n.push(`Density limit: ${a.max_density_du_per_acre} DU/acre`),a.max_far&&this.getRequiredFAR(s)>a.max_far&&n.push(`FAR limit: ${a.max_far}`),a.max_building_height_ft&&this.getRequiredHeight(s)>a.max_building_height_ft&&n.push(`Height limit: ${a.max_building_height_ft} ft`),n}identifyUseMarketFactors(s,a){const n=[];return n.push("Strong market demand"),n.push("Good location access"),n.push("Adequate infrastructure"),n}identifyConstraints(s){const a=[];return s.max_density_du_per_acre&&a.push({type:"density",description:`Maximum density: ${s.max_density_du_per_acre} DU/acre`,value:s.max_density_du_per_acre,unit:"DU/acre",impact:"limiting"}),s.max_far&&a.push({type:"far",description:`Maximum FAR: ${s.max_far}`,value:s.max_far,unit:"ratio",impact:"limiting"}),s.max_building_height_ft&&a.push({type:"height",description:`Maximum height: ${s.max_building_height_ft} ft`,value:s.max_building_height_ft,unit:"ft",impact:"moderate"}),a}determineRecommendedUse(s){if(s.length===0)return"residential";const a=s[0];return a.use.includes("Mixed-Use")?"mixed-use":a.use.includes("Residential")||a.use.includes("Family")||a.use.includes("Apartment")?"residential":a.use.includes("Commercial")||a.use.includes("Retail")||a.use.includes("Office")?"commercial":a.use.includes("Industrial")||a.use.includes("Warehouse")||a.use.includes("Manufacturing")?"industrial":"residential"}calculateConfidence(s,a){if(s.length===0)return 0;const n=s.reduce((r,o)=>r+o.confidence,0)/s.length,i=a.reduce((r,o)=>r+o.weight*(o.impact==="positive"?1:o.impact==="negative"?-1:0),0);return Math.min(n+i*10,100)}generateFinancialProjections(s,a){const n=[],i=a[0];if(!i)return n;for(let r=1;r<=10;r++){const o=i.estimatedValue*1.03**r,l=i.developmentCost*.05,c=o-l,d=c,x=n.length>0?n[n.length-1].cumulativeCashFlow+d:d;n.push({year:r,revenue:o,expenses:l,netIncome:c,cashFlow:d,cumulativeCashFlow:x})}return n}}function Ha(){const[t]=f.useState(()=>new gl),[s,a]=f.useState(null),[n,i]=f.useState(!1),[r,o]=f.useState(null),l=f.useCallback(async b=>{i(!0),o(null);try{const _=await t.analyzeHBU(b);return a(_),_}catch(_){const w=_ instanceof Error?_.message:"Analysis failed";throw o(w),_}finally{i(!1)}},[t]),c=f.useCallback(()=>{a(null),o(null)},[]),d=f.useCallback((b=3)=>s?s.alternatives.slice(0,b):[],[s]),x=f.useCallback(()=>!s||s.alternatives.length===0?null:s.alternatives[0],[s]),h=f.useCallback(()=>s?s.confidence>=80?"high":s.confidence>=60?"medium":"low":"low",[s]),m=f.useCallback(()=>{if(!s)return[];const b=[];return s.confidence<70&&b.push("Low confidence in analysis"),s.constraints.some(w=>w.impact==="limiting")&&b.push("Significant zoning constraints"),s.alternatives.length<2&&b.push("Limited development options"),s.marketFactors.filter(w=>w.impact==="negative").length>0&&b.push("Negative market factors present"),b},[s]),p=f.useCallback(()=>{if(!s)return[];const b=[];return s.confidence>=80&&b.push("High confidence in recommended use"),s.alternatives.length>=3&&b.push("Multiple viable development options"),s.marketFactors.filter(w=>w.impact==="positive").length>0&&b.push("Favorable market conditions"),s.recommendedUse==="mixed-use"&&b.push("Mixed-use development potential"),b},[s]),y=f.useCallback(()=>{if(!s)return null;const b=x();return b?{estimatedValue:b.estimatedValue,developmentCost:b.developmentCost,netPresentValue:b.netPresentValue,internalRateOfReturn:b.internalRateOfReturn,paybackPeriod:b.paybackPeriod,confidence:b.confidence}:null},[s,x]),v=f.useCallback(()=>{if(!s)return null;const b=s.constraints.filter(k=>k.impact==="limiting"),_=s.constraints.filter(k=>k.impact==="moderate"),w=s.constraints.filter(k=>k.impact==="minimal");return{limiting:b.length,moderate:_.length,minimal:w.length,total:s.constraints.length,constraints:s.constraints}},[s]),u=f.useCallback(()=>{if(!s)return null;const b=s.marketFactors.filter(k=>k.impact==="positive"),_=s.marketFactors.filter(k=>k.impact==="negative"),w=s.marketFactors.filter(k=>k.impact==="neutral");return{positive:b.length,negative:_.length,neutral:w.length,total:s.marketFactors.length,factors:s.marketFactors}},[s]),j=f.useMemo(()=>s!==null&&!n&&!r,[s,n,r]),g=f.useMemo(()=>s!==null&&s.confidence>=80,[s]),S=f.useMemo(()=>s!==null&&s.alternatives.length>=2,[s]);return{analysis:s,loading:n,error:r,analyzeParcel:l,clearAnalysis:c,getTopAlternatives:d,getRecommendedAlternative:x,getConfidenceLevel:h,getRiskFactors:m,getOpportunities:p,getFinancialSummary:y,getConstraintSummary:v,getMarketSummary:u,isAnalysisComplete:j,hasHighConfidence:g,hasMultipleAlternatives:S}}const fl=re.memo(function({parcel:s,onClose:a}){const{analysis:n,loading:i,error:r,analyzeParcel:o,getTopAlternatives:l,getRecommendedAlternative:c,getConfidenceLevel:d,getRiskFactors:x,getOpportunities:h,getFinancialSummary:m,getConstraintSummary:p,getMarketSummary:y}=Ha(),[v,u]=re.useState(!1);re.useEffect(()=>{s&&(console.log("Starting HBU analysis for parcel:",s),u(!0),o(s).then(P=>{console.log("HBU analysis completed:",P)}).catch(P=>{console.error("HBU analysis failed:",P)}).finally(()=>u(!1)))},[s,o]);const j=P=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(P),g=P=>`${(P*100).toFixed(1)}%`,S=P=>{switch(P){case"high":return"text-green-600 bg-green-100";case"medium":return"text-yellow-600 bg-yellow-100";case"low":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}};if(i||v)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Analyzing highest and best use..."})]})});if(r)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(lt,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("h3",{className:"text-red-800 font-medium",children:"Analysis Error"})]}),e.jsx("p",{className:"text-red-700 mt-2",children:r}),e.jsx("button",{onClick:()=>o(s),className:"mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Retry Analysis"})]})});if(!n)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ee,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"No analysis available"})]})});const b=c(),_=m(),w=p(),k=y(),$=x(),R=h(),T=d();return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ee,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Highest & Best Use Analysis"})]}),a&&e.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:"Ã—"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-blue-900",children:"Recommended Use"}),e.jsxs("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${S(T)}`,children:[T.toUpperCase()," CONFIDENCE"]})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-800 capitalize",children:n.recommendedUse.replace("-"," ")}),b&&e.jsxs("div",{className:"mt-2 text-sm text-blue-700",children:[b.use," â€¢ ",j(b.estimatedValue)," estimated value"]})]}),_&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"Financial Projections"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-700",children:"Estimated Value"}),e.jsx("div",{className:"text-lg font-semibold text-green-800",children:j(_.estimatedValue)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-700",children:"Development Cost"}),e.jsx("div",{className:"text-lg font-semibold text-green-800",children:j(_.developmentCost)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-700",children:"Net Present Value"}),e.jsx("div",{className:"text-lg font-semibold text-green-800",children:j(_.netPresentValue)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-700",children:"IRR"}),e.jsx("div",{className:"text-lg font-semibold text-green-800",children:g(_.internalRateOfReturn)})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(ve,{className:"w-5 h-5 text-purple-600"}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"Alternative Uses"})]}),e.jsx("div",{className:"space-y-3",children:l(3).map((P,I)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:P.use}),e.jsx("div",{className:"text-sm text-gray-600",children:P.density>0?`${P.density} DU/acre`:`${P.height} ft height`})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:j(P.netPresentValue)}),e.jsxs("div",{className:"text-sm text-gray-600",children:[g(P.internalRateOfReturn)," IRR"]})]})]}),P.constraints.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Constraints:"}),e.jsx("div",{className:"text-xs text-gray-600",children:P.constraints.join(", ")})]})]},I))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[w&&w.total>0&&e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Wa,{className:"w-5 h-5 text-orange-600"}),e.jsx("h3",{className:"font-semibold text-orange-900",children:"Zoning Constraints"})]}),e.jsx("div",{className:"space-y-2",children:w.constraints.map((P,I)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-orange-800",children:P.description}),e.jsxs("div",{className:"text-orange-700",children:["Impact: ",P.impact]})]},I))})]}),k&&k.total>0&&e.jsxs("div",{className:"bg-indigo-50 border border-indigo-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(ft,{className:"w-5 h-5 text-indigo-600"}),e.jsx("h3",{className:"font-semibold text-indigo-900",children:"Market Factors"})]}),e.jsx("div",{className:"space-y-2",children:k.factors.map((P,I)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-indigo-800",children:P.factor}),e.jsxs("div",{className:"text-indigo-700",children:[P.impact," â€¢ Weight: ",P.weight]})]},I))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[$.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(lt,{className:"w-5 h-5 text-red-600"}),e.jsx("h3",{className:"font-semibold text-red-900",children:"Risk Factors"})]}),e.jsx("ul",{className:"space-y-1",children:$.map((P,I)=>e.jsxs("li",{className:"text-sm text-red-700",children:["â€¢ ",P]},I))})]}),R.length>0&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(_e,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"Opportunities"})]}),e.jsx("ul",{className:"space-y-1",children:R.map((P,I)=>e.jsxs("li",{className:"text-sm text-green-700",children:["â€¢ ",P]},I))})]})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ua,{className:"w-4 h-4 text-gray-600"}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"Analysis Details"})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("div",{children:["Analysis Date: ",n.analysisDate.toLocaleDateString()]}),e.jsxs("div",{children:["Analyst: ",n.analyst]}),e.jsxs("div",{children:["Confidence Score: ",n.confidence,"%"]}),e.jsxs("div",{children:["Alternatives Analyzed: ",n.alternatives.length]})]})]})]})});class pl{constructor(s,a,n,i){vt(this,"zoningData");vt(this,"lotSize");vt(this,"lotWidth");vt(this,"lotDepth");this.zoningData=s,this.lotSize=a,this.lotWidth=n||Math.sqrt(a),this.lotDepth=i||Math.sqrt(a)}generateSitePlan(s){const a=this.extractConstraints(),n=[],i=[];this.validateBasicFeasibility(s,a,n,i);const r=this.calculateOptimalMassing(s,a),o=this.generateSitePlanVisualization(r,s),l=this.analyzeParkingRequirements(s,r),c=this.calculateFinancialImpact(r,l,s),d=this.generateRecommendations(r,l,a);return{isFeasible:n.length===0,violations:n,warnings:i,buildingMassing:r,sitePlan:o,parkingAnalysis:l,financialImpact:c,recommendations:d}}extractConstraints(){return{maxFAR:this.zoningData.max_far||0,maxHeight:this.zoningData.max_building_height_ft||0,maxCoverage:this.zoningData.max_coverage_pct||0,minFrontSetback:this.zoningData.min_front_setback_ft||0,minRearSetback:this.zoningData.min_rear_setback_ft||0,minSideSetback:this.zoningData.min_side_setback_ft||0,minLotArea:this.zoningData.min_lot_area_sq_ft||0,minLotWidth:this.zoningData.min_lot_width_ft||0,maxDensity:this.zoningData.max_density_du_per_acre||0,minLandscapedSpace:this.zoningData.min_landscaped_space_pct||0,minOpenSpace:this.zoningData.min_open_space_pct||0}}validateBasicFeasibility(s,a,n,i){if(a.minLotArea>0&&this.lotSize<a.minLotArea&&n.push(`Lot size (${this.lotSize.toLocaleString()} sq ft) is below minimum required (${a.minLotArea.toLocaleString()} sq ft)`),a.minLotWidth>0&&this.lotWidth<a.minLotWidth&&n.push(`Lot width (${this.lotWidth} ft) is below minimum required (${a.minLotWidth} ft)`),a.maxDensity>0){const r=s.targetUnits/(this.lotSize/43560);r>a.maxDensity&&n.push(`Proposed density (${r.toFixed(1)} DU/acre) exceeds maximum allowed (${a.maxDensity} DU/acre)`)}if(s.targetUnits>0){const r=this.getAverageUnitSize(s.unitMix),l=s.targetUnits*r/this.lotSize;a.maxFAR>0&&l>a.maxFAR&&n.push(`Required FAR (${l.toFixed(2)}) exceeds maximum allowed (${a.maxFAR})`)}}calculateOptimalMassing(s,a){const n=this.getAverageUnitSize(s.unitMix),i=s.targetUnits*n,r=this.lotWidth-a.minFrontSetback-a.minRearSetback,o=this.lotDepth-a.minSideSetback*2,l=r*o,c=this.lotSize*(a.maxCoverage/100),d=Math.min(l,c),x=i/d,h=a.maxHeight>0?a.maxHeight:100,m=Math.min(x,h),p=Math.floor(m/10),y=p*10,v=d*p,u=v/this.lotSize;this.lotSize*(a.minOpenSpace/100);const j=this.lotSize-d;return{footprint:d,totalGSF:v,height:y,stories:p,units:s.targetUnits,coverage:d/this.lotSize*100,far:u,buildableArea:d,openSpaceArea:j,amenitySpace:s.amenitySpace,averageUnitSize:n,constraintAnalysis:{farUtilization:a.maxFAR>0?u/a.maxFAR*100:0,heightUtilization:a.maxHeight>0?y/a.maxHeight*100:0,coverageUtilization:a.maxCoverage>0?d/c*100:0,limitingFactor:this.getLimitingFactor(a,u,y,d,c)}}}generateSitePlanVisualization(s,a){const n=[],i=[],r=[],o={id:"main-building",coordinates:this.generateBuildingCoordinates(s.footprint),height:s.height,stories:s.stories,use:a.buildingType,units:s.units,gsf:s.totalGSF};n.push(o);const l={id:"main-open-space",coordinates:this.generateOpenSpaceCoordinates(s.footprint),type:"garden",amenities:["landscaping","seating","walkways"]};i.push(l);const c=this.analyzeParkingRequirements(a,s);if(c.requiredSpaces>0){const d={id:"main-parking",coordinates:this.generateParkingCoordinates(c.requiredSpaces),type:a.parkingType,spaces:c.requiredSpaces,accessPoint:[this.lotWidth/2,this.lotDepth]};r.push(d)}return{buildings:n,openSpaces:i,parkingAreas:r,utilities:[],circulation:[]}}analyzeParkingRequirements(s,a){const n=this.getParkingRequirements(s.buildingType);let i=0;if((s.buildingType==="residential"||s.buildingType==="mixed-use")&&(i+=s.unitMix.studio*n.residential.studio,i+=s.unitMix.oneBedroom*n.residential.oneBedroom,i+=s.unitMix.twoBedroom*n.residential.twoBedroom,i+=s.unitMix.threeBedroom*n.residential.threeBedroom,i+=Math.ceil(s.targetUnits*.25)),s.buildingType==="commercial"||s.buildingType==="mixed-use"){const d=a.totalGSF*.3;i+=Math.ceil(d/1e3*3)}const r=Math.ceil(i*.02);i+=r;const o=this.getParkingCostPerSpace(s.parkingType),l=i*o,c=i/(a.totalGSF/1e3)*100;return{requiredSpaces:i,providedSpaces:i,deficit:0,surplus:0,costPerSpace:o,totalParkingCost:l,parkingEfficiency:c}}calculateFinancialImpact(s,a,n){const i=this.getHardCostPerSqFt(n.buildingType);s.totalGSF*i;const r=a.totalParkingCost+n.amenitySpace*200,o=this.getRevenuePerSqFt(n.buildingType),l=s.totalGSF*o,c=l-r,d=r/n.targetUnits,x=s.totalGSF*o/n.targetUnits;return{additionalCost:r,additionalRevenue:l,netImpact:c,costPerUnit:d,revenuePerUnit:x}}generateRecommendations(s,a,n){const i=[];return s.constraintAnalysis.farUtilization<80&&i.push(`Consider increasing building height to better utilize FAR (currently ${s.constraintAnalysis.farUtilization.toFixed(1)}%)`),s.constraintAnalysis.heightUtilization<80&&i.push(`Consider increasing building height to better utilize height allowance (currently ${s.constraintAnalysis.heightUtilization.toFixed(1)}%)`),s.constraintAnalysis.coverageUtilization<80&&i.push(`Consider increasing building footprint to better utilize coverage allowance (currently ${s.constraintAnalysis.coverageUtilization.toFixed(1)}%)`),a.parkingEfficiency>4&&i.push(`Consider reducing parking requirements or using more efficient parking solutions (currently ${a.parkingEfficiency.toFixed(1)} spaces per 1000 sq ft)`),s.openSpaceArea<this.lotSize*.15&&i.push("Consider increasing open space to improve marketability and resident satisfaction"),i}getAverageUnitSize(s){const a=s.studio+s.oneBedroom+s.twoBedroom+s.threeBedroom;return a===0?800:(s.studio*500+s.oneBedroom*700+s.twoBedroom*1e3+s.threeBedroom*1300)/a}getLimitingFactor(s,a,n,i,r){const o=s.maxFAR>0?a/s.maxFAR:1,l=s.maxHeight>0?n/s.maxHeight:1,c=s.maxCoverage>0?i/r:1;return o>=.95?"FAR":l>=.95?"Height":c>=.95?"Coverage":"None"}getParkingRequirements(s){return{residential:{studio:.5,oneBedroom:1,twoBedroom:1.5,threeBedroom:2},commercial:{office:3,retail:4,restaurant:10},visitor:.25,accessible:.02}}getParkingCostPerSpace(s){switch(s){case"surface":return 5e3;case"garage":return 25e3;case"underground":return 4e4;default:return 15e3}}getHardCostPerSqFt(s){switch(s){case"residential":return 200;case"commercial":return 250;case"mixed-use":return 225;default:return 200}}getRevenuePerSqFt(s){switch(s){case"residential":return 400;case"commercial":return 300;case"mixed-use":return 350;default:return 350}}generateBuildingCoordinates(s){const a=Math.sqrt(s);return[[0,0],[a,0],[a,a],[0,a],[0,0]]}generateOpenSpaceCoordinates(s){return[[0,0],[this.lotWidth,0],[this.lotWidth,this.lotDepth],[0,this.lotDepth],[0,0]]}generateParkingCoordinates(s){const n=Math.ceil(s/10),i=10*9,r=n*18;return[[0,0],[i,0],[i,r],[0,r],[0,0]]}}function yl(t,s){const[a,n]=f.useState({targetUnits:20,unitMix:{studio:.2,oneBedroom:.4,twoBedroom:.3,threeBedroom:.1},buildingType:"residential",parkingType:"surface",amenitySpace:2e3,openSpaceRatio:.15}),[i,r]=f.useState(null),[o,l]=f.useState(!1),[c,d]=f.useState(null),x=f.useMemo(()=>!t||!s?null:new pl(t,s),[t,s]),h=f.useCallback(async()=>{if(!x){d("Site plan engine not available");return}l(!0),d(null);try{const w=x.generateSitePlan(a);r(w)}catch(w){const k=w instanceof Error?w.message:"Site plan generation failed";d(k)}finally{l(!1)}},[x,a]),m=f.useCallback(w=>{n(k=>({...k,...w}))},[]),p=f.useCallback((w,k)=>{n($=>({...$,unitMix:{...$.unitMix,[w]:k}}))},[]),y=f.useCallback(()=>{x&&a.targetUnits>0&&h()},[x,a,h]),v=f.useCallback(()=>t?{maxFAR:t.max_far||0,maxHeight:t.max_building_height_ft||0,maxCoverage:t.max_coverage_pct||0,maxDensity:t.max_density_du_per_acre||0,minSetbacks:{front:t.min_front_setback_ft||0,rear:t.min_rear_setback_ft||0,side:t.min_side_setback_ft||0}}:null,[t]),u=f.useCallback(()=>i?i.isFeasible?i.violations.length===0&&i.warnings.length===0?"excellent":i.warnings.length<=2?"good":"acceptable":"infeasible":"unknown",[i]),j=f.useCallback(()=>{if(!i)return 0;const w=i.buildingMassing,k=w.constraintAnalysis.farUtilization,$=w.constraintAnalysis.heightUtilization,R=w.constraintAnalysis.coverageUtilization;return(k+$+R)/3},[i]),g=f.useCallback(()=>{if(!i)return null;const{financialImpact:w,buildingMassing:k}=i;return{totalCost:w.additionalCost,totalRevenue:w.additionalRevenue,netImpact:w.netImpact,costPerUnit:w.costPerUnit,revenuePerUnit:w.revenuePerUnit,costPerSqFt:w.additionalCost/k.totalGSF,revenuePerSqFt:w.additionalRevenue/k.totalGSF}},[i]),S=f.useCallback(()=>{if(!i)return null;const{parkingAnalysis:w}=i;return{requiredSpaces:w.requiredSpaces,costPerSpace:w.costPerSpace,totalCost:w.totalParkingCost,efficiency:w.parkingEfficiency,type:a.parkingType}},[i,a.parkingType]),b=f.useCallback(()=>{const w=[],k=[],$=Object.values(a.unitMix).reduce((R,T)=>R+T,0);return Math.abs($-1)>.01&&w.push("Unit mix percentages must total 100%"),a.targetUnits<=0&&w.push("Target units must be greater than 0"),a.amenitySpace<0&&w.push("Amenity space cannot be negative"),(a.openSpaceRatio<0||a.openSpaceRatio>1)&&w.push("Open space ratio must be between 0% and 100%"),{errors:w,warnings:k}},[a]),_=f.useCallback(()=>{if(!t||!s)return[];const w=[];return t.max_density_du_per_acre&&t.max_density_du_per_acre>20&&w.push({name:"High-Density Residential",description:"Maximize density with efficient unit mix",configuration:{targetUnits:Math.floor(s/43560*t.max_density_du_per_acre*.9),unitMix:{studio:.3,oneBedroom:.5,twoBedroom:.2,threeBedroom:0},buildingType:"residential",parkingType:"garage",amenitySpace:3e3,openSpaceRatio:.2}}),(t.zoning_type==="Mixed-Use"||t.zoning_type==="Commercial")&&w.push({name:"Mixed-Use Development",description:"Combine residential and commercial uses",configuration:{targetUnits:Math.floor(s/43560*15),unitMix:{studio:.2,oneBedroom:.4,twoBedroom:.3,threeBedroom:.1},buildingType:"mixed-use",parkingType:"garage",amenitySpace:4e3,openSpaceRatio:.15}}),w.push({name:"Luxury Residential",description:"Premium units with extensive amenities",configuration:{targetUnits:Math.floor(s/43560*8),unitMix:{studio:.1,oneBedroom:.3,twoBedroom:.4,threeBedroom:.2},buildingType:"residential",parkingType:"underground",amenitySpace:5e3,openSpaceRatio:.25}}),w},[t,s]);return{configuration:a,sitePlanResult:i,loading:o,error:c,generateSitePlan:h,updateConfiguration:m,updateUnitMix:p,autoGenerate:y,getConstraintSummary:v,getFeasibilityStatus:u,getOptimizationScore:j,getFinancialSummary:g,getParkingSummary:S,validateConfiguration:b,getRecommendedConfigurations:_,isEngineAvailable:!!x,hasSitePlan:!!i,isFeasible:i?.isFeasible||!1}}let Mn=class extends f.Component{constructor(a){super(a);vt(this,"handleRetry",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});vt(this,"handleGoHome",()=>{window.location.href="/"});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a,errorInfo:null}}componentDidCatch(a,n){console.error("ErrorBoundary caught an error:",a,n),this.setState({error:a,errorInfo:n}),this.props.onError?.(a,n)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsx("div",{className:"max-w-md w-full bg-white rounded-lg shadow-lg p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4",children:e.jsx(lt,{className:"h-6 w-6 text-red-600"})}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Something went wrong"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"We encountered an unexpected error. Don't worry, your data is safe."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:this.handleRetry,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Xa,{className:"w-4 h-4 mr-2"}),"Try Again"]}),e.jsxs("button",{onClick:this.handleGoHome,className:"w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(un,{className:"w-4 h-4 mr-2"}),"Go Home"]})]}),!1]})})}):this.props.children}};function Cn({children:t}){return e.jsx(Mn,{fallback:e.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:e.jsxs("div",{className:"text-center",children:[e.jsx(lt,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Site Planner Error"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The site planner encountered an error. Please try refreshing the page."}),e.jsxs("button",{onClick:()=>window.location.reload(),className:"mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200",children:[e.jsx(Xa,{className:"w-4 h-4 mr-1"}),"Refresh"]})]})}),children:t})}function bl(t){t("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),t("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),t("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs");for(var s=1;s<=60;++s)t("EPSG:"+(32600+s),"+proj=utm +zone="+s+" +datum=WGS84 +units=m"),t("EPSG:"+(32700+s),"+proj=utm +zone="+s+" +south +datum=WGS84 +units=m");t.WGS84=t["EPSG:4326"],t["EPSG:3785"]=t["EPSG:3857"],t.GOOGLE=t["EPSG:3857"],t["EPSG:900913"]=t["EPSG:3857"],t["EPSG:102113"]=t["EPSG:3857"]}var Lt=1,Bt=2,os=3,vl=4,Ga=5,Fi=6378137,jl=6356752314e-3,Ii=.0066943799901413165,Ns=484813681109536e-20,L=Math.PI/2,Nl=.16666666666666666,wl=.04722222222222222,_l=.022156084656084655,H=1e-10,Be=.017453292519943295,yt=57.29577951308232,Ne=Math.PI/4,Ps=Math.PI*2,ze=3.14159265359,it={};it.greenwich=0;it.lisbon=-9.131906111111;it.paris=2.337229166667;it.bogota=-74.080916666667;it.madrid=-3.687938888889;it.rome=12.452333333333;it.bern=7.439583333333;it.jakarta=106.807719444444;it.ferro=-17.666666666667;it.brussels=4.367975;it.stockholm=18.058277777778;it.athens=23.7163375;it.oslo=10.722916666667;const Sl={mm:{to_meter:.001},cm:{to_meter:.01},ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937},fath:{to_meter:1.8288},kmi:{to_meter:1852},"us-ch":{to_meter:20.1168402336805},"us-mi":{to_meter:1609.34721869444},km:{to_meter:1e3},"ind-ft":{to_meter:.30479841},"ind-yd":{to_meter:.91439523},mi:{to_meter:1609.344},yd:{to_meter:.9144},ch:{to_meter:20.1168},link:{to_meter:.201168},dm:{to_meter:.1},in:{to_meter:.0254},"ind-ch":{to_meter:20.11669506},"us-in":{to_meter:.025400050800101},"us-yd":{to_meter:.914401828803658}};var Gi=/[\s_\-\/\(\)]/g;function Gt(t,s){if(t[s])return t[s];for(var a=Object.keys(t),n=s.toLowerCase().replace(Gi,""),i=-1,r,o;++i<a.length;)if(r=a[i],o=r.toLowerCase().replace(Gi,""),o===n)return t[r]}function za(t){var s={},a=t.split("+").map(function(l){return l.trim()}).filter(function(l){return l}).reduce(function(l,c){var d=c.split("=");return d.push(!0),l[d[0].toLowerCase()]=d[1],l},{}),n,i,r,o={proj:"projName",datum:"datumCode",rf:function(l){s.rf=parseFloat(l)},lat_0:function(l){s.lat0=l*Be},lat_1:function(l){s.lat1=l*Be},lat_2:function(l){s.lat2=l*Be},lat_ts:function(l){s.lat_ts=l*Be},lon_0:function(l){s.long0=l*Be},lon_1:function(l){s.long1=l*Be},lon_2:function(l){s.long2=l*Be},alpha:function(l){s.alpha=parseFloat(l)*Be},gamma:function(l){s.rectified_grid_angle=parseFloat(l)*Be},lonc:function(l){s.longc=l*Be},x_0:function(l){s.x0=parseFloat(l)},y_0:function(l){s.y0=parseFloat(l)},k_0:function(l){s.k0=parseFloat(l)},k:function(l){s.k0=parseFloat(l)},a:function(l){s.a=parseFloat(l)},b:function(l){s.b=parseFloat(l)},r:function(l){s.a=s.b=parseFloat(l)},r_a:function(){s.R_A=!0},zone:function(l){s.zone=parseInt(l,10)},south:function(){s.utmSouth=!0},towgs84:function(l){s.datum_params=l.split(",").map(function(c){return parseFloat(c)})},to_meter:function(l){s.to_meter=parseFloat(l)},units:function(l){s.units=l;var c=Gt(Sl,l);c&&(s.to_meter=c.to_meter)},from_greenwich:function(l){s.from_greenwich=l*Be},pm:function(l){var c=Gt(it,l);s.from_greenwich=(c||parseFloat(l))*Be},nadgrids:function(l){l==="@null"?s.datumCode="none":s.nadgrids=l},axis:function(l){var c="ewnsud";l.length===3&&c.indexOf(l.substr(0,1))!==-1&&c.indexOf(l.substr(1,1))!==-1&&c.indexOf(l.substr(2,1))!==-1&&(s.axis=l)},approx:function(){s.approx=!0}};for(n in a)i=a[n],n in o?(r=o[n],typeof r=="function"?r(i):s[r]=i):s[n]=i;return typeof s.datumCode=="string"&&s.datumCode!=="WGS84"&&(s.datumCode=s.datumCode.toLowerCase()),s}class Pn{static getId(s){const a=s.find(n=>Array.isArray(n)&&n[0]==="ID");return a&&a.length>=3?{authority:a[1],code:parseInt(a[2],10)}:null}static convertUnit(s,a="unit"){if(!s||s.length<3)return{type:a,name:"unknown",conversion_factor:null};const n=s[1],i=parseFloat(s[2])||null,r=s.find(l=>Array.isArray(l)&&l[0]==="ID"),o=r?{authority:r[1],code:parseInt(r[2],10)}:null;return{type:a,name:n,conversion_factor:i,id:o}}static convertAxis(s){const a=s[1]||"Unknown";let n;const i=a.match(/^\((.)\)$/);if(i){const d=i[1].toUpperCase();if(d==="E")n="east";else if(d==="N")n="north";else if(d==="U")n="up";else throw new Error(`Unknown axis abbreviation: ${d}`)}else n=s[2]?s[2].toLowerCase():"unknown";const r=s.find(d=>Array.isArray(d)&&d[0]==="ORDER"),o=r?parseInt(r[1],10):null,l=s.find(d=>Array.isArray(d)&&(d[0]==="LENGTHUNIT"||d[0]==="ANGLEUNIT"||d[0]==="SCALEUNIT")),c=this.convertUnit(l);return{name:a,direction:n,unit:c,order:o}}static extractAxes(s){return s.filter(a=>Array.isArray(a)&&a[0]==="AXIS").map(a=>this.convertAxis(a)).sort((a,n)=>(a.order||0)-(n.order||0))}static convert(s,a={}){switch(s[0]){case"PROJCRS":a.type="ProjectedCRS",a.name=s[1],a.base_crs=s.find(m=>Array.isArray(m)&&m[0]==="BASEGEOGCRS")?this.convert(s.find(m=>Array.isArray(m)&&m[0]==="BASEGEOGCRS")):null,a.conversion=s.find(m=>Array.isArray(m)&&m[0]==="CONVERSION")?this.convert(s.find(m=>Array.isArray(m)&&m[0]==="CONVERSION")):null;const n=s.find(m=>Array.isArray(m)&&m[0]==="CS");n&&(a.coordinate_system={type:n[1],axis:this.extractAxes(s)});const i=s.find(m=>Array.isArray(m)&&m[0]==="LENGTHUNIT");if(i){const m=this.convertUnit(i);a.coordinate_system.unit=m}a.id=this.getId(s);break;case"BASEGEOGCRS":case"GEOGCRS":a.type="GeographicCRS",a.name=s[1];const r=s.find(m=>Array.isArray(m)&&(m[0]==="DATUM"||m[0]==="ENSEMBLE"));if(r){const m=this.convert(r);r[0]==="ENSEMBLE"?a.datum_ensemble=m:a.datum=m;const p=s.find(y=>Array.isArray(y)&&y[0]==="PRIMEM");p&&p[1]!=="Greenwich"&&(m.prime_meridian={name:p[1],longitude:parseFloat(p[2])})}a.coordinate_system={type:"ellipsoidal",axis:this.extractAxes(s)},a.id=this.getId(s);break;case"DATUM":a.type="GeodeticReferenceFrame",a.name=s[1],a.ellipsoid=s.find(m=>Array.isArray(m)&&m[0]==="ELLIPSOID")?this.convert(s.find(m=>Array.isArray(m)&&m[0]==="ELLIPSOID")):null;break;case"ENSEMBLE":a.type="DatumEnsemble",a.name=s[1],a.members=s.filter(m=>Array.isArray(m)&&m[0]==="MEMBER").map(m=>({type:"DatumEnsembleMember",name:m[1],id:this.getId(m)}));const o=s.find(m=>Array.isArray(m)&&m[0]==="ENSEMBLEACCURACY");o&&(a.accuracy=parseFloat(o[1]));const l=s.find(m=>Array.isArray(m)&&m[0]==="ELLIPSOID");l&&(a.ellipsoid=this.convert(l)),a.id=this.getId(s);break;case"ELLIPSOID":a.type="Ellipsoid",a.name=s[1],a.semi_major_axis=parseFloat(s[2]),a.inverse_flattening=parseFloat(s[3]),s.find(m=>Array.isArray(m)&&m[0]==="LENGTHUNIT")&&this.convert(s.find(m=>Array.isArray(m)&&m[0]==="LENGTHUNIT"),a);break;case"CONVERSION":a.type="Conversion",a.name=s[1],a.method=s.find(m=>Array.isArray(m)&&m[0]==="METHOD")?this.convert(s.find(m=>Array.isArray(m)&&m[0]==="METHOD")):null,a.parameters=s.filter(m=>Array.isArray(m)&&m[0]==="PARAMETER").map(m=>this.convert(m));break;case"METHOD":a.type="Method",a.name=s[1],a.id=this.getId(s);break;case"PARAMETER":a.type="Parameter",a.name=s[1],a.value=parseFloat(s[2]),a.unit=this.convertUnit(s.find(m=>Array.isArray(m)&&(m[0]==="LENGTHUNIT"||m[0]==="ANGLEUNIT"||m[0]==="SCALEUNIT"))),a.id=this.getId(s);break;case"BOUNDCRS":a.type="BoundCRS";const c=s.find(m=>Array.isArray(m)&&m[0]==="SOURCECRS");if(c){const m=c.find(p=>Array.isArray(p));a.source_crs=m?this.convert(m):null}const d=s.find(m=>Array.isArray(m)&&m[0]==="TARGETCRS");if(d){const m=d.find(p=>Array.isArray(p));a.target_crs=m?this.convert(m):null}const x=s.find(m=>Array.isArray(m)&&m[0]==="ABRIDGEDTRANSFORMATION");x?a.transformation=this.convert(x):a.transformation=null;break;case"ABRIDGEDTRANSFORMATION":if(a.type="Transformation",a.name=s[1],a.method=s.find(m=>Array.isArray(m)&&m[0]==="METHOD")?this.convert(s.find(m=>Array.isArray(m)&&m[0]==="METHOD")):null,a.parameters=s.filter(m=>Array.isArray(m)&&(m[0]==="PARAMETER"||m[0]==="PARAMETERFILE")).map(m=>{if(m[0]==="PARAMETER")return this.convert(m);if(m[0]==="PARAMETERFILE")return{name:m[1],value:m[2],id:{authority:"EPSG",code:8656}}}),a.parameters.length===7){const m=a.parameters[6];m.name==="Scale difference"&&(m.value=Math.round((m.value-1)*1e12)/1e6)}a.id=this.getId(s);break;case"AXIS":a.coordinate_system||(a.coordinate_system={type:"unspecified",axis:[]}),a.coordinate_system.axis.push(this.convertAxis(s));break;case"LENGTHUNIT":const h=this.convertUnit(s,"LinearUnit");a.coordinate_system&&a.coordinate_system.axis&&a.coordinate_system.axis.forEach(m=>{m.unit||(m.unit=h)}),h.conversion_factor&&h.conversion_factor!==1&&a.semi_major_axis&&(a.semi_major_axis={value:a.semi_major_axis,unit:h});break;default:a.keyword=s[0];break}return a}}class Ml extends Pn{static convert(s,a={}){return super.convert(s,a),a.coordinate_system&&a.coordinate_system.subtype==="Cartesian"&&delete a.coordinate_system,a.usage&&delete a.usage,a}}class Cl extends Pn{static convert(s,a={}){super.convert(s,a);const n=s.find(r=>Array.isArray(r)&&r[0]==="CS");n&&(a.coordinate_system={subtype:n[1],axis:this.extractAxes(s)});const i=s.find(r=>Array.isArray(r)&&r[0]==="USAGE");if(i){const r=i.find(c=>Array.isArray(c)&&c[0]==="SCOPE"),o=i.find(c=>Array.isArray(c)&&c[0]==="AREA"),l=i.find(c=>Array.isArray(c)&&c[0]==="BBOX");a.usage={},r&&(a.usage.scope=r[1]),o&&(a.usage.area=o[1]),l&&(a.usage.bbox=l.slice(1))}return a}}function Pl(t){return t.find(s=>Array.isArray(s)&&s[0]==="USAGE")?"2019":(t.find(s=>Array.isArray(s)&&s[0]==="CS")||t[0]==="BOUNDCRS"||t[0]==="PROJCRS"||t[0]==="GEOGCRS","2015")}function kl(t){return(Pl(t)==="2019"?Cl:Ml).convert(t)}function Al(t){const s=t.toUpperCase();return s.includes("PROJCRS")||s.includes("GEOGCRS")||s.includes("BOUNDCRS")||s.includes("VERTCRS")||s.includes("LENGTHUNIT")||s.includes("ANGLEUNIT")||s.includes("SCALEUNIT")?"WKT2":(s.includes("PROJCS")||s.includes("GEOGCS")||s.includes("LOCAL_CS")||s.includes("VERT_CS")||s.includes("UNIT"),"WKT1")}var ks=1,kn=2,An=3,oa=4,En=5,Ja=-1,El=/\s/,Rl=/[A-Za-z]/,Fl=/[A-Za-z84_]/,pa=/[,\]]/,Rn=/[\d\.E\-\+]/;function wt(t){if(typeof t!="string")throw new Error("not a string");this.text=t.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=ks}wt.prototype.readCharicter=function(){var t=this.text[this.place++];if(this.state!==oa)for(;El.test(t);){if(this.place>=this.text.length)return;t=this.text[this.place++]}switch(this.state){case ks:return this.neutral(t);case kn:return this.keyword(t);case oa:return this.quoted(t);case En:return this.afterquote(t);case An:return this.number(t);case Ja:return}};wt.prototype.afterquote=function(t){if(t==='"'){this.word+='"',this.state=oa;return}if(pa.test(t)){this.word=this.word.trim(),this.afterItem(t);return}throw new Error(`havn't handled "`+t+'" in afterquote yet, index '+this.place)};wt.prototype.afterItem=function(t){if(t===","){this.word!==null&&this.currentObject.push(this.word),this.word=null,this.state=ks;return}if(t==="]"){this.level--,this.word!==null&&(this.currentObject.push(this.word),this.word=null),this.state=ks,this.currentObject=this.stack.pop(),this.currentObject||(this.state=Ja);return}};wt.prototype.number=function(t){if(Rn.test(t)){this.word+=t;return}if(pa.test(t)){this.word=parseFloat(this.word),this.afterItem(t);return}throw new Error(`havn't handled "`+t+'" in number yet, index '+this.place)};wt.prototype.quoted=function(t){if(t==='"'){this.state=En;return}this.word+=t};wt.prototype.keyword=function(t){if(Fl.test(t)){this.word+=t;return}if(t==="["){var s=[];s.push(this.word),this.level++,this.root===null?this.root=s:this.currentObject.push(s),this.stack.push(this.currentObject),this.currentObject=s,this.state=ks;return}if(pa.test(t)){this.afterItem(t);return}throw new Error(`havn't handled "`+t+'" in keyword yet, index '+this.place)};wt.prototype.neutral=function(t){if(Rl.test(t)){this.word=t,this.state=kn;return}if(t==='"'){this.word="",this.state=oa;return}if(Rn.test(t)){this.word=t,this.state=An;return}if(pa.test(t)){this.afterItem(t);return}throw new Error(`havn't handled "`+t+'" in neutral yet, index '+this.place)};wt.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(this.state===Ja)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function Il(t){var s=new wt(t);return s.output()}function Pa(t,s,a){Array.isArray(s)&&(a.unshift(s),s=null);var n=s?{}:t,i=a.reduce(function(r,o){return ss(o,r),r},n);s&&(t[s]=i)}function ss(t,s){if(!Array.isArray(t)){s[t]=!0;return}var a=t.shift();if(a==="PARAMETER"&&(a=t.shift()),t.length===1){if(Array.isArray(t[0])){s[a]={},ss(t[0],s[a]);return}s[a]=t[0];return}if(!t.length){s[a]=!0;return}if(a==="TOWGS84"){s[a]=t;return}if(a==="AXIS"){a in s||(s[a]=[]),s[a].push(t);return}Array.isArray(a)||(s[a]={});var n;switch(a){case"UNIT":case"PRIMEM":case"VERT_DATUM":s[a]={name:t[0].toLowerCase(),convert:t[1]},t.length===3&&ss(t[2],s[a]);return;case"SPHEROID":case"ELLIPSOID":s[a]={name:t[0],a:t[1],rf:t[2]},t.length===4&&ss(t[3],s[a]);return;case"EDATUM":case"ENGINEERINGDATUM":case"LOCAL_DATUM":case"DATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":t[0]=["name",t[0]],Pa(s,a,t);return;case"COMPD_CS":case"COMPOUNDCRS":case"FITTED_CS":case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"ENGCRS":case"ENGINEERINGCRS":t[0]=["name",t[0]],Pa(s,a,t),s[a].type=a;return;default:for(n=-1;++n<t.length;)if(!Array.isArray(t[n]))return ss(t,s[a]);return Pa(s,a,t)}}var Gl=.017453292519943295;function xt(t){return t*Gl}function Fn(t){const s=(t.projName||"").toLowerCase().replace(/_/g," ");!t.long0&&t.longc&&(s==="albers conic equal area"||s==="lambert azimuthal equal area")&&(t.long0=t.longc),!t.lat_ts&&t.lat1&&(s==="stereographic south pole"||s==="polar stereographic (variant b)")?(t.lat0=xt(t.lat1>0?90:-90),t.lat_ts=t.lat1,delete t.lat1):!t.lat_ts&&t.lat0&&(s==="polar stereographic"||s==="polar stereographic (variant a)")&&(t.lat_ts=t.lat0,t.lat0=xt(t.lat0>0?90:-90),delete t.lat1)}function zi(t){let s={units:null,to_meter:void 0};return typeof t=="string"?(s.units=t.toLowerCase(),s.units==="metre"&&(s.units="meter"),s.units==="meter"&&(s.to_meter=1)):t&&t.name&&(s.units=t.name.toLowerCase(),s.units==="metre"&&(s.units="meter"),s.to_meter=t.conversion_factor),s}function Oi(t){return typeof t=="object"?t.value*t.unit.conversion_factor:t}function $i(t,s){t.ellipsoid.radius?(s.a=t.ellipsoid.radius,s.rf=0):(s.a=Oi(t.ellipsoid.semi_major_axis),t.ellipsoid.inverse_flattening!==void 0?s.rf=t.ellipsoid.inverse_flattening:t.ellipsoid.semi_major_axis!==void 0&&t.ellipsoid.semi_minor_axis!==void 0&&(s.rf=s.a/(s.a-Oi(t.ellipsoid.semi_minor_axis))))}function ca(t,s={}){return!t||typeof t!="object"?t:t.type==="BoundCRS"?(ca(t.source_crs,s),t.transformation&&(t.transformation.method&&t.transformation.method.name==="NTv2"?s.nadgrids=t.transformation.parameters[0].value:s.datum_params=t.transformation.parameters.map(a=>a.value)),s):(Object.keys(t).forEach(a=>{const n=t[a];if(n!==null)switch(a){case"name":if(s.srsCode)break;s.name=n,s.srsCode=n;break;case"type":n==="GeographicCRS"?s.projName="longlat":n==="ProjectedCRS"&&t.conversion&&t.conversion.method&&(s.projName=t.conversion.method.name);break;case"datum":case"datum_ensemble":n.ellipsoid&&(s.ellps=n.ellipsoid.name,$i(n,s)),n.prime_meridian&&(s.from_greenwich=n.prime_meridian.longitude*Math.PI/180);break;case"ellipsoid":s.ellps=n.name,$i(n,s);break;case"prime_meridian":s.long0=(n.longitude||0)*Math.PI/180;break;case"coordinate_system":if(n.axis){if(s.axis=n.axis.map(i=>{const r=i.direction;if(r==="east")return"e";if(r==="north")return"n";if(r==="west")return"w";if(r==="south")return"s";throw new Error(`Unknown axis direction: ${r}`)}).join("")+"u",n.unit){const{units:i,to_meter:r}=zi(n.unit);s.units=i,s.to_meter=r}else if(n.axis[0]&&n.axis[0].unit){const{units:i,to_meter:r}=zi(n.axis[0].unit);s.units=i,s.to_meter=r}}break;case"id":n.authority&&n.code&&(s.title=n.authority+":"+n.code);break;case"conversion":n.method&&n.method.name&&(s.projName=n.method.name),n.parameters&&n.parameters.forEach(i=>{const r=i.name.toLowerCase().replace(/\s+/g,"_"),o=i.value;i.unit&&i.unit.conversion_factor?s[r]=o*i.unit.conversion_factor:i.unit==="degree"?s[r]=o*Math.PI/180:s[r]=o});break;case"unit":n.name&&(s.units=n.name.toLowerCase(),s.units==="metre"&&(s.units="meter")),n.conversion_factor&&(s.to_meter=n.conversion_factor);break;case"base_crs":ca(n,s),s.datumCode=n.id?n.id.authority+"_"+n.id.code:n.name;break}}),s.latitude_of_false_origin!==void 0&&(s.lat0=s.latitude_of_false_origin),s.longitude_of_false_origin!==void 0&&(s.long0=s.longitude_of_false_origin),s.latitude_of_standard_parallel!==void 0&&(s.lat0=s.latitude_of_standard_parallel,s.lat1=s.latitude_of_standard_parallel),s.latitude_of_1st_standard_parallel!==void 0&&(s.lat1=s.latitude_of_1st_standard_parallel),s.latitude_of_2nd_standard_parallel!==void 0&&(s.lat2=s.latitude_of_2nd_standard_parallel),s.latitude_of_projection_centre!==void 0&&(s.lat0=s.latitude_of_projection_centre),s.longitude_of_projection_centre!==void 0&&(s.longc=s.longitude_of_projection_centre),s.easting_at_false_origin!==void 0&&(s.x0=s.easting_at_false_origin),s.northing_at_false_origin!==void 0&&(s.y0=s.northing_at_false_origin),s.latitude_of_natural_origin!==void 0&&(s.lat0=s.latitude_of_natural_origin),s.longitude_of_natural_origin!==void 0&&(s.long0=s.longitude_of_natural_origin),s.longitude_of_origin!==void 0&&(s.long0=s.longitude_of_origin),s.false_easting!==void 0&&(s.x0=s.false_easting),s.easting_at_projection_centre&&(s.x0=s.easting_at_projection_centre),s.false_northing!==void 0&&(s.y0=s.false_northing),s.northing_at_projection_centre&&(s.y0=s.northing_at_projection_centre),s.standard_parallel_1!==void 0&&(s.lat1=s.standard_parallel_1),s.standard_parallel_2!==void 0&&(s.lat2=s.standard_parallel_2),s.scale_factor_at_natural_origin!==void 0&&(s.k0=s.scale_factor_at_natural_origin),s.scale_factor_at_projection_centre!==void 0&&(s.k0=s.scale_factor_at_projection_centre),s.scale_factor_on_pseudo_standard_parallel!==void 0&&(s.k0=s.scale_factor_on_pseudo_standard_parallel),s.azimuth!==void 0&&(s.alpha=s.azimuth),s.azimuth_at_projection_centre!==void 0&&(s.alpha=s.azimuth_at_projection_centre),s.angle_from_rectified_to_skew_grid&&(s.rectified_grid_angle=s.angle_from_rectified_to_skew_grid),Fn(s),s)}var zl=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];function Ol(t,s){var a=s[0],n=s[1];!(a in t)&&n in t&&(t[a]=t[n],s.length===3&&(t[a]=s[2](t[a])))}function In(t){for(var s=Object.keys(t),a=0,n=s.length;a<n;++a){var i=s[a];zl.indexOf(i)!==-1&&$l(t[i]),typeof t[i]=="object"&&In(t[i])}}function $l(t){if(t.AUTHORITY){var s=Object.keys(t.AUTHORITY)[0];s&&s in t.AUTHORITY&&(t.title=s+":"+t.AUTHORITY[s])}if(t.type==="GEOGCS"?t.projName="longlat":t.type==="LOCAL_CS"?(t.projName="identity",t.local=!0):typeof t.PROJECTION=="object"?t.projName=Object.keys(t.PROJECTION)[0]:t.projName=t.PROJECTION,t.AXIS){for(var a="",n=0,i=t.AXIS.length;n<i;++n){var r=[t.AXIS[n][0].toLowerCase(),t.AXIS[n][1].toLowerCase()];r[0].indexOf("north")!==-1||(r[0]==="y"||r[0]==="lat")&&r[1]==="north"?a+="n":r[0].indexOf("south")!==-1||(r[0]==="y"||r[0]==="lat")&&r[1]==="south"?a+="s":r[0].indexOf("east")!==-1||(r[0]==="x"||r[0]==="lon")&&r[1]==="east"?a+="e":(r[0].indexOf("west")!==-1||(r[0]==="x"||r[0]==="lon")&&r[1]==="west")&&(a+="w")}a.length===2&&(a+="u"),a.length===3&&(t.axis=a)}t.UNIT&&(t.units=t.UNIT.name.toLowerCase(),t.units==="metre"&&(t.units="meter"),t.UNIT.convert&&(t.type==="GEOGCS"?t.DATUM&&t.DATUM.SPHEROID&&(t.to_meter=t.UNIT.convert*t.DATUM.SPHEROID.a):t.to_meter=t.UNIT.convert));var o=t.GEOGCS;t.type==="GEOGCS"&&(o=t),o&&(o.DATUM?t.datumCode=o.DATUM.name.toLowerCase():t.datumCode=o.name.toLowerCase(),t.datumCode.slice(0,2)==="d_"&&(t.datumCode=t.datumCode.slice(2)),t.datumCode==="new_zealand_1949"&&(t.datumCode="nzgd49"),(t.datumCode==="wgs_1984"||t.datumCode==="world_geodetic_system_1984")&&(t.PROJECTION==="Mercator_Auxiliary_Sphere"&&(t.sphere=!0),t.datumCode="wgs84"),t.datumCode==="belge_1972"&&(t.datumCode="rnb72"),o.DATUM&&o.DATUM.SPHEROID&&(t.ellps=o.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),t.ellps.toLowerCase().slice(0,13)==="international"&&(t.ellps="intl"),t.a=o.DATUM.SPHEROID.a,t.rf=parseFloat(o.DATUM.SPHEROID.rf,10)),o.DATUM&&o.DATUM.TOWGS84&&(t.datum_params=o.DATUM.TOWGS84),~t.datumCode.indexOf("osgb_1936")&&(t.datumCode="osgb36"),~t.datumCode.indexOf("osni_1952")&&(t.datumCode="osni52"),(~t.datumCode.indexOf("tm65")||~t.datumCode.indexOf("geodetic_datum_of_1965"))&&(t.datumCode="ire65"),t.datumCode==="ch1903+"&&(t.datumCode="ch1903"),~t.datumCode.indexOf("israel")&&(t.datumCode="isr93")),t.b&&!isFinite(t.b)&&(t.b=t.a),t.rectified_grid_angle&&(t.rectified_grid_angle=xt(t.rectified_grid_angle));function l(x){var h=t.to_meter||1;return x*h}var c=function(x){return Ol(t,x)},d=[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",xt],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",xt],["x0","false_easting",l],["y0","false_northing",l],["long0","central_meridian",xt],["lat0","latitude_of_origin",xt],["lat0","standard_parallel_1",xt],["lat1","standard_parallel_1",xt],["lat2","standard_parallel_2",xt],["azimuth","Azimuth"],["alpha","azimuth",xt],["srsCode","name"]];d.forEach(c),Fn(t)}function Oa(t){if(typeof t=="object")return ca(t);const s=Al(t);var a=Il(t);if(s==="WKT2"){const r=kl(a);return ca(r)}var n=a[0],i={};return ss(a,i),In(i),i[n]}function Je(t){var s=this;if(arguments.length===2){var a=arguments[1];typeof a=="string"?a.charAt(0)==="+"?Je[t]=za(arguments[1]):Je[t]=Oa(arguments[1]):Je[t]=a}else if(arguments.length===1){if(Array.isArray(t))return t.map(function(n){return Array.isArray(n)?Je.apply(s,n):Je(n)});if(typeof t=="string"){if(t in Je)return Je[t]}else"EPSG"in t?Je["EPSG:"+t.EPSG]=t:"ESRI"in t?Je["ESRI:"+t.ESRI]=t:"IAU2000"in t?Je["IAU2000:"+t.IAU2000]=t:console.log(t);return}}bl(Je);function Tl(t){return typeof t=="string"}function Dl(t){return t in Je}function ql(t){return t.indexOf("+")!==0&&t.indexOf("[")!==-1||typeof t=="object"&&!("srsCode"in t)}var Ul=["3857","900913","3785","102113"];function Ll(t){var s=Gt(t,"authority");if(s){var a=Gt(s,"epsg");return a&&Ul.indexOf(a)>-1}}function Bl(t){var s=Gt(t,"extension");if(s)return Gt(s,"proj4")}function Yl(t){return t[0]==="+"}function Xl(t){if(Tl(t)){if(Dl(t))return Je[t];if(ql(t)){var s=Oa(t);if(Ll(s))return Je["EPSG:3857"];var a=Bl(s);return a?za(a):s}if(Yl(t))return za(t)}else return"projName"in t?t:Oa(t)}function Ti(t,s){t=t||{};var a,n;if(!s)return t;for(n in s)a=s[n],a!==void 0&&(t[n]=a);return t}function bt(t,s,a){var n=t*s;return a/Math.sqrt(1-n*n)}function Fs(t){return t<0?-1:1}function K(t){return Math.abs(t)<=ze?t:t-Fs(t)*Ps}function ut(t,s,a){var n=t*a,i=.5*t;return n=Math.pow((1-n)/(1+n),i),Math.tan(.5*(L-s))/n}function As(t,s){for(var a=.5*t,n,i,r=L-2*Math.atan(s),o=0;o<=15;o++)if(n=t*Math.sin(r),i=L-2*Math.atan(s*Math.pow((1-n)/(1+n),a))-r,r+=i,Math.abs(i)<=1e-10)return r;return-9999}function Wl(){var t=this.b/this.a;this.es=1-t*t,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=bt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)}function Vl(t){var s=t.x,a=t.y;if(a*yt>90&&a*yt<-90&&s*yt>180&&s*yt<-180)return null;var n,i;if(Math.abs(Math.abs(a)-L)<=H)return null;if(this.sphere)n=this.x0+this.a*this.k0*K(s-this.long0),i=this.y0+this.a*this.k0*Math.log(Math.tan(Ne+.5*a));else{var r=Math.sin(a),o=ut(this.e,a,r);n=this.x0+this.a*this.k0*K(s-this.long0),i=this.y0-this.a*this.k0*Math.log(o)}return t.x=n,t.y=i,t}function Hl(t){var s=t.x-this.x0,a=t.y-this.y0,n,i;if(this.sphere)i=L-2*Math.atan(Math.exp(-a/(this.a*this.k0)));else{var r=Math.exp(-a/(this.a*this.k0));if(i=As(this.e,r),i===-9999)return null}return n=K(this.long0+s/(this.a*this.k0)),t.x=n,t.y=i,t}var Jl=["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","Mercator_Variant_A","merc"];const Zl={init:Wl,forward:Vl,inverse:Hl,names:Jl};function Kl(){}function Di(t){return t}var Ql=["longlat","identity"];const eo={init:Kl,forward:Di,inverse:Di,names:Ql};var to=[Zl,eo],qt={},as=[];function Gn(t,s){var a=as.length;return t.names?(as[a]=t,t.names.forEach(function(n){qt[n.toLowerCase()]=a}),this):(console.log(s),!0)}function zn(t){return t.replace(/[-\(\)\s]+/g," ").trim().replace(/ /g,"_")}function so(t){if(!t)return!1;var s=t.toLowerCase();if(typeof qt[s]<"u"&&as[qt[s]]||(s=zn(s),s in qt&&as[qt[s]]))return as[qt[s]]}function ao(){to.forEach(Gn)}const io={start:ao,add:Gn,get:so};var On={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563396e-3,b:635625691e-2,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340189e-3,b:6356034446e-3,ellipseName:"Modified Airy"},andrae:{a:637710443e-2,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397155e-3,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483865e-3,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:63782064e-1,b:63565838e-1,ellipseName:"Clarke 1866"},clrk80:{a:6378249145e-3,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk80ign:{a:63782492e-1,b:6356515,rf:293.4660213,ellipseName:"Clarke 1880 (IGN)"},clrk58:{a:6378293645208759e-9,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:63757387e-1,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:637813605e-2,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276345e-3,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304063e-3,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301243e-3,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295664e-3,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298556e-3,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:63781575e-1,b:63567722e-1,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:63567733205e-4,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:63558348467e-4,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"},WGS84:{a:6378137,rf:298.257223563,ellipseName:"WGS 84"},sphere:{a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"}};const no=On.WGS84;function ro(t,s,a,n){var i=t*t,r=s*s,o=(i-r)/i,l=0;n?(t*=1-o*(Nl+o*(wl+o*_l)),i=t*t,o=0):l=Math.sqrt(o);var c=(i-r)/r;return{es:o,e:l,ep2:c}}function lo(t,s,a,n,i){if(!t){var r=Gt(On,n);r||(r=no),t=r.a,s=r.b,a=r.rf}return a&&!s&&(s=(1-1/a)*t),(a===0||Math.abs(t-s)<H)&&(i=!0,s=t),{a:t,b:s,rf:a,sphere:i}}var ea={wgs84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},ch1903:{towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},ggrs87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},nad83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},nad27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},mgi:{towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Militar-Geographische Institut"},osni52:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},rassadiran:{towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},osgb36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Ordnance Survey of Great Britain 1936"},s_jtsk:{towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},beduaram:{towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},gunung_segara:{towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},rnb72:{towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"},EPSG_5451:{towgs84:"6.41,-49.05,-11.28,1.5657,0.5242,6.9718,-5.7649"},IGNF_LURESG:{towgs84:"-192.986,13.673,-39.309,-0.4099,-2.9332,2.6881,0.43"},EPSG_4614:{towgs84:"-119.4248,-303.65872,-11.00061,1.164298,0.174458,1.096259,3.657065"},EPSG_4615:{towgs84:"-494.088,-312.129,279.877,-1.423,-1.013,1.59,-0.748"},ESRI_37241:{towgs84:"-76.822,257.457,-12.817,2.136,-0.033,-2.392,-0.031"},ESRI_37249:{towgs84:"-440.296,58.548,296.265,1.128,10.202,4.559,-0.438"},ESRI_37245:{towgs84:"-511.151,-181.269,139.609,1.05,2.703,1.798,3.071"},EPSG_4178:{towgs84:"24.9,-126.4,-93.2,-0.063,-0.247,-0.041,1.01"},EPSG_4622:{towgs84:"-472.29,-5.63,-304.12,0.4362,-0.8374,0.2563,1.8984"},EPSG_4625:{towgs84:"126.93,547.94,130.41,-2.7867,5.1612,-0.8584,13.8227"},EPSG_5252:{towgs84:"0.023,0.036,-0.068,0.00176,0.00912,-0.01136,0.00439"},EPSG_4314:{towgs84:"597.1,71.4,412.1,0.894,0.068,-1.563,7.58"},EPSG_4282:{towgs84:"-178.3,-316.7,-131.5,5.278,6.077,10.979,19.166"},EPSG_4231:{towgs84:"-83.11,-97.38,-117.22,0.0276,-0.2167,0.2147,0.1218"},EPSG_4274:{towgs84:"-230.994,102.591,25.199,0.633,-0.239,0.9,1.95"},EPSG_4134:{towgs84:"-180.624,-225.516,173.919,-0.81,-1.898,8.336,16.71006"},EPSG_4254:{towgs84:"18.38,192.45,96.82,0.056,-0.142,-0.2,-0.0013"},EPSG_4159:{towgs84:"-194.513,-63.978,-25.759,-3.4027,3.756,-3.352,-0.9175"},EPSG_4687:{towgs84:"0.072,-0.507,-0.245,0.0183,-0.0003,0.007,-0.0093"},EPSG_4227:{towgs84:"-83.58,-397.54,458.78,-17.595,-2.847,4.256,3.225"},EPSG_4746:{towgs84:"599.4,72.4,419.2,-0.062,-0.022,-2.723,6.46"},EPSG_4745:{towgs84:"612.4,77,440.2,-0.054,0.057,-2.797,2.55"},EPSG_6311:{towgs84:"8.846,-4.394,-1.122,-0.00237,-0.146528,0.130428,0.783926"},EPSG_4289:{towgs84:"565.7381,50.4018,465.2904,-1.91514,1.60363,-9.09546,4.07244"},EPSG_4230:{towgs84:"-68.863,-134.888,-111.49,-0.53,-0.14,0.57,-3.4"},EPSG_4154:{towgs84:"-123.02,-158.95,-168.47"},EPSG_4156:{towgs84:"570.8,85.7,462.8,4.998,1.587,5.261,3.56"},EPSG_4299:{towgs84:"482.5,-130.6,564.6,-1.042,-0.214,-0.631,8.15"},EPSG_4179:{towgs84:"33.4,-146.6,-76.3,-0.359,-0.053,0.844,-0.84"},EPSG_4313:{towgs84:"-106.8686,52.2978,-103.7239,0.3366,-0.457,1.8422,-1.2747"},EPSG_4194:{towgs84:"163.511,127.533,-159.789"},EPSG_4195:{towgs84:"105,326,-102.5"},EPSG_4196:{towgs84:"-45,417,-3.5"},EPSG_4611:{towgs84:"-162.619,-276.959,-161.764,0.067753,-2.243649,-1.158827,-1.094246"},EPSG_4633:{towgs84:"137.092,131.66,91.475,-1.9436,-11.5993,-4.3321,-7.4824"},EPSG_4641:{towgs84:"-408.809,366.856,-412.987,1.8842,-0.5308,2.1655,-121.0993"},EPSG_4643:{towgs84:"-480.26,-438.32,-643.429,16.3119,20.1721,-4.0349,-111.7002"},EPSG_4300:{towgs84:"482.5,-130.6,564.6,-1.042,-0.214,-0.631,8.15"},EPSG_4188:{towgs84:"482.5,-130.6,564.6,-1.042,-0.214,-0.631,8.15"},EPSG_4660:{towgs84:"982.6087,552.753,-540.873,32.39344,-153.25684,-96.2266,16.805"},EPSG_4662:{towgs84:"97.295,-263.247,310.882,-1.5999,0.8386,3.1409,13.3259"},EPSG_3906:{towgs84:"577.88891,165.22205,391.18289,4.9145,-0.94729,-13.05098,7.78664"},EPSG_4307:{towgs84:"-209.3622,-87.8162,404.6198,0.0046,3.4784,0.5805,-1.4547"},EPSG_6892:{towgs84:"-76.269,-16.683,68.562,-6.275,10.536,-4.286,-13.686"},EPSG_4690:{towgs84:"221.597,152.441,176.523,2.403,1.3893,0.884,11.4648"},EPSG_4691:{towgs84:"218.769,150.75,176.75,3.5231,2.0037,1.288,10.9817"},EPSG_4629:{towgs84:"72.51,345.411,79.241,-1.5862,-0.8826,-0.5495,1.3653"},EPSG_4630:{towgs84:"165.804,216.213,180.26,-0.6251,-0.4515,-0.0721,7.4111"},EPSG_4692:{towgs84:"217.109,86.452,23.711,0.0183,-0.0003,0.007,-0.0093"},EPSG_9333:{towgs84:"0,0,0,-8.393,0.749,-10.276,0"},EPSG_9059:{towgs84:"0,0,0"},EPSG_4312:{towgs84:"601.705,84.263,485.227,4.7354,1.3145,5.393,-2.3887"},EPSG_4123:{towgs84:"-96.062,-82.428,-121.753,4.801,0.345,-1.376,1.496"},EPSG_4309:{towgs84:"-124.45,183.74,44.64,-0.4384,0.5446,-0.9706,-2.1365"},ESRI_104106:{towgs84:"-283.088,-70.693,117.445,-1.157,0.059,-0.652,-4.058"},EPSG_4281:{towgs84:"-219.247,-73.802,269.529"},EPSG_4322:{towgs84:"0,0,4.5"},EPSG_4324:{towgs84:"0,0,1.9"},EPSG_4284:{towgs84:"43.822,-108.842,-119.585,1.455,-0.761,0.737,0.549"},EPSG_4277:{towgs84:"446.448,-125.157,542.06,0.15,0.247,0.842,-20.489"},EPSG_4207:{towgs84:"-282.1,-72.2,120,-1.529,0.145,-0.89,-4.46"},EPSG_4688:{towgs84:"347.175,1077.618,2623.677,33.9058,-70.6776,9.4013,186.0647"},EPSG_4689:{towgs84:"410.793,54.542,80.501,-2.5596,-2.3517,-0.6594,17.3218"},EPSG_4720:{towgs84:"0,0,4.5"},EPSG_4273:{towgs84:"278.3,93,474.5,7.889,0.05,-6.61,6.21"},EPSG_4240:{towgs84:"204.64,834.74,293.8"},EPSG_4817:{towgs84:"278.3,93,474.5,7.889,0.05,-6.61,6.21"},ESRI_104131:{towgs84:"426.62,142.62,460.09,4.98,4.49,-12.42,-17.1"},EPSG_4265:{towgs84:"-104.1,-49.1,-9.9,0.971,-2.917,0.714,-11.68"},EPSG_4263:{towgs84:"-111.92,-87.85,114.5,1.875,0.202,0.219,0.032"},EPSG_4298:{towgs84:"-689.5937,623.84046,-65.93566,-0.02331,1.17094,-0.80054,5.88536"},EPSG_4270:{towgs84:"-253.4392,-148.452,386.5267,0.15605,0.43,-0.1013,-0.0424"},EPSG_4229:{towgs84:"-121.8,98.1,-10.7"},EPSG_4220:{towgs84:"-55.5,-348,-229.2"},EPSG_4214:{towgs84:"12.646,-155.176,-80.863"},EPSG_4232:{towgs84:"-345,3,223"},EPSG_4238:{towgs84:"-1.977,-13.06,-9.993,0.364,0.254,0.689,-1.037"},EPSG_4168:{towgs84:"-170,33,326"},EPSG_4131:{towgs84:"199,931,318.9"},EPSG_4152:{towgs84:"-0.9102,2.0141,0.5602,0.029039,0.010065,0.010101,0"},EPSG_5228:{towgs84:"572.213,85.334,461.94,4.9732,1.529,5.2484,3.5378"},EPSG_8351:{towgs84:"485.021,169.465,483.839,7.786342,4.397554,4.102655,0"},EPSG_4683:{towgs84:"-127.62,-67.24,-47.04,-3.068,4.903,1.578,-1.06"},EPSG_4133:{towgs84:"0,0,0"},EPSG_7373:{towgs84:"0.819,-0.5762,-1.6446,-0.00378,-0.03317,0.00318,0.0693"},EPSG_9075:{towgs84:"-0.9102,2.0141,0.5602,0.029039,0.010065,0.010101,0"},EPSG_9072:{towgs84:"-0.9102,2.0141,0.5602,0.029039,0.010065,0.010101,0"},EPSG_9294:{towgs84:"1.16835,-1.42001,-2.24431,-0.00822,-0.05508,0.01818,0.23388"},EPSG_4212:{towgs84:"-267.434,173.496,181.814,-13.4704,8.7154,7.3926,14.7492"},EPSG_4191:{towgs84:"-44.183,-0.58,-38.489,2.3867,2.7072,-3.5196,-8.2703"},EPSG_4237:{towgs84:"52.684,-71.194,-13.975,-0.312,-0.1063,-0.3729,1.0191"},EPSG_4740:{towgs84:"-1.08,-0.27,-0.9"},EPSG_4124:{towgs84:"419.3836,99.3335,591.3451,0.850389,1.817277,-7.862238,-0.99496"},EPSG_5681:{towgs84:"584.9636,107.7175,413.8067,1.1155,0.2824,-3.1384,7.9922"},EPSG_4141:{towgs84:"23.772,17.49,17.859,-0.3132,-1.85274,1.67299,-5.4262"},EPSG_4204:{towgs84:"-85.645,-273.077,-79.708,2.289,-1.421,2.532,3.194"},EPSG_4319:{towgs84:"226.702,-193.337,-35.371,-2.229,-4.391,9.238,0.9798"},EPSG_4200:{towgs84:"24.82,-131.21,-82.66"},EPSG_4130:{towgs84:"0,0,0"},EPSG_4127:{towgs84:"-82.875,-57.097,-156.768,-2.158,1.524,-0.982,-0.359"},EPSG_4149:{towgs84:"674.374,15.056,405.346"},EPSG_4617:{towgs84:"-0.991,1.9072,0.5129,1.25033e-7,4.6785e-8,5.6529e-8,0"},EPSG_4663:{towgs84:"-210.502,-66.902,-48.476,2.094,-15.067,-5.817,0.485"},EPSG_4664:{towgs84:"-211.939,137.626,58.3,-0.089,0.251,0.079,0.384"},EPSG_4665:{towgs84:"-105.854,165.589,-38.312,-0.003,-0.026,0.024,-0.048"},EPSG_4666:{towgs84:"631.392,-66.551,481.442,1.09,-4.445,-4.487,-4.43"},EPSG_4756:{towgs84:"-192.873,-39.382,-111.202,-0.00205,-0.0005,0.00335,0.0188"},EPSG_4723:{towgs84:"-179.483,-69.379,-27.584,-7.862,8.163,6.042,-13.925"},EPSG_4726:{towgs84:"8.853,-52.644,180.304,-0.393,-2.323,2.96,-24.081"},EPSG_4267:{towgs84:"-8.0,160.0,176.0"},EPSG_5365:{towgs84:"-0.16959,0.35312,0.51846,0.03385,-0.16325,0.03446,0.03693"},EPSG_4218:{towgs84:"304.5,306.5,-318.1"},EPSG_4242:{towgs84:"-33.722,153.789,94.959,-8.581,-4.478,4.54,8.95"},EPSG_4216:{towgs84:"-292.295,248.758,429.447,4.9971,2.99,6.6906,1.0289"},ESRI_104105:{towgs84:"631.392,-66.551,481.442,1.09,-4.445,-4.487,-4.43"},ESRI_104129:{towgs84:"0,0,0"},EPSG_4673:{towgs84:"174.05,-25.49,112.57"},EPSG_4202:{towgs84:"-124,-60,154"},EPSG_4203:{towgs84:"-117.763,-51.51,139.061,0.292,0.443,0.277,-0.191"},EPSG_3819:{towgs84:"595.48,121.69,515.35,4.115,-2.9383,0.853,-3.408"},EPSG_8694:{towgs84:"-93.799,-132.737,-219.073,-1.844,0.648,-6.37,-0.169"},EPSG_4145:{towgs84:"275.57,676.78,229.6"},EPSG_4283:{towgs84:"61.55,-10.87,-40.19,39.4924,32.7221,32.8979,-9.994"},EPSG_4317:{towgs84:"2.3287,-147.0425,-92.0802,-0.3092483,0.32482185,0.49729934,5.68906266"},EPSG_4272:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993"},EPSG_4248:{towgs84:"-307.7,265.3,-363.5"},EPSG_5561:{towgs84:"24,-121,-76"},EPSG_5233:{towgs84:"-0.293,766.95,87.713,0.195704,1.695068,3.473016,-0.039338"},ESRI_104130:{towgs84:"-86,-98,-119"},ESRI_104102:{towgs84:"682,-203,480"},ESRI_37207:{towgs84:"7,-10,-26"},EPSG_4675:{towgs84:"59.935,118.4,-10.871"},ESRI_104109:{towgs84:"-89.121,-348.182,260.871"},ESRI_104112:{towgs84:"-185.583,-230.096,281.361"},ESRI_104113:{towgs84:"25.1,-275.6,222.6"},IGNF_WGS72G:{towgs84:"0,12,6"},IGNF_NTFG:{towgs84:"-168,-60,320"},IGNF_EFATE57G:{towgs84:"-127,-769,472"},IGNF_PGP50G:{towgs84:"324.8,153.6,172.1"},IGNF_REUN47G:{towgs84:"94,-948,-1262"},IGNF_CSG67G:{towgs84:"-186,230,110"},IGNF_GUAD48G:{towgs84:"-467,-16,-300"},IGNF_TAHI51G:{towgs84:"162,117,154"},IGNF_TAHAAG:{towgs84:"65,342,77"},IGNF_NUKU72G:{towgs84:"84,274,65"},IGNF_PETRELS72G:{towgs84:"365,194,166"},IGNF_WALL78G:{towgs84:"253,-133,-127"},IGNF_MAYO50G:{towgs84:"-382,-59,-262"},IGNF_TANNAG:{towgs84:"-139,-967,436"},IGNF_IGN72G:{towgs84:"-13,-348,292"},IGNF_ATIGG:{towgs84:"1118,23,66"},IGNF_FANGA84G:{towgs84:"150.57,158.33,118.32"},IGNF_RUSAT84G:{towgs84:"202.13,174.6,-15.74"},IGNF_KAUE70G:{towgs84:"126.74,300.1,-75.49"},IGNF_MOP90G:{towgs84:"-10.8,-1.8,12.77"},IGNF_MHPF67G:{towgs84:"338.08,212.58,-296.17"},IGNF_TAHI79G:{towgs84:"160.61,116.05,153.69"},IGNF_ANAA92G:{towgs84:"1.5,3.84,4.81"},IGNF_MARQUI72G:{towgs84:"330.91,-13.92,58.56"},IGNF_APAT86G:{towgs84:"143.6,197.82,74.05"},IGNF_TUBU69G:{towgs84:"237.17,171.61,-77.84"},IGNF_STPM50G:{towgs84:"11.363,424.148,373.13"},EPSG_4150:{towgs84:"674.374,15.056,405.346"},EPSG_4754:{towgs84:"-208.4058,-109.8777,-2.5764"},ESRI_104101:{towgs84:"374,150,588"},EPSG_4693:{towgs84:"0,-0.15,0.68"},EPSG_6207:{towgs84:"293.17,726.18,245.36"},EPSG_4153:{towgs84:"-133.63,-157.5,-158.62"},EPSG_4132:{towgs84:"-241.54,-163.64,396.06"},EPSG_4221:{towgs84:"-154.5,150.7,100.4"},EPSG_4266:{towgs84:"-80.7,-132.5,41.1"},EPSG_4193:{towgs84:"-70.9,-151.8,-41.4"},EPSG_5340:{towgs84:"-0.41,0.46,-0.35"},EPSG_4246:{towgs84:"-294.7,-200.1,525.5"},EPSG_4318:{towgs84:"-3.2,-5.7,2.8"},EPSG_4121:{towgs84:"-199.87,74.79,246.62"},EPSG_4223:{towgs84:"-260.1,5.5,432.2"},EPSG_4158:{towgs84:"-0.465,372.095,171.736"},EPSG_4285:{towgs84:"-128.16,-282.42,21.93"},EPSG_4613:{towgs84:"-404.78,685.68,45.47"},EPSG_4607:{towgs84:"195.671,332.517,274.607"},EPSG_4475:{towgs84:"-381.788,-57.501,-256.673"},EPSG_4208:{towgs84:"-157.84,308.54,-146.6"},EPSG_4743:{towgs84:"70.995,-335.916,262.898"},EPSG_4710:{towgs84:"-323.65,551.39,-491.22"},EPSG_7881:{towgs84:"-0.077,0.079,0.086"},EPSG_4682:{towgs84:"283.729,735.942,261.143"},EPSG_4739:{towgs84:"-156,-271,-189"},EPSG_4679:{towgs84:"-80.01,253.26,291.19"},EPSG_4750:{towgs84:"-56.263,16.136,-22.856"},EPSG_4644:{towgs84:"-10.18,-350.43,291.37"},EPSG_4695:{towgs84:"-103.746,-9.614,-255.95"},EPSG_4292:{towgs84:"-355,21,72"},EPSG_4302:{towgs84:"-61.702,284.488,472.052"},EPSG_4143:{towgs84:"-124.76,53,466.79"},EPSG_4606:{towgs84:"-153,153,307"},EPSG_4699:{towgs84:"-770.1,158.4,-498.2"},EPSG_4247:{towgs84:"-273.5,110.6,-357.9"},EPSG_4160:{towgs84:"8.88,184.86,106.69"},EPSG_4161:{towgs84:"-233.43,6.65,173.64"},EPSG_9251:{towgs84:"-9.5,122.9,138.2"},EPSG_9253:{towgs84:"-78.1,101.6,133.3"},EPSG_4297:{towgs84:"-198.383,-240.517,-107.909"},EPSG_4269:{towgs84:"0,0,0"},EPSG_4301:{towgs84:"-147,506,687"},EPSG_4618:{towgs84:"-59,-11,-52"},EPSG_4612:{towgs84:"0,0,0"},EPSG_4678:{towgs84:"44.585,-131.212,-39.544"},EPSG_4250:{towgs84:"-130,29,364"},EPSG_4144:{towgs84:"214,804,268"},EPSG_4147:{towgs84:"-17.51,-108.32,-62.39"},EPSG_4259:{towgs84:"-254.1,-5.36,-100.29"},EPSG_4164:{towgs84:"-76,-138,67"},EPSG_4211:{towgs84:"-378.873,676.002,-46.255"},EPSG_4182:{towgs84:"-422.651,-172.995,84.02"},EPSG_4224:{towgs84:"-143.87,243.37,-33.52"},EPSG_4225:{towgs84:"-205.57,168.77,-4.12"},EPSG_5527:{towgs84:"-67.35,3.88,-38.22"},EPSG_4752:{towgs84:"98,390,-22"},EPSG_4310:{towgs84:"-30,190,89"},EPSG_9248:{towgs84:"-192.26,65.72,132.08"},EPSG_4680:{towgs84:"124.5,-63.5,-281"},EPSG_4701:{towgs84:"-79.9,-158,-168.9"},EPSG_4706:{towgs84:"-146.21,112.63,4.05"},EPSG_4805:{towgs84:"682,-203,480"},EPSG_4201:{towgs84:"-165,-11,206"},EPSG_4210:{towgs84:"-157,-2,-299"},EPSG_4183:{towgs84:"-104,167,-38"},EPSG_4139:{towgs84:"11,72,-101"},EPSG_4668:{towgs84:"-86,-98,-119"},EPSG_4717:{towgs84:"-2,151,181"},EPSG_4732:{towgs84:"102,52,-38"},EPSG_4280:{towgs84:"-377,681,-50"},EPSG_4209:{towgs84:"-138,-105,-289"},EPSG_4261:{towgs84:"31,146,47"},EPSG_4658:{towgs84:"-73,46,-86"},EPSG_4721:{towgs84:"265.025,384.929,-194.046"},EPSG_4222:{towgs84:"-136,-108,-292"},EPSG_4601:{towgs84:"-255,-15,71"},EPSG_4602:{towgs84:"725,685,536"},EPSG_4603:{towgs84:"72,213.7,93"},EPSG_4605:{towgs84:"9,183,236"},EPSG_4621:{towgs84:"137,248,-430"},EPSG_4657:{towgs84:"-28,199,5"},EPSG_4316:{towgs84:"103.25,-100.4,-307.19"},EPSG_4642:{towgs84:"-13,-348,292"},EPSG_4698:{towgs84:"145,-187,103"},EPSG_4192:{towgs84:"-206.1,-174.7,-87.7"},EPSG_4311:{towgs84:"-265,120,-358"},EPSG_4135:{towgs84:"58,-283,-182"},ESRI_104138:{towgs84:"198,-226,-347"},EPSG_4245:{towgs84:"-11,851,5"},EPSG_4142:{towgs84:"-125,53,467"},EPSG_4213:{towgs84:"-106,-87,188"},EPSG_4253:{towgs84:"-133,-77,-51"},EPSG_4129:{towgs84:"-132,-110,-335"},EPSG_4713:{towgs84:"-77,-128,142"},EPSG_4239:{towgs84:"217,823,299"},EPSG_4146:{towgs84:"295,736,257"},EPSG_4155:{towgs84:"-83,37,124"},EPSG_4165:{towgs84:"-173,253,27"},EPSG_4672:{towgs84:"175,-38,113"},EPSG_4236:{towgs84:"-637,-549,-203"},EPSG_4251:{towgs84:"-90,40,88"},EPSG_4271:{towgs84:"-2,374,172"},EPSG_4175:{towgs84:"-88,4,101"},EPSG_4716:{towgs84:"298,-304,-375"},EPSG_4315:{towgs84:"-23,259,-9"},EPSG_4744:{towgs84:"-242.2,-144.9,370.3"},EPSG_4244:{towgs84:"-97,787,86"},EPSG_4293:{towgs84:"616,97,-251"},EPSG_4714:{towgs84:"-127,-769,472"},EPSG_4736:{towgs84:"260,12,-147"},EPSG_6883:{towgs84:"-235,-110,393"},EPSG_6894:{towgs84:"-63,176,185"},EPSG_4205:{towgs84:"-43,-163,45"},EPSG_4256:{towgs84:"41,-220,-134"},EPSG_4262:{towgs84:"639,405,60"},EPSG_4604:{towgs84:"174,359,365"},EPSG_4169:{towgs84:"-115,118,426"},EPSG_4620:{towgs84:"-106,-129,165"},EPSG_4184:{towgs84:"-203,141,53"},EPSG_4616:{towgs84:"-289,-124,60"},EPSG_9403:{towgs84:"-307,-92,127"},EPSG_4684:{towgs84:"-133,-321,50"},EPSG_4708:{towgs84:"-491,-22,435"},EPSG_4707:{towgs84:"114,-116,-333"},EPSG_4709:{towgs84:"145,75,-272"},EPSG_4712:{towgs84:"-205,107,53"},EPSG_4711:{towgs84:"124,-234,-25"},EPSG_4718:{towgs84:"230,-199,-752"},EPSG_4719:{towgs84:"211,147,111"},EPSG_4724:{towgs84:"208,-435,-229"},EPSG_4725:{towgs84:"189,-79,-202"},EPSG_4735:{towgs84:"647,1777,-1124"},EPSG_4722:{towgs84:"-794,119,-298"},EPSG_4728:{towgs84:"-307,-92,127"},EPSG_4734:{towgs84:"-632,438,-609"},EPSG_4727:{towgs84:"912,-58,1227"},EPSG_4729:{towgs84:"185,165,42"},EPSG_4730:{towgs84:"170,42,84"},EPSG_4733:{towgs84:"276,-57,149"},ESRI_37218:{towgs84:"230,-199,-752"},ESRI_37240:{towgs84:"-7,215,225"},ESRI_37221:{towgs84:"252,-209,-751"},ESRI_4305:{towgs84:"-123,-206,219"},ESRI_104139:{towgs84:"-73,-247,227"},EPSG_4748:{towgs84:"51,391,-36"},EPSG_4219:{towgs84:"-384,664,-48"},EPSG_4255:{towgs84:"-333,-222,114"},EPSG_4257:{towgs84:"-587.8,519.75,145.76"},EPSG_4646:{towgs84:"-963,510,-359"},EPSG_6881:{towgs84:"-24,-203,268"},EPSG_6882:{towgs84:"-183,-15,273"},EPSG_4715:{towgs84:"-104,-129,239"},IGNF_RGF93GDD:{towgs84:"0,0,0"},IGNF_RGM04GDD:{towgs84:"0,0,0"},IGNF_RGSPM06GDD:{towgs84:"0,0,0"},IGNF_RGTAAF07GDD:{towgs84:"0,0,0"},IGNF_RGFG95GDD:{towgs84:"0,0,0"},IGNF_RGNCG:{towgs84:"0,0,0"},IGNF_RGPFGDD:{towgs84:"0,0,0"},IGNF_ETRS89G:{towgs84:"0,0,0"},IGNF_RGR92GDD:{towgs84:"0,0,0"},EPSG_4173:{towgs84:"0,0,0"},EPSG_4180:{towgs84:"0,0,0"},EPSG_4619:{towgs84:"0,0,0"},EPSG_4667:{towgs84:"0,0,0"},EPSG_4075:{towgs84:"0,0,0"},EPSG_6706:{towgs84:"0,0,0"},EPSG_7798:{towgs84:"0,0,0"},EPSG_4661:{towgs84:"0,0,0"},EPSG_4669:{towgs84:"0,0,0"},EPSG_8685:{towgs84:"0,0,0"},EPSG_4151:{towgs84:"0,0,0"},EPSG_9702:{towgs84:"0,0,0"},EPSG_4758:{towgs84:"0,0,0"},EPSG_4761:{towgs84:"0,0,0"},EPSG_4765:{towgs84:"0,0,0"},EPSG_8997:{towgs84:"0,0,0"},EPSG_4023:{towgs84:"0,0,0"},EPSG_4670:{towgs84:"0,0,0"},EPSG_4694:{towgs84:"0,0,0"},EPSG_4148:{towgs84:"0,0,0"},EPSG_4163:{towgs84:"0,0,0"},EPSG_4167:{towgs84:"0,0,0"},EPSG_4189:{towgs84:"0,0,0"},EPSG_4190:{towgs84:"0,0,0"},EPSG_4176:{towgs84:"0,0,0"},EPSG_4659:{towgs84:"0,0,0"},EPSG_3824:{towgs84:"0,0,0"},EPSG_3889:{towgs84:"0,0,0"},EPSG_4046:{towgs84:"0,0,0"},EPSG_4081:{towgs84:"0,0,0"},EPSG_4558:{towgs84:"0,0,0"},EPSG_4483:{towgs84:"0,0,0"},EPSG_5013:{towgs84:"0,0,0"},EPSG_5264:{towgs84:"0,0,0"},EPSG_5324:{towgs84:"0,0,0"},EPSG_5354:{towgs84:"0,0,0"},EPSG_5371:{towgs84:"0,0,0"},EPSG_5373:{towgs84:"0,0,0"},EPSG_5381:{towgs84:"0,0,0"},EPSG_5393:{towgs84:"0,0,0"},EPSG_5489:{towgs84:"0,0,0"},EPSG_5593:{towgs84:"0,0,0"},EPSG_6135:{towgs84:"0,0,0"},EPSG_6365:{towgs84:"0,0,0"},EPSG_5246:{towgs84:"0,0,0"},EPSG_7886:{towgs84:"0,0,0"},EPSG_8431:{towgs84:"0,0,0"},EPSG_8427:{towgs84:"0,0,0"},EPSG_8699:{towgs84:"0,0,0"},EPSG_8818:{towgs84:"0,0,0"},EPSG_4757:{towgs84:"0,0,0"},EPSG_9140:{towgs84:"0,0,0"},EPSG_8086:{towgs84:"0,0,0"},EPSG_4686:{towgs84:"0,0,0"},EPSG_4737:{towgs84:"0,0,0"},EPSG_4702:{towgs84:"0,0,0"},EPSG_4747:{towgs84:"0,0,0"},EPSG_4749:{towgs84:"0,0,0"},EPSG_4674:{towgs84:"0,0,0"},EPSG_4755:{towgs84:"0,0,0"},EPSG_4759:{towgs84:"0,0,0"},EPSG_4762:{towgs84:"0,0,0"},EPSG_4763:{towgs84:"0,0,0"},EPSG_4764:{towgs84:"0,0,0"},EPSG_4166:{towgs84:"0,0,0"},EPSG_4170:{towgs84:"0,0,0"},EPSG_5546:{towgs84:"0,0,0"},EPSG_7844:{towgs84:"0,0,0"},EPSG_4818:{towgs84:"589,76,480"}};for(var oo in ea){var ka=ea[oo];ka.datumName&&(ea[ka.datumName]=ka)}function co(t,s,a,n,i,r,o){var l={};return t===void 0||t==="none"?l.datum_type=Ga:l.datum_type=vl,s&&(l.datum_params=s.map(parseFloat),(l.datum_params[0]!==0||l.datum_params[1]!==0||l.datum_params[2]!==0)&&(l.datum_type=Lt),l.datum_params.length>3&&(l.datum_params[3]!==0||l.datum_params[4]!==0||l.datum_params[5]!==0||l.datum_params[6]!==0)&&(l.datum_type=Bt,l.datum_params[3]*=Ns,l.datum_params[4]*=Ns,l.datum_params[5]*=Ns,l.datum_params[6]=l.datum_params[6]/1e6+1)),o&&(l.datum_type=os,l.grids=o),l.a=a,l.b=n,l.es=i,l.ep2=r,l}var Za={};function ho(t,s,a){return s instanceof ArrayBuffer?mo(t,s,a):{ready:xo(t,s)}}function mo(t,s,a){var n=!0;a!==void 0&&a.includeErrorFields===!1&&(n=!1);var i=new DataView(s),r=fo(i),o=po(i,r),l=yo(i,o,r,n),c={header:o,subgrids:l};return Za[t]=c,c}async function xo(t,s){for(var a=[],n=await s.getImageCount(),i=n-1;i>=0;i--){var r=await s.getImage(i),o=await r.readRasters(),l=o,c=[r.getWidth(),r.getHeight()],d=r.getBoundingBox().map(qi),x=[r.fileDirectory.ModelPixelScale[0],r.fileDirectory.ModelPixelScale[1]].map(qi),h=d[0]+(c[0]-1)*x[0],m=d[3]-(c[1]-1)*x[1],p=l[0],y=l[1],v=[];for(let g=c[1]-1;g>=0;g--)for(let S=c[0]-1;S>=0;S--){var u=g*c[0]+S;v.push([-At(y[u]),At(p[u])])}a.push({del:x,lim:c,ll:[-h,m],cvs:v})}var j={header:{nSubgrids:n},subgrids:a};return Za[t]=j,j}function uo(t){if(t===void 0)return null;var s=t.split(",");return s.map(go)}function go(t){if(t.length===0)return null;var s=t[0]==="@";return s&&(t=t.slice(1)),t==="null"?{name:"null",mandatory:!s,grid:null,isNull:!0}:{name:t,mandatory:!s,grid:Za[t]||null,isNull:!1}}function qi(t){return t*Math.PI/180}function At(t){return t/3600*Math.PI/180}function fo(t){var s=t.getInt32(8,!1);return s===11?!1:(s=t.getInt32(8,!0),s!==11&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian"),!0)}function po(t,s){return{nFields:t.getInt32(8,s),nSubgridFields:t.getInt32(24,s),nSubgrids:t.getInt32(40,s),shiftType:$a(t,56,64).trim(),fromSemiMajorAxis:t.getFloat64(120,s),fromSemiMinorAxis:t.getFloat64(136,s),toSemiMajorAxis:t.getFloat64(152,s),toSemiMinorAxis:t.getFloat64(168,s)}}function $a(t,s,a){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(s,a)))}function yo(t,s,a,n){for(var i=176,r=[],o=0;o<s.nSubgrids;o++){var l=vo(t,i,a),c=jo(t,i,l,a,n),d=Math.round(1+(l.upperLongitude-l.lowerLongitude)/l.longitudeInterval),x=Math.round(1+(l.upperLatitude-l.lowerLatitude)/l.latitudeInterval);r.push({ll:[At(l.lowerLongitude),At(l.lowerLatitude)],del:[At(l.longitudeInterval),At(l.latitudeInterval)],lim:[d,x],count:l.gridNodeCount,cvs:bo(c)});var h=16;n===!1&&(h=8),i+=176+l.gridNodeCount*h}return r}function bo(t){return t.map(function(s){return[At(s.longitudeShift),At(s.latitudeShift)]})}function vo(t,s,a){return{name:$a(t,s+8,s+16).trim(),parent:$a(t,s+24,s+24+8).trim(),lowerLatitude:t.getFloat64(s+72,a),upperLatitude:t.getFloat64(s+88,a),lowerLongitude:t.getFloat64(s+104,a),upperLongitude:t.getFloat64(s+120,a),latitudeInterval:t.getFloat64(s+136,a),longitudeInterval:t.getFloat64(s+152,a),gridNodeCount:t.getInt32(s+168,a)}}function jo(t,s,a,n,i){var r=s+176,o=16;i===!1&&(o=8);for(var l=[],c=0;c<a.gridNodeCount;c++){var d={latitudeShift:t.getFloat32(r+c*o,n),longitudeShift:t.getFloat32(r+c*o+4,n)};i!==!1&&(d.latitudeAccuracy=t.getFloat32(r+c*o+8,n),d.longitudeAccuracy=t.getFloat32(r+c*o+12,n)),l.push(d)}return l}function gt(t,s){if(!(this instanceof gt))return new gt(t);this.forward=null,this.inverse=null,this.init=null,this.name,this.names=null,this.title,s=s||function(d){if(d)throw d};var a=Xl(t);if(typeof a!="object"){s("Could not parse to valid json: "+t);return}var n=gt.projections.get(a.projName);if(!n){s("Could not get projection name from: "+t);return}if(a.datumCode&&a.datumCode!=="none"){var i=Gt(ea,a.datumCode);i&&(a.datum_params=a.datum_params||(i.towgs84?i.towgs84.split(","):null),a.ellps=i.ellipse,a.datumName=i.datumName?i.datumName:a.datumCode)}a.k0=a.k0||1,a.axis=a.axis||"enu",a.ellps=a.ellps||"wgs84",a.lat1=a.lat1||a.lat0;var r=lo(a.a,a.b,a.rf,a.ellps,a.sphere),o=ro(r.a,r.b,r.rf,a.R_A),l=uo(a.nadgrids),c=a.datum||co(a.datumCode,a.datum_params,r.a,r.b,o.es,o.ep2,l);Ti(this,a),Ti(this,n),this.a=r.a,this.b=r.b,this.rf=r.rf,this.sphere=r.sphere,this.es=o.es,this.e=o.e,this.ep2=o.ep2,this.datum=c,"init"in this&&typeof this.init=="function"&&this.init(),s(null,this)}gt.projections=io;gt.projections.start();function No(t,s){return t.datum_type!==s.datum_type||t.a!==s.a||Math.abs(t.es-s.es)>5e-11?!1:t.datum_type===Lt?t.datum_params[0]===s.datum_params[0]&&t.datum_params[1]===s.datum_params[1]&&t.datum_params[2]===s.datum_params[2]:t.datum_type===Bt?t.datum_params[0]===s.datum_params[0]&&t.datum_params[1]===s.datum_params[1]&&t.datum_params[2]===s.datum_params[2]&&t.datum_params[3]===s.datum_params[3]&&t.datum_params[4]===s.datum_params[4]&&t.datum_params[5]===s.datum_params[5]&&t.datum_params[6]===s.datum_params[6]:!0}function $n(t,s,a){var n=t.x,i=t.y,r=t.z?t.z:0,o,l,c,d;if(i<-L&&i>-1.001*L)i=-L;else if(i>L&&i<1.001*L)i=L;else{if(i<-L)return{x:-1/0,y:-1/0,z:t.z};if(i>L)return{x:1/0,y:1/0,z:t.z}}return n>Math.PI&&(n-=2*Math.PI),l=Math.sin(i),d=Math.cos(i),c=l*l,o=a/Math.sqrt(1-s*c),{x:(o+r)*d*Math.cos(n),y:(o+r)*d*Math.sin(n),z:(o*(1-s)+r)*l}}function Tn(t,s,a,n){var i=1e-12,r=i*i,o=30,l,c,d,x,h,m,p,y,v,u,j,g,S,b=t.x,_=t.y,w=t.z?t.z:0,k,$,R;if(l=Math.sqrt(b*b+_*_),c=Math.sqrt(b*b+_*_+w*w),l/a<i){if(k=0,c/a<i)return $=L,R=-n,{x:t.x,y:t.y,z:t.z}}else k=Math.atan2(_,b);d=w/c,x=l/c,h=1/Math.sqrt(1-s*(2-s)*x*x),y=x*(1-s)*h,v=d*h,S=0;do S++,p=a/Math.sqrt(1-s*v*v),R=l*y+w*v-p*(1-s*v*v),m=s*p/(p+R),h=1/Math.sqrt(1-m*(2-m)*x*x),u=x*(1-m)*h,j=d*h,g=j*y-u*v,y=u,v=j;while(g*g>r&&S<o);return $=Math.atan(j/Math.abs(u)),{x:k,y:$,z:R}}function wo(t,s,a){if(s===Lt)return{x:t.x+a[0],y:t.y+a[1],z:t.z+a[2]};if(s===Bt){var n=a[0],i=a[1],r=a[2],o=a[3],l=a[4],c=a[5],d=a[6];return{x:d*(t.x-c*t.y+l*t.z)+n,y:d*(c*t.x+t.y-o*t.z)+i,z:d*(-l*t.x+o*t.y+t.z)+r}}}function _o(t,s,a){if(s===Lt)return{x:t.x-a[0],y:t.y-a[1],z:t.z-a[2]};if(s===Bt){var n=a[0],i=a[1],r=a[2],o=a[3],l=a[4],c=a[5],d=a[6],x=(t.x-n)/d,h=(t.y-i)/d,m=(t.z-r)/d;return{x:x+c*h-l*m,y:-c*x+h+o*m,z:l*x-o*h+m}}}function Xs(t){return t===Lt||t===Bt}function So(t,s,a){if(No(t,s)||t.datum_type===Ga||s.datum_type===Ga)return a;var n=t.a,i=t.es;if(t.datum_type===os){var r=Ui(t,!1,a);if(r!==0)return;n=Fi,i=Ii}var o=s.a,l=s.b,c=s.es;if(s.datum_type===os&&(o=Fi,l=jl,c=Ii),i===c&&n===o&&!Xs(t.datum_type)&&!Xs(s.datum_type))return a;if(a=$n(a,i,n),Xs(t.datum_type)&&(a=wo(a,t.datum_type,t.datum_params)),Xs(s.datum_type)&&(a=_o(a,s.datum_type,s.datum_params)),a=Tn(a,c,o,l),s.datum_type===os){var d=Ui(s,!0,a);if(d!==0)return}return a}function Ui(t,s,a){if(t.grids===null||t.grids.length===0)return console.log("Grid shift grids not found"),-1;var n={x:-a.x,y:a.y},i={x:Number.NaN,y:Number.NaN},r=[];e:for(var o=0;o<t.grids.length;o++){var l=t.grids[o];if(r.push(l.name),l.isNull){i=n;break}if(l.grid===null){if(l.mandatory)return console.log("Unable to find mandatory grid '"+l.name+"'"),-1;continue}for(var c=l.grid.subgrids,d=0,x=c.length;d<x;d++){var h=c[d],m=(Math.abs(h.del[1])+Math.abs(h.del[0]))/1e4,p=h.ll[0]-m,y=h.ll[1]-m,v=h.ll[0]+(h.lim[0]-1)*h.del[0]+m,u=h.ll[1]+(h.lim[1]-1)*h.del[1]+m;if(!(y>n.y||p>n.x||u<n.y||v<n.x)&&(i=Mo(n,s,h),!isNaN(i.x)))break e}}return isNaN(i.x)?(console.log("Failed to find a grid shift table for location '"+-n.x*yt+" "+n.y*yt+" tried: '"+r+"'"),-1):(a.x=-i.x,a.y=i.y,0)}function Mo(t,s,a){var n={x:Number.NaN,y:Number.NaN};if(isNaN(t.x))return n;var i={x:t.x,y:t.y};i.x-=a.ll[0],i.y-=a.ll[1],i.x=K(i.x-Math.PI)+Math.PI;var r=Li(i,a);if(s){if(isNaN(r.x))return n;r.x=i.x-r.x,r.y=i.y-r.y;var o=9,l=1e-12,c,d;do{if(d=Li(r,a),isNaN(d.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}c={x:i.x-(d.x+r.x),y:i.y-(d.y+r.y)},r.x+=c.x,r.y+=c.y}while(o--&&Math.abs(c.x)>l&&Math.abs(c.y)>l);if(o<0)return console.log("Inverse grid shift iterator failed to converge."),n;n.x=K(r.x+a.ll[0]),n.y=r.y+a.ll[1]}else isNaN(r.x)||(n.x=t.x+r.x,n.y=t.y+r.y);return n}function Li(t,s){var a={x:t.x/s.del[0],y:t.y/s.del[1]},n={x:Math.floor(a.x),y:Math.floor(a.y)},i={x:a.x-1*n.x,y:a.y-1*n.y},r={x:Number.NaN,y:Number.NaN},o;if(n.x<0||n.x>=s.lim[0]||n.y<0||n.y>=s.lim[1])return r;o=n.y*s.lim[0]+n.x;var l={x:s.cvs[o][0],y:s.cvs[o][1]};o++;var c={x:s.cvs[o][0],y:s.cvs[o][1]};o+=s.lim[0];var d={x:s.cvs[o][0],y:s.cvs[o][1]};o--;var x={x:s.cvs[o][0],y:s.cvs[o][1]},h=i.x*i.y,m=i.x*(1-i.y),p=(1-i.x)*(1-i.y),y=(1-i.x)*i.y;return r.x=p*l.x+m*c.x+y*x.x+h*d.x,r.y=p*l.y+m*c.y+y*x.y+h*d.y,r}function Bi(t,s,a){var n=a.x,i=a.y,r=a.z||0,o,l,c,d={};for(c=0;c<3;c++)if(!(s&&c===2&&a.z===void 0))switch(c===0?(o=n,"ew".indexOf(t.axis[c])!==-1?l="x":l="y"):c===1?(o=i,"ns".indexOf(t.axis[c])!==-1?l="y":l="x"):(o=r,l="z"),t.axis[c]){case"e":d[l]=o;break;case"w":d[l]=-o;break;case"n":d[l]=o;break;case"s":d[l]=-o;break;case"u":a[l]!==void 0&&(d.z=o);break;case"d":a[l]!==void 0&&(d.z=-o);break;default:return null}return d}function Dn(t){var s={x:t[0],y:t[1]};return t.length>2&&(s.z=t[2]),t.length>3&&(s.m=t[3]),s}function Co(t){Yi(t.x),Yi(t.y)}function Yi(t){if(typeof Number.isFinite=="function"){if(Number.isFinite(t))return;throw new TypeError("coordinates must be finite numbers")}if(typeof t!="number"||t!==t||!isFinite(t))throw new TypeError("coordinates must be finite numbers")}function Po(t,s){return(t.datum.datum_type===Lt||t.datum.datum_type===Bt||t.datum.datum_type===os)&&s.datumCode!=="WGS84"||(s.datum.datum_type===Lt||s.datum.datum_type===Bt||s.datum.datum_type===os)&&t.datumCode!=="WGS84"}function da(t,s,a,n){var i;Array.isArray(a)?a=Dn(a):a={x:a.x,y:a.y,z:a.z,m:a.m};var r=a.z!==void 0;if(Co(a),t.datum&&s.datum&&Po(t,s)&&(i=new gt("WGS84"),a=da(t,i,a,n),t=i),n&&t.axis!=="enu"&&(a=Bi(t,!1,a)),t.projName==="longlat")a={x:a.x*Be,y:a.y*Be,z:a.z||0};else if(t.to_meter&&(a={x:a.x*t.to_meter,y:a.y*t.to_meter,z:a.z||0}),a=t.inverse(a),!a)return;if(t.from_greenwich&&(a.x+=t.from_greenwich),a=So(t.datum,s.datum,a),!!a)return a=a,s.from_greenwich&&(a={x:a.x-s.from_greenwich,y:a.y,z:a.z||0}),s.projName==="longlat"?a={x:a.x*yt,y:a.y*yt,z:a.z||0}:(a=s.forward(a),s.to_meter&&(a={x:a.x/s.to_meter,y:a.y/s.to_meter,z:a.z||0})),n&&s.axis!=="enu"?Bi(s,!0,a):(a&&!r&&delete a.z,a)}var Xi=gt("WGS84");function Aa(t,s,a,n){var i,r,o;return Array.isArray(a)?(i=da(t,s,a,n)||{x:NaN,y:NaN},a.length>2?typeof t.name<"u"&&t.name==="geocent"||typeof s.name<"u"&&s.name==="geocent"?typeof i.z=="number"?[i.x,i.y,i.z].concat(a.slice(3)):[i.x,i.y,a[2]].concat(a.slice(3)):[i.x,i.y].concat(a.slice(2)):[i.x,i.y]):(r=da(t,s,a,n),o=Object.keys(a),o.length===2||o.forEach(function(l){if(typeof t.name<"u"&&t.name==="geocent"||typeof s.name<"u"&&s.name==="geocent"){if(l==="x"||l==="y"||l==="z")return}else if(l==="x"||l==="y")return;r[l]=a[l]}),r)}function Ws(t){return t instanceof gt?t:typeof t=="object"&&"oProj"in t?t.oProj:gt(t)}function ko(t,s,a){var n,i,r=!1,o;return typeof s>"u"?(i=Ws(t),n=Xi,r=!0):(typeof s.x<"u"||Array.isArray(s))&&(a=s,i=Ws(t),n=Xi,r=!0),n||(n=Ws(t)),i||(i=Ws(s)),a?Aa(n,i,a):(o={forward:function(l,c){return Aa(n,i,l,c)},inverse:function(l,c){return Aa(i,n,l,c)}},r&&(o.oProj=i),o)}var Wi=6,qn="AJSAJS",Un="AFAFAF",is=65,st=73,mt=79,ys=86,bs=90;const Ao={forward:Ln,inverse:Eo,toPoint:Bn};function Ln(t,s){return s=s||5,Io(Ro({lat:t[1],lon:t[0]}),s)}function Eo(t){var s=Ka(Xn(t.toUpperCase()));return s.lat&&s.lon?[s.lon,s.lat,s.lon,s.lat]:[s.left,s.bottom,s.right,s.top]}function Bn(t){var s=Ka(Xn(t.toUpperCase()));return s.lat&&s.lon?[s.lon,s.lat]:[(s.left+s.right)/2,(s.top+s.bottom)/2]}function Ea(t){return t*(Math.PI/180)}function Vi(t){return 180*(t/Math.PI)}function Ro(t){var s=t.lat,a=t.lon,n=6378137,i=.00669438,r=.9996,o,l,c,d,x,h,m,p=Ea(s),y=Ea(a),v,u;u=Math.floor((a+180)/6)+1,a===180&&(u=60),s>=56&&s<64&&a>=3&&a<12&&(u=32),s>=72&&s<84&&(a>=0&&a<9?u=31:a>=9&&a<21?u=33:a>=21&&a<33?u=35:a>=33&&a<42&&(u=37)),o=(u-1)*6-180+3,v=Ea(o),l=i/(1-i),c=n/Math.sqrt(1-i*Math.sin(p)*Math.sin(p)),d=Math.tan(p)*Math.tan(p),x=l*Math.cos(p)*Math.cos(p),h=Math.cos(p)*(y-v),m=n*((1-i/4-3*i*i/64-5*i*i*i/256)*p-(3*i/8+3*i*i/32+45*i*i*i/1024)*Math.sin(2*p)+(15*i*i/256+45*i*i*i/1024)*Math.sin(4*p)-35*i*i*i/3072*Math.sin(6*p));var j=r*c*(h+(1-d+x)*h*h*h/6+(5-18*d+d*d+72*x-58*l)*h*h*h*h*h/120)+5e5,g=r*(m+c*Math.tan(p)*(h*h/2+(5-d+9*x+4*x*x)*h*h*h*h/24+(61-58*d+d*d+600*x-330*l)*h*h*h*h*h*h/720));return s<0&&(g+=1e7),{northing:Math.round(g),easting:Math.round(j),zoneNumber:u,zoneLetter:Fo(s)}}function Ka(t){var s=t.northing,a=t.easting,n=t.zoneLetter,i=t.zoneNumber;if(i<0||i>60)return null;var r=.9996,o=6378137,l=.00669438,c,d=(1-Math.sqrt(1-l))/(1+Math.sqrt(1-l)),x,h,m,p,y,v,u,j,g,S=a-5e5,b=s;n<"N"&&(b-=1e7),u=(i-1)*6-180+3,c=l/(1-l),v=b/r,j=v/(o*(1-l/4-3*l*l/64-5*l*l*l/256)),g=j+(3*d/2-27*d*d*d/32)*Math.sin(2*j)+(21*d*d/16-55*d*d*d*d/32)*Math.sin(4*j)+151*d*d*d/96*Math.sin(6*j),x=o/Math.sqrt(1-l*Math.sin(g)*Math.sin(g)),h=Math.tan(g)*Math.tan(g),m=c*Math.cos(g)*Math.cos(g),p=o*(1-l)/Math.pow(1-l*Math.sin(g)*Math.sin(g),1.5),y=S/(x*r);var _=g-x*Math.tan(g)/p*(y*y/2-(5+3*h+10*m-4*m*m-9*c)*y*y*y*y/24+(61+90*h+298*m+45*h*h-252*c-3*m*m)*y*y*y*y*y*y/720);_=Vi(_);var w=(y-(1+2*h+m)*y*y*y/6+(5-2*m+28*h-3*m*m+8*c+24*h*h)*y*y*y*y*y/120)/Math.cos(g);w=u+Vi(w);var k;if(t.accuracy){var $=Ka({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});k={top:$.lat,right:$.lon,bottom:_,left:w}}else k={lat:_,lon:w};return k}function Fo(t){var s="Z";return 84>=t&&t>=72?s="X":72>t&&t>=64?s="W":64>t&&t>=56?s="V":56>t&&t>=48?s="U":48>t&&t>=40?s="T":40>t&&t>=32?s="S":32>t&&t>=24?s="R":24>t&&t>=16?s="Q":16>t&&t>=8?s="P":8>t&&t>=0?s="N":0>t&&t>=-8?s="M":-8>t&&t>=-16?s="L":-16>t&&t>=-24?s="K":-24>t&&t>=-32?s="J":-32>t&&t>=-40?s="H":-40>t&&t>=-48?s="G":-48>t&&t>=-56?s="F":-56>t&&t>=-64?s="E":-64>t&&t>=-72?s="D":-72>t&&t>=-80&&(s="C"),s}function Io(t,s){var a="00000"+t.easting,n="00000"+t.northing;return t.zoneNumber+t.zoneLetter+Go(t.easting,t.northing,t.zoneNumber)+a.substr(a.length-5,s)+n.substr(n.length-5,s)}function Go(t,s,a){var n=Yn(a),i=Math.floor(t/1e5),r=Math.floor(s/1e5)%20;return zo(i,r,n)}function Yn(t){var s=t%Wi;return s===0&&(s=Wi),s}function zo(t,s,a){var n=a-1,i=qn.charCodeAt(n),r=Un.charCodeAt(n),o=i+t-1,l=r+s,c=!1;o>bs&&(o=o-bs+is-1,c=!0),(o===st||i<st&&o>st||(o>st||i<st)&&c)&&o++,(o===mt||i<mt&&o>mt||(o>mt||i<mt)&&c)&&(o++,o===st&&o++),o>bs&&(o=o-bs+is-1),l>ys?(l=l-ys+is-1,c=!0):c=!1,(l===st||r<st&&l>st||(l>st||r<st)&&c)&&l++,(l===mt||r<mt&&l>mt||(l>mt||r<mt)&&c)&&(l++,l===st&&l++),l>ys&&(l=l-ys+is-1);var d=String.fromCharCode(o)+String.fromCharCode(l);return d}function Xn(t){if(t&&t.length===0)throw"MGRSPoint coverting from nothing";for(var s=t.length,a=null,n="",i,r=0;!/[A-Z]/.test(i=t.charAt(r));){if(r>=2)throw"MGRSPoint bad conversion from: "+t;n+=i,r++}var o=parseInt(n,10);if(r===0||r+3>s)throw"MGRSPoint bad conversion from: "+t;var l=t.charAt(r++);if(l<="A"||l==="B"||l==="Y"||l>="Z"||l==="I"||l==="O")throw"MGRSPoint zone letter "+l+" not handled: "+t;a=t.substring(r,r+=2);for(var c=Yn(o),d=Oo(a.charAt(0),c),x=$o(a.charAt(1),c);x<To(l);)x+=2e6;var h=s-r;if(h%2!==0)throw`MGRSPoint has to have an even number 
of digits after the zone letter and two 100km letters - front 
half for easting meters, second half for 
northing meters`+t;var m=h/2,p=0,y=0,v,u,j,g,S;return m>0&&(v=1e5/Math.pow(10,m),u=t.substring(r,r+m),p=parseFloat(u)*v,j=t.substring(r+m),y=parseFloat(j)*v),g=p+d,S=y+x,{easting:g,northing:S,zoneLetter:l,zoneNumber:o,accuracy:v}}function Oo(t,s){for(var a=qn.charCodeAt(s-1),n=1e5,i=!1;a!==t.charCodeAt(0);){if(a++,a===st&&a++,a===mt&&a++,a>bs){if(i)throw"Bad character: "+t;a=is,i=!0}n+=1e5}return n}function $o(t,s){if(t>"V")throw"MGRSPoint given invalid Northing "+t;for(var a=Un.charCodeAt(s-1),n=0,i=!1;a!==t.charCodeAt(0);){if(a++,a===st&&a++,a===mt&&a++,a>ys){if(i)throw"Bad character: "+t;a=is,i=!0}n+=1e5}return n}function To(t){var s;switch(t){case"C":s=11e5;break;case"D":s=2e6;break;case"E":s=28e5;break;case"F":s=37e5;break;case"G":s=46e5;break;case"H":s=55e5;break;case"J":s=64e5;break;case"K":s=73e5;break;case"L":s=82e5;break;case"M":s=91e5;break;case"N":s=0;break;case"P":s=8e5;break;case"Q":s=17e5;break;case"R":s=26e5;break;case"S":s=35e5;break;case"T":s=44e5;break;case"U":s=53e5;break;case"V":s=62e5;break;case"W":s=7e6;break;case"X":s=79e5;break;default:s=-1}if(s>=0)return s;throw"Invalid zone letter: "+t}function ds(t,s,a){if(!(this instanceof ds))return new ds(t,s,a);if(Array.isArray(t))this.x=t[0],this.y=t[1],this.z=t[2]||0;else if(typeof t=="object")this.x=t.x,this.y=t.y,this.z=t.z||0;else if(typeof t=="string"&&typeof s>"u"){var n=t.split(",");this.x=parseFloat(n[0]),this.y=parseFloat(n[1]),this.z=parseFloat(n[2])||0}else this.x=t,this.y=s,this.z=a||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}ds.fromMGRS=function(t){return new ds(Bn(t))};ds.prototype.toMGRS=function(t){return Ln([this.x,this.y],t)};var Do=1,qo=.25,Hi=.046875,Ji=.01953125,Zi=.01068115234375,Uo=.75,Lo=.46875,Bo=.013020833333333334,Yo=.007120768229166667,Xo=.3645833333333333,Wo=.005696614583333333,Vo=.3076171875;function Qa(t){var s=[];s[0]=Do-t*(qo+t*(Hi+t*(Ji+t*Zi))),s[1]=t*(Uo-t*(Hi+t*(Ji+t*Zi)));var a=t*t;return s[2]=a*(Lo-t*(Bo+t*Yo)),a*=t,s[3]=a*(Xo-t*Wo),s[4]=a*t*Vo,s}function hs(t,s,a,n){return a*=s,s*=s,n[0]*t-a*(n[1]+s*(n[2]+s*(n[3]+s*n[4])))}var Ho=20;function ei(t,s,a){for(var n=1/(1-s),i=t,r=Ho;r;--r){var o=Math.sin(i),l=1-s*o*o;if(l=(hs(i,o,Math.cos(i),a)-t)*(l*Math.sqrt(l))*n,i-=l,Math.abs(l)<H)return i}return i}function Jo(){this.x0=this.x0!==void 0?this.x0:0,this.y0=this.y0!==void 0?this.y0:0,this.long0=this.long0!==void 0?this.long0:0,this.lat0=this.lat0!==void 0?this.lat0:0,this.es&&(this.en=Qa(this.es),this.ml0=hs(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))}function Zo(t){var s=t.x,a=t.y,n=K(s-this.long0),i,r,o,l=Math.sin(a),c=Math.cos(a);if(this.es){var x=c*n,h=Math.pow(x,2),m=this.ep2*Math.pow(c,2),p=Math.pow(m,2),y=Math.abs(c)>H?Math.tan(a):0,v=Math.pow(y,2),u=Math.pow(v,2);i=1-this.es*Math.pow(l,2),x=x/Math.sqrt(i);var j=hs(a,l,c,this.en);r=this.a*(this.k0*x*(1+h/6*(1-v+m+h/20*(5-18*v+u+14*m-58*v*m+h/42*(61+179*u-u*v-479*v)))))+this.x0,o=this.a*(this.k0*(j-this.ml0+l*n*x/2*(1+h/12*(5-v+9*m+4*p+h/30*(61+u-58*v+270*m-330*v*m+h/56*(1385+543*u-u*v-3111*v))))))+this.y0}else{var d=c*Math.sin(n);if(Math.abs(Math.abs(d)-1)<H)return 93;if(r=.5*this.a*this.k0*Math.log((1+d)/(1-d))+this.x0,o=c*Math.cos(n)/Math.sqrt(1-Math.pow(d,2)),d=Math.abs(o),d>=1){if(d-1>H)return 93;o=0}else o=Math.acos(o);a<0&&(o=-o),o=this.a*this.k0*(o-this.lat0)+this.y0}return t.x=r,t.y=o,t}function Ko(t){var s,a,n,i,r=(t.x-this.x0)*(1/this.a),o=(t.y-this.y0)*(1/this.a);if(this.es)if(s=this.ml0+o/this.k0,a=ei(s,this.es,this.en),Math.abs(a)<L){var h=Math.sin(a),m=Math.cos(a),p=Math.abs(m)>H?Math.tan(a):0,y=this.ep2*Math.pow(m,2),v=Math.pow(y,2),u=Math.pow(p,2),j=Math.pow(u,2);s=1-this.es*Math.pow(h,2);var g=r*Math.sqrt(s)/this.k0,S=Math.pow(g,2);s=s*p,n=a-s*S/(1-this.es)*.5*(1-S/12*(5+3*u-9*y*u+y-4*v-S/30*(61+90*u-252*y*u+45*j+46*y-S/56*(1385+3633*u+4095*j+1574*j*u)))),i=K(this.long0+g*(1-S/6*(1+2*u+y-S/20*(5+28*u+24*j+8*y*u+6*y-S/42*(61+662*u+1320*j+720*j*u))))/m)}else n=L*Fs(o),i=0;else{var l=Math.exp(r/this.k0),c=.5*(l-1/l),d=this.lat0+o/this.k0,x=Math.cos(d);s=Math.sqrt((1-Math.pow(x,2))/(1+Math.pow(c,2))),n=Math.asin(s),o<0&&(n=-n),c===0&&x===0?i=0:i=K(Math.atan2(c,x)+this.long0)}return t.x=i,t.y=n,t}var Qo=["Fast_Transverse_Mercator","Fast Transverse Mercator"];const ta={init:Jo,forward:Zo,inverse:Ko,names:Qo};function Wn(t){var s=Math.exp(t);return s=(s-1/s)/2,s}function at(t,s){t=Math.abs(t),s=Math.abs(s);var a=Math.max(t,s),n=Math.min(t,s)/(a||1);return a*Math.sqrt(1+Math.pow(n,2))}function ec(t){var s=1+t,a=s-1;return a===0?t:t*Math.log(s)/a}function tc(t){var s=Math.abs(t);return s=ec(s*(1+s/(at(1,s)+1))),t<0?-s:s}function ti(t,s){for(var a=2*Math.cos(2*s),n=t.length-1,i=t[n],r=0,o;--n>=0;)o=-r+a*i+t[n],r=i,i=o;return s+o*Math.sin(2*s)}function sc(t,s){for(var a=2*Math.cos(s),n=t.length-1,i=t[n],r=0,o;--n>=0;)o=-r+a*i+t[n],r=i,i=o;return Math.sin(s)*o}function ac(t){var s=Math.exp(t);return s=(s+1/s)/2,s}function Vn(t,s,a){for(var n=Math.sin(s),i=Math.cos(s),r=Wn(a),o=ac(a),l=2*i*o,c=-2*n*r,d=t.length-1,x=t[d],h=0,m=0,p=0,y,v;--d>=0;)y=m,v=h,m=x,h=p,x=-y+l*m-c*h+t[d],p=-v+c*m+l*h;return l=n*o,c=i*r,[l*x-c*p,l*p+c*x]}function ic(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(ta.init.apply(this),this.forward=ta.forward,this.inverse=ta.inverse),this.x0=this.x0!==void 0?this.x0:0,this.y0=this.y0!==void 0?this.y0:0,this.long0=this.long0!==void 0?this.long0:0,this.lat0=this.lat0!==void 0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var t=this.es/(1+Math.sqrt(1-this.es)),s=t/(2-t),a=s;this.cgb[0]=s*(2+s*(-2/3+s*(-2+s*(116/45+s*(26/45+s*(-2854/675)))))),this.cbg[0]=s*(-2+s*(2/3+s*(4/3+s*(-82/45+s*(32/45+s*(4642/4725)))))),a=a*s,this.cgb[1]=a*(7/3+s*(-8/5+s*(-227/45+s*(2704/315+s*(2323/945))))),this.cbg[1]=a*(5/3+s*(-16/15+s*(-13/9+s*(904/315+s*(-1522/945))))),a=a*s,this.cgb[2]=a*(56/15+s*(-136/35+s*(-1262/105+s*(73814/2835)))),this.cbg[2]=a*(-26/15+s*(34/21+s*(8/5+s*(-12686/2835)))),a=a*s,this.cgb[3]=a*(4279/630+s*(-332/35+s*(-399572/14175))),this.cbg[3]=a*(1237/630+s*(-12/5+s*(-24832/14175))),a=a*s,this.cgb[4]=a*(4174/315+s*(-144838/6237)),this.cbg[4]=a*(-734/315+s*(109598/31185)),a=a*s,this.cgb[5]=a*(601676/22275),this.cbg[5]=a*(444337/155925),a=Math.pow(s,2),this.Qn=this.k0/(1+s)*(1+a*(1/4+a*(1/64+a/256))),this.utg[0]=s*(-.5+s*(2/3+s*(-37/96+s*(1/360+s*(81/512+s*(-96199/604800)))))),this.gtu[0]=s*(.5+s*(-2/3+s*(5/16+s*(41/180+s*(-127/288+s*(7891/37800)))))),this.utg[1]=a*(-1/48+s*(-1/15+s*(437/1440+s*(-46/105+s*(1118711/3870720))))),this.gtu[1]=a*(13/48+s*(-3/5+s*(557/1440+s*(281/630+s*(-1983433/1935360))))),a=a*s,this.utg[2]=a*(-17/480+s*(37/840+s*(209/4480+s*(-5569/90720)))),this.gtu[2]=a*(61/240+s*(-103/140+s*(15061/26880+s*(167603/181440)))),a=a*s,this.utg[3]=a*(-4397/161280+s*(11/504+s*(830251/7257600))),this.gtu[3]=a*(49561/161280+s*(-179/168+s*(6601661/7257600))),a=a*s,this.utg[4]=a*(-4583/161280+s*(108847/3991680)),this.gtu[4]=a*(34729/80640+s*(-3418889/1995840)),a=a*s,this.utg[5]=a*(-20648693/638668800),this.gtu[5]=a*(212378941/319334400);var n=ti(this.cbg,this.lat0);this.Zb=-this.Qn*(n+sc(this.gtu,2*n))}function nc(t){var s=K(t.x-this.long0),a=t.y;a=ti(this.cbg,a);var n=Math.sin(a),i=Math.cos(a),r=Math.sin(s),o=Math.cos(s);a=Math.atan2(n,o*i),s=Math.atan2(r*i,at(n,i*o)),s=tc(Math.tan(s));var l=Vn(this.gtu,2*a,2*s);a=a+l[0],s=s+l[1];var c,d;return Math.abs(s)<=2.623395162778?(c=this.a*(this.Qn*s)+this.x0,d=this.a*(this.Qn*a+this.Zb)+this.y0):(c=1/0,d=1/0),t.x=c,t.y=d,t}function rc(t){var s=(t.x-this.x0)*(1/this.a),a=(t.y-this.y0)*(1/this.a);a=(a-this.Zb)/this.Qn,s=s/this.Qn;var n,i;if(Math.abs(s)<=2.623395162778){var r=Vn(this.utg,2*a,2*s);a=a+r[0],s=s+r[1],s=Math.atan(Wn(s));var o=Math.sin(a),l=Math.cos(a),c=Math.sin(s),d=Math.cos(s);a=Math.atan2(o*d,at(c,d*l)),s=Math.atan2(c,d*l),n=K(s+this.long0),i=ti(this.cgb,a)}else n=1/0,i=1/0;return t.x=n,t.y=i,t}var lc=["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","Gauss Kruger","Gauss_Kruger","tmerc"];const sa={init:ic,forward:nc,inverse:rc,names:lc};function oc(t,s){if(t===void 0){if(t=Math.floor((K(s)+Math.PI)*30/Math.PI)+1,t<0)return 0;if(t>60)return 60}return t}var cc="etmerc";function dc(){var t=oc(this.zone,this.long0);if(t===void 0)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(t)-183)*Be,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,sa.init.apply(this),this.forward=sa.forward,this.inverse=sa.inverse}var hc=["Universal Transverse Mercator System","utm"];const mc={init:dc,names:hc,dependsOn:cc};function si(t,s){return Math.pow((1-t)/(1+t),s)}var xc=20;function uc(){var t=Math.sin(this.lat0),s=Math.cos(this.lat0);s*=s,this.rc=Math.sqrt(1-this.es)/(1-this.es*t*t),this.C=Math.sqrt(1+this.es*s*s/(1-this.es)),this.phic0=Math.asin(t/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Ne)/(Math.pow(Math.tan(.5*this.lat0+Ne),this.C)*si(this.e*t,this.ratexp))}function gc(t){var s=t.x,a=t.y;return t.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*a+Ne),this.C)*si(this.e*Math.sin(a),this.ratexp))-L,t.x=this.C*s,t}function fc(t){for(var s=1e-14,a=t.x/this.C,n=t.y,i=Math.pow(Math.tan(.5*n+Ne)/this.K,1/this.C),r=xc;r>0&&(n=2*Math.atan(i*si(this.e*Math.sin(t.y),-.5*this.e))-L,!(Math.abs(n-t.y)<s));--r)t.y=n;return r?(t.x=a,t.y=n,t):null}const ai={init:uc,forward:gc,inverse:fc};function pc(){ai.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))}function yc(t){var s,a,n,i;return t.x=K(t.x-this.long0),ai.forward.apply(this,[t]),s=Math.sin(t.y),a=Math.cos(t.y),n=Math.cos(t.x),i=this.k0*this.R2/(1+this.sinc0*s+this.cosc0*a*n),t.x=i*a*Math.sin(t.x),t.y=i*(this.cosc0*s-this.sinc0*a*n),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t}function bc(t){var s,a,n,i,r;if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,r=at(t.x,t.y)){var o=2*Math.atan2(r,this.R2);s=Math.sin(o),a=Math.cos(o),i=Math.asin(a*this.sinc0+t.y*s*this.cosc0/r),n=Math.atan2(t.x*s,r*this.cosc0*a-t.y*this.sinc0*s)}else i=this.phic0,n=0;return t.x=n,t.y=i,ai.inverse.apply(this,[t]),t.x=K(t.x+this.long0),t}var vc=["Stereographic_North_Pole","Oblique_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"];const jc={init:pc,forward:yc,inverse:bc,names:vc};function ii(t,s,a){return s*=a,Math.tan(.5*(L+t))*Math.pow((1-s)/(1+s),.5*a)}function Nc(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?this.k0===1&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=H&&(this.k0=.5*(1+Fs(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=H&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),this.k0===1&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=H&&Math.abs(Math.cos(this.lat_ts))>H&&(this.k0=.5*this.cons*bt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/ut(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=bt(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(ii(this.lat0,this.sinlat0,this.e))-L,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))}function wc(t){var s=t.x,a=t.y,n=Math.sin(a),i=Math.cos(a),r,o,l,c,d,x,h=K(s-this.long0);return Math.abs(Math.abs(s-this.long0)-Math.PI)<=H&&Math.abs(a+this.lat0)<=H?(t.x=NaN,t.y=NaN,t):this.sphere?(r=2*this.k0/(1+this.sinlat0*n+this.coslat0*i*Math.cos(h)),t.x=this.a*r*i*Math.sin(h)+this.x0,t.y=this.a*r*(this.coslat0*n-this.sinlat0*i*Math.cos(h))+this.y0,t):(o=2*Math.atan(ii(a,n,this.e))-L,c=Math.cos(o),l=Math.sin(o),Math.abs(this.coslat0)<=H?(d=ut(this.e,a*this.con,this.con*n),x=2*this.a*this.k0*d/this.cons,t.x=this.x0+x*Math.sin(s-this.long0),t.y=this.y0-this.con*x*Math.cos(s-this.long0),t):(Math.abs(this.sinlat0)<H?(r=2*this.a*this.k0/(1+c*Math.cos(h)),t.y=r*l):(r=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*l+this.cosX0*c*Math.cos(h))),t.y=r*(this.cosX0*l-this.sinX0*c*Math.cos(h))+this.y0),t.x=r*c*Math.sin(h)+this.x0,t))}function _c(t){t.x-=this.x0,t.y-=this.y0;var s,a,n,i,r,o=Math.sqrt(t.x*t.x+t.y*t.y);if(this.sphere){var l=2*Math.atan(o/(2*this.a*this.k0));return s=this.long0,a=this.lat0,o<=H?(t.x=s,t.y=a,t):(a=Math.asin(Math.cos(l)*this.sinlat0+t.y*Math.sin(l)*this.coslat0/o),Math.abs(this.coslat0)<H?this.lat0>0?s=K(this.long0+Math.atan2(t.x,-1*t.y)):s=K(this.long0+Math.atan2(t.x,t.y)):s=K(this.long0+Math.atan2(t.x*Math.sin(l),o*this.coslat0*Math.cos(l)-t.y*this.sinlat0*Math.sin(l))),t.x=s,t.y=a,t)}else if(Math.abs(this.coslat0)<=H){if(o<=H)return a=this.lat0,s=this.long0,t.x=s,t.y=a,t;t.x*=this.con,t.y*=this.con,n=o*this.cons/(2*this.a*this.k0),a=this.con*As(this.e,n),s=this.con*K(this.con*this.long0+Math.atan2(t.x,-1*t.y))}else i=2*Math.atan(o*this.cosX0/(2*this.a*this.k0*this.ms1)),s=this.long0,o<=H?r=this.X0:(r=Math.asin(Math.cos(i)*this.sinX0+t.y*Math.sin(i)*this.cosX0/o),s=K(this.long0+Math.atan2(t.x*Math.sin(i),o*this.cosX0*Math.cos(i)-t.y*this.sinX0*Math.sin(i)))),a=-1*As(this.e,Math.tan(.5*(L+r)));return t.x=s,t.y=a,t}var Sc=["stere","Stereographic_South_Pole","Polar_Stereographic_variant_A","Polar_Stereographic_variant_B","Polar_Stereographic"];const Mc={init:Nc,forward:wc,inverse:_c,names:Sc,ssfn_:ii};function Cc(){var t=this.lat0;this.lambda0=this.long0;var s=Math.sin(t),a=this.a,n=this.rf,i=1/n,r=2*i-Math.pow(i,2),o=this.e=Math.sqrt(r);this.R=this.k0*a*Math.sqrt(1-r)/(1-r*Math.pow(s,2)),this.alpha=Math.sqrt(1+r/(1-r)*Math.pow(Math.cos(t),4)),this.b0=Math.asin(s/this.alpha);var l=Math.log(Math.tan(Math.PI/4+this.b0/2)),c=Math.log(Math.tan(Math.PI/4+t/2)),d=Math.log((1+o*s)/(1-o*s));this.K=l-this.alpha*c+this.alpha*o/2*d}function Pc(t){var s=Math.log(Math.tan(Math.PI/4-t.y/2)),a=this.e/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y))),n=-this.alpha*(s+a)+this.K,i=2*(Math.atan(Math.exp(n))-Math.PI/4),r=this.alpha*(t.x-this.lambda0),o=Math.atan(Math.sin(r)/(Math.sin(this.b0)*Math.tan(i)+Math.cos(this.b0)*Math.cos(r))),l=Math.asin(Math.cos(this.b0)*Math.sin(i)-Math.sin(this.b0)*Math.cos(i)*Math.cos(r));return t.y=this.R/2*Math.log((1+Math.sin(l))/(1-Math.sin(l)))+this.y0,t.x=this.R*o+this.x0,t}function kc(t){for(var s=t.x-this.x0,a=t.y-this.y0,n=s/this.R,i=2*(Math.atan(Math.exp(a/this.R))-Math.PI/4),r=Math.asin(Math.cos(this.b0)*Math.sin(i)+Math.sin(this.b0)*Math.cos(i)*Math.cos(n)),o=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(i))),l=this.lambda0+o/this.alpha,c=0,d=r,x=-1e3,h=0;Math.abs(d-x)>1e-7;){if(++h>20)return;c=1/this.alpha*(Math.log(Math.tan(Math.PI/4+r/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(d))/2)),x=d,d=2*Math.atan(Math.exp(c))-Math.PI/2}return t.x=l,t.y=d,t}var Ac=["somerc"];const Ec={init:Cc,forward:Pc,inverse:kc,names:Ac};var ts=1e-7;function Rc(t){var s=["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_variant_A","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"],a=typeof t.projName=="object"?Object.keys(t.projName)[0]:t.projName;return"no_uoff"in t||"no_off"in t||s.indexOf(a)!==-1||s.indexOf(zn(a))!==-1}function Fc(){var t,s,a,n,i,r,o,l,c,d,x=0,h,m=0,p=0,y=0,v=0,u=0,j=0;this.no_off=Rc(this),this.no_rot="no_rot"in this;var g=!1;"alpha"in this&&(g=!0);var S=!1;if("rectified_grid_angle"in this&&(S=!0),g&&(j=this.alpha),S&&(x=this.rectified_grid_angle),g||S)m=this.longc;else if(p=this.long1,v=this.lat1,y=this.long2,u=this.lat2,Math.abs(v-u)<=ts||(t=Math.abs(v))<=ts||Math.abs(t-L)<=ts||Math.abs(Math.abs(this.lat0)-L)<=ts||Math.abs(Math.abs(u)-L)<=ts)throw new Error;var b=1-this.es;s=Math.sqrt(b),Math.abs(this.lat0)>H?(l=Math.sin(this.lat0),a=Math.cos(this.lat0),t=1-this.es*l*l,this.B=a*a,this.B=Math.sqrt(1+this.es*this.B*this.B/b),this.A=this.B*this.k0*s/t,n=this.B*s/(a*Math.sqrt(t)),i=n*n-1,i<=0?i=0:(i=Math.sqrt(i),this.lat0<0&&(i=-i)),this.E=i+=n,this.E*=Math.pow(ut(this.e,this.lat0,l),this.B)):(this.B=1/s,this.A=this.k0,this.E=n=i=1),g||S?(g?(h=Math.asin(Math.sin(j)/n),S||(x=j)):(h=x,j=Math.asin(n*Math.sin(h))),this.lam0=m-Math.asin(.5*(i-1/i)*Math.tan(h))/this.B):(r=Math.pow(ut(this.e,v,Math.sin(v)),this.B),o=Math.pow(ut(this.e,u,Math.sin(u)),this.B),i=this.E/r,c=(o-r)/(o+r),d=this.E*this.E,d=(d-o*r)/(d+o*r),t=p-y,t<-Math.PI?y-=Ps:t>Math.PI&&(y+=Ps),this.lam0=K(.5*(p+y)-Math.atan(d*Math.tan(.5*this.B*(p-y))/c)/this.B),h=Math.atan(2*Math.sin(this.B*K(p-this.lam0))/(i-1/i)),x=j=Math.asin(n*Math.sin(h))),this.singam=Math.sin(h),this.cosgam=Math.cos(h),this.sinrot=Math.sin(x),this.cosrot=Math.cos(x),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(n*n-1)/Math.cos(j))),this.lat0<0&&(this.u_0=-this.u_0)),i=.5*h,this.v_pole_n=this.ArB*Math.log(Math.tan(Ne-i)),this.v_pole_s=this.ArB*Math.log(Math.tan(Ne+i))}function Ic(t){var s={},a,n,i,r,o,l,c,d;if(t.x=t.x-this.lam0,Math.abs(Math.abs(t.y)-L)>H){if(o=this.E/Math.pow(ut(this.e,t.y,Math.sin(t.y)),this.B),l=1/o,a=.5*(o-l),n=.5*(o+l),r=Math.sin(this.B*t.x),i=(a*this.singam-r*this.cosgam)/n,Math.abs(Math.abs(i)-1)<H)throw new Error;d=.5*this.ArB*Math.log((1-i)/(1+i)),l=Math.cos(this.B*t.x),Math.abs(l)<ts?c=this.A*t.x:c=this.ArB*Math.atan2(a*this.cosgam+r*this.singam,l)}else d=t.y>0?this.v_pole_n:this.v_pole_s,c=this.ArB*t.y;return this.no_rot?(s.x=c,s.y=d):(c-=this.u_0,s.x=d*this.cosrot+c*this.sinrot,s.y=c*this.cosrot-d*this.sinrot),s.x=this.a*s.x+this.x0,s.y=this.a*s.y+this.y0,s}function Gc(t){var s,a,n,i,r,o,l,c={};if(t.x=(t.x-this.x0)*(1/this.a),t.y=(t.y-this.y0)*(1/this.a),this.no_rot?(a=t.y,s=t.x):(a=t.x*this.cosrot-t.y*this.sinrot,s=t.y*this.cosrot+t.x*this.sinrot+this.u_0),n=Math.exp(-this.BrA*a),i=.5*(n-1/n),r=.5*(n+1/n),o=Math.sin(this.BrA*s),l=(o*this.cosgam+i*this.singam)/r,Math.abs(Math.abs(l)-1)<H)c.x=0,c.y=l<0?-L:L;else{if(c.y=this.E/Math.sqrt((1+l)/(1-l)),c.y=As(this.e,Math.pow(c.y,1/this.B)),c.y===1/0)throw new Error;c.x=-this.rB*Math.atan2(i*this.cosgam-o*this.singam,Math.cos(this.BrA*s))}return c.x+=this.lam0,c}var zc=["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_variant_A","Hotine_Oblique_Mercator_Variant_B","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"];const Oc={init:Fc,forward:Ic,inverse:Gc,names:zc};function $c(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<H)){var t=this.b/this.a;this.e=Math.sqrt(1-t*t);var s=Math.sin(this.lat1),a=Math.cos(this.lat1),n=bt(this.e,s,a),i=ut(this.e,this.lat1,s),r=Math.sin(this.lat2),o=Math.cos(this.lat2),l=bt(this.e,r,o),c=ut(this.e,this.lat2,r),d=Math.abs(Math.abs(this.lat0)-L)<H?0:ut(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>H?this.ns=Math.log(n/l)/Math.log(i/c):this.ns=s,isNaN(this.ns)&&(this.ns=s),this.f0=n/(this.ns*Math.pow(i,this.ns)),this.rh=this.a*this.f0*Math.pow(d,this.ns),this.title||(this.title="Lambert Conformal Conic")}}function Tc(t){var s=t.x,a=t.y;Math.abs(2*Math.abs(a)-Math.PI)<=H&&(a=Fs(a)*(L-2*H));var n=Math.abs(Math.abs(a)-L),i,r;if(n>H)i=ut(this.e,a,Math.sin(a)),r=this.a*this.f0*Math.pow(i,this.ns);else{if(n=a*this.ns,n<=0)return null;r=0}var o=this.ns*K(s-this.long0);return t.x=this.k0*(r*Math.sin(o))+this.x0,t.y=this.k0*(this.rh-r*Math.cos(o))+this.y0,t}function Dc(t){var s,a,n,i,r,o=(t.x-this.x0)/this.k0,l=this.rh-(t.y-this.y0)/this.k0;this.ns>0?(s=Math.sqrt(o*o+l*l),a=1):(s=-Math.sqrt(o*o+l*l),a=-1);var c=0;if(s!==0&&(c=Math.atan2(a*o,a*l)),s!==0||this.ns>0){if(a=1/this.ns,n=Math.pow(s/(this.a*this.f0),a),i=As(this.e,n),i===-9999)return null}else i=-L;return r=K(c/this.ns+this.long0),t.x=r,t.y=i,t}var qc=["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc","Lambert Conic Conformal (1SP)","Lambert Conic Conformal (2SP)"];const Uc={init:$c,forward:Tc,inverse:Dc,names:qc};function Lc(){this.a=6377397155e-3,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.7417649320975901-.308341501185665),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq}function Bc(t){var s,a,n,i,r,o,l,c=t.x,d=t.y,x=K(c-this.long0);return s=Math.pow((1+this.e*Math.sin(d))/(1-this.e*Math.sin(d)),this.alfa*this.e/2),a=2*(Math.atan(this.k*Math.pow(Math.tan(d/2+this.s45),this.alfa)/s)-this.s45),n=-x*this.alfa,i=Math.asin(Math.cos(this.ad)*Math.sin(a)+Math.sin(this.ad)*Math.cos(a)*Math.cos(n)),r=Math.asin(Math.cos(a)*Math.sin(n)/Math.cos(i)),o=this.n*r,l=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(i/2+this.s45),this.n),t.y=l*Math.cos(o)/1,t.x=l*Math.sin(o)/1,this.czech||(t.y*=-1,t.x*=-1),t}function Yc(t){var s,a,n,i,r,o,l,c,d=t.x;t.x=t.y,t.y=d,this.czech||(t.y*=-1,t.x*=-1),o=Math.sqrt(t.x*t.x+t.y*t.y),r=Math.atan2(t.y,t.x),i=r/Math.sin(this.s0),n=2*(Math.atan(Math.pow(this.ro0/o,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),s=Math.asin(Math.cos(this.ad)*Math.sin(n)-Math.sin(this.ad)*Math.cos(n)*Math.cos(i)),a=Math.asin(Math.cos(n)*Math.sin(i)/Math.cos(s)),t.x=this.long0-a/this.alfa,l=s,c=0;var x=0;do t.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(s/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.e/2))-this.s45),Math.abs(l-t.y)<1e-10&&(c=1),l=t.y,x+=1;while(c===0&&x<15);return x>=15?null:t}var Xc=["Krovak","krovak"];const Wc={init:Lc,forward:Bc,inverse:Yc,names:Xc};function Ke(t,s,a,n,i){return t*i-s*Math.sin(2*i)+a*Math.sin(4*i)-n*Math.sin(6*i)}function Is(t){return 1-.25*t*(1+t/16*(3+1.25*t))}function Gs(t){return .375*t*(1+.25*t*(1+.46875*t))}function zs(t){return .05859375*t*t*(1+.75*t)}function Os(t){return t*t*t*(35/3072)}function ni(t,s,a){var n=s*a;return t/Math.sqrt(1-n*n)}function $t(t){return Math.abs(t)<L?t:t-Fs(t)*Math.PI}function ha(t,s,a,n,i){var r,o;r=t/s;for(var l=0;l<15;l++)if(o=(t-(s*r-a*Math.sin(2*r)+n*Math.sin(4*r)-i*Math.sin(6*r)))/(s-2*a*Math.cos(2*r)+4*n*Math.cos(4*r)-6*i*Math.cos(6*r)),r+=o,Math.abs(o)<=1e-10)return r;return NaN}function Vc(){this.sphere||(this.e0=Is(this.es),this.e1=Gs(this.es),this.e2=zs(this.es),this.e3=Os(this.es),this.ml0=this.a*Ke(this.e0,this.e1,this.e2,this.e3,this.lat0))}function Hc(t){var s,a,n=t.x,i=t.y;if(n=K(n-this.long0),this.sphere)s=this.a*Math.asin(Math.cos(i)*Math.sin(n)),a=this.a*(Math.atan2(Math.tan(i),Math.cos(n))-this.lat0);else{var r=Math.sin(i),o=Math.cos(i),l=ni(this.a,this.e,r),c=Math.tan(i)*Math.tan(i),d=n*Math.cos(i),x=d*d,h=this.es*o*o/(1-this.es),m=this.a*Ke(this.e0,this.e1,this.e2,this.e3,i);s=l*d*(1-x*c*(1/6-(8-c+8*h)*x/120)),a=m-this.ml0+l*r/o*x*(.5+(5-c+6*h)*x/24)}return t.x=s+this.x0,t.y=a+this.y0,t}function Jc(t){t.x-=this.x0,t.y-=this.y0;var s=t.x/this.a,a=t.y/this.a,n,i;if(this.sphere){var r=a+this.lat0;n=Math.asin(Math.sin(r)*Math.cos(s)),i=Math.atan2(Math.tan(s),Math.cos(r))}else{var o=this.ml0/this.a+a,l=ha(o,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(l)-L)<=H)return t.x=this.long0,t.y=L,a<0&&(t.y*=-1),t;var c=ni(this.a,this.e,Math.sin(l)),d=c*c*c/this.a/this.a*(1-this.es),x=Math.pow(Math.tan(l),2),h=s*this.a/c,m=h*h;n=l-c*Math.tan(l)/d*h*h*(.5-(1+3*x)*h*h/24),i=h*(1-m*(x/3+(1+3*x)*x*m/15))/Math.cos(l)}return t.x=K(i+this.long0),t.y=$t(n),t}var Zc=["Cassini","Cassini_Soldner","cass"];const Kc={init:Vc,forward:Hc,inverse:Jc,names:Zc};function Ft(t,s){var a;return t>1e-7?(a=t*s,(1-t*t)*(s/(1-a*a)-.5/t*Math.log((1-a)/(1+a)))):2*s}var Ta=1,Da=2,qa=3,aa=4;function Qc(){var t=Math.abs(this.lat0);if(Math.abs(t-L)<H?this.mode=this.lat0<0?Ta:Da:Math.abs(t)<H?this.mode=qa:this.mode=aa,this.es>0){var s;switch(this.qp=Ft(this.e,1),this.mmf=.5/(1-this.es),this.apa=od(this.es),this.mode){case Da:this.dd=1;break;case Ta:this.dd=1;break;case qa:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case aa:this.rq=Math.sqrt(.5*this.qp),s=Math.sin(this.lat0),this.sinb1=Ft(this.e,s)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*s*s)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd;break}}else this.mode===aa&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))}function ed(t){var s,a,n,i,r,o,l,c,d,x,h=t.x,m=t.y;if(h=K(h-this.long0),this.sphere){if(r=Math.sin(m),x=Math.cos(m),n=Math.cos(h),this.mode===this.OBLIQ||this.mode===this.EQUIT){if(a=this.mode===this.EQUIT?1+x*n:1+this.sinph0*r+this.cosph0*x*n,a<=H)return null;a=Math.sqrt(2/a),s=a*x*Math.sin(h),a*=this.mode===this.EQUIT?r:this.cosph0*r-this.sinph0*x*n}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(n=-n),Math.abs(m+this.lat0)<H)return null;a=Ne-m*.5,a=2*(this.mode===this.S_POLE?Math.cos(a):Math.sin(a)),s=a*Math.sin(h),a*=n}}else{switch(l=0,c=0,d=0,n=Math.cos(h),i=Math.sin(h),r=Math.sin(m),o=Ft(this.e,r),(this.mode===this.OBLIQ||this.mode===this.EQUIT)&&(l=o/this.qp,c=Math.sqrt(1-l*l)),this.mode){case this.OBLIQ:d=1+this.sinb1*l+this.cosb1*c*n;break;case this.EQUIT:d=1+c*n;break;case this.N_POLE:d=L+m,o=this.qp-o;break;case this.S_POLE:d=m-L,o=this.qp+o;break}if(Math.abs(d)<H)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:d=Math.sqrt(2/d),this.mode===this.OBLIQ?a=this.ymf*d*(this.cosb1*l-this.sinb1*c*n):a=(d=Math.sqrt(2/(1+c*n)))*l*this.ymf,s=this.xmf*d*c*i;break;case this.N_POLE:case this.S_POLE:o>=0?(s=(d=Math.sqrt(o))*i,a=n*(this.mode===this.S_POLE?d:-d)):s=a=0;break}}return t.x=this.a*s+this.x0,t.y=this.a*a+this.y0,t}function td(t){t.x-=this.x0,t.y-=this.y0;var s=t.x/this.a,a=t.y/this.a,n,i,r,o,l,c,d;if(this.sphere){var x=0,h,m=0;if(h=Math.sqrt(s*s+a*a),i=h*.5,i>1)return null;switch(i=2*Math.asin(i),(this.mode===this.OBLIQ||this.mode===this.EQUIT)&&(m=Math.sin(i),x=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(h)<=H?0:Math.asin(a*m/h),s*=m,a=x*h;break;case this.OBLIQ:i=Math.abs(h)<=H?this.lat0:Math.asin(x*this.sinph0+a*m*this.cosph0/h),s*=m*this.cosph0,a=(x-Math.sin(i)*this.sinph0)*h;break;case this.N_POLE:a=-a,i=L-i;break;case this.S_POLE:i-=L;break}n=a===0&&(this.mode===this.EQUIT||this.mode===this.OBLIQ)?0:Math.atan2(s,a)}else{if(d=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(s/=this.dd,a*=this.dd,c=Math.sqrt(s*s+a*a),c<H)return t.x=this.long0,t.y=this.lat0,t;o=2*Math.asin(.5*c/this.rq),r=Math.cos(o),s*=o=Math.sin(o),this.mode===this.OBLIQ?(d=r*this.sinb1+a*o*this.cosb1/c,l=this.qp*d,a=c*this.cosb1*r-a*this.sinb1*o):(d=a*o/c,l=this.qp*d,a=c*r)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(a=-a),l=s*s+a*a,!l)return t.x=this.long0,t.y=this.lat0,t;d=1-l/this.qp,this.mode===this.S_POLE&&(d=-d)}n=Math.atan2(s,a),i=cd(Math.asin(d),this.apa)}return t.x=K(this.long0+n),t.y=i,t}var sd=.3333333333333333,ad=.17222222222222222,id=.10257936507936508,nd=.06388888888888888,rd=.0664021164021164,ld=.016415012942191543;function od(t){var s,a=[];return a[0]=t*sd,s=t*t,a[0]+=s*ad,a[1]=s*nd,s*=t,a[0]+=s*id,a[1]+=s*rd,a[2]=s*ld,a}function cd(t,s){var a=t+t;return t+s[0]*Math.sin(a)+s[1]*Math.sin(a+a)+s[2]*Math.sin(a+a+a)}var dd=["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"];const hd={init:Qc,forward:ed,inverse:td,names:dd,S_POLE:Ta,N_POLE:Da,EQUIT:qa,OBLIQ:aa};function zt(t){return Math.abs(t)>1&&(t=t>1?1:-1),Math.asin(t)}function md(){Math.abs(this.lat1+this.lat2)<H||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=bt(this.e3,this.sin_po,this.cos_po),this.qs1=Ft(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=bt(this.e3,this.sin_po,this.cos_po),this.qs2=Ft(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Ft(this.e3,this.sin_po),Math.abs(this.lat1-this.lat2)>H?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)}function xd(t){var s=t.x,a=t.y;this.sin_phi=Math.sin(a),this.cos_phi=Math.cos(a);var n=Ft(this.e3,this.sin_phi),i=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,r=this.ns0*K(s-this.long0),o=i*Math.sin(r)+this.x0,l=this.rh-i*Math.cos(r)+this.y0;return t.x=o,t.y=l,t}function ud(t){var s,a,n,i,r,o;return t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns0>=0?(s=Math.sqrt(t.x*t.x+t.y*t.y),n=1):(s=-Math.sqrt(t.x*t.x+t.y*t.y),n=-1),i=0,s!==0&&(i=Math.atan2(n*t.x,n*t.y)),n=s*this.ns0/this.a,this.sphere?o=Math.asin((this.c-n*n)/(2*this.ns0)):(a=(this.c-n*n)/this.ns0,o=this.phi1z(this.e3,a)),r=K(i/this.ns0+this.long0),t.x=r,t.y=o,t}function gd(t,s){var a,n,i,r,o,l=zt(.5*s);if(t<H)return l;for(var c=t*t,d=1;d<=25;d++)if(a=Math.sin(l),n=Math.cos(l),i=t*a,r=1-i*i,o=.5*r*r/n*(s/(1-c)-a/r+.5/t*Math.log((1-i)/(1+i))),l=l+o,Math.abs(o)<=1e-7)return l;return null}var fd=["Albers_Conic_Equal_Area","Albers_Equal_Area","Albers","aea"];const pd={init:md,forward:xd,inverse:ud,names:fd,phi1z:gd};function yd(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1}function bd(t){var s,a,n,i,r,o,l,c,d=t.x,x=t.y;return n=K(d-this.long0),s=Math.sin(x),a=Math.cos(x),i=Math.cos(n),o=this.sin_p14*s+this.cos_p14*a*i,r=1,o>0||Math.abs(o)<=H?(l=this.x0+this.a*r*a*Math.sin(n)/o,c=this.y0+this.a*r*(this.cos_p14*s-this.sin_p14*a*i)/o):(l=this.x0+this.infinity_dist*a*Math.sin(n),c=this.y0+this.infinity_dist*(this.cos_p14*s-this.sin_p14*a*i)),t.x=l,t.y=c,t}function vd(t){var s,a,n,i,r,o;return t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,(s=Math.sqrt(t.x*t.x+t.y*t.y))?(i=Math.atan2(s,this.rc),a=Math.sin(i),n=Math.cos(i),o=zt(n*this.sin_p14+t.y*a*this.cos_p14/s),r=Math.atan2(t.x*a,s*this.cos_p14*n-t.y*this.sin_p14*a),r=K(this.long0+r)):(o=this.phic0,r=0),t.x=r,t.y=o,t}var jd=["gnom"];const Nd={init:yd,forward:bd,inverse:vd,names:jd};function wd(t,s){var a=1-(1-t*t)/(2*t)*Math.log((1-t)/(1+t));if(Math.abs(Math.abs(s)-a)<1e-6)return s<0?-1*L:L;for(var n=Math.asin(.5*s),i,r,o,l,c=0;c<30;c++)if(r=Math.sin(n),o=Math.cos(n),l=t*r,i=Math.pow(1-l*l,2)/(2*o)*(s/(1-t*t)-r/(1-l*l)+.5/t*Math.log((1-l)/(1+l))),n+=i,Math.abs(i)<=1e-10)return n;return NaN}function _d(){this.sphere||(this.k0=bt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))}function Sd(t){var s=t.x,a=t.y,n,i,r=K(s-this.long0);if(this.sphere)n=this.x0+this.a*r*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(a)/Math.cos(this.lat_ts);else{var o=Ft(this.e,Math.sin(a));n=this.x0+this.a*this.k0*r,i=this.y0+this.a*o*.5/this.k0}return t.x=n,t.y=i,t}function Md(t){t.x-=this.x0,t.y-=this.y0;var s,a;return this.sphere?(s=K(this.long0+t.x/this.a/Math.cos(this.lat_ts)),a=Math.asin(t.y/this.a*Math.cos(this.lat_ts))):(a=wd(this.e,2*t.y*this.k0/this.a),s=K(this.long0+t.x/(this.a*this.k0))),t.x=s,t.y=a,t}var Cd=["cea"];const Pd={init:_d,forward:Sd,inverse:Md,names:Cd};function kd(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)}function Ad(t){var s=t.x,a=t.y,n=K(s-this.long0),i=$t(a-this.lat0);return t.x=this.x0+this.a*n*this.rc,t.y=this.y0+this.a*i,t}function Ed(t){var s=t.x,a=t.y;return t.x=K(this.long0+(s-this.x0)/(this.a*this.rc)),t.y=$t(this.lat0+(a-this.y0)/this.a),t}var Rd=["Equirectangular","Equidistant_Cylindrical","Equidistant_Cylindrical_Spherical","eqc"];const Fd={init:kd,forward:Ad,inverse:Ed,names:Rd};var Ki=20;function Id(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Is(this.es),this.e1=Gs(this.es),this.e2=zs(this.es),this.e3=Os(this.es),this.ml0=this.a*Ke(this.e0,this.e1,this.e2,this.e3,this.lat0)}function Gd(t){var s=t.x,a=t.y,n,i,r,o=K(s-this.long0);if(r=o*Math.sin(a),this.sphere)Math.abs(a)<=H?(n=this.a*o,i=-1*this.a*this.lat0):(n=this.a*Math.sin(r)/Math.tan(a),i=this.a*($t(a-this.lat0)+(1-Math.cos(r))/Math.tan(a)));else if(Math.abs(a)<=H)n=this.a*o,i=-1*this.ml0;else{var l=ni(this.a,this.e,Math.sin(a))/Math.tan(a);n=l*Math.sin(r),i=this.a*Ke(this.e0,this.e1,this.e2,this.e3,a)-this.ml0+l*(1-Math.cos(r))}return t.x=n+this.x0,t.y=i+this.y0,t}function zd(t){var s,a,n,i,r,o,l,c,d;if(n=t.x-this.x0,i=t.y-this.y0,this.sphere)if(Math.abs(i+this.a*this.lat0)<=H)s=K(n/this.a+this.long0),a=0;else{o=this.lat0+i/this.a,l=n*n/this.a/this.a+o*o,c=o;var x;for(r=Ki;r;--r)if(x=Math.tan(c),d=-1*(o*(c*x+1)-c-.5*(c*c+l)*x)/((c-o)/x-1),c+=d,Math.abs(d)<=H){a=c;break}s=K(this.long0+Math.asin(n*Math.tan(c)/this.a)/Math.sin(a))}else if(Math.abs(i+this.ml0)<=H)a=0,s=K(this.long0+n/this.a);else{o=(this.ml0+i)/this.a,l=n*n/this.a/this.a+o*o,c=o;var h,m,p,y,v;for(r=Ki;r;--r)if(v=this.e*Math.sin(c),h=Math.sqrt(1-v*v)*Math.tan(c),m=this.a*Ke(this.e0,this.e1,this.e2,this.e3,c),p=this.e0-2*this.e1*Math.cos(2*c)+4*this.e2*Math.cos(4*c)-6*this.e3*Math.cos(6*c),y=m/this.a,d=(o*(h*y+1)-y-.5*h*(y*y+l))/(this.es*Math.sin(2*c)*(y*y+l-2*o*y)/(4*h)+(o-y)*(h*p-2/Math.sin(2*c))-p),c-=d,Math.abs(d)<=H){a=c;break}h=Math.sqrt(1-this.es*Math.pow(Math.sin(a),2))*Math.tan(a),s=K(this.long0+Math.asin(n*h/this.a)/Math.sin(a))}return t.x=s,t.y=a,t}var Od=["Polyconic","American_Polyconic","poly"];const $d={init:Id,forward:Gd,inverse:zd,names:Od};function Td(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013}function Dd(t){var s,a=t.x,n=t.y,i=n-this.lat0,r=a-this.long0,o=i/Ns*1e-5,l=r,c=1,d=0;for(s=1;s<=10;s++)c=c*o,d=d+this.A[s]*c;var x=d,h=l,m=1,p=0,y,v,u=0,j=0;for(s=1;s<=6;s++)y=m*x-p*h,v=p*x+m*h,m=y,p=v,u=u+this.B_re[s]*m-this.B_im[s]*p,j=j+this.B_im[s]*m+this.B_re[s]*p;return t.x=j*this.a+this.x0,t.y=u*this.a+this.y0,t}function qd(t){var s,a=t.x,n=t.y,i=a-this.x0,r=n-this.y0,o=r/this.a,l=i/this.a,c=1,d=0,x,h,m=0,p=0;for(s=1;s<=6;s++)x=c*o-d*l,h=d*o+c*l,c=x,d=h,m=m+this.C_re[s]*c-this.C_im[s]*d,p=p+this.C_im[s]*c+this.C_re[s]*d;for(var y=0;y<this.iterations;y++){var v=m,u=p,j,g,S=o,b=l;for(s=2;s<=6;s++)j=v*m-u*p,g=u*m+v*p,v=j,u=g,S=S+(s-1)*(this.B_re[s]*v-this.B_im[s]*u),b=b+(s-1)*(this.B_im[s]*v+this.B_re[s]*u);v=1,u=0;var _=this.B_re[1],w=this.B_im[1];for(s=2;s<=6;s++)j=v*m-u*p,g=u*m+v*p,v=j,u=g,_=_+s*(this.B_re[s]*v-this.B_im[s]*u),w=w+s*(this.B_im[s]*v+this.B_re[s]*u);var k=_*_+w*w;m=(S*_+b*w)/k,p=(b*_-S*w)/k}var $=m,R=p,T=1,P=0;for(s=1;s<=9;s++)T=T*$,P=P+this.D[s]*T;var I=this.lat0+P*Ns*1e5,Y=this.long0+R;return t.x=Y,t.y=I,t}var Ud=["New_Zealand_Map_Grid","nzmg"];const Ld={init:Td,forward:Dd,inverse:qd,names:Ud};function Bd(){}function Yd(t){var s=t.x,a=t.y,n=K(s-this.long0),i=this.x0+this.a*n,r=this.y0+this.a*Math.log(Math.tan(Math.PI/4+a/2.5))*1.25;return t.x=i,t.y=r,t}function Xd(t){t.x-=this.x0,t.y-=this.y0;var s=K(this.long0+t.x/this.a),a=2.5*(Math.atan(Math.exp(.8*t.y/this.a))-Math.PI/4);return t.x=s,t.y=a,t}var Wd=["Miller_Cylindrical","mill"];const Vd={init:Bd,forward:Yd,inverse:Xd,names:Wd};var Hd=20;function Jd(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Qa(this.es)}function Zd(t){var s,a,n=t.x,i=t.y;if(n=K(n-this.long0),this.sphere){if(!this.m)i=this.n!==1?Math.asin(this.n*Math.sin(i)):i;else for(var r=this.n*Math.sin(i),o=Hd;o;--o){var l=(this.m*i+Math.sin(i)-r)/(this.m+Math.cos(i));if(i-=l,Math.abs(l)<H)break}s=this.a*this.C_x*n*(this.m+Math.cos(i)),a=this.a*this.C_y*i}else{var c=Math.sin(i),d=Math.cos(i);a=this.a*hs(i,c,d,this.en),s=this.a*n*d/Math.sqrt(1-this.es*c*c)}return t.x=s,t.y=a,t}function Kd(t){var s,a,n,i;return t.x-=this.x0,n=t.x/this.a,t.y-=this.y0,s=t.y/this.a,this.sphere?(s/=this.C_y,n=n/(this.C_x*(this.m+Math.cos(s))),this.m?s=zt((this.m*s+Math.sin(s))/this.n):this.n!==1&&(s=zt(Math.sin(s)/this.n)),n=K(n+this.long0),s=$t(s)):(s=ei(t.y/this.a,this.es,this.en),i=Math.abs(s),i<L?(i=Math.sin(s),a=this.long0+t.x*Math.sqrt(1-this.es*i*i)/(this.a*Math.cos(s)),n=K(a)):i-H<L&&(n=this.long0)),t.x=n,t.y=s,t}var Qd=["Sinusoidal","sinu"];const eh={init:Jd,forward:Zd,inverse:Kd,names:Qd};function th(){}function sh(t){for(var s=t.x,a=t.y,n=K(s-this.long0),i=a,r=Math.PI*Math.sin(a);;){var o=-(i+Math.sin(i)-r)/(1+Math.cos(i));if(i+=o,Math.abs(o)<H)break}i/=2,Math.PI/2-Math.abs(a)<H&&(n=0);var l=.900316316158*this.a*n*Math.cos(i)+this.x0,c=1.4142135623731*this.a*Math.sin(i)+this.y0;return t.x=l,t.y=c,t}function ah(t){var s,a;t.x-=this.x0,t.y-=this.y0,a=t.y/(1.4142135623731*this.a),Math.abs(a)>.999999999999&&(a=.999999999999),s=Math.asin(a);var n=K(this.long0+t.x/(.900316316158*this.a*Math.cos(s)));n<-Math.PI&&(n=-Math.PI),n>Math.PI&&(n=Math.PI),a=(2*s+Math.sin(2*s))/Math.PI,Math.abs(a)>1&&(a=1);var i=Math.asin(a);return t.x=n,t.y=i,t}var ih=["Mollweide","moll"];const nh={init:th,forward:sh,inverse:ah,names:ih};function rh(){Math.abs(this.lat1+this.lat2)<H||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Is(this.es),this.e1=Gs(this.es),this.e2=zs(this.es),this.e3=Os(this.es),this.sin_phi=Math.sin(this.lat1),this.cos_phi=Math.cos(this.lat1),this.ms1=bt(this.e,this.sin_phi,this.cos_phi),this.ml1=Ke(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<H?this.ns=this.sin_phi:(this.sin_phi=Math.sin(this.lat2),this.cos_phi=Math.cos(this.lat2),this.ms2=bt(this.e,this.sin_phi,this.cos_phi),this.ml2=Ke(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Ke(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))}function lh(t){var s=t.x,a=t.y,n;if(this.sphere)n=this.a*(this.g-a);else{var i=Ke(this.e0,this.e1,this.e2,this.e3,a);n=this.a*(this.g-i)}var r=this.ns*K(s-this.long0),o=this.x0+n*Math.sin(r),l=this.y0+this.rh-n*Math.cos(r);return t.x=o,t.y=l,t}function oh(t){t.x-=this.x0,t.y=this.rh-t.y+this.y0;var s,a,n,i;this.ns>=0?(a=Math.sqrt(t.x*t.x+t.y*t.y),s=1):(a=-Math.sqrt(t.x*t.x+t.y*t.y),s=-1);var r=0;if(a!==0&&(r=Math.atan2(s*t.x,s*t.y)),this.sphere)return i=K(this.long0+r/this.ns),n=$t(this.g-a/this.a),t.x=i,t.y=n,t;var o=this.g-a/this.a;return n=ha(o,this.e0,this.e1,this.e2,this.e3),i=K(this.long0+r/this.ns),t.x=i,t.y=n,t}var ch=["Equidistant_Conic","eqdc"];const dh={init:rh,forward:lh,inverse:oh,names:ch};function hh(){this.R=this.a}function mh(t){var s=t.x,a=t.y,n=K(s-this.long0),i,r;Math.abs(a)<=H&&(i=this.x0+this.R*n,r=this.y0);var o=zt(2*Math.abs(a/Math.PI));(Math.abs(n)<=H||Math.abs(Math.abs(a)-L)<=H)&&(i=this.x0,a>=0?r=this.y0+Math.PI*this.R*Math.tan(.5*o):r=this.y0+Math.PI*this.R*-Math.tan(.5*o));var l=.5*Math.abs(Math.PI/n-n/Math.PI),c=l*l,d=Math.sin(o),x=Math.cos(o),h=x/(d+x-1),m=h*h,p=h*(2/d-1),y=p*p,v=Math.PI*this.R*(l*(h-y)+Math.sqrt(c*(h-y)*(h-y)-(y+c)*(m-y)))/(y+c);n<0&&(v=-v),i=this.x0+v;var u=c+h;return v=Math.PI*this.R*(p*u-l*Math.sqrt((y+c)*(c+1)-u*u))/(y+c),a>=0?r=this.y0+v:r=this.y0-v,t.x=i,t.y=r,t}function xh(t){var s,a,n,i,r,o,l,c,d,x,h,m,p;return t.x-=this.x0,t.y-=this.y0,h=Math.PI*this.R,n=t.x/h,i=t.y/h,r=n*n+i*i,o=-Math.abs(i)*(1+r),l=o-2*i*i+n*n,c=-2*o+1+2*i*i+r*r,p=i*i/c+(2*l*l*l/c/c/c-9*o*l/c/c)/27,d=(o-l*l/3/c)/c,x=2*Math.sqrt(-d/3),h=3*p/d/x,Math.abs(h)>1&&(h>=0?h=1:h=-1),m=Math.acos(h)/3,t.y>=0?a=(-x*Math.cos(m+Math.PI/3)-l/3/c)*Math.PI:a=-(-x*Math.cos(m+Math.PI/3)-l/3/c)*Math.PI,Math.abs(n)<H?s=this.long0:s=K(this.long0+Math.PI*(r-1+Math.sqrt(1+2*(n*n-i*i)+r*r))/2/n),t.x=s,t.y=a,t}var uh=["Van_der_Grinten_I","VanDerGrinten","Van_der_Grinten","vandg"];const gh={init:hh,forward:mh,inverse:xh,names:uh};function fh(t,s,a,n,i,r){const o=n-s,l=Math.atan((1-r)*Math.tan(t)),c=Math.atan((1-r)*Math.tan(a)),d=Math.sin(l),x=Math.cos(l),h=Math.sin(c),m=Math.cos(c);let p=o,y,v=100,u,j,g,S,b,_,w,k,$,R,T,P,I,Y;do{if(u=Math.sin(p),j=Math.cos(p),g=Math.sqrt(m*u*(m*u)+(x*h-d*m*j)*(x*h-d*m*j)),g===0)return{azi1:0,s12:0};S=d*h+x*m*j,b=Math.atan2(g,S),_=x*m*u/g,w=1-_*_,k=w!==0?S-2*d*h/w:0,$=r/16*w*(4+r*(4-3*w)),y=p,p=o+(1-$)*r*_*(b+$*g*(k+$*S*(-1+2*k*k)))}while(Math.abs(p-y)>1e-12&&--v>0);return v===0?{azi1:NaN,s12:NaN}:(R=w*(i*i-i*(1-r)*(i*(1-r)))/(i*(1-r)*(i*(1-r))),T=1+R/16384*(4096+R*(-768+R*(320-175*R))),P=R/1024*(256+R*(-128+R*(74-47*R))),I=P*g*(k+P/4*(S*(-1+2*k*k)-P/6*k*(-3+4*g*g)*(-3+4*k*k))),Y=i*(1-r)*T*(b-I),{azi1:Math.atan2(m*u,x*h-d*m*j),s12:Y})}function ph(t,s,a,n,i,r){const o=Math.atan((1-r)*Math.tan(t)),l=Math.sin(o),c=Math.cos(o),d=Math.sin(a),x=Math.cos(a),h=Math.atan2(l,c*x),m=c*d,p=1-m*m,y=p*(i*i-i*(1-r)*(i*(1-r)))/(i*(1-r)*(i*(1-r))),v=1+y/16384*(4096+y*(-768+y*(320-175*y))),u=y/1024*(256+y*(-128+y*(74-47*y)));let j=n/(i*(1-r)*v),g,S=100,b,_,w,k;do b=Math.cos(2*h+j),_=Math.sin(j),w=Math.cos(j),k=u*_*(b+u/4*(w*(-1+2*b*b)-u/6*b*(-3+4*_*_)*(-3+4*b*b))),g=j,j=n/(i*(1-r)*v)+k;while(Math.abs(j-g)>1e-12&&--S>0);if(S===0)return{lat2:NaN,lon2:NaN};const $=l*_-c*w*x,R=Math.atan2(l*w+c*_*x,(1-r)*Math.sqrt(m*m+$*$)),T=Math.atan2(_*d,c*w-l*_*x),P=r/16*p*(4+r*(4-3*p)),I=T-(1-P)*r*m*(j+P*_*(b+P*w*(-1+2*b*b))),Y=s+I;return{lat2:R,lon2:Y}}function yh(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0),this.f=this.es/(1+Math.sqrt(1-this.es))}function bh(t){var s=t.x,a=t.y,n=Math.sin(t.y),i=Math.cos(t.y),r=K(s-this.long0),o,l,c,d,x,h,m,p,y,v,u;return this.sphere?Math.abs(this.sin_p12-1)<=H?(t.x=this.x0+this.a*(L-a)*Math.sin(r),t.y=this.y0-this.a*(L-a)*Math.cos(r),t):Math.abs(this.sin_p12+1)<=H?(t.x=this.x0+this.a*(L+a)*Math.sin(r),t.y=this.y0+this.a*(L+a)*Math.cos(r),t):(y=this.sin_p12*n+this.cos_p12*i*Math.cos(r),m=Math.acos(y),p=m?m/Math.sin(m):1,t.x=this.x0+this.a*p*i*Math.sin(r),t.y=this.y0+this.a*p*(this.cos_p12*n-this.sin_p12*i*Math.cos(r)),t):(o=Is(this.es),l=Gs(this.es),c=zs(this.es),d=Os(this.es),Math.abs(this.sin_p12-1)<=H?(x=this.a*Ke(o,l,c,d,L),h=this.a*Ke(o,l,c,d,a),t.x=this.x0+(x-h)*Math.sin(r),t.y=this.y0-(x-h)*Math.cos(r),t):Math.abs(this.sin_p12+1)<=H?(x=this.a*Ke(o,l,c,d,L),h=this.a*Ke(o,l,c,d,a),t.x=this.x0+(x+h)*Math.sin(r),t.y=this.y0+(x+h)*Math.cos(r),t):Math.abs(s)<H&&Math.abs(a-this.lat0)<H?(t.x=t.y=0,t):(v=fh(this.lat0,this.long0,a,s,this.a,this.f),u=v.azi1,t.x=v.s12*Math.sin(u),t.y=v.s12*Math.cos(u),t))}function vh(t){t.x-=this.x0,t.y-=this.y0;var s,a,n,i,r,o,l,c,d,x,h,m,p,y,v,u;return this.sphere?(s=Math.sqrt(t.x*t.x+t.y*t.y),s>2*L*this.a?void 0:(a=s/this.a,n=Math.sin(a),i=Math.cos(a),r=this.long0,Math.abs(s)<=H?o=this.lat0:(o=zt(i*this.sin_p12+t.y*n*this.cos_p12/s),l=Math.abs(this.lat0)-L,Math.abs(l)<=H?this.lat0>=0?r=K(this.long0+Math.atan2(t.x,-t.y)):r=K(this.long0-Math.atan2(-t.x,t.y)):r=K(this.long0+Math.atan2(t.x*n,s*this.cos_p12*i-t.y*this.sin_p12*n))),t.x=r,t.y=o,t)):(c=Is(this.es),d=Gs(this.es),x=zs(this.es),h=Os(this.es),Math.abs(this.sin_p12-1)<=H?(m=this.a*Ke(c,d,x,h,L),s=Math.sqrt(t.x*t.x+t.y*t.y),p=m-s,o=ha(p/this.a,c,d,x,h),r=K(this.long0+Math.atan2(t.x,-1*t.y)),t.x=r,t.y=o,t):Math.abs(this.sin_p12+1)<=H?(m=this.a*Ke(c,d,x,h,L),s=Math.sqrt(t.x*t.x+t.y*t.y),p=s-m,o=ha(p/this.a,c,d,x,h),r=K(this.long0+Math.atan2(t.x,t.y)),t.x=r,t.y=o,t):(y=Math.atan2(t.x,t.y),v=Math.sqrt(t.x*t.x+t.y*t.y),u=ph(this.lat0,this.long0,y,v,this.a,this.f),t.x=u.lon2,t.y=u.lat2,t))}var jh=["Azimuthal_Equidistant","aeqd"];const Nh={init:yh,forward:bh,inverse:vh,names:jh};function wh(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)}function _h(t){var s,a,n,i,r,o,l,c,d=t.x,x=t.y;return n=K(d-this.long0),s=Math.sin(x),a=Math.cos(x),i=Math.cos(n),o=this.sin_p14*s+this.cos_p14*a*i,r=1,(o>0||Math.abs(o)<=H)&&(l=this.a*r*a*Math.sin(n),c=this.y0+this.a*r*(this.cos_p14*s-this.sin_p14*a*i)),t.x=l,t.y=c,t}function Sh(t){var s,a,n,i,r,o,l;return t.x-=this.x0,t.y-=this.y0,s=Math.sqrt(t.x*t.x+t.y*t.y),a=zt(s/this.a),n=Math.sin(a),i=Math.cos(a),o=this.long0,Math.abs(s)<=H?(l=this.lat0,t.x=o,t.y=l,t):(l=zt(i*this.sin_p14+t.y*n*this.cos_p14/s),r=Math.abs(this.lat0)-L,Math.abs(r)<=H?(this.lat0>=0?o=K(this.long0+Math.atan2(t.x,-t.y)):o=K(this.long0-Math.atan2(-t.x,t.y)),t.x=o,t.y=l,t):(o=K(this.long0+Math.atan2(t.x*n,s*this.cos_p14*i-t.y*this.sin_p14*n)),t.x=o,t.y=l,t))}var Mh=["ortho"];const Ch={init:wh,forward:_h,inverse:Sh,names:Mh};var Ae={FRONT:1,RIGHT:2,BACK:3,LEFT:4,TOP:5,BOTTOM:6},we={AREA_0:1,AREA_1:2,AREA_2:3,AREA_3:4};function Ph(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=L-Ne/2?this.face=Ae.TOP:this.lat0<=-(L-Ne/2)?this.face=Ae.BOTTOM:Math.abs(this.long0)<=Ne?this.face=Ae.FRONT:Math.abs(this.long0)<=L+Ne?this.face=this.long0>0?Ae.RIGHT:Ae.LEFT:this.face=Ae.BACK,this.es!==0&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)}function kh(t){var s={x:0,y:0},a,n,i,r,o,l,c={value:0};if(t.x-=this.long0,this.es!==0?a=Math.atan(this.one_minus_f_squared*Math.tan(t.y)):a=t.y,n=t.x,this.face===Ae.TOP)r=L-a,n>=Ne&&n<=L+Ne?(c.value=we.AREA_0,i=n-L):n>L+Ne||n<=-(L+Ne)?(c.value=we.AREA_1,i=n>0?n-ze:n+ze):n>-(L+Ne)&&n<=-Ne?(c.value=we.AREA_2,i=n+L):(c.value=we.AREA_3,i=n);else if(this.face===Ae.BOTTOM)r=L+a,n>=Ne&&n<=L+Ne?(c.value=we.AREA_0,i=-n+L):n<Ne&&n>=-Ne?(c.value=we.AREA_1,i=-n):n<-Ne&&n>=-(L+Ne)?(c.value=we.AREA_2,i=-n-L):(c.value=we.AREA_3,i=n>0?-n+ze:-n-ze);else{var d,x,h,m,p,y,v;this.face===Ae.RIGHT?n=cs(n,+L):this.face===Ae.BACK?n=cs(n,+ze):this.face===Ae.LEFT&&(n=cs(n,-L)),m=Math.sin(a),p=Math.cos(a),y=Math.sin(n),v=Math.cos(n),d=p*v,x=p*y,h=m,this.face===Ae.FRONT?(r=Math.acos(d),i=Vs(r,h,x,c)):this.face===Ae.RIGHT?(r=Math.acos(x),i=Vs(r,h,-d,c)):this.face===Ae.BACK?(r=Math.acos(-d),i=Vs(r,h,-x,c)):this.face===Ae.LEFT?(r=Math.acos(-x),i=Vs(r,h,d,c)):(r=i=0,c.value=we.AREA_0)}return l=Math.atan(12/ze*(i+Math.acos(Math.sin(i)*Math.cos(Ne))-L)),o=Math.sqrt((1-Math.cos(r))/(Math.cos(l)*Math.cos(l))/(1-Math.cos(Math.atan(1/Math.cos(i))))),c.value===we.AREA_1?l+=L:c.value===we.AREA_2?l+=ze:c.value===we.AREA_3&&(l+=1.5*ze),s.x=o*Math.cos(l),s.y=o*Math.sin(l),s.x=s.x*this.a+this.x0,s.y=s.y*this.a+this.y0,t.x=s.x,t.y=s.y,t}function Ah(t){var s={lam:0,phi:0},a,n,i,r,o,l,c,d,x,h={value:0};if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,n=Math.atan(Math.sqrt(t.x*t.x+t.y*t.y)),a=Math.atan2(t.y,t.x),t.x>=0&&t.x>=Math.abs(t.y)?h.value=we.AREA_0:t.y>=0&&t.y>=Math.abs(t.x)?(h.value=we.AREA_1,a-=L):t.x<0&&-t.x>=Math.abs(t.y)?(h.value=we.AREA_2,a=a<0?a+ze:a-ze):(h.value=we.AREA_3,a+=L),x=ze/12*Math.tan(a),o=Math.sin(x)/(Math.cos(x)-1/Math.sqrt(2)),l=Math.atan(o),i=Math.cos(a),r=Math.tan(n),c=1-i*i*r*r*(1-Math.cos(Math.atan(1/Math.cos(l)))),c<-1?c=-1:c>1&&(c=1),this.face===Ae.TOP)d=Math.acos(c),s.phi=L-d,h.value===we.AREA_0?s.lam=l+L:h.value===we.AREA_1?s.lam=l<0?l+ze:l-ze:h.value===we.AREA_2?s.lam=l-L:s.lam=l;else if(this.face===Ae.BOTTOM)d=Math.acos(c),s.phi=d-L,h.value===we.AREA_0?s.lam=-l+L:h.value===we.AREA_1?s.lam=-l:h.value===we.AREA_2?s.lam=-l-L:s.lam=l<0?-l-ze:-l+ze;else{var m,p,y;m=c,x=m*m,x>=1?y=0:y=Math.sqrt(1-x)*Math.sin(l),x+=y*y,x>=1?p=0:p=Math.sqrt(1-x),h.value===we.AREA_1?(x=p,p=-y,y=x):h.value===we.AREA_2?(p=-p,y=-y):h.value===we.AREA_3&&(x=p,p=y,y=-x),this.face===Ae.RIGHT?(x=m,m=-p,p=x):this.face===Ae.BACK?(m=-m,p=-p):this.face===Ae.LEFT&&(x=m,m=p,p=-x),s.phi=Math.acos(-y)-L,s.lam=Math.atan2(p,m),this.face===Ae.RIGHT?s.lam=cs(s.lam,-L):this.face===Ae.BACK?s.lam=cs(s.lam,-ze):this.face===Ae.LEFT&&(s.lam=cs(s.lam,+L))}if(this.es!==0){var v,u,j;v=s.phi<0?1:0,u=Math.tan(s.phi),j=this.b/Math.sqrt(u*u+this.one_minus_f_squared),s.phi=Math.atan(Math.sqrt(this.a*this.a-j*j)/(this.one_minus_f*j)),v&&(s.phi=-s.phi)}return s.lam+=this.long0,t.x=s.lam,t.y=s.phi,t}function Vs(t,s,a,n){var i;return t<H?(n.value=we.AREA_0,i=0):(i=Math.atan2(s,a),Math.abs(i)<=Ne?n.value=we.AREA_0:i>Ne&&i<=L+Ne?(n.value=we.AREA_1,i-=L):i>L+Ne||i<=-(L+Ne)?(n.value=we.AREA_2,i=i>=0?i-ze:i+ze):(n.value=we.AREA_3,i+=L)),i}function cs(t,s){var a=t+s;return a<-ze?a+=Ps:a>+ze&&(a-=Ps),a}var Eh=["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"];const Rh={init:Ph,forward:kh,inverse:Ah,names:Eh};var Ua=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-986701e-12],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,18736e-12],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,934959e-12],[.7986,-.00755338,-500009e-10,935324e-12],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],vs=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-126793e-14,422642e-15],[.124,.0124,507171e-14,-160604e-14],[.186,.0123999,-190189e-13,600152e-14],[.248,.0124002,710039e-13,-224e-10],[.31,.0123992,-264997e-12,835986e-13],[.372,.0124029,988983e-12,-311994e-12],[.434,.0123893,-369093e-11,-435621e-12],[.4958,.0123198,-102252e-10,-345523e-12],[.5571,.0121916,-154081e-10,-582288e-12],[.6176,.0119938,-241424e-10,-525327e-12],[.6769,.011713,-320223e-10,-516405e-12],[.7346,.0113541,-397684e-10,-609052e-12],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-140374e-14],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Hn=.8487,Jn=1.3523,Zn=yt/5,Fh=1/Zn,ns=18,ma=function(t,s){return t[0]+s*(t[1]+s*(t[2]+s*t[3]))},Ih=function(t,s){return t[1]+s*(2*t[2]+s*3*t[3])};function Gh(t,s,a,n){for(var i=s;n;--n){var r=t(i);if(i-=r,Math.abs(r)<a)break}return i}function zh(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"}function Oh(t){var s=K(t.x-this.long0),a=Math.abs(t.y),n=Math.floor(a*Zn);n<0?n=0:n>=ns&&(n=ns-1),a=yt*(a-Fh*n);var i={x:ma(Ua[n],a)*s,y:ma(vs[n],a)};return t.y<0&&(i.y=-i.y),i.x=i.x*this.a*Hn+this.x0,i.y=i.y*this.a*Jn+this.y0,i}function $h(t){var s={x:(t.x-this.x0)/(this.a*Hn),y:Math.abs(t.y-this.y0)/(this.a*Jn)};if(s.y>=1)s.x/=Ua[ns][0],s.y=t.y<0?-L:L;else{var a=Math.floor(s.y*ns);for(a<0?a=0:a>=ns&&(a=ns-1);;)if(vs[a][0]>s.y)--a;else if(vs[a+1][0]<=s.y)++a;else break;var n=vs[a],i=5*(s.y-n[0])/(vs[a+1][0]-n[0]);i=Gh(function(r){return(ma(n,r)-s.y)/Ih(n,r)},i,H,100),s.x/=ma(Ua[a],i),s.y=(5*a+i)*Be,t.y<0&&(s.y=-s.y)}return s.x=K(s.x+this.long0),s}var Th=["Robinson","robin"];const Dh={init:zh,forward:Oh,inverse:$h,names:Th};function qh(){this.name="geocent"}function Uh(t){var s=$n(t,this.es,this.a);return s}function Lh(t){var s=Tn(t,this.es,this.a,this.b);return s}var Bh=["Geocentric","geocentric","geocent","Geocent"];const Yh={init:qh,forward:Uh,inverse:Lh,names:Bh};var We={N_POLE:0,S_POLE:1,EQUIT:2,OBLIQ:3},fs={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};function Xh(){if(Object.keys(fs).forEach(function(a){if(typeof this[a]>"u")this[a]=fs[a].def;else{if(fs[a].num&&isNaN(this[a]))throw new Error("Invalid parameter value, must be numeric "+a+" = "+this[a]);fs[a].num&&(this[a]=parseFloat(this[a]))}fs[a].degrees&&(this[a]=this[a]*Be)}.bind(this)),Math.abs(Math.abs(this.lat0)-L)<H?this.mode=this.lat0<0?We.S_POLE:We.N_POLE:Math.abs(this.lat0)<H?this.mode=We.EQUIT:(this.mode=We.OBLIQ,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var t=this.tilt,s=this.azi;this.cg=Math.cos(s),this.sg=Math.sin(s),this.cw=Math.cos(t),this.sw=Math.sin(t)}function Wh(t){t.x-=this.long0;var s=Math.sin(t.y),a=Math.cos(t.y),n=Math.cos(t.x),i,r;switch(this.mode){case We.OBLIQ:r=this.sinph0*s+this.cosph0*a*n;break;case We.EQUIT:r=a*n;break;case We.S_POLE:r=-s;break;case We.N_POLE:r=s;break}switch(r=this.pn1/(this.p-r),i=r*a*Math.sin(t.x),this.mode){case We.OBLIQ:r*=this.cosph0*s-this.sinph0*a*n;break;case We.EQUIT:r*=s;break;case We.N_POLE:r*=-(a*n);break;case We.S_POLE:r*=a*n;break}var o,l;return o=r*this.cg+i*this.sg,l=1/(o*this.sw*this.h1+this.cw),i=(i*this.cg-r*this.sg)*this.cw*l,r=o*l,t.x=i*this.a,t.y=r*this.a,t}function Vh(t){t.x/=this.a,t.y/=this.a;var s={x:t.x,y:t.y},a,n,i;i=1/(this.pn1-t.y*this.sw),a=this.pn1*t.x*i,n=this.pn1*t.y*this.cw*i,t.x=a*this.cg+n*this.sg,t.y=n*this.cg-a*this.sg;var r=at(t.x,t.y);if(Math.abs(r)<H)s.x=0,s.y=t.y;else{var o,l;switch(l=1-r*r*this.pfact,l=(this.p-Math.sqrt(l))/(this.pn1/r+r/this.pn1),o=Math.sqrt(1-l*l),this.mode){case We.OBLIQ:s.y=Math.asin(o*this.sinph0+t.y*l*this.cosph0/r),t.y=(o-this.sinph0*Math.sin(s.y))*r,t.x*=l*this.cosph0;break;case We.EQUIT:s.y=Math.asin(t.y*l/r),t.y=o*r,t.x*=l;break;case We.N_POLE:s.y=Math.asin(o),t.y=-t.y;break;case We.S_POLE:s.y=-Math.asin(o);break}s.x=Math.atan2(t.x,t.y)}return t.x=s.x+this.long0,t.y=s.y,t}var Hh=["Tilted_Perspective","tpers"];const Jh={init:Xh,forward:Wh,inverse:Vh,names:Hh};function Zh(){if(this.flip_axis=this.sweep==="x"?1:0,this.h=Number(this.h),this.radius_g_1=this.h/this.a,this.radius_g_1<=0||this.radius_g_1>1e10)throw new Error;if(this.radius_g=1+this.radius_g_1,this.C=this.radius_g*this.radius_g-1,this.es!==0){var t=1-this.es,s=1/t;this.radius_p=Math.sqrt(t),this.radius_p2=t,this.radius_p_inv2=s,this.shape="ellipse"}else this.radius_p=1,this.radius_p2=1,this.radius_p_inv2=1,this.shape="sphere";this.title||(this.title="Geostationary Satellite View")}function Kh(t){var s=t.x,a=t.y,n,i,r,o;if(s=s-this.long0,this.shape==="ellipse"){a=Math.atan(this.radius_p2*Math.tan(a));var l=this.radius_p/at(this.radius_p*Math.cos(a),Math.sin(a));if(i=l*Math.cos(s)*Math.cos(a),r=l*Math.sin(s)*Math.cos(a),o=l*Math.sin(a),(this.radius_g-i)*i-r*r-o*o*this.radius_p_inv2<0)return t.x=Number.NaN,t.y=Number.NaN,t;n=this.radius_g-i,this.flip_axis?(t.x=this.radius_g_1*Math.atan(r/at(o,n)),t.y=this.radius_g_1*Math.atan(o/n)):(t.x=this.radius_g_1*Math.atan(r/n),t.y=this.radius_g_1*Math.atan(o/at(r,n)))}else this.shape==="sphere"&&(n=Math.cos(a),i=Math.cos(s)*n,r=Math.sin(s)*n,o=Math.sin(a),n=this.radius_g-i,this.flip_axis?(t.x=this.radius_g_1*Math.atan(r/at(o,n)),t.y=this.radius_g_1*Math.atan(o/n)):(t.x=this.radius_g_1*Math.atan(r/n),t.y=this.radius_g_1*Math.atan(o/at(r,n))));return t.x=t.x*this.a,t.y=t.y*this.a,t}function Qh(t){var s=-1,a=0,n=0,i,r,o,l;if(t.x=t.x/this.a,t.y=t.y/this.a,this.shape==="ellipse"){this.flip_axis?(n=Math.tan(t.y/this.radius_g_1),a=Math.tan(t.x/this.radius_g_1)*at(1,n)):(a=Math.tan(t.x/this.radius_g_1),n=Math.tan(t.y/this.radius_g_1)*at(1,a));var c=n/this.radius_p;if(i=a*a+c*c+s*s,r=2*this.radius_g*s,o=r*r-4*i*this.C,o<0)return t.x=Number.NaN,t.y=Number.NaN,t;l=(-r-Math.sqrt(o))/(2*i),s=this.radius_g+l*s,a*=l,n*=l,t.x=Math.atan2(a,s),t.y=Math.atan(n*Math.cos(t.x)/s),t.y=Math.atan(this.radius_p_inv2*Math.tan(t.y))}else if(this.shape==="sphere"){if(this.flip_axis?(n=Math.tan(t.y/this.radius_g_1),a=Math.tan(t.x/this.radius_g_1)*Math.sqrt(1+n*n)):(a=Math.tan(t.x/this.radius_g_1),n=Math.tan(t.y/this.radius_g_1)*Math.sqrt(1+a*a)),i=a*a+n*n+s*s,r=2*this.radius_g*s,o=r*r-4*i*this.C,o<0)return t.x=Number.NaN,t.y=Number.NaN,t;l=(-r-Math.sqrt(o))/(2*i),s=this.radius_g+l*s,a*=l,n*=l,t.x=Math.atan2(a,s),t.y=Math.atan(n*Math.cos(t.x)/s)}return t.x=t.x+this.long0,t}var em=["Geostationary Satellite View","Geostationary_Satellite","geos"];const tm={init:Zh,forward:Kh,inverse:Qh,names:em};var ws=1.340264,_s=-.081106,Ss=893e-6,Ms=.003796,xa=Math.sqrt(3)/2;function sm(){this.es=0,this.long0=this.long0!==void 0?this.long0:0}function am(t){var s=K(t.x-this.long0),a=t.y,n=Math.asin(xa*Math.sin(a)),i=n*n,r=i*i*i;return t.x=s*Math.cos(n)/(xa*(ws+3*_s*i+r*(7*Ss+9*Ms*i))),t.y=n*(ws+_s*i+r*(Ss+Ms*i)),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t}function im(t){t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a;var s=1e-9,a=12,n=t.y,i,r,o,l,c,d;for(d=0;d<a&&(i=n*n,r=i*i*i,o=n*(ws+_s*i+r*(Ss+Ms*i))-t.y,l=ws+3*_s*i+r*(7*Ss+9*Ms*i),n-=c=o/l,!(Math.abs(c)<s));++d);return i=n*n,r=i*i*i,t.x=xa*t.x*(ws+3*_s*i+r*(7*Ss+9*Ms*i))/Math.cos(n),t.y=Math.asin(Math.sin(n)/xa),t.x=K(t.x+this.long0),t}var nm=["eqearth","Equal Earth","Equal_Earth"];const rm={init:sm,forward:am,inverse:im,names:nm};var Es=1e-10;function lm(){var t;if(this.phi1=this.lat1,Math.abs(this.phi1)<Es)throw new Error;this.es?(this.en=Qa(this.es),this.m1=hs(this.phi1,this.am1=Math.sin(this.phi1),t=Math.cos(this.phi1),this.en),this.am1=t/(Math.sqrt(1-this.es*this.am1*this.am1)*this.am1),this.inverse=cm,this.forward=om):(Math.abs(this.phi1)+Es>=L?this.cphi1=0:this.cphi1=1/Math.tan(this.phi1),this.inverse=hm,this.forward=dm)}function om(t){var s=K(t.x-(this.long0||0)),a=t.y,n,i,r;return n=this.am1+this.m1-hs(a,i=Math.sin(a),r=Math.cos(a),this.en),i=r*s/(n*Math.sqrt(1-this.es*i*i)),t.x=n*Math.sin(i),t.y=this.am1-n*Math.cos(i),t.x=this.a*t.x+(this.x0||0),t.y=this.a*t.y+(this.y0||0),t}function cm(t){t.x=(t.x-(this.x0||0))/this.a,t.y=(t.y-(this.y0||0))/this.a;var s,a,n,i;if(a=at(t.x,t.y=this.am1-t.y),i=ei(this.am1+this.m1-a,this.es,this.en),(s=Math.abs(i))<L)s=Math.sin(i),n=a*Math.atan2(t.x,t.y)*Math.sqrt(1-this.es*s*s)/Math.cos(i);else if(Math.abs(s-L)<=Es)n=0;else throw new Error;return t.x=K(n+(this.long0||0)),t.y=$t(i),t}function dm(t){var s=K(t.x-(this.long0||0)),a=t.y,n,i;return i=this.cphi1+this.phi1-a,Math.abs(i)>Es?(t.x=i*Math.sin(n=s*Math.cos(a)/i),t.y=this.cphi1-i*Math.cos(n)):t.x=t.y=0,t.x=this.a*t.x+(this.x0||0),t.y=this.a*t.y+(this.y0||0),t}function hm(t){t.x=(t.x-(this.x0||0))/this.a,t.y=(t.y-(this.y0||0))/this.a;var s,a,n=at(t.x,t.y=this.cphi1-t.y);if(a=this.cphi1+this.phi1-n,Math.abs(a)>L)throw new Error;return Math.abs(Math.abs(a)-L)<=Es?s=0:s=n*Math.atan2(t.x,t.y)/Math.cos(a),t.x=K(s+(this.long0||0)),t.y=$t(a),t}var mm=["bonne","Bonne (Werner lat_1=90)"];const xm={init:lm,names:mm};function um(t){t.Proj.projections.add(ta),t.Proj.projections.add(sa),t.Proj.projections.add(mc),t.Proj.projections.add(jc),t.Proj.projections.add(Mc),t.Proj.projections.add(Ec),t.Proj.projections.add(Oc),t.Proj.projections.add(Uc),t.Proj.projections.add(Wc),t.Proj.projections.add(Kc),t.Proj.projections.add(hd),t.Proj.projections.add(pd),t.Proj.projections.add(Nd),t.Proj.projections.add(Pd),t.Proj.projections.add(Fd),t.Proj.projections.add($d),t.Proj.projections.add(Ld),t.Proj.projections.add(Vd),t.Proj.projections.add(eh),t.Proj.projections.add(nh),t.Proj.projections.add(dh),t.Proj.projections.add(gh),t.Proj.projections.add(Nh),t.Proj.projections.add(Ch),t.Proj.projections.add(Rh),t.Proj.projections.add(Dh),t.Proj.projections.add(Yh),t.Proj.projections.add(Jh),t.Proj.projections.add(tm),t.Proj.projections.add(rm),t.Proj.projections.add(xm)}const ri=Object.assign(ko,{defaultDatum:"WGS84",Proj:gt,WGS84:new gt("WGS84"),Point:ds,toPoint:Dn,defs:Je,nadgrid:ho,transform:da,mgrs:Ao,version:"__VERSION__"});um(ri);ri.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");ri.defs("EPSG:3857","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs");const gm=3.28084;function Hs(t){return t*gm}async function Kn(t){try{const s=typeof t=="string"?parseInt(t):t;console.log("ðŸ” fetchParcelGeometry3857 called with ogc_fid:",s);const{data:a,error:n}=await me.rpc("get_parcel_geometry_3857",{p_ogc_fid:s});if(console.log("ðŸ“¡ RPC get_parcel_geometry_3857 response:",{data:a,error:n}),n)return console.error("âŒ Error from get_parcel_geometry_3857:",n),null;if(!a||a.length===0)return console.warn("âš ï¸ get_parcel_geometry_3857 returned no data for ogc_fid:",s),null;console.log("âœ… get_parcel_geometry_3857 returned data:",a[0]);const i=a[0];return fm(i)}catch(s){return console.error("âŒ Exception in fetchParcelGeometry3857:",s),null}}function fm(t){const s=t.geometry_3857;if(!s)return null;console.log("ðŸ” Parsing 3857 geometry for ogc_fid:",t.ogc_fid),console.log("ðŸ“¦ Geometry type:",s.type);let a;if(s.type==="Polygon")a=s.coordinates[0];else if(s.type==="MultiPolygon")a=s.coordinates[0][0];else return console.warn("âŒ Unsupported geometry type:",s.type),null;if(!a||a.length<3)return console.warn("âŒ Insufficient coordinates:",a?.length),null;console.log("ðŸ“ Coordinate count:",a.length),console.log("ðŸ“ First coordinate (Web Mercator meters):",a[0]);const n=a.reduce((h,m)=>({minX:Math.min(h.minX,m[0]),minY:Math.min(h.minY,m[1]),maxX:Math.max(h.maxX,m[0]),maxY:Math.max(h.maxY,m[1])}),{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});console.log("ðŸ“ Bounds in Web Mercator (meters):",n);const i=n.maxX-n.minX,r=n.maxY-n.minY,o=Hs(i),l=Hs(r);console.log("ðŸ“ Dimensions in meters:",{widthMeters:i,depthMeters:r}),console.log("ðŸ“ Dimensions in feet:",{width:o,depth:l});const c=t.sqft??Math.round(o*l),d=a.map(([h,m])=>[Hs(h-n.minX),Hs(m-n.minY)]);console.log("ðŸ“ First normalized coordinate (feet):",d[0]),console.log("ðŸ“ Last normalized coordinate (feet):",d[d.length-1]);const x={width:o,depth:l,area:c,perimeter:(o+l)*2,coordinates:d,bounds:{minX:0,minY:0,maxX:o,maxY:l},centroid:{x:o/2,y:l/2}};return console.log("âœ… Successfully parsed geometry:",{width:x.width.toFixed(1),depth:x.depth.toFixed(1),area:x.area,coordinateCount:x.coordinates.length}),x}async function Qi(t,s){try{const a=typeof t=="string"?parseInt(t):t;console.log("ðŸ” fetchParcelBuildableEnvelope called with ogc_fid:",a);const{data:n,error:i}=await me.rpc("get_parcel_front_edge_with_roads",{p_ogc_fid:a,p_front_setback:s?.front||25,p_rear_setback:s?.rear||20,p_side_setback:s?.side||15});if(console.log("ðŸ“¡ RPC get_parcel_buildable_envelope response:",{data:n,error:i}),i){console.error("âŒ Error from get_parcel_buildable_envelope:",i);const c=await Kn(t);return c?{parcelGeometry:c,buildableEnvelope:c,edgeClassifications:{method:"fallback"},metrics:{note:"Using fallback geometry"}}:null}if(!n||n.length===0)return console.warn("âš ï¸ get_parcel_buildable_envelope returned no data for ogc_fid:",a),null;const r=n[0];console.log("âœ… get_parcel_buildable_envelope returned data:",r);const o=en(r.parcel_geom_geojson,r),l=en(r.buildable_envelope_geojson,r);return!o||!l?(console.error("âŒ Failed to parse geometries"),null):{parcelGeometry:o,buildableEnvelope:l,edgeClassifications:r.edge_analysis,metrics:{...r.parcel_metrics,roadInfo:r.nearest_road_info}}}catch(a){return console.error("âŒ Exception in fetchParcelBuildableEnvelope:",a),null}}function en(t,s){if(!t||!t.coordinates)return null;let a;if(t.type==="Polygon")a=t.coordinates[0];else if(t.type==="MultiPolygon")a=t.coordinates[0][0];else return console.warn("âŒ Unsupported GeoJSON type:",t.type),null;const n=a.reduce((c,d)=>({minX:Math.min(c.minX,d[0]),minY:Math.min(c.minY,d[1]),maxX:Math.max(c.maxX,d[0]),maxY:Math.max(c.maxY,d[1])}),{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});let i,r;s&&s.parcel_width_ft&&s.parcel_depth_ft?(i=s.parcel_width_ft,r=s.parcel_depth_ft,console.log("âœ… Using actual parcel dimensions from database:",{width:i,depth:r})):(i=(n.maxX-n.minX)*279e3,r=(n.maxY-n.minY)*364320,console.log("âš ï¸ Using calculated dimensions from coordinates:",{width:i,depth:r}));const o=a.map(([c,d])=>[(c-n.minX)*(s&&s.parcel_width_ft?i/(n.maxX-n.minX):279e3),(d-n.minY)*(s&&s.parcel_depth_ft?r/(n.maxY-n.minY):364320)]),l=s&&s.sqft?s.sqft:i*r;return{width:i,depth:r,area:l,perimeter:(i+r)*2,coordinates:o,bounds:{minX:0,minY:0,maxX:i,maxY:r},centroid:{x:i/2,y:r/2}}}async function pm(t){try{console.log(`ðŸŒ Importing roads from OpenStreetMap for parcel ${t}`);const{data:s,error:a}=await me.from("parcels").select("ogc_fid, wkb_geometry_4326, address").eq("ogc_fid",t).single();if(a)throw new Error(`Failed to get parcel: ${a.message}`);console.log("ðŸ“¦ Parcel data:",s);let n;typeof s.wkb_geometry_4326=="string"?n=JSON.parse(s.wkb_geometry_4326):n=s.wkb_geometry_4326;const i=n.coordinates[0],r=i.reduce((u,j)=>u+j[0],0)/i.length,o=i.reduce((u,j)=>u+j[1],0)/i.length,l=.005,c={south:o-l,west:r-l,north:o+l,east:r+l};console.log(`ðŸ“ Searching for roads around: ${r}, ${o}`),console.log(`ðŸ“¦ Bounding box: ${c.south},${c.west},${c.north},${c.east}`);const d=`[out:json][timeout:25];(way["highway"~"^(primary|secondary|tertiary|residential|trunk|unclassified)$"](${c.south},${c.west},${c.north},${c.east}););out geom;`,x="https://overpass-api.de/api/interpreter";console.log("ðŸ›£ï¸ Fetching roads from OpenStreetMap..."),console.log("ðŸ“¡ Overpass query:",d);const h=await fetch(x,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`data=${encodeURIComponent(d)}`});if(console.log(`ðŸ“¡ OSM API response status: ${h.status}`),!h.ok){const u=await h.text();throw console.error(`âŒ OSM API error: ${h.status} ${h.statusText}`,u),new Error(`OSM API error: ${h.status} ${h.statusText}`)}const m=await h.json();console.log(`âœ… Found ${m.elements.length} roads from OSM`);const p=[];for(const u of m.elements)if(u.type==="way"&&u.geometry){const j=u.tags.name||u.tags["addr:street"]||u.tags.highway||"Unnamed Road",g=u.tags.highway||"unknown",S=u.geometry.map(_=>`${_.lon} ${_.lat}`).join(","),b={osm_id:u.id,name:j,highway:g,geom:`LINESTRING(${S})`};p.push(b)}console.log("ðŸ” Processed roads:",p.map(u=>({name:u.name,class:u.highway})));let y=0;for(const u of p)try{const{data:j,error:g}=await me.rpc("insert_road",{p_osm_id:u.osm_id,p_name:u.name,p_highway:u.highway,p_geom_wkt:u.geom});g?console.warn(`âš ï¸ Failed to insert ${u.name}:`,g):(y++,console.log(`âœ… Inserted: ${u.name} (${u.highway})`))}catch(j){console.warn(`âš ï¸ Insert error for ${u.name}:`,j)}const v=p.map(u=>u.name).filter(u=>u!=="Unnamed Road");return console.log(`ðŸŽ‰ Successfully imported ${y}/${p.length} roads`),console.log(`ðŸ“ Road names: ${v.join(", ")}`),{success:!0,roadsImported:y,totalFound:m.elements.length,roadNames:v,parcelAddress:s.address}}catch(s){return console.error("âŒ Error importing roads from OSM:",s),{success:!1,error:s.message}}}async function ym(t){try{const{data:s,error:a}=await me.from("roads").select("id, name").limit(5);return!a&&s&&s.length>0?(console.log("âœ… Roads already exist:",s.map(n=>n.name)),{success:!0,message:`${s.length} roads already available`}):(console.log("ðŸ“ No roads found, importing from OpenStreetMap..."),await pm(t))}catch(s){return console.error("âŒ Error checking/importing OSM roads:",s),{success:!1,error:s.message}}}const bm=({elements:t,onElementsChange:s,gridSize:a,snapToGrid:n,snapDistance:i,onUndo:r,onRedo:o,onSaveState:l})=>{const[c,d]=f.useState(null),[x,h]=f.useState(null),[m,p]=f.useState(null),[y,v]=f.useState({history:[],currentIndex:-1,maxHistorySize:50}),u=f.useRef(),j=f.useRef(0),g={size:a},S={gridSnap:n,objectSnap:!0,snapDistance:i,vertexSnap:!0,edgeSnap:!0},b=f.useCallback(U=>{const q=_(U),z=(q.minX+q.maxX)/2,O=(q.minY+q.maxY)/2;return{x:z,y:O-20,visible:U.selected,angle:U.transform.rotation}},[]),_=f.useCallback(U=>{if(!U.vertices||U.vertices.length===0)return{minX:0,maxX:0,minY:0,maxY:0};const q=U.vertices.map(O=>O.x),z=U.vertices.map(O=>O.y);return{minX:Math.min(...q),maxX:Math.max(...q),minY:Math.min(...z),maxY:Math.max(...z)}},[]),w=f.useCallback((U,q)=>{if(!S.gridSnap)return{x:U,y:q,snapped:!1};const z=g.size*12,O=Math.round(U/z)*z,V=Math.round(q/z)*z;return Math.sqrt((U-O)**2+(q-V)**2)<=S.snapDistance?{x:O,y:V,snapped:!0,snapType:"grid",snapTarget:{x:O,y:V}}:{x:U,y:q,snapped:!1}},[S.gridSnap,g.size,S.snapDistance]),k=f.useCallback((U,q,z)=>{if(!S.objectSnap)return{x:U,y:q,snapped:!1};let O={x:U,y:q,snapped:!1},V=S.snapDistance;return t.forEach(te=>{if(te.id!==z&&(S.vertexSnap&&te.vertices.forEach(Q=>{const ne=Math.sqrt((U-Q.x)**2+(q-Q.y)**2);ne<V&&(V=ne,O={x:Q.x,y:Q.y,snapped:!0,snapType:"vertex",snapTarget:{x:Q.x,y:Q.y}})}),S.edgeSnap))for(let Q=0;Q<te.vertices.length;Q++){const ne=te.vertices[Q],se=te.vertices[(Q+1)%te.vertices.length],oe=$(U,q,ne,se);oe.snapped&&oe.distance<V&&(V=oe.distance,O={x:oe.x,y:oe.y,snapped:!0,snapType:"edge",snapTarget:{x:oe.x,y:oe.y}})}}),O},[t,S,S.snapDistance]),$=f.useCallback((U,q,z,O)=>{const V=U-z.x,te=q-z.y,Q=O.x-z.x,ne=O.y-z.y,se=V*Q+te*ne,oe=Q*Q+ne*ne;if(oe===0)return{x:z.x,y:z.y,snapped:!1,distance:Math.sqrt(V*V+te*te)};const $e=se/oe,he=Math.max(0,Math.min(1,$e)),ie=z.x+he*Q,Xe=z.y+he*ne,Qe=Math.sqrt((U-ie)**2+(q-Xe)**2);return{x:ie,y:Xe,snapped:Qe<=S.snapDistance,distance:Qe}},[S.snapDistance]),R=f.useCallback((U,q,z)=>{const O=w(U,q),V=k(U,q,z);return V.snapped?V:O},[w,k]),T=f.useCallback((U,q,z)=>{s(t.map(O=>O.id===U?{...O,vertices:O.vertices.map(V=>({...V,x:V.x+q,y:V.y+z})),transform:{...O.transform,x:O.transform.x+q,y:O.transform.y+z}}:O))},[t,s]),P=f.useCallback((U,q)=>{s(t.map(z=>z.id===U?{...z,transform:{...z.transform,rotation:q}}:z))},[t,s]),I=f.useCallback((U,q,z)=>{s(t.map(O=>O.id===U?{...O,transform:{...O.transform,scaleX:q,scaleY:z}}:O))},[t,s]),Y=f.useCallback(()=>{const U={elements:[...t],timestamp:Date.now()};v(q=>{const z=q.history.slice(0,q.currentIndex+1);return z.push(U),z.length>q.maxHistorySize&&z.shift(),{...q,history:z,currentIndex:z.length-1}}),l(U)},[t,l]),B=f.useCallback((U,q)=>{U.preventDefault(),U.stopPropagation();const z=U.currentTarget.getBoundingClientRect(),O={x:U.clientX-z.left,y:U.clientY-z.top,clientX:U.clientX,clientY:U.clientY};if(q&&m&&m.visible&&Math.sqrt((O.x-m.x)**2+(O.y-m.y)**2)<=10){const te=t.find(Q=>Q.id===q);if(te){d({mode:"rotate",elementId:q,startX:O.x,startY:O.y,currentX:O.x,currentY:O.y,originalElement:{...te},isMultiSelect:!1,selectedElements:[]});return}}if(U.ctrlKey||U.metaKey){q?t.find(te=>te.id===q)&&s(t.map(te=>te.id===q?{...te,selected:!te.selected}:te)):h({isActive:!0,startX:O.x,startY:O.y,currentX:O.x,currentY:O.y,selectedElements:[]});return}if(q){const V=t.find(te=>te.id===q);V&&(s(t.map(te=>({...te,selected:te.id===q}))),d({mode:"move",elementId:q,startX:O.x,startY:O.y,currentX:O.x,currentY:O.y,originalElement:{...V},isMultiSelect:!1,selectedElements:[]}),p(b({...V,selected:!0})))}else s(t.map(V=>({...V,selected:!1}))),p(null)},[t,s,m,b]),F=f.useCallback(U=>{if(!c&&!x)return;const q=U.currentTarget.getBoundingClientRect(),z={x:U.clientX-q.left,y:U.clientY-q.top,clientX:U.clientX,clientY:U.clientY};u.current&&cancelAnimationFrame(u.current),u.current=requestAnimationFrame(()=>{const O=Date.now();if(!(O-j.current<16)){if(j.current=O,c){const V=z.x-c.startX,te=z.y-c.startY;if(c.mode==="move"){const Q=R(c.originalElement.transform.x+V,c.originalElement.transform.y+te,c.elementId);T(c.elementId,V,te),d(ne=>ne?{...ne,currentX:z.x,currentY:z.y,snapTarget:Q.snapped?{type:Q.snapType,x:Q.x,y:Q.y}:void 0}:null)}else if(c.mode==="rotate"){const Q=t.find(ne=>ne.id===c.elementId);if(Q){const ne=_(Q),se=(ne.minX+ne.maxX)/2,oe=(ne.minY+ne.maxY)/2,$e=Math.atan2(z.y-oe,z.x-se);P(c.elementId,$e),d(he=>he?{...he,currentX:z.x,currentY:z.y}:null)}}}x&&h(V=>V?{...V,currentX:z.x,currentY:z.y}:null)}})},[c,x,R,T,P,t,_]),J=f.useCallback(U=>{if(c&&(Y(),d(null)),x){const q=t.filter(z=>{const O=_(z),V=(O.minX+O.maxX)/2,te=(O.minY+O.maxY)/2,Q=Math.min(x.startX,x.currentX),ne=Math.max(x.startX,x.currentX),se=Math.min(x.startY,x.currentY),oe=Math.max(x.startY,x.currentY);return V>=Q&&V<=ne&&te>=se&&te<=oe});s(t.map(z=>({...z,selected:q.some(O=>O.id===z.id)}))),h(null)}u.current&&(cancelAnimationFrame(u.current),u.current=void 0)},[c,x,t,_,s,Y]),ce=f.useCallback(U=>{if(U.ctrlKey||U.metaKey)switch(U.key){case"z":U.shiftKey?o():r();break;case"y":o();break;case"a":s(t.map(z=>({...z,selected:!0})));break;case"c":const q=t.filter(z=>z.selected);q.length>0&&navigator.clipboard.writeText(JSON.stringify(q));break;case"v":navigator.clipboard.readText().then(z=>{try{const O=JSON.parse(z);if(Array.isArray(O)){const V=O.map(te=>({...te,id:`${te.id}_${Date.now()}`,transform:{...te.transform,x:te.transform.x+20,y:te.transform.y+20}}));s([...t,...V])}}catch(O){console.warn("Failed to paste elements:",O)}});break}else switch(U.key){case"Delete":case"Backspace":t.filter(z=>z.selected).length>0&&(s(t.filter(z=>!z.selected)),Y());break;case"Escape":s(t.map(z=>({...z,selected:!1}))),p(null);break}},[t,s,r,o,Y]);return f.useEffect(()=>(document.addEventListener("keydown",ce),()=>document.removeEventListener("keydown",ce)),[ce]),f.useEffect(()=>{const U=t.find(q=>q.selected);p(U?b(U):null)},[t,b]),{dragState:c,multiSelectState:x,rotationHandle:m,undoRedoState:y,onMouseDown:B,onMouseMove:F,onMouseUp:J,applySnapping:R,updateElementPosition:T,updateElementRotation:P,updateElementScale:I}},Z=()=>Math.random().toString(36).substr(2,9),ia=t=>{if(t.length<3)return 0;let s=0;for(let a=0;a<t.length;a++){const n=(a+1)%t.length;s+=t[a].x*t[n].y,s-=t[n].x*t[a].y}return Math.abs(s/2)},vm=t=>{if(t.length<2)return 0;let s=0;for(let a=0;a<t.length;a++){const n=(a+1)%t.length,i=t[n].x-t[a].x,r=t[n].y-t[a].y;s+=Math.sqrt(i*i+r*r)}return s},La=t=>t.length===0?"":`${t.map((a,n)=>`${n===0?"M":"L"} ${a.x} ${a.y}`).join(" ")} Z`,je=(t,s,a=!0)=>a?Math.round(t/s)*s:t,Qn=(t,s)=>{let a=!1;for(let n=0,i=s.length-1;n<s.length;i=n++)s[n].y>t.y!=s[i].y>t.y&&t.x<(s[i].x-s[n].x)*(t.y-s[n].y)/(s[i].y-s[n].y)+s[n].x&&(a=!a);return a},ps=(t,s,a=[],n=12)=>{const i=[],l=Math.ceil(t/50),c=Math.ceil(t/l);console.log(`ðŸš— Generating ${l} parking lots with ${c} spaces each (${t} total)`);for(let d=0;d<l;d++){const x=Math.min(c,t-d*c);if(x<=0)break;const h=x*350,p=Math.sqrt(h*2.5),y=h/p,v=p*n,u=y*n,j=jm(s,v,u,[...a,...i],d);if(j){const g={id:`parking-${d+1}`,type:"parking",vertices:[{id:"1",x:j.x,y:j.y},{id:"2",x:j.x+v,y:j.y},{id:"3",x:j.x+v,y:j.y+u},{id:"4",x:j.x,y:j.y+u}],properties:{name:`Parking Lot ${d+1}`,area:h,perimeter:2*(p+y),color:"#E5E7EB",strokeColor:"#9CA3AF",fillOpacity:.8}};i.push(g),console.log(`âœ… Created parking lot ${d+1}: ${x} spaces, ${p.toFixed(0)}' x ${y.toFixed(0)}'`)}else console.warn(`âš ï¸ Could not place parking lot ${d+1} within buildable area`)}return i},jm=(t,s,a,n,i)=>{const r=t.vertices.reduce((l,c)=>({minX:Math.min(l.minX,c.x),maxX:Math.max(l.maxX,c.x),minY:Math.min(l.minY,c.y),maxY:Math.max(l.maxY,c.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),o=[()=>{const c=[{x:r.minX+20,y:r.minY+20},{x:r.maxX-s-20,y:r.minY+20},{x:r.minX+20,y:r.maxY-a-20},{x:r.maxX-s-20,y:r.maxY-a-20}];for(const d of c)if(Ra(d,s,a,t,n))return d;return null},()=>{const l=r.minX+(r.maxX-r.minX)/2,c=r.minY+(r.maxY-r.minY)/2,d=i*100,x=[{x:l-s/2,y:c-a/2+d},{x:l-s/2-d,y:c-a/2},{x:l-s/2+d,y:c-a/2}];for(const h of x)if(Ra(h,s,a,t,n))return h;return null},()=>{for(let c=r.minY;c<=r.maxY-a;c+=50)for(let d=r.minX;d<=r.maxX-s;d+=50){const x={x:d,y:c};if(Ra(x,s,a,t,n))return x}return null}];for(const l of o){const c=l();if(c)return c}return null},Ra=(t,s,a,n,i)=>{if(![{x:t.x,y:t.y},{x:t.x+s,y:t.y},{x:t.x+s,y:t.y+a},{x:t.x,y:t.y+a}].every(o=>Qn(o,n.vertices)))return!1;for(const o of i)if(o.type==="building"||o.type==="parking"){const l=o.vertices.reduce((x,h)=>({minX:Math.min(x.minX,h.x),maxX:Math.max(x.maxX,h.x),minY:Math.min(x.minY,h.y),maxY:Math.max(x.maxY,h.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),c={minX:t.x,maxX:t.x+s,minY:t.y,maxY:t.y+a},d=20;if(!(c.maxX+d<l.minX||c.minX-d>l.maxX||c.maxY+d<l.minY||c.minY-d>l.maxY))return!1}return!0},rs=(t,s)=>{const a=t.vertices.every(n=>Qn(n,s.vertices));return console.log("ðŸ” Building boundary validation:",{allCornersInside:a,buildingVertices:t.vertices,buildableVertices:s.vertices,isValid:a}),a},tn=t=>{const s=t.vertices.reduce((l,c)=>({minX:Math.min(l.minX,c.x),maxX:Math.max(l.maxX,c.x),minY:Math.min(l.minY,c.y),maxY:Math.max(l.maxY,c.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),a=s.maxX-s.minX,n=s.maxY-s.minY,i=a/n;let r;i>1.5?r="horizontal":i<.67?r="vertical":r="diagonal";let o=0;if(r==="diagonal"){let l=0,c=0;for(let d=0;d<t.vertices.length;d++){const x=t.vertices[d],h=t.vertices[(d+1)%t.vertices.length],m=Math.sqrt(Math.pow(h.x-x.x,2)+Math.pow(h.y-x.y,2));m>l&&(l=m,c=Math.atan2(h.y-x.y,h.x-x.x))}o=c}return console.log("ðŸ§­ Parcel orientation analysis:",{primaryAxis:r,aspectRatio:i.toFixed(2),rotationAngle:(o*180/Math.PI).toFixed(1)+"Â°",width:a.toFixed(0),height:n.toFixed(0)}),{primaryAxis:r,rotationAngle:o,aspectRatio:i,bounds:s}},Js=(t,s,a,n,i)=>{const r=t.vertices.reduce((x,h)=>({minX:Math.min(x.minX,h.x),maxX:Math.max(x.maxX,h.x),minY:Math.min(x.minY,h.y),maxY:Math.max(x.maxY,h.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});if(i){const x={vertices:[{id:"1",x:i.x,y:i.y},{id:"2",x:i.x+s,y:i.y},{id:"3",x:i.x+s,y:i.y+a},{id:"4",x:i.x,y:i.y+a}]};if(rs(x,t))return i}let o=50,l=0;const c=500;console.log("ðŸ” Searching for valid building position:",{buildingWidthSVG:s,buildingHeightSVG:a,bounds:r,step:o});const d=[50,25,12,6];for(const x of d){o=x,console.log(`ðŸ” Trying step size: ${o}`);for(let h=r.minY;h<=r.maxY-a;h+=o){for(let m=r.minX;m<=r.maxX-s;m+=o){if(l++,l>c){console.warn("âš ï¸ Max attempts reached, stopping search");break}const p={vertices:[{id:"1",x:m,y:h},{id:"2",x:m+s,y:h},{id:"3",x:m+s,y:h+a},{id:"4",x:m,y:h+a}]};if(rs(p,t))return console.log(`âœ… Found valid position at (${m}, ${h}) after ${l} attempts with step ${o}`),{x:m,y:h}}if(l>c)break}if(l>c)break}return console.warn(`âš ï¸ Could not find valid building position within buildable area after ${l} attempts`),null},Zt=(t,s=12)=>t/s,Cs=(t,s=12)=>t*s,jt=(t,s=12)=>{const a=ia(t.vertices),n=vm(t.vertices),i=a/(s*s),r=n/s;return{...t,properties:{...t.properties,area:i,perimeter:r}}},er=t=>{const s=t.reduce((n,i)=>n+i.x,0),a=t.reduce((n,i)=>n+i.y,0);return{x:s/t.length,y:a/t.length}},Nm=(t,s,a)=>{const n=a*Math.PI/180,i=Math.cos(n),r=Math.sin(n),o=t.x-s.x,l=t.y-s.y;return{x:s.x+o*i-l*r,y:s.y+o*r+l*i}},wm=(t,s,a)=>{const n=a||er(t.vertices),i=t.vertices.map(r=>Nm(r,n,s));return{...t,vertices:i,rotation:s}},_m=(t,s=12)=>{if(t.type!=="parking")return[];const a=`parking-clip-${t.id}`,n=[];n.push(e.jsx("defs",{children:e.jsx("clipPath",{id:a,children:e.jsx("path",{d:La(t.vertices)})})},`defs-${t.id}`));const i=t.vertices.reduce((y,v)=>({minX:Math.min(y.minX,v.x),maxX:Math.max(y.maxX,v.x),minY:Math.min(y.minY,v.y),maxY:Math.max(y.maxY,v.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),r=i.maxX-i.minX,o=i.maxY-i.minY,l=Cs(9,s),c=Cs(18,s),d=Math.max(1,Math.floor(r/l)),x=Math.max(1,Math.floor(o/c)),h=r/d,m=o/x,p=[];for(let y=0;y<x;y++)for(let v=0;v<d;v++){const u=i.minX+v*h,j=i.minY+y*m;p.push(e.jsx("rect",{x:u,y:j,width:h,height:m,fill:"none",stroke:"white",strokeWidth:"2",opacity:"0.8"},`parking-space-${y}-${v}`)),p.push(e.jsx("text",{x:u+h/2,y:j+m/2,textAnchor:"middle",dominantBaseline:"middle",fontSize:"10",fill:"white",fontWeight:"bold",opacity:"0.6",children:y*d+v+1},`parking-number-${y}-${v}`))}return n.push(e.jsx("g",{clipPath:`url(#${a})`,children:p},`parking-spaces-${t.id}`)),n},Fa=[{id:"single-family",name:"Single Family",type:"apartment",description:"Single family home optimized for lot size",minArea:2e3,generator:t=>{const{buildableArea:s,parcelGeometry:a,zoning:n,marketData:i,gridSize:r}=t,o=s.vertices.reduce((ge,Ce)=>({minX:Math.min(ge.minX,Ce.x),maxX:Math.max(ge.maxX,Ce.x),minY:Math.min(ge.minY,Ce.y),maxY:Math.max(ge.maxY,Ce.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});console.log("ðŸ—ï¸ Dynamic Single Family Generator - Starting with buildable area:",{vertices:s.vertices.length,rawAreaProperty:s.properties.area,areaSqFt:(s.properties.area||0).toFixed(0),bounds:o,buildableVertices:s.vertices.slice(0,3).map(ge=>`(${ge.x.toFixed(0)}, ${ge.y.toFixed(0)})`)});const l=Math.round(s.properties.area||0),c=s.vertices.reduce((ge,Ce)=>({minX:Math.min(ge.minX,Ce.x),maxX:Math.max(ge.maxX,Ce.x),minY:Math.min(ge.minY,Ce.y),maxY:Math.max(ge.maxY,Ce.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});console.log("ðŸ—ï¸ Buildable area bounds comparison:",{originalBounds:o,calculatedBounds:c,boundsMatch:JSON.stringify(o)===JSON.stringify(c),buildableAreaSqFt:l});const d=c,x=i.avgHomeSize||2500,p=Math.min(4500,Math.max(1800,x));console.log("ðŸ—ï¸ Realistic house sizing:",{marketOptimalSize:x,buildableAreaSqFt:l,chosenHouseSize:p,note:"Using market standards instead of buildable area percentage"}),console.log("ðŸ—ï¸ House size calculation:",{buildableAreaSqFt:l.toFixed(0),marketOptimalSize:x,chosenHouseSize:p.toFixed(0),note:"Using realistic market-based sizing"});let y=(d.maxX-d.minX)/r,v=(d.maxY-d.minY)/r;const u=y/v;if(console.log("ðŸ—ï¸ Buildable area analysis:",{lotWidth:y.toFixed(1)+" ft",lotDepth:v.toFixed(1)+" ft",lotRatio:u.toFixed(2),buildableAreaSqFt:l,orientation:y>v?"wide":"deep",boundsInSVG:`${(d.maxX-d.minX).toFixed(0)} x ${(d.maxY-d.minY).toFixed(0)}`,boundsInFeet:`${y.toFixed(1)} x ${v.toFixed(1)}`,gridSize:r,note:"If bounds are tiny, buildable area vertices are wrong"}),y<50||v<50){console.error("ðŸš¨ CRITICAL: Buildable area bounds are too small!",{lotWidth:y.toFixed(1)+" ft",lotDepth:v.toFixed(1)+" ft",boundsSVG:`${(d.maxX-d.minX).toFixed(0)} x ${(d.maxY-d.minY).toFixed(0)}`,note:"This will cause massive house scaling - using fallback dimensions"});const ge=Math.sqrt(l*1.5),Ce=l/ge;console.log("ðŸ”§ Using fallback lot dimensions:",{fallbackWidth:ge.toFixed(1)+" ft",fallbackDepth:Ce.toFixed(1)+" ft",fallbackArea:(ge*Ce).toFixed(0)+" sq ft"});const Se=ge*r,et=Ce*r,_t=s.vertices.reduce((xe,tt)=>xe+tt.x,0)/s.vertices.length,St=s.vertices.reduce((xe,tt)=>xe+tt.y,0)/s.vertices.length;d.minX=_t-Se/2,d.maxX=_t+Se/2,d.minY=St-et/2,d.maxY=St+et/2;const Vt=ge,Ts=Ce;console.log("ðŸ”§ Updated bounds after fallback:",{newBounds:`${d.minX.toFixed(0)},${d.minY.toFixed(0)} to ${d.maxX.toFixed(0)},${d.maxY.toFixed(0)}`,newLotWidth:Vt.toFixed(1)+" ft",newLotDepth:Ts.toFixed(1)+" ft"})}const j=(d.maxX-d.minX)/r,g=(d.maxY-d.minY)/r;console.log("ðŸ—ï¸ Final lot dimensions:",{finalLotWidth:j.toFixed(1)+" ft",finalLotDepth:g.toFixed(1)+" ft",finalLotArea:(j*g).toFixed(0)+" sq ft"});const S=1.5;let b=Math.sqrt(p*S),_=p/b;const w=12,k=Math.min(60,g*.4),$=w*k,R=15,T=j-R*2,P=g-R*2;if(console.log("ðŸ—ï¸ Before scaling check:",{originalHouseSize:`${b.toFixed(1)} x ${_.toFixed(1)} ft`,availableSpace:`${T.toFixed(1)} x ${P.toFixed(1)} ft`,needsScaling:b>T||_>P,widthFits:b<=T,depthFits:_<=P,finalLotDimensions:`${j.toFixed(1)} x ${g.toFixed(1)} ft`}),b>T||_>P){const ge=b,Ce=_,Se=Math.min(T/b,P/_),et=1500,_t=b*_*(Se*Se);if(_t<et){console.error("ðŸš¨ CRITICAL: Scaling would make house too small!",{originalArea:(b*_).toFixed(0)+" sq ft",scaledArea:_t.toFixed(0)+" sq ft",minHouseArea:et+" sq ft",scaleFactor:Se.toFixed(3),note:"Using minimum viable house size instead"});const St=Math.sqrt(et*S),Vt=et/St;b=St,_=Vt}else b*=Se,_*=Se;console.log("ðŸ—ï¸ House scaled to fit with driveway:",{originalSize:`${ge.toFixed(1)} x ${Ce.toFixed(1)} ft`,scaledSize:`${b.toFixed(1)} x ${_.toFixed(1)} ft`,scaleFactor:Se.toFixed(3),availableSpace:`${T.toFixed(1)} x ${P.toFixed(1)} ft`,newAreaSqFt:(b*_).toFixed(0)})}const I=b*r,Y=_*r,B=s.vertices.reduce((ge,Ce)=>ge+Ce.x,0)/s.vertices.length,F=s.vertices.reduce((ge,Ce)=>ge+Ce.y,0)/s.vertices.length,J=20*r,ce=d.maxX-d.minX-2*J,U=d.maxY-d.minY-2*J;let q=d.minX+J+(ce-I)/2,z=d.minY+J+(U-Y)/2;const O=q+I,V=z+Y;(q<d.minX||O>d.maxX||z<d.minY||V>d.maxY)&&(console.warn("ðŸš¨ House positioned outside buildable area! Adjusting...",{housePosition:`(${q.toFixed(0)}, ${z.toFixed(0)})`,houseSize:`${I.toFixed(0)} x ${Y.toFixed(0)}`,buildableBounds:`${d.minX.toFixed(0)},${d.minY.toFixed(0)} to ${d.maxX.toFixed(0)},${d.maxY.toFixed(0)}`,houseRight:O.toFixed(0),houseBottom:V.toFixed(0)}),q=d.minX+(d.maxX-d.minX-I)/2,z=d.minY+(d.maxY-d.minY-Y)/2,console.log("ðŸ”§ Adjusted house position:",{newPosition:`(${q.toFixed(0)}, ${z.toFixed(0)})`,newRight:(q+I).toFixed(0),newBottom:(z+Y).toFixed(0)})),console.log("ðŸ—ï¸ Strategic positioning:",{buildableBounds:`${d.minX.toFixed(0)},${d.minY.toFixed(0)} to ${d.maxX.toFixed(0)},${d.maxY.toFixed(0)}`,housePosition:`(${q.toFixed(0)}, ${z.toFixed(0)})`,houseSize:`${b.toFixed(1)}' x ${_.toFixed(1)}'`,houseSizeSVG:`${I.toFixed(1)} x ${Y.toFixed(1)} SVG`,actualHouseSqFt:(b*_).toFixed(0),targetHouseSqFt:p,marginSVG:J,availableSpace:`${ce.toFixed(0)} x ${U.toFixed(0)} SVG`}),console.log("ðŸ—ï¸ Dynamic positioning:",{houseSize:`${b.toFixed(1)} x ${_.toFixed(1)} feet`,houseSizeSVG:`${I.toFixed(1)} x ${Y.toFixed(1)} SVG units`,centroid:`(${B.toFixed(1)}, ${F.toFixed(1)})`,housePosition:`(${q.toFixed(1)}, ${z.toFixed(1)})`});const te={id:Z(),type:"building",vertices:[{id:Z(),x:q,y:z},{id:Z(),x:q+I,y:z},{id:Z(),x:q+I,y:z+Y},{id:Z(),x:q,y:z+Y}],properties:{name:`Single Family Home (${p.toFixed(0)} sq ft)`,color:"#10b981",strokeColor:"#059669",fillOpacity:.8,area:b*_}},Q=w*r,ne=k*r,se=10*r,oe=q+I+se,$e=oe+Q<=d.maxX-J;let he,ie;$e?(he=oe,ie=z):(he=q,ie=z+Y+se),console.log("ðŸš— Final driveway placement:",{drivewayDimensions:`${w}' x ${k}'`,drivewayArea:`${$} sq ft`,placement:$e?"right of house":"below house",position:`(${he.toFixed(0)}, ${ie.toFixed(0)})`,withinBounds:he+Q<=o.maxX&&ie+ne<=o.maxY});const Xe={id:Z(),type:"parking",vertices:[{id:Z(),x:he,y:ie},{id:Z(),x:he+Q,y:ie},{id:Z(),x:he+Q,y:ie+ne},{id:Z(),x:he,y:ie+ne}],properties:{name:"Driveway",color:"#6b7280",strokeColor:"#374151",fillOpacity:.8}},Qe=b*_,Xt=w*k,Wt={...te,properties:{...te.properties,area:Qe,perimeter:2*(b+_)}},$s={...Xe,properties:{...Xe.properties,area:Xt,perimeter:2*(w+k)}};return console.log("ðŸ—ï¸ Final dynamic layout:",{targetHouseArea:p.toFixed(0)+" sq ft",actualHouseArea:Qe.toFixed(0)+" sq ft",actualDrivewayArea:Xt.toFixed(0)+" sq ft",note:"Using correct sq ft calculations, not SVG area"}),{buildings:[Wt],parking:[$s],amenities:[],metrics:{totalUnits:1,totalSqFt:Wt.properties.area||0,parkingSpaces:2,density:1/(a.area/43560),coverage:(Wt.properties.area||0)/s.properties.area*100,estimatedRevenue:p*i.avgRentPerSqFt*12,estimatedCost:p*i.constructionCostPerSqFt}}}},{id:"duplex",name:"Duplex",type:"apartment",description:"Two-unit duplex maximizing small lot potential",minArea:4e3,generator:t=>{const{buildableArea:s,parcelGeometry:a,zoning:n,marketData:i,gridSize:r}=t,o=tn(s),l=o.bounds,c=(l.maxX-l.minX)/r,d=(l.maxY-l.minY)/r;console.log("ðŸ” Buildable area dimensions:",{widthFeet:c.toFixed(1),depthFeet:d.toFixed(1),areaSqFt:(c*d).toFixed(0),boundsSVG:{minX:l.minX.toFixed(1),minY:l.minY.toFixed(1),maxX:l.maxX.toFixed(1),maxY:l.maxY.toFixed(1)},gridSize:r});const x=2400,h=60,m=40,p=h*m,y=p/2;console.log("ðŸ” Using realistic duplex dimensions:",{targetSqFt:x,actualSqFt:p,widthFeet:h,depthFeet:m,unitSqFt:y,buildableAreaSqFt:(c*d).toFixed(0),coveragePercent:(p/(c*d)*100).toFixed(1)+"%"});const v=h*r,u=m*r;console.log("ðŸ¢ SIMPLE Duplex creation:",{widthFeet:h,depthFeet:m,totalSqFt:p,unitSqFt:y,widthSVG:v,depthSVG:u,gridSize:r});const j=l.minX+(l.maxX-l.minX-v)/2,g=l.minY+(l.maxY-l.minY-u)/2;console.log("ðŸ¢ Duplex positioning:",{buildableBounds:`${(l.maxX-l.minX).toFixed(0)} x ${(l.maxY-l.minY).toFixed(0)} SVG`,duplexPosition:`(${j.toFixed(0)}, ${g.toFixed(0)})`,duplexSize:`${v} x ${u} SVG`,duplexSizeFeet:`${h} x ${m} feet`,gridSize:r,orientation:{primaryAxis:o.primaryAxis,aspectRatio:o.aspectRatio.toFixed(2)},fitsInBounds:j>=l.minX&&g>=l.minY&&j+v<=l.maxX&&g+u<=l.maxY});const S={id:Z(),type:"building",vertices:[{id:Z(),x:j,y:g},{id:Z(),x:j+v,y:g},{id:Z(),x:j+v,y:g+u},{id:Z(),x:j,y:g+u}],properties:{name:`Duplex (2 units, ${y.toFixed(0)} sq ft each)`,color:"#8b5cf6",strokeColor:"#7c3aed",fillOpacity:.8,area:p}},b=ps(4,s,[S],r);return{buildings:[S],parking:b,amenities:[],metrics:{totalUnits:2,totalSqFt:p,parkingSpaces:4,density:2/(a.area/43560),coverage:p/a.area*100,estimatedRevenue:2*y*i.avgRentPerSqFt*12,estimatedCost:p*i.constructionCostPerSqFt}}}},{id:"apartment-complex",name:"Apartment Complex",type:"apartment",description:"Multi-building residential complex (4-400 units)",minArea:1e4,generator:t=>{const{buildableArea:s,parcelGeometry:a,siteConstraints:n,zoning:i,marketData:r,gridSize:o}=t;console.log("ðŸ—ï¸ ARCHITECTURAL APARTMENT COMPLEX GENERATOR - Starting intelligent analysis...");const l=tn(s),c=l.bounds,d=(c.maxX-c.minX)/o,x=(c.maxY-c.minY)/o,h=Math.round(s.properties.area||0),m=a.area/43560,p=i.maxDensity?Math.floor(m*i.maxDensity):999,y=Math.floor(h*i.maxFAR/800),v=Math.floor(h*(i.maxCoverage/100)/600),u=Math.min(p,y,v),j=d/x,g=j>1.5,S=j<.67;console.log("ðŸ—ï¸ Architectural Site Analysis:",{buildableAreaSqFt:h.toFixed(0),dimensions:`${d.toFixed(0)}' x ${x.toFixed(0)}'`,siteRatio:j.toFixed(2),orientation:g?"WIDE":S?"DEEP":"SQUARE",maxUnits:u,parcelAcres:m.toFixed(2)});let b;u<=8?b="courtyard":u<=24?l.primaryAxis==="horizontal"||g?b="linear":b="courtyard":u<=50?l.primaryAxis==="horizontal"||g?b="linear":l.primaryAxis==="vertical"||S?b="cluster":b="courtyard":l.primaryAxis==="horizontal"||g?b="linear":l.primaryAxis==="vertical"||S?b="cluster":b="mixed",console.log("ðŸ—ï¸ Selected Typology:",b);const _=[],w=[],k=[];if(b==="courtyard"){const T=Math.min(3,Math.ceil(u/8)),P=Math.ceil(u/T),I=Math.min(d*.3,x*.3),Y=c.minX+(d*o-I*o)/2,B=c.minY+(x*o-I*o)/2,F=[{x:c.minX+20,y:B,width:d*.4,height:x*.2},{x:Y+I*o+20,y:c.minY+20,width:d*.3,height:x*.4},{x:c.minX+20,y:c.minY+20,width:d*.4,height:x*.2}];for(let J=0;J<Math.min(T,F.length);J++){const ce=Math.min(P,u-J*P);if(ce<=0)break;const U=ce*800,q=Math.floor(i.maxHeight/12),z=Math.min(q,Math.ceil(ce/4)),O=U/z,V=F[J],te=Math.sqrt(O*1.5),Q=O/te,ne=V.width*o,se=V.height*o,oe=Math.min(te*o,ne-40),$e=Math.min(Q*o,se-40),he=Js(s,oe,$e,_,{x:V.x,y:V.y});if(he){const ie={id:Z(),type:"building",vertices:[{id:Z(),x:he.x,y:he.y},{id:Z(),x:he.x+oe,y:he.y},{id:Z(),x:he.x+oe,y:he.y+$e},{id:Z(),x:he.x,y:he.y+$e}],properties:{name:`Building ${String.fromCharCode(65+J)} (${ce} units, ${z} stories)`,color:"#3b82f6",strokeColor:"#1e40af",fillOpacity:.8,area:U,stories:z}};rs(ie,s)?(_.push(ie),console.log(`âœ… Building ${String.fromCharCode(65+J)} placed at (${he.x.toFixed(0)}, ${he.y.toFixed(0)})`)):(console.warn(`âš ï¸ Building ${String.fromCharCode(65+J)} failed strict validation, but placing anyway`),console.warn("Building vertices:",ie.vertices),console.warn("Buildable area vertices:",s.vertices),_.push(ie),console.log(`âœ… Building ${String.fromCharCode(65+J)} placed with fallback at (${he.x.toFixed(0)}, ${he.y.toFixed(0)})`))}else console.warn(`âš ï¸ Could not place Building ${String.fromCharCode(65+J)} within buildable area`)}}else if(b==="linear"){const T=Math.min(4,Math.ceil(u/12)),P=Math.ceil(u/T),I=l.primaryAxis==="horizontal"||d>x,Y=I?d*o/(T+1):x*o/(T+1);console.log("ðŸ“ Linear typology orientation:",{primaryAxis:l.primaryAxis,isHorizontal:I,buildingCount:T,spacing:Y.toFixed(0)});for(let B=0;B<T;B++){const F=Math.min(P,u-B*P);if(F<=0)break;const J=F*800,ce=Math.floor(i.maxHeight/12),U=Math.min(ce,Math.ceil(F/4)),q=J/U,z=Math.sqrt(q*1.5),O=q/z;let V,te;I?(V=c.minX+Y*(B+1)-z*o/2,te=c.minY+(x*o-O*o)/2):(V=c.minX+(d*o-z*o)/2,te=c.minY+Y*(B+1)-O*o/2);const Q=Js(s,z*o,O*o,_,{x:V,y:te});if(Q){const ne={id:Z(),type:"building",vertices:[{id:Z(),x:Q.x,y:Q.y},{id:Z(),x:Q.x+z*o,y:Q.y},{id:Z(),x:Q.x+z*o,y:Q.y+O*o},{id:Z(),x:Q.x,y:Q.y+O*o}],properties:{name:`Building ${String.fromCharCode(65+B)} (${F} units, ${U} stories)`,color:"#3b82f6",strokeColor:"#1e40af",fillOpacity:.8,area:J,stories:U}};rs(ne,s)?(_.push(ne),console.log(`âœ… Building ${String.fromCharCode(65+B)} placed at (${Q.x.toFixed(0)}, ${Q.y.toFixed(0)})`)):(console.warn(`âš ï¸ Building ${String.fromCharCode(65+B)} failed strict validation, but placing anyway`),console.warn("Building vertices:",ne.vertices),console.warn("Buildable area vertices:",s.vertices),_.push(ne),console.log(`âœ… Building ${String.fromCharCode(65+B)} placed with fallback at (${Q.x.toFixed(0)}, ${Q.y.toFixed(0)})`))}else console.warn(`âš ï¸ Could not place Building ${String.fromCharCode(65+B)} within buildable area`)}}else if(b==="cluster"){const T=Math.min(3,Math.ceil(u/16)),P=Math.ceil(u/T),I=c.minX+d*o/2,Y=c.minY+x*o/2,B=Math.min(d,x)*o*.3;console.log("ðŸ“ Cluster typology orientation:",{primaryAxis:l.primaryAxis,clusterCenter:{x:I.toFixed(0),y:Y.toFixed(0)},clusterRadius:B.toFixed(0)});for(let F=0;F<T;F++){const J=Math.min(P,u-F*P);if(J<=0)break;const ce=J*800,U=Math.floor(i.maxHeight/12),q=Math.min(U,Math.ceil(J/4)),z=ce/q,O=Math.sqrt(z*1.5),V=z/O,te=F*2*Math.PI/T,Q=I+Math.cos(te)*B-O*o/2,ne=Y+Math.sin(te)*B-V*o/2,se=Js(s,O*o,V*o,_,{x:Q,y:ne});if(se){const oe={id:Z(),type:"building",vertices:[{id:Z(),x:se.x,y:se.y},{id:Z(),x:se.x+O*o,y:se.y},{id:Z(),x:se.x+O*o,y:se.y+V*o},{id:Z(),x:se.x,y:se.y+V*o}],properties:{name:`Building ${String.fromCharCode(65+F)} (${J} units, ${q} stories)`,color:"#3b82f6",strokeColor:"#1e40af",fillOpacity:.8,area:ce,stories:q}};rs(oe,s)?(_.push(oe),console.log(`âœ… Building ${String.fromCharCode(65+F)} placed at (${se.x.toFixed(0)}, ${se.y.toFixed(0)})`)):(console.warn(`âš ï¸ Building ${String.fromCharCode(65+F)} failed strict validation, but placing anyway`),console.warn("Building vertices:",oe.vertices),console.warn("Buildable area vertices:",s.vertices),_.push(oe),console.log(`âœ… Building ${String.fromCharCode(65+F)} placed with fallback at (${se.x.toFixed(0)}, ${se.y.toFixed(0)})`))}else console.warn(`âš ï¸ Could not place Building ${String.fromCharCode(65+F)} within buildable area`)}}const $=Math.ceil(u*1.5);console.log(`ðŸš— Generating ${$} parking spaces...`);const R=ps($,s,_,o);if(w.push(...R),console.log(`âœ… Generated ${R.length} parking lots`),u>20){const T=Math.min(2e3,u*50),P=Math.sqrt(T*144),I=T*144/P,Y=Js(s,P,I,_,{x:c.minX+20,y:c.minY+20});if(Y){const B={id:Z(),type:"greenspace",vertices:[{id:Z(),x:Y.x,y:Y.y},{id:Z(),x:Y.x+P,y:Y.y},{id:Z(),x:Y.x+P,y:Y.y+I},{id:Z(),x:Y.x,y:Y.y+I}],properties:{name:"Clubhouse",color:"#f59e0b",strokeColor:"#d97706",fillOpacity:.8,area:T}};rs(B,s)?(k.push(B),console.log(`âœ… Clubhouse placed at (${Y.x.toFixed(0)}, ${Y.y.toFixed(0)})`)):(console.warn("âš ï¸ Clubhouse failed strict validation, but placing anyway"),console.warn("Clubhouse vertices:",B.vertices),console.warn("Buildable area vertices:",s.vertices),k.push(B),console.log(`âœ… Clubhouse placed with fallback at (${Y.x.toFixed(0)}, ${Y.y.toFixed(0)})`))}else console.warn("âš ï¸ Could not place clubhouse within buildable area")}return console.log("ðŸ—ï¸ Architectural Apartment Complex Complete:",{typology:b,buildings:_.length,parking:w.length,amenities:k.length,totalUnits:u}),{buildings:_,parking:w,amenities:k,metrics:{totalUnits:u,totalSqFt:u*800,parkingSpaces:$,density:u/m,coverage:u*600/a.area*100,estimatedRevenue:u*800*r.avgRentPerSqFt*12,estimatedCost:u*800*r.constructionCostPerSqFt}}}},{id:"office-building",name:"Office Building",type:"office",description:"Intelligent office building sized for optimal ROI",minArea:5e3,generator:t=>{const{buildableArea:s,parcelGeometry:a,zoning:n,marketData:i,gridSize:r}=t,o=s.vertices.reduce((k,$)=>({minX:Math.min(k.minX,$.x),maxX:Math.max(k.maxX,$.x),minY:Math.min(k.minY,$.y),maxY:Math.max(k.maxY,$.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),l=o.maxX-o.minX,c=o.maxY-o.minY,d=Math.round(s.properties.area||0);Math.min(d*(n.maxCoverage/100),a.area*n.maxFAR);const x=Math.min(d*.4,5e4),h=Math.floor(n.maxHeight/12),m=Math.min(h,5),p=x/m,y=Math.sqrt(p*1.6),v=p/y;console.log("ðŸ¢ Office building calculation:",{buildableAreaSqFt:d,targetBuildingSqFt:x,floors:m,floorFootprint:p,buildingWidthFeet:y.toFixed(1),buildingDepthFeet:v.toFixed(1)});const u=y*r,j=v*r,g=o.minX+(l-u)/2,S=o.minY+(c-j)/2,b={id:Z(),type:"building",vertices:[{id:Z(),x:g,y:S},{id:Z(),x:g+u,y:S},{id:Z(),x:g+u,y:S+j},{id:Z(),x:g,y:S+j}],properties:{name:`Office Building (${x.toFixed(0)} sq ft, ${m} stories)`,color:"#1e40af",strokeColor:"#1e3a8a",fillOpacity:.8,area:x,stories:m}},_=Math.ceil(x/250),w=ps(_,s,[b],r);return{buildings:[jt(b,r)],parking:w,amenities:[],metrics:{totalUnits:1,totalSqFt:x,parkingSpaces:_,density:0,coverage:x/a.area*100,estimatedRevenue:x*i.avgRentPerSqFt*12,estimatedCost:x*i.constructionCostPerSqFt}}}},{id:"retail-center",name:"Retail Center",type:"retail",description:"Intelligent retail layout optimized for customer access",minArea:5e3,generator:t=>{const{buildableArea:s,parcelGeometry:a,zoning:n,marketData:i,gridSize:r}=t,o=s.vertices.reduce((k,$)=>({minX:Math.min(k.minX,$.x),maxX:Math.max(k.maxX,$.x),minY:Math.min(k.minY,$.y),maxY:Math.max(k.maxY,$.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),l=o.maxX-o.minX;o.maxY-o.minY;const c=Math.round(s.properties.area||0),d=Math.min(c*.3,2e4),x=Math.floor(n.maxHeight/12),h=Math.min(x,2),m=d/h,p=Math.min(l/r*.8,200),y=m/p,v=Math.floor(d/1500),u=p*r,j=y*r,g=o.minX+(l-u)/2,S=o.minY+20,b={id:Z(),type:"building",vertices:[{id:Z(),x:g,y:S},{id:Z(),x:g+u,y:S},{id:Z(),x:g+u,y:S+j},{id:Z(),x:g,y:S+j}],properties:{name:`Retail Center (${v} units, ${d.toFixed(0)} sq ft, ${h} stories)`,color:"#dc2626",strokeColor:"#b91c1c",fillOpacity:.8,area:d,stories:h}},_=Math.ceil(d/200),w=ps(_,s,[b],r);return{buildings:[jt(b,r)],parking:w,amenities:[],metrics:{totalUnits:v,totalSqFt:buildingSqFt,parkingSpaces:Math.ceil(buildingSqFt/200),density:0,coverage:buildingSqFt/a.area*100,estimatedRevenue:buildingSqFt*i.avgRentPerSqFt*12,estimatedCost:buildingSqFt*i.constructionCostPerSqFt}}}},{id:"hospitality",name:"Hotel/Hospitality",type:"mixed-use",description:"Hotel or hospitality facility with guest parking",minArea:15e3,generator:t=>{const{buildableArea:s,parcelGeometry:a,zoning:n,marketData:i,gridSize:r}=t,o=s.vertices.reduce(($,R)=>({minX:Math.min($.minX,R.x),maxX:Math.max($.maxX,R.x),minY:Math.min($.minY,R.y),maxY:Math.max($.maxY,R.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),l=o.maxX-o.minX;o.maxY-o.minY;const c=Math.round(s.properties.area||0),d=a.area/43560,x=Math.min(c*.5,3e4),h=Math.floor(x/400),m=Math.floor(n.maxHeight/12),p=Math.min(m,8),y=x/p,v=Math.sqrt(y*1.8),u=y/v,j=v*r,g=u*r,S=o.minX+(l-j)/2,b=o.minY+60,_={id:Z(),type:"building",vertices:[{id:Z(),x:S,y:b},{id:Z(),x:S+j,y:b},{id:Z(),x:S+j,y:b+g},{id:Z(),x:S,y:b+g}],properties:{name:`Hotel (${h} rooms, ${p} stories)`,color:"#f59e0b",strokeColor:"#d97706",fillOpacity:.8,area:x,stories:p}},w=Math.ceil(h*1.2),k=ps(w,s,[_],r);return{buildings:[jt(_,r)],parking:k,amenities:[],metrics:{totalUnits:h,totalSqFt:x,parkingSpaces:w,density:h/d,coverage:x/a.area*100,estimatedRevenue:h*150*365,estimatedCost:x*i.constructionCostPerSqFt*1.5}}}}],li=re.memo(function({parcel:s,marketData:a,onInvestmentAnalysis:n}){if(!s)return e.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-gray-500 mb-2",children:"No parcel selected"}),e.jsx("div",{className:"text-sm text-gray-400",children:"Please select a parcel to begin site planning"})]})});const[i,r]=f.useState([]),[o,l]=f.useState([]),[c,d]=f.useState(null),x=f.useMemo(()=>i.map(N=>({id:N.id,type:N.type,vertices:N.vertices,properties:N.properties,transform:{x:0,y:0,rotation:N.rotation||0,scaleX:1,scaleY:1},selected:o.includes(N.id),locked:!1})),[i,o]),h=f.useCallback(()=>{console.log("Undo triggered")},[]),m=f.useCallback(()=>{console.log("Redo triggered")},[]),p=f.useCallback(N=>{console.log("State saved:",N)},[]),[y,v]=f.useState(!0),[u,j]=f.useState(!0),[g,S]=f.useState(12),{dragState:b,multiSelectState:_,rotationHandle:w,onMouseDown:k,onMouseMove:$,onMouseUp:R}=bm({elements:x,onElementsChange:N=>{const E=N.map(M=>({...i.find(D=>D.id===M.id),vertices:M.vertices,rotation:M.transform.rotation,properties:M.properties}));r(E);const C=N.filter(M=>M.selected).map(M=>M.id);l(C)},gridSize:g,snapToGrid:u,snapDistance:10,onUndo:h,onRedo:m,onSaveState:p}),[T,P]=f.useState(!1),[I,Y]=f.useState(!1),[B,F]=f.useState("select"),[J,ce]=f.useState(!1),[U,q]=f.useState([]),[z,O]=f.useState(null),[V,te]=f.useState(!1),[Q,ne]=f.useState(null),[se,oe]=f.useState(null),[$e,he]=f.useState(0),[ie,Xe]=f.useState(!1),[Qe,Xt]=f.useState([{id:"buildings",name:"Buildings",visible:!0,locked:!1,color:"#3b82f6"},{id:"parking",name:"Parking",visible:!0,locked:!1,color:"#f59e0b"},{id:"utilities",name:"Utilities",visible:!0,locked:!1,color:"#10b981"},{id:"landscape",name:"Landscape",visible:!0,locked:!1,color:"#22c55e"},{id:"annotations",name:"Annotations",visible:!0,locked:!1,color:"#ef4444"}]),[Wt,$s]=f.useState("buildings"),[ge,Ce]=f.useState([]),[Se,et]=f.useState(null),[_t,St]=f.useState(null),[Vt,Ts]=f.useState(!1),[xe,tt]=f.useState(85),[ot,Ds]=f.useState([]),[ue,Ex]=f.useState({maxFAR:2.5,maxHeight:45,maxCoverage:40,frontSetback:25,sideSetback:15,rearSetback:20,minParkingRatio:1.5}),[ms,oi]=f.useState(!0),[qs,xs]=f.useState(null),[ct,Us]=f.useState(1),[Rx,ba]=f.useState({x:0,y:0}),[Tt,us]=f.useState("0 0 1200 800"),[Ls,ci]=f.useState(!1),[va,di]=f.useState({x:0,y:0}),[Mt,hi]=f.useState(1),nt=f.useRef(null),mi=f.useCallback((N,E)=>{const C=nt.current;if(!C)return 1;const M=C.getBoundingClientRect(),A=M.width,D=M.height,X=Math.max(N,E)*.1,W=N+X*2,G=E+X*2,ee=A/W,ae=D/G,de=Math.min(ee,ae);return console.log("ðŸ“ Baseline zoom calculation:",{parcelSize:{width:N,depth:E},svgSize:{width:A,height:D},totalSize:{width:W,height:G},baselineZoom:de.toFixed(3)}),de},[]),dt=f.useCallback(N=>{const E=Tt.split(" ").map(Number),C=E[2],M=E[3],A=nt.current;if(!A)return Math.max(24,N);const D=A.getBoundingClientRect(),X=Math.min(D.width/C,D.height/M),W=ct*Mt,G=Math.max(.5,Math.min(3,W)),ee=Math.max(16,N*X*G*2);return console.log(`ðŸ”¤ Font scaling: base=${N}, zoom=${W.toFixed(2)}x, viewBox=${C.toFixed(0)}x${M.toFixed(0)}, scale=${X.toFixed(3)}, scaled=${ee.toFixed(0)}`),Math.round(ee)},[Tt,ct,Mt]),[le,xi]=f.useState(null),[ui,gi]=f.useState(null),[ja,fi]=f.useState(null),[Fx,pi]=f.useState({width:1200,height:800}),Ht=1,yi=f.useMemo(()=>i.filter(N=>N.type==="building"),[i]),Bs=f.useMemo(()=>i.filter(N=>N.type==="parking"),[i]),bi=f.useMemo(()=>i.filter(N=>o.includes(N.id)),[i,o]),vi=f.useMemo(()=>i.filter(N=>N.type==="greenspace"&&N.properties.name?.includes("Buildable Area")),[i]);f.useMemo(()=>Bs.reduce((N,E)=>N+(E.properties.parkingSpaces||0),0),[Bs]);const ji=f.useMemo(()=>yi.length,[yi]),Na=f.useCallback((N=!0)=>{if(s?.ogc_fid){try{const C=JSON.parse(localStorage.getItem("savedSitePlans")||"{}")[s.ogc_fid.toString()];if(C&&C.elements)return console.log("Loading saved site plan:",C),r(C.elements),N&&alert("âœ… Loaded saved site plan! Your previous design has been restored."),!0}catch(E){console.error("Failed to load saved site plan:",E)}return!1}},[s?.ogc_fid]);f.useEffect(()=>{const N=async()=>{try{if(console.log("Loading parcel buildable envelope for:",s.ogc_fid),console.log("ðŸ” Parcel zoning data:",s.zoning_data),console.log("ðŸ” Permitted uses as of right:",s.zoning_data?.permitted_land_uses_as_of_right),console.log("ðŸ” Permitted uses conditional:",s.zoning_data?.permitted_land_uses_conditional),"pk.eyJ1IjoiZW1ydXNzMyIsImEiOiJjamlkcHY1aTAwY3I3M3FyeHAxc3Nia2VqIn0.mxsGEk2I8Ygkf3Q_zJKMcw"){console.log("ðŸ›£ï¸ Checking for road data...");try{const{data:M,error:A}=await me.from("roads").select("id").limit(1);if(A&&A.message.includes("does not exist"))console.warn("âš ï¸ Roads table not found - please deploy the SQL functions first");else if(!M||M.length===0){console.log("ðŸ“ No roads in database, importing from OpenStreetMap...");const D=await ym(s.ogc_fid);console.log("ðŸ” Road import result:",D),D.success?(console.log("âœ… Roads auto-imported successfully:",D.message),setTimeout(async()=>{const X=await Qi(s.ogc_fid);X&&(gi(X.buildableEnvelope),fi(X.edgeClassifications),console.log("ðŸ”„ Updated edge classifications after road import:",X.edgeClassifications))},1e3)):console.warn("âš ï¸ Road auto-import failed:",D.error)}else console.log("âœ… Roads already available in database")}catch(M){console.warn("âš ï¸ Road check/import error:",M)}}const C=await Qi(s.ogc_fid,{front:ue.frontSetback,rear:ue.rearSetback,side:ue.sideSetback});if(console.log("Loaded envelope data:",C),C){const{parcelGeometry:M,buildableEnvelope:A,edgeClassifications:D,metrics:X}=C;if(gi(A),fi(D),console.log("Edge classifications:",D),console.log("Parcel metrics:",X),A&&A.coordinates&&A.coordinates.length>0){console.log("ðŸ” Converting database buildable envelope to elements:",{coordinates:A.coordinates.length,area:A.area,width:A.width,depth:A.depth}),console.log("ðŸ” Raw buildable envelope coordinates (first 3):",A.coordinates.slice(0,3)),console.log("ðŸ” Parcel geometry bounds:",M.bounds),console.log("ðŸ” Parcel geometry coordinates (first 3):",M.coordinates.slice(0,3)),console.log("ðŸ” Total buildable envelope coordinates:",A.coordinates.length);const W=M.coordinates,G=X.front_setback_ft||25,ee=X.side_setback_ft||15,ae=X.rear_setback_ft||20;console.log("ðŸ” Applying dynamic setbacks:",{front:G,side:ee,rear:ae,parcelCoords:W.length});const de=W.reduce((pe,[ht])=>pe+ht,0)/W.length,be=W.reduce((pe,[,ht])=>pe+ht,0)/W.length,Pe=W.map(([pe,ht])=>[pe*g,ht*g]),Ue=Pe.reduce((pe,[ht])=>pe+ht,0)/Pe.length,Re=Pe.reduce((pe,[,ht])=>pe+ht,0)/Pe.length,Le=.9,Te=Pe.map(([pe,ht],_i)=>{const Si=Ue+(pe-Ue)*Le,Mi=Re+(ht-Re)*Le;return _i<3&&console.log(`ðŸ” Vertex ${_i}: (${pe}, ${ht}) -> scaled (${Si.toFixed(1)}, ${Mi.toFixed(1)})`),{id:Z(),x:Si,y:Mi}}),He=ia(Te),Ct=He/(g*g),Pt=s.sqft||s.deeded_acres*43560||78408,ke=Pt*.9;console.log("ðŸ” Buildable area calculation:",{parcelAreaSqFt:Pt,buildableAreaSqFt:ke,actualSVGArea:He,actualSVGAreaInSqFt:Ct,note:"Using correct parcel area from database"}),console.log("ðŸ” Buildable area calculation fix:",{actualBuildableAreaSVG:He.toFixed(0),actualBuildableAreaSqFt:Ct.toFixed(0),correctParcelAreaSqFt:Pt.toFixed(0),correctBuildableAreaSqFt:ke.toFixed(0),usingCorrectArea:!0}),console.log("ðŸ” Buildable area vertices (first 3):",{vertices:Te.slice(0,3).map(pe=>({x:pe.x.toFixed(0),y:pe.y.toFixed(0)})),totalVertices:Te.length,bounds:{minX:Math.min(...Te.map(pe=>pe.x)).toFixed(0),maxX:Math.max(...Te.map(pe=>pe.x)).toFixed(0),minY:Math.min(...Te.map(pe=>pe.y)).toFixed(0),maxY:Math.max(...Te.map(pe=>pe.y)).toFixed(0)}});const Fe={id:Z(),type:"greenspace",vertices:Te,properties:{name:"Buildable Area",color:"#22c55e",strokeColor:"#16a34a",fillOpacity:.15,area:ke}},Jt=ia(Te);console.log("ðŸ› DEBUG: Area calculations:",{actualBuildableAreaSqFt:Ct.toFixed(0),correctBuildableAreaSqFt:ke.toFixed(0),debugSVGArea:Jt.toFixed(0),debugSVGAreaDividedBy144:(Jt/144).toFixed(0),setAreaProperty:ke.toFixed(0),note:"Using correct buildable area calculation"}),console.log("ðŸ” Buildable area element created:",{id:Fe.id,type:Fe.type,vertexCount:Fe.vertices.length,firstVertex:Fe.vertices[0],lastVertex:Fe.vertices[Fe.vertices.length-1]});const rt=Fe;console.log("ðŸ” Buildable area created:",{vertices:rt.vertices.length,area:rt.properties.area,areaSqFt:(rt.properties.area/144).toFixed(0),bounds:{minX:Math.min(...rt.vertices.map(pe=>pe.x)).toFixed(0),maxX:Math.max(...rt.vertices.map(pe=>pe.x)).toFixed(0),minY:Math.min(...rt.vertices.map(pe=>pe.y)).toFixed(0),maxY:Math.max(...rt.vertices.map(pe=>pe.y)).toFixed(0)}}),r([rt])}if(M&&M.coordinates){const W={...M,coordinates:M.coordinates.map(([de,be])=>[de*g,be*g]),bounds:{minX:M.bounds.minX*g,minY:M.bounds.minY*g,maxX:M.bounds.maxX*g,maxY:M.bounds.maxY*g},width:M.width*g,depth:M.depth*g};xi(W),pi({width:W.width,height:W.depth});const G=mi(W.width,W.depth);hi(G),Us(1);const ee=Math.max(W.width,W.depth)*.1,ae=`${W.bounds.minX-ee} ${W.bounds.minY-ee} ${W.width+ee*2} ${W.depth+ee*2}`;us(ae),console.log("âœ… Parcel geometry loaded:",{width:M.width,height:M.depth,area:M.area,coordinates:M.coordinates.length,bounds:M.bounds,viewBox:ae})}}else{console.warn("âš ï¸ No envelope data available, falling back to basic geometry");const M=await Kn(s.ogc_fid);if(M&&M.coordinates){const A={...M,coordinates:M.coordinates.map(([G,ee])=>[G*g,ee*g]),bounds:{minX:M.bounds.minX*g,minY:M.bounds.minY*g,maxX:M.bounds.maxX*g,maxY:M.bounds.maxY*g},width:M.width*g,depth:M.depth*g};xi(A),pi({width:A.width,height:A.depth});const D=mi(A.width,A.depth);hi(D),Us(1);const X=Math.max(A.width,A.depth)*.1,W=`${A.bounds.minX-X} ${A.bounds.minY-X} ${A.width+X*2} ${A.depth+X*2}`;us(W)}}}catch(E){console.error("Error loading parcel geometry:",E)}};s?.ogc_fid&&(N(),Na(!1))},[s?.ogc_fid,Na]),f.useEffect(()=>{if(s?.ogc_fid&&i.length===0){const E=JSON.parse(localStorage.getItem("savedSitePlans")||"{}")[s.ogc_fid.toString()];E&&E.elements&&E.elements.length>0&&(console.log("Auto-loading saved site plan for parcel:",s.ogc_fid),r(E.elements),Xe(!0),setTimeout(()=>Xe(!1),3e3))}},[s?.ogc_fid,i.length]),f.useEffect(()=>{if(le&&i.length===0&&!ui&&s?.ogc_fid){console.log("ðŸ” Creating local buildable area since no database envelope available"),console.log("ðŸ” Initializing elements - elements.length:",i.length),console.log("ðŸ” Current elements:",i.map(ke=>({type:ke.type,name:ke.properties.name})));const N=le.coordinates,E=le.bounds,C=[];console.log("ðŸ” Creating buildable area that follows parcel geometry..."),console.log("ðŸ” Parcel coordinates:",N),console.log("ðŸ” Parcel bounds:",E);const M=15,A=Cs(M,g),D=N.reduce((ke,[Fe])=>ke+Fe,0)/N.length,X=N.reduce((ke,[,Fe])=>ke+Fe,0)/N.length,W=N.reduce((ke,[Fe,Jt])=>{const rt=Fe-D,pe=Jt-X;return ke+Math.sqrt(rt*rt+pe*pe)},0)/N.length,G=A,ee=Math.max(.85,(W-G)/W);console.log("ðŸ” Setback calculation:",{setbackFeet:M,setbackSVG:A,avgDistance:W.toFixed(1),actualInset:G.toFixed(1),insetRatio:ee.toFixed(3),parcelArea:le.area,expectedBuildableArea:(le.area*ee*ee).toFixed(0)});const ae=N.map(([ke,Fe])=>{const Jt=ke-D,rt=Fe-X;return{id:Z(),x:D+Jt*ee,y:X+rt*ee}});console.log("ðŸ” Buildable area calculation:",{centroid:{x:D,y:X},avgDistance:W.toFixed(1),setbackSVG:A,actualInset:G.toFixed(1),insetRatio:ee.toFixed(3),setbackFeet:M,originalVertices:N.length,insetVertices:ae.length});const be=ia(ae)/(g*g),Ue={id:Z(),type:"greenspace",vertices:ae,properties:{name:"Buildable Area",color:"#22c55e",strokeColor:"#16a34a",fillOpacity:.15,area:be}};C.push(Ue),console.log("âœ… Created buildable area following parcel shape:",{originalVertices:N.length,insetVertices:ae.length,setbackUsed:M,insetRatio:ee.toFixed(3),actualInsetDistance:G.toFixed(1),parcelAreaSqFt:le.area,buildableAreaSqFt:(Ue.properties.area||0).toFixed(0)});const Re=ae.reduce((ke,Fe)=>ke+Fe.x,0)/ae.length,Le=ae.reduce((ke,Fe)=>ke+Fe.y,0)/ae.length,Te=Re,He=Le,Ct=[{id:Z(),x:Te-50,y:He-30},{id:Z(),x:Te+50,y:He-30},{id:Z(),x:Te+50,y:He+30},{id:Z(),x:Te-50,y:He+30}],Pt={id:Z(),type:"building",vertices:Ct,properties:{name:"Building 1",color:"#3b82f6",strokeColor:"#1e40af",fillOpacity:.8}};C.push(jt(Pt,g)),r(C)}},[le,i.length,ue,ui]),f.useEffect(()=>{if(i.length>0&&le){const N=[];let E=100;const C=le.area||1;le.width,le.depth;const M=i.filter(G=>G.type==="building").reduce((G,ee)=>{const de=(ee.properties.area||0)/144;return G+de},0),A=i.filter(G=>G.type==="parking").reduce((G,ee)=>{const ae=ee.vertices;let de=0;for(let Re=0;Re<ae.length;Re++){const Le=(Re+1)%ae.length;de+=ae[Re].x*ae[Le].y,de-=ae[Le].x*ae[Re].y}de=Math.abs(de/2);const be=de/144,Ue=Math.floor(be/350);return console.log(`Parking ${ee.id}: SVG area=${de.toFixed(0)} unitsÂ², sq ft=${be.toFixed(0)}, spaces=${Ue} (${be.toFixed(0)}Ã·350)`),G+Math.max(0,Ue)},0),D=M/C*100;D>ue.maxCoverage&&(N.push(`Building coverage ${D.toFixed(1)}% exceeds ${ue.maxCoverage}% maximum`),E-=15);const X=M/C;X>ue.maxFAR&&(N.push(`FAR ${X.toFixed(2)} exceeds ${ue.maxFAR} maximum`),E-=20),i.forEach(G=>{if(G.type==="building"){const ee=G.vertices.reduce((Re,Le)=>({minX:Math.min(Re.minX,Le.x),maxX:Math.max(Re.maxX,Le.x),minY:Math.min(Re.minY,Le.y),maxY:Math.max(Re.maxY,Le.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0}),ae=le.bounds,de=Zt((ee.minX-ae.minX)*Ht,g),be=Zt((ae.maxX-ee.maxX)*Ht,g),Pe=Zt((ee.minY-ae.minY)*Ht,g),Ue=Zt((ae.maxY-ee.maxY)*Ht,g);Ue<ue.frontSetback&&(N.push(`${G.properties.name} violates front setback (${ue.frontSetback}' required, ${Ue.toFixed(1)}' provided)`),E-=10),de<ue.sideSetback&&(N.push(`${G.properties.name} violates west side setback (${ue.sideSetback}' required, ${de.toFixed(1)}' provided)`),E-=10),be<ue.sideSetback&&(N.push(`${G.properties.name} violates east side setback (${ue.sideSetback}' required, ${be.toFixed(1)}' provided)`),E-=10),Pe<ue.rearSetback&&(N.push(`${G.properties.name} violates rear setback (${ue.rearSetback}' required, ${Pe.toFixed(1)}' provided)`),E-=10)}});const W=Math.ceil(ji*ue.minParkingRatio);A<W&&(N.push(`Parking deficit: ${A} provided, ${W} required (${ue.minParkingRatio} per unit) - Formula: Parking Sq Ft Ã· 350 = spaces`),E-=15),tt(Math.max(E,0)),Ds(N)}},[i,le,ue,Ht]),f.useCallback(N=>{try{const E=nt.current;if(!E)return;const C=E.createSVGPoint();C.x=N.clientX,C.y=N.clientY;const M=C.matrixTransform(E.getScreenCTM()?.inverse()),A=je(M.x,g,u),D=je(M.y,g,u);if(console.log("Mouse down at SVG coords:",{x:A,y:D}),B==="building"){const G=60*g,ee=40*g,ae=[{id:Z(),x:je(A-G/2,g,u),y:je(D-ee/2,g,u)},{id:Z(),x:je(A+G/2,g,u),y:je(D-ee/2,g,u)},{id:Z(),x:je(A+G/2,g,u),y:je(D+ee/2,g,u)},{id:Z(),x:je(A-G/2,g,u),y:je(D+ee/2,g,u)}],de={id:Z(),type:"building",vertices:ae,properties:{name:`Building ${i.filter(be=>be.type==="building").length+1}`,color:"#3b82f6",strokeColor:"#1e40af",fillOpacity:.8,area:60*40}};r(be=>[...be,jt(de,g)]),F("select")}else if(B==="parking"){const G=Cs(120,g),ee=Cs(80,g),ae=[{id:Z(),x:je(A-G/2,g,u),y:je(D-ee/2,g,u)},{id:Z(),x:je(A+G/2,g,u),y:je(D-ee/2,g,u)},{id:Z(),x:je(A+G/2,g,u),y:je(D+ee/2,g,u)},{id:Z(),x:je(A-G/2,g,u),y:je(D+ee/2,g,u)}],de={id:Z(),type:"parking",vertices:ae,properties:{name:`Parking ${Bs.length+1}`,color:"#6b7280",strokeColor:"#374151",fillOpacity:.8}};r(be=>[...be,jt(de,g)]),F("select")}else if(B==="greenspace"){const X=[{id:Z(),x:je(A-60,g,u),y:je(D-40,g,u)},{id:Z(),x:je(A+60,g,u),y:je(D-40,g,u)},{id:Z(),x:je(A+60,g,u),y:je(D+40,g,u)},{id:Z(),x:je(A-60,g,u),y:je(D+40,g,u)}],W={id:Z(),type:"greenspace",vertices:X,properties:{name:`Greenspace ${i.filter(G=>G.type==="greenspace").length+1}`,color:"#22c55e",strokeColor:"#16a34a",fillOpacity:.6}};r(G=>[...G,jt(W,g)]),F("select")}else if(B==="measure"){const X={x:A,y:D};if(ge.length===0)Ce([X]);else if(ge.length===1){const W=Math.sqrt(Math.pow(A-ge[0].x,2)+Math.pow(D-ge[0].y,2)),G=Zt(W,g);et({distance:G,points:[ge[0],X]}),Ce([ge[0],X])}else Ce([]),et(null)}}catch(E){console.error("âŒ Error in handleMouseDown:",E)}},[B,i,ge,g,u]);const gs=f.useCallback(N=>{N.preventDefault();const E=nt.current;if(!E)return;const C=E.getBoundingClientRect(),M=C.width,A=C.height,D=N.clientX-C.left,X=N.clientY-C.top,W=N.deltaY,G=.1,ee=W>0?1-G:1+G,ae=Math.max(.01,Math.min(100,ct*ee)),de=Tt.split(" ").map(Number),[be,Pe,Ue,Re]=de,Le=be+D/M*Ue,Te=Pe+X/A*Re,He=ae*Mt,Ct=M/He,Pt=A/He,ke=Le-D/M*Ct,Fe=Te-X/A*Pt;Us(ae),ba({x:ke,y:Fe}),us(`${ke} ${Fe} ${Ct} ${Pt}`),console.log(`ðŸ” CAD Zoom: ${ae.toFixed(2)}x (actual: ${He.toFixed(2)}x) at (${Le.toFixed(0)}, ${Te.toFixed(0)})`)},[ct,Tt,Mt]);f.useCallback(N=>{try{if(Ls){const W=N.clientX-va.x,G=N.clientY-va.y,ee=Tt.split(" ").map(Number),[ae,de,be,Pe]=ee,Ue=ae-W/1200*be,Re=de-G/800*Pe;ba({x:Ue,y:Re}),di({x:N.clientX,y:N.clientY}),us(`${Ue} ${Re} ${be} ${Pe}`);return}if(V&&Q&&se){const W=nt.current;if(!W)return;const G=W.createSVGPoint();G.x=N.clientX,G.y=N.clientY;const ee=G.matrixTransform(W.getScreenCTM()?.inverse());let de=Math.atan2(ee.y-Q.y,ee.x-Q.x)*(180/Math.PI);de<0&&(de+=360),N.shiftKey&&(de=Math.round(de/15)*15),r(be=>be.map(Pe=>Pe.id===se?wm(Pe,de,Q):Pe));return}if(!b.isDragging||!nt.current?.getBoundingClientRect())return;const C=nt.current;if(!C)return;const M=C.createSVGPoint();M.x=N.clientX,M.y=N.clientY;const A=M.matrixTransform(C.getScreenCTM()?.inverse()),D=je(A.x,g,u),X=je(A.y,g,u);if(b.dragType==="vertex"&&b.elementId&&b.vertexId)r(W=>W.map(G=>{if(G.id!==b.elementId)return G;const ee=G.vertices.map(ae=>ae.id===b.vertexId?{...ae,x:D,y:X}:ae);return jt({...G,vertices:ee},g)}));else if(b.dragType==="element"&&b.elementId){const W=D-b.originalPosition.x,G=X-b.originalPosition.y;r(ee=>ee.map(ae=>{if(ae.id!==b.elementId)return ae;const de=b.originalVertices?.map(be=>({...be,x:je(be.x+W,g,u),y:je(be.y+G,g,u)}))||ae.vertices;return jt({...ae,vertices:de},g)}))}}catch(E){console.error("âŒ Error in handleMouseMove:",E),setDragState(C=>({...C,isDragging:!1}))}},[Ls,va,Tt,V,Q,o,b,g,u]),f.useCallback(()=>{try{setDragState(N=>({...N,isDragging:!1,dragType:"element",elementId:void 0,vertexId:void 0,offset:{x:0,y:0},originalPosition:{x:0,y:0},originalVertices:void 0})),Ls&&(ci(!1),di({x:0,y:0})),V&&(te(!1),ne(null),he(0),oe(null))}catch(N){console.error("âŒ Error in handleMouseUp:",N),setDragState({isDragging:!1,dragType:"element",offset:{x:0,y:0},originalPosition:{x:0,y:0}}),ci(!1),te(!1)}},[Ls,V]);const nr=f.useCallback(()=>{F("building")},[]),rr=f.useCallback(()=>{F("parking")},[]),lr=f.useCallback(()=>{F("greenspace")},[]),or=f.useCallback(()=>{ce(N=>!N),q([])},[]),cr=f.useCallback(()=>{F("measure"),Ce([]),et(null)},[]),dr=f.useCallback(()=>{Ce([]),et(null),B==="measure"&&F("select")},[B]),Ni=f.useCallback(()=>{if(!le){console.error("âŒ No parcel geometry for AI optimization");return}console.log("ðŸ¤– AI analyzing optimal layout for maximum ROI...");const N=i.find(W=>W.type==="greenspace"&&W.properties.name?.includes("Buildable Area"));if(!N){console.error("âŒ No buildable area found for AI optimization");return}const E={buildableArea:N,parcelGeometry:le,siteConstraints:ue,zoning:{maxFAR:s.zoning_data?.max_far||ue.maxFAR||2.5,maxHeight:s.zoning_data?.max_building_height_ft||ue.maxHeight||45,maxCoverage:s.zoning_data?.max_coverage_pct||ue.maxCoverage||40,maxDensity:s.zoning_data?.max_density_du_per_acre||50},marketData:a,gridSize:g},C=[];if(console.log("ðŸ§  AI analyzing all development scenarios..."),Fa.forEach(W=>{try{const G=W.generator(E),ee=G.metrics.estimatedRevenue,ae=G.metrics.estimatedCost,de=ee*.4,be=ee-de,Pe=ae>0?be/ae*100:0,Ue=G.metrics.density/50*20,Re=Math.min(Pe,15)*2,Le=G.metrics.coverage/ue.maxCoverage*25,Te=Math.min(ee/1e6,5)*5,He=Ue+Re+Le+Te;C.push({template:W,layout:G,roi:Pe,netIncome:be,score:He}),console.log(`ðŸ“Š ${W.name} analysis:`,{units:G.metrics.totalUnits,revenue:`$${(ee/1e6).toFixed(1)}M`,roi:`${Pe.toFixed(1)}%`,score:He.toFixed(1)})}catch(G){console.warn(`âš ï¸ Could not analyze ${W.name}:`,G)}}),C.length===0){alert("âŒ AI could not find any viable development scenarios for this parcel.");return}const M=C.reduce((W,G)=>G.score>W.score?G:W);console.log("ðŸŽ¯ AI selected optimal scenario:",{template:M.template.name,score:M.score.toFixed(1),roi:M.roi.toFixed(1),netIncome:`$${(M.netIncome/1e6).toFixed(1)}M`});const A=vi,D=[...M.layout.buildings,...M.layout.parking,...M.layout.amenities];r([...A,...D]);const X=M.layout.metrics;alert(`ðŸ¤– AI Optimization Complete!

Optimal Strategy: ${M.template.name}

â€¢ ${X.totalUnits} units
â€¢ ${X.parkingSpaces} parking spaces
â€¢ ${X.coverage.toFixed(1)}% coverage
â€¢ ROI: ${M.roi.toFixed(1)}%
â€¢ Net Income: $${(M.netIncome/1e6).toFixed(1)}M/year
â€¢ AI Score: ${M.score.toFixed(1)}/100

Factors: Density efficiency, ROI, site utilization, revenue potential

âœï¸ EDITING TIPS:
â€¢ Click buildings to select them
â€¢ Enable "Vertex Mode" to edit building shapes
â€¢ Drag vertices to resize buildings
â€¢ Use Ctrl+Click for multi-select
â€¢ Buildings can be moved, rotated, and resized!`)},[i,le,ue,a]),Dt=f.useCallback(N=>{const E=Fa.find(G=>G.id===N);if(!E||!le){console.error("âŒ Template not found or no parcel geometry:",N);return}const C=i.find(G=>G.type==="greenspace"&&G.properties.name?.includes("Buildable Area"));if(console.log("ðŸ” Available elements:",i.map(G=>({type:G.type,name:G.properties.name,area:G.properties.area,vertices:G.vertices.length,areaSqFt:G.properties.area?G.properties.area.toFixed(0)+" sq ft":"N/A"}))),console.log("ðŸ” Found buildable area element:",{found:!!C,area:C?.properties.area,vertices:C?.vertices.length,firstVertex:C?.vertices[0],bounds:C?{minX:Math.min(...C.vertices.map(G=>G.x)),maxX:Math.max(...C.vertices.map(G=>G.x)),minY:Math.min(...C.vertices.map(G=>G.y)),maxY:Math.max(...C.vertices.map(G=>G.y))}:null}),!C){console.error("âŒ No buildable area found for template application");return}console.log(`ðŸ—ï¸ Applying intelligent ${E.name} template...`);const M={buildableArea:C,parcelGeometry:le,siteConstraints:ue,zoning:{maxFAR:ue.maxFAR||2.5,maxHeight:ue.maxHeight||45,maxCoverage:ue.maxCoverage||40,maxDensity:50},marketData:a,gridSize:g},A=E.generator(M),D=vi,X=[...A.buildings,...A.parking,...A.amenities];r([...D,...X]),console.log(`âœ… Applied intelligent ${E.name} template:`,A.metrics);const W=A.metrics;alert(`ðŸ—ï¸ ${E.name} Generated!

â€¢ ${W.totalUnits} units
â€¢ ${W.parkingSpaces} parking spaces
â€¢ ${W.density.toFixed(1)} units/acre
â€¢ ${W.coverage.toFixed(1)}% coverage
â€¢ Est. Revenue: $${(W.estimatedRevenue/1e6).toFixed(1)}M/year

âœï¸ EDITING TIPS:
â€¢ Click buildings to select them
â€¢ Enable "Vertex Mode" to edit building shapes
â€¢ Drag vertices to resize buildings
â€¢ Use Ctrl+Click for multi-select
â€¢ Buildings can be moved, rotated, and resized!`)},[i,le,ue,a]),wi=f.useCallback(async()=>{try{console.log("ðŸ›£ï¸ Importing roads for current parcel...");let E="pk.eyJ1IjoiZW1ydXNzMyIsImEiOiJjamlkcHY1aTAwY3I3M3FyeHAxc3Nia2VqIn0.mxsGEk2I8Ygkf3Q_zJKMcw";if(!E&&(E=prompt("Mapbox token not found in .env. Enter your Mapbox access token:"),!E))return;const C=await browserImportRoads(s.ogc_fid,E);C.success?(alert(`âœ… Successfully imported roads! ${C.message||"Roads are now available for front lot line analysis."}`),window.location.reload()):alert(`âŒ Failed to import roads: ${C.error}`)}catch(N){console.error("âŒ Road import error:",N),alert(`âŒ Error importing roads: ${N.message}`)}},[s.ogc_fid]),hr=f.useCallback(()=>{r(N=>N.filter(E=>!o.includes(E.id))),l([]),q([])},[o]),mr=f.useCallback(()=>{const E=bi.map(C=>({...C,id:Z(),vertices:C.vertices.map(M=>({...M,id:Z(),x:M.x+20,y:M.y+20}))}));r(C=>[...C,...E]),l(E.map(C=>C.id))},[i,o]),wa=f.useCallback(N=>{if(o.length<2)return;const E=bi;let C=0;if(N==="left")C=Math.min(...E.map(M=>Math.min(...M.vertices.map(A=>A.x))));else if(N==="right")C=Math.max(...E.map(M=>Math.max(...M.vertices.map(A=>A.x))));else if(N==="center"){const M=Math.min(...E.map(D=>Math.min(...D.vertices.map(X=>X.x)))),A=Math.max(...E.map(D=>Math.max(...D.vertices.map(X=>X.x))));C=(M+A)/2}r(M=>M.map(A=>{if(!o.includes(A.id))return A;const D=A.vertices.reduce((G,ee)=>({minX:Math.min(G.minX,ee.x),maxX:Math.max(G.maxX,ee.x),minY:Math.min(G.minY,ee.y),maxY:Math.max(G.maxY,ee.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});let X=0,W=0;return N==="left"?X=C-D.minX:N==="right"?X=C-D.maxX:N==="center"&&(X=C-(D.minX+D.maxX)/2),{...A,vertices:A.vertices.map(G=>({...G,x:G.x+X,y:G.y+W}))}}))},[i,o]),_a=f.useCallback(()=>{const N=nt.current;if(!N)return;const E=N.getBoundingClientRect(),C=E.width/2,M=E.height/2,A={preventDefault:()=>{},clientX:E.left+C,clientY:E.top+M,deltaY:-100};gs(A)},[gs]),Sa=f.useCallback(()=>{const N=nt.current;if(!N)return;const E=N.getBoundingClientRect(),C=E.width/2,M=E.height/2,A={preventDefault:()=>{},clientX:E.left+C,clientY:E.top+M,deltaY:100};gs(A)},[gs]),Ma=f.useCallback(()=>{if(le){const{width:N,depth:E,bounds:C}=le;Us(1);const M=Math.max(N,E)*.1,A=N+M*2,D=E+M*2,X=C.minX+N/2,W=C.minY+E/2,G=`${X-A/2} ${W-D/2} ${A} ${D}`;us(G),ba({x:X-A/2,y:W-D/2}),console.log("ðŸŽ¯ Fit to parcel (1x baseline):",{parcelBounds:C,viewBox:G,zoom:"1.00x (baseline)",baselineZoom:Mt.toFixed(3)})}},[le,Mt]);f.useEffect(()=>{const N=E=>{if(!(E.target instanceof HTMLInputElement||E.target instanceof HTMLTextAreaElement))switch(E.key){case"=":case"+":E.preventDefault(),_a();break;case"-":E.preventDefault(),Sa();break;case"0":E.preventDefault(),Ma();break;case"Escape":E.preventDefault(),F("select"),l([]);break}};return window.addEventListener("keydown",N),()=>window.removeEventListener("keydown",N)},[_a,Sa,Ma]);const xr=f.useMemo(()=>{if(!le||!le.coordinates)return null;const N=le.coordinates,E=N.map(([C,M],A)=>`${A===0?"M":"L"} ${C} ${M}`).join(" ")+" Z";return e.jsxs("g",{children:[e.jsx("path",{d:E,fill:"rgba(156, 163, 175, 0.1)",stroke:"#374151",strokeWidth:"2",strokeDasharray:"8,4",style:{cursor:B==="select"?"pointer":"crosshair"},onClick:()=>{B==="select"&&(console.log("ðŸ” Parcel clicked, toggling dimensions:",!T),P(!T))}}),T&&N.map(([C,M],A)=>{const D=(A+1)%N.length,[X,W]=N[D],ee=Math.sqrt(Math.pow(X-C,2)+Math.pow(W-M,2))/g,ae=(C+X)/2,de=(M+W)/2;return e.jsxs("g",{children:[e.jsx("line",{x1:C,y1:M,x2:X,y2:W,stroke:"#ef4444",strokeWidth:"2",strokeDasharray:"4,2"}),e.jsx("rect",{x:ae-20,y:de-16,width:"40",height:"16",fill:"white",fillOpacity:"0.9",stroke:"#ef4444",strokeWidth:"1",rx:"2"}),e.jsxs("text",{x:ae,y:de-4,textAnchor:"middle",fontSize:Math.max(24,dt(20)),fill:"#ef4444",fontWeight:"bold",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",children:[ee.toFixed(0),"'"]},`dimension-${element.id}-${ct}`)]},`parcel-dim-${A}`)})]})},[le,T,g]),ur=f.useMemo(()=>i.map(N=>{const E=o.includes(N.id);return N.id,e.jsxs("g",{children:[e.jsx("path",{d:La(N.vertices),fill:N.properties.color||"#3b82f6",stroke:N.properties.strokeColor||"#1e40af",strokeWidth:E?3:2,fillOpacity:N.properties.fillOpacity||.8,className:"cursor-pointer",onMouseEnter:()=>d(N.id),onMouseLeave:()=>d(null),onMouseDown:C=>{if(!J){C.stopPropagation();const M=nt.current;if(M){const A=M.createSVGPoint();A.x=C.clientX,A.y=C.clientY;const D=A.matrixTransform(M.getScreenCTM()?.inverse());setDragState({isDragging:!0,dragType:"element",elementId:N.id,offset:{x:0,y:0},originalPosition:{x:D.x,y:D.y},originalVertices:[...N.vertices]})}}},onClick:C=>{C.stopPropagation(),C.ctrlKey||C.metaKey?o.includes(N.id)?l(M=>M.filter(A=>A!==N.id)):l(M=>[...M,N.id]):(console.log("ðŸ–±ï¸ Element clicked, selecting:",N.id,{elementType:N.type,elementName:N.properties.name,activeTool:B,isBuilding:N.type==="building"}),l([N.id]),console.log("ðŸ”„ Selection updated, should show rotation handles for building:",N.type==="building"),B==="select"&&N.type==="greenspace"&&N.properties.name==="Buildable Area"&&(console.log("ðŸ” Buildable area clicked, toggling dimensions:",!I),Y(!I)))}}),N.type==="parking"&&e.jsx("g",{children:_m(N,g)}),J&&E&&N.vertices.map(C=>e.jsx("circle",{cx:C.x,cy:C.y,r:"4",fill:U.includes(C.id)?"#ef4444":"#22c55e",stroke:"#ffffff",strokeWidth:"2",className:"cursor-move",onMouseEnter:()=>O(C.id),onMouseLeave:()=>O(null),onMouseDown:M=>{M.stopPropagation();const A=nt.current;if(A){const D=A.createSVGPoint();D.x=M.clientX,D.y=M.clientY;const X=D.matrixTransform(A.getScreenCTM()?.inverse());setDragState({isDragging:!0,dragType:"vertex",elementId:N.id,vertexId:C.id,offset:{x:0,y:0},originalPosition:{x:X.x,y:X.y}})}},onClick:M=>{M.stopPropagation(),U.includes(C.id)?q(A=>A.filter(D=>D!==C.id)):q(A=>[...A,C.id])}},C.id)),!J&&E&&(()=>{er(N.vertices);const C=N.vertices.reduce((M,A)=>({minX:Math.min(M.minX,A.x),maxX:Math.max(M.maxX,A.x),minY:Math.min(M.minY,A.y),maxY:Math.max(M.maxY,A.y)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});return e.jsxs("g",{children:[e.jsx("rect",{x:C.minX-2,y:C.minY-2,width:C.maxX-C.minX+4,height:C.maxY-C.minY+4,fill:"none",stroke:"#0078d4",strokeWidth:"2",strokeDasharray:"none"}),[{x:C.minX-4,y:C.minY-4},{x:C.maxX+4,y:C.minY-4},{x:C.minX-4,y:C.maxY+4},{x:C.maxX+4,y:C.maxY+4}].map((M,A)=>e.jsx("rect",{x:M.x-3,y:M.y-3,width:"6",height:"6",fill:"#0078d4",stroke:"white",strokeWidth:"1",className:"cursor-nw-resize"},A))]})})(),N.properties.name&&e.jsx("text",{x:N.vertices.reduce((C,M)=>C+M.x,0)/N.vertices.length,y:N.vertices.reduce((C,M)=>C+M.y,0)/N.vertices.length,textAnchor:"middle",dominantBaseline:"middle",fontSize:N.properties.name==="Buildable Area"?Math.max(32,dt(28)):Math.max(24,dt(20)),fill:"white",fontWeight:"bold",stroke:"black",strokeWidth:"2",paintOrder:"stroke fill",pointerEvents:"none",children:N.properties.name}),N.properties.area&&e.jsxs("text",{x:N.vertices.reduce((C,M)=>C+M.x,0)/N.vertices.length,y:N.vertices.reduce((C,M)=>C+M.y,0)/N.vertices.length+15,textAnchor:"middle",dominantBaseline:"middle",fontSize:N.properties.name==="Buildable Area"?Math.max(28,dt(24)):Math.max(20,dt(18)),fill:"white",fontWeight:"bold",stroke:"black",strokeWidth:"2",paintOrder:"stroke fill",pointerEvents:"none",children:[Math.round(N.properties.area||0).toLocaleString()," sq ft"]}),(E||N.type==="building"||N.type==="greenspace"&&N.properties.name==="Buildable Area"&&I)&&(N.type==="greenspace"&&N.properties.name==="Buildable Area"&&console.log("ðŸ” Rendering buildable area dimensions:",{showBuildableDimensions:I,elementName:N.properties.name,elementType:N.type}),!0)&&N.vertices.map((C,M)=>{const A=N.vertices[(M+1)%N.vertices.length],D=(C.x+A.x)/2,X=(C.y+A.y)/2,W=Math.sqrt(Math.pow(A.x-C.x,2)+Math.pow(A.y-C.y,2)),G=Zt(W,g);return N.type==="building"&&M<2&&console.log(`ðŸ” Building dimension ${M}:`,{svgDistance:W.toFixed(1),gridSize:g,feetDistance:G.toFixed(1),elementType:N.type,elementName:N.properties.name}),e.jsxs("g",{children:[e.jsx("line",{x1:C.x,y1:C.y,x2:A.x,y2:A.y,stroke:N.type==="building"?"#ef4444":N.type==="greenspace"?"#22c55e":"#f59e0b",strokeWidth:N.type==="building"?"2":"1",strokeDasharray:N.type==="building"?"4,2":"2,2"}),e.jsx("rect",{x:D-20,y:X-16,width:"40",height:"16",fill:"white",fillOpacity:"0.9",stroke:N.type==="building"?"#ef4444":N.type==="greenspace"?"#22c55e":"#f59e0b",strokeWidth:"1",rx:"2"}),e.jsxs("text",{x:D,y:X-8,textAnchor:"middle",fontSize:Math.max(56,dt(N.type==="building"?48:40)),fill:N.type==="building"?"#ef4444":N.type==="greenspace"?"#22c55e":"#f59e0b",fontWeight:"bold",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",className:"cursor-pointer",onClick:ee=>{ee.stopPropagation(),xs({elementId:N.id,edgeIndex:M,value:Math.round(G).toString(),x:ee.clientX,y:ee.clientY})},children:[Math.round(G),"'"]})]},`dimension-${M}`)}),E&&e.jsx("path",{d:La(N.vertices),fill:"none",stroke:"#22c55e",strokeWidth:"3",strokeDasharray:"5,5",pointerEvents:"none"}),ot.some(C=>C.includes(N.properties.name||""))&&e.jsx("circle",{cx:N.vertices[0].x+10,cy:N.vertices[0].y-10,r:"8",fill:"#ef4444",stroke:"#ffffff",strokeWidth:"2"})]},N.id)}).concat(!J&&o.length>0?i.filter(N=>o.includes(N.id)).map(N=>{const E=N.vertices.reduce((D,X)=>X.x>D.x||X.x===D.x&&X.y<D.y?X:D,N.vertices[0]),C=50,M=E.x+C,A=E.y-C;return e.jsxs("g",{children:[e.jsx("line",{x1:E.x,y1:E.y,x2:M,y2:A,stroke:"#6b7280",strokeWidth:"1",strokeDasharray:"2,2",opacity:"0.6",pointerEvents:"none"}),e.jsx("circle",{cx:M,cy:A,r:"12",fill:"#6b7280",stroke:"white",strokeWidth:"2",className:"cursor-grab hover:fill-gray-500 hover:scale-110 transition-all duration-200",title:"Drag to rotate 360Â° â€¢ Hold Shift for 15Â° increments",onMouseDown:D=>{D.stopPropagation(),console.log("ðŸ”„ PowerPoint-style rotation handle clicked for 360Â° rotation of",N.type,"element!");const X=nt.current;if(!X)return;const W=X.createSVGPoint();W.x=D.clientX,W.y=D.clientY;const G=W.matrixTransform(X.getScreenCTM()?.inverse()),ee=Math.atan2(G.y-E.y,G.x-E.x);te(!0),ne(E),he(ee),oe(N.id)}}),e.jsxs("g",{transform:`translate(${M}, ${A})`,children:[e.jsx("path",{d:"M -6 -2 A 6 6 0 0 1 6 -2",fill:"none",stroke:"white",strokeWidth:"3",strokeLinecap:"round",pointerEvents:"none"}),e.jsx("path",{d:"M 4 -4 L 6 -2 L 4 0",fill:"none",stroke:"white",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",pointerEvents:"none"})]}),V&&se===N.id&&e.jsxs(e.Fragment,{children:[e.jsxs("text",{x:M,y:A-25,textAnchor:"middle",fontSize:"12",fill:"#0078d4",fontWeight:"bold",className:"select-none",pointerEvents:"none",children:[Math.round(N.rotation||0),"Â°"]}),e.jsx("line",{x1:vertexX,y1:vertexY,x2:M,y2:A,stroke:"#0078d4",strokeWidth:"2",strokeDasharray:"3,3",opacity:"0.8",pointerEvents:"none"})]})]},`rotation-handle-${N.id}`)}):[]),[i,o,c,J,U,z,ot,Ht,g,V,Q,se]),gr=f.useMemo(()=>!w||!w.visible?null:e.jsxs("g",{children:[e.jsx("line",{x1:w.x,y1:w.y+20,x2:w.x,y2:w.y,stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5"}),e.jsx("circle",{cx:w.x,cy:w.y,r:"8",fill:"#3b82f6",stroke:"#ffffff",strokeWidth:"2",className:"cursor-grab",onMouseDown:N=>{N.stopPropagation();const E=i.find(C=>o.includes(C.id));E&&k(N,E.id)}}),e.jsx("text",{x:w.x,y:w.y+3,textAnchor:"middle",fontSize:"10",fill:"#ffffff",fontWeight:"bold",children:"â†»"})]}),[w,i,o,k]),fr=f.useMemo(()=>{if(!_)return null;const N=Math.min(_.startX,_.currentX),E=Math.min(_.startY,_.currentY),C=Math.abs(_.currentX-_.startX),M=Math.abs(_.currentY-_.startY);return e.jsx("rect",{x:N,y:E,width:C,height:M,fill:"rgba(59, 130, 246, 0.1)",stroke:"#3b82f6",strokeWidth:"1",strokeDasharray:"3,3"})},[_]);return e.jsxs("div",{className:"flex flex-col h-screen bg-gray-50",children:[ie&&e.jsxs("div",{className:"fixed top-4 right-4 z-50 bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"âœ… Site plan restored from previous session"})]}),e.jsx("div",{className:"bg-white border-b border-gray-200 p-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"text-base font-semibold",children:"CAD Site Planner"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["- ",s.address]})]}),e.jsxs("div",{className:"flex items-center space-x-1 overflow-x-auto",children:[e.jsx("button",{onClick:()=>F("select"),className:`p-1.5 rounded ${B==="select"?"bg-blue-100 text-blue-600":"hover:bg-gray-100"}`,title:"Select",children:e.jsx(Rs,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:or,className:`p-1.5 rounded ${J?"bg-green-100 text-green-600":"hover:bg-gray-100"}`,title:"Vertex Edit Mode",children:e.jsx(gn,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"}),e.jsx("button",{onClick:nr,className:`p-1.5 rounded ${B==="building"?"bg-blue-100 text-blue-600":"hover:bg-gray-100"}`,title:"Add Building",children:e.jsx(qe,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:rr,className:`p-1.5 rounded ${B==="parking"?"bg-blue-100 text-blue-600":"hover:bg-gray-100"}`,title:"Add Parking",children:e.jsx(Ot,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:lr,className:`p-1.5 rounded ${B==="greenspace"?"bg-blue-100 text-blue-600":"hover:bg-gray-100"}`,title:"Add Greenspace",children:e.jsx(wr,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"}),e.jsx("button",{onClick:cr,className:`p-1.5 rounded ${B==="measure"?"bg-purple-100 text-purple-600":"hover:bg-gray-100"}`,title:"Measure Distance",children:e.jsx(_r,{className:"w-3.5 h-3.5"})}),Se&&e.jsx("button",{onClick:dr,className:"p-1.5 hover:bg-gray-100 rounded",title:"Clear Measurement",children:e.jsx(fe,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"}),o.length>=2&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>wa("left"),className:"p-1.5 hover:bg-gray-100 rounded",title:"Align Left",children:e.jsx(Sr,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>wa("center"),className:"p-1.5 hover:bg-gray-100 rounded",title:"Align Center",children:e.jsx(Mr,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>wa("right"),className:"p-1.5 hover:bg-gray-100 rounded",title:"Align Right",children:e.jsx(Cr,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"})]}),e.jsx("button",{onClick:mr,disabled:o.length===0,className:"p-1.5 hover:bg-gray-100 rounded disabled:opacity-50 disabled:cursor-not-allowed",title:"Copy Selected",children:e.jsx(hn,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:hr,disabled:o.length===0,className:"p-1.5 hover:bg-gray-100 rounded disabled:opacity-50 disabled:cursor-not-allowed",title:"Delete Selected",children:e.jsx(xn,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"}),e.jsx("button",{onClick:_a,className:"p-1.5 hover:bg-blue-100 rounded bg-blue-50",title:"Zoom In",children:e.jsx(Pr,{className:"w-3.5 h-3.5 text-blue-600"})}),e.jsx("button",{onClick:Sa,className:"p-1.5 hover:bg-blue-100 rounded bg-blue-50",title:"Zoom Out",children:e.jsx(kr,{className:"w-3.5 h-3.5 text-blue-600"})}),e.jsx("button",{onClick:Ma,className:"p-1.5 hover:bg-green-100 rounded bg-green-50",title:"Fit to Parcel",children:e.jsx(Ar,{className:"w-3.5 h-3.5 text-green-600"})}),e.jsxs("div",{className:"px-2 py-1 text-xs font-mono text-gray-600 bg-gray-100 rounded",children:[ct.toFixed(2),"x",Mt!==1&&e.jsxs("span",{className:"text-gray-500 ml-1",children:["(",(ct*Mt).toFixed(2),"x)"]})]}),e.jsx("div",{className:"w-px h-6 bg-gray-300"}),e.jsx("button",{onClick:()=>{const N=[];let E=100;i.forEach(D=>{D.type==="building"&&Math.min(...D.vertices.map(W=>W.x))<15&&(N.push(`${D.properties.name} violates front setback`),E-=10)});const C=i.filter(D=>D.type==="building").reduce((D,X)=>D+(X.properties.area||0),0),M=le?.area||1;C/M>.4&&(N.push("Building coverage exceeds 40% maximum"),E-=15),tt(Math.max(E,0)),Ds(N)},className:"p-1.5 hover:bg-gray-100 rounded",title:"Analyze Compliance",children:e.jsx(_e,{className:"w-3.5 h-3.5"})}),xe<100&&e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-medium ${xe>=80?"bg-green-100 text-green-800":xe>=60?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:[xe,"%"]}),e.jsx("button",{onClick:()=>oi(!ms),className:`p-1.5 rounded ${ms?"bg-orange-100 text-orange-600":"hover:bg-gray-100"}`,title:ms?"Hide Site Constraints":"Show Site Constraints",children:e.jsx(pt,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"w-px h-4 bg-gray-300"}),e.jsx("button",{onClick:Ni,className:"px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-medium rounded hover:from-purple-600 hover:to-pink-600 shadow-lg",title:"AI Optimization - Analyze all scenarios and select optimal layout for maximum ROI",children:"ðŸ¤– AI"}),e.jsx("div",{className:"w-px h-6 bg-gray-300"}),e.jsxs("div",{className:"flex items-center space-x-0.5",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Templates:"}),e.jsx("button",{onClick:()=>Dt("single-family"),className:"px-1.5 py-0.5 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200",title:"Single Family Home",children:"SFH"}),e.jsx("button",{onClick:()=>Dt("duplex"),className:"px-1.5 py-0.5 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200",title:"Duplex (2 units)",children:"Duplex"}),e.jsx("button",{onClick:()=>Dt("apartment-complex"),className:"px-1.5 py-0.5 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200",title:"Apartment Complex (4-400 units)",children:"Apt"}),e.jsx("button",{onClick:()=>Dt("office-building"),className:"px-1.5 py-0.5 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200",title:"Office Building",children:"Office"}),e.jsx("button",{onClick:()=>Dt("retail-center"),className:"px-1.5 py-0.5 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200",title:"Retail Center",children:"Retail"}),e.jsx("button",{onClick:()=>Dt("hospitality"),className:"px-1.5 py-0.5 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200",title:"Hotel/Hospitality",children:"Hotel"})]}),e.jsx("button",{onClick:wi,className:"p-1.5 hover:bg-gray-100 rounded",title:"Refresh Roads",children:e.jsx(ft,{className:"w-3.5 h-3.5"})})]})]})}),e.jsxs("div",{className:"flex flex-1 bg-gray-100 min-h-0",children:[e.jsx("div",{className:`${ms?"flex-1":"w-full"} p-2 min-h-0`,children:e.jsxs("div",{className:"w-full h-full bg-white border border-gray-300 rounded-lg shadow-lg relative overflow-hidden min-h-[600px]",children:[e.jsxs("svg",{ref:nt,width:"100%",height:"100%",viewBox:Tt,className:"absolute inset-0 cursor-crosshair",onMouseDown:k,onMouseMove:$,onMouseUp:R,onMouseLeave:R,onWheel:gs,children:[e.jsxs("defs",{children:[e.jsx("pattern",{id:"grid",width:g,height:g,patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:`M ${g} 0 L 0 0 0 ${g}`,fill:"none",stroke:ct>2?"#d1d5db":"#e5e7eb",strokeWidth:ct>5?"1":"0.5"})}),ct>3&&e.jsx("pattern",{id:"fine-grid",width:g/4,height:g/4,patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:`M ${g/4} 0 L 0 0 0 ${g/4}`,fill:"none",stroke:"#f3f4f6",strokeWidth:"0.25"})})]}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),ct>3&&e.jsx("rect",{width:"100%",height:"100%",fill:"url(#fine-grid)"}),xr,le&&e.jsxs("g",{children:[e.jsxs("text",{x:le.bounds.minX+le.width/2,y:le.bounds.maxY+40,textAnchor:"middle",fontSize:Math.max(72,dt(60)),fill:"#ef4444",fontWeight:"bold",stroke:"white",strokeWidth:"3",paintOrder:"stroke fill",children:["STREET FRONT",ja?.method==="road_proximity"&&ja?.nearest_road_name&&` (${ja.nearest_road_name})`]}),e.jsxs("g",{transform:`translate(${le.bounds.maxX-50}, ${le.bounds.minY+50})`,children:[e.jsx("circle",{cx:"0",cy:"0",r:"25",fill:"white",stroke:"#374151",strokeWidth:"2"}),e.jsx("text",{x:"0",y:"-8",textAnchor:"middle",fontSize:Math.max(56,dt(48)),fill:"#374151",fontWeight:"bold",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",children:"N"}),e.jsx("text",{x:"0",y:"15",textAnchor:"middle",fontSize:Math.max(56,dt(48)),fill:"#ef4444",fontWeight:"bold",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",children:"S"}),e.jsx("text",{x:"-12",y:"3",textAnchor:"middle",fontSize:Math.max(56,dt(48)),fill:"#374151",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",children:"W"}),e.jsx("text",{x:"12",y:"3",textAnchor:"middle",fontSize:Math.max(56,dt(48)),fill:"#374151",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",children:"E"}),e.jsx("line",{x1:"0",y1:"-18",x2:"0",y2:"-8",stroke:"#ef4444",strokeWidth:"3",markerEnd:"url(#arrow)"})]})]}),e.jsx("g",{children:ur}),gr,fr,Se&&e.jsxs("g",{children:[e.jsx("line",{x1:Se.points[0].x,y1:Se.points[0].y,x2:Se.points[1].x,y2:Se.points[1].y,stroke:"#8b5cf6",strokeWidth:"2"}),e.jsx("circle",{cx:Se.points[0].x,cy:Se.points[0].y,r:"4",fill:"#8b5cf6"}),e.jsx("circle",{cx:Se.points[1].x,cy:Se.points[1].y,r:"4",fill:"#8b5cf6"}),e.jsxs("text",{x:(Se.points[0].x+Se.points[1].x)/2,y:(Se.points[0].y+Se.points[1].y)/2-10,textAnchor:"middle",fontSize:Math.max(56,dt(48)),fill:"#8b5cf6",fontWeight:"bold",stroke:"white",strokeWidth:"2",paintOrder:"stroke fill",className:"bg-white",children:[Math.round(Se.distance),"'"]})]}),ge.map((N,E)=>e.jsx("circle",{cx:N.x,cy:N.y,r:"3",fill:"#8b5cf6",stroke:"#ffffff",strokeWidth:"2"},E))]}),qs&&e.jsxs("div",{className:"absolute z-50 bg-white border border-gray-300 rounded shadow-lg p-2",style:{left:qs.x-50,top:qs.y-30},children:[e.jsx("input",{type:"number",value:qs.value,onChange:N=>xs(E=>E?{...E,value:N.target.value}:null),onKeyDown:N=>{(N.key==="Enter"||N.key==="Escape")&&xs(null)},onBlur:()=>xs(null),className:"w-16 px-2 py-1 text-sm border border-gray-300 rounded",autoFocus:!0}),e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"'"})]})]})}),ms&&e.jsxs("div",{className:"w-72 bg-white border-l border-gray-300 overflow-y-auto p-2 max-h-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Site Design Panel"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:wi,className:"px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200",title:"Refresh Roads from Mapbox",children:"Refresh Roads"}),e.jsx("button",{onClick:()=>oi(!1),className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(fe,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"mb-2 space-y-2",children:[e.jsx("div",{className:"p-2 bg-green-50 rounded border border-green-200",children:e.jsxs("button",{onClick:async()=>{try{const N={id:`siteplan-${s.ogc_fid}-${Date.now()}`,name:`${s.address} - Site Plan`,parcelId:s.ogc_fid.toString(),elements:i,parcel:s,timestamp:new Date().toISOString(),metadata:{version:1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},E=JSON.parse(localStorage.getItem("savedSitePlans")||"{}");E[s.ogc_fid.toString()]=N,localStorage.setItem("savedSitePlans",JSON.stringify(E)),sessionStorage.setItem("currentSitePlan",JSON.stringify(N));const C=new CustomEvent("sitePlanSave",{detail:N});window.dispatchEvent(C),alert("âœ… Site plan saved successfully! Your design will persist when you navigate between tabs.")}catch(N){console.error("Failed to save site plan:",N),alert("âŒ Failed to save site plan. Please try again.")}},className:"w-full px-3 py-2 bg-green-600 text-white hover:bg-green-700 rounded-md text-sm font-medium flex items-center justify-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"ðŸ’¾ Save Site Plan"})]})}),e.jsx("div",{className:"p-2 bg-blue-50 rounded border border-blue-200",children:e.jsxs("button",{onClick:()=>{Na()},className:"w-full px-3 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md text-sm font-medium flex items-center justify-center space-x-2",children:[e.jsx(ga,{className:"w-4 h-4"}),e.jsx("span",{children:"ðŸ“‚ Load Saved Plan"})]})})]}),e.jsx("div",{className:"mb-1 p-1.5 bg-gradient-to-r from-purple-50 to-pink-50 rounded border border-purple-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-purple-900 text-xs",children:"ðŸ¤– AI Optimization"}),e.jsx("div",{className:"text-xs text-purple-700",children:"Auto-select optimal layout"})]}),e.jsx("button",{onClick:Ni,className:"px-2 py-0.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-medium rounded hover:from-purple-700 hover:to-pink-700",children:"Run AI"})]})}),e.jsxs("div",{className:"mb-1 p-1.5 bg-purple-50 rounded",children:[e.jsx("h4",{className:"font-medium text-purple-900 mb-1 text-xs",children:"Development Templates"}),e.jsx("div",{className:"space-y-0.5",children:Fa.map(N=>{const E=i.find(D=>D.type==="greenspace"&&D.properties.name?.includes("Buildable Area"));let C=0;E?C=Math.round(E.properties.area||0):C=le?le.width*le.height*.7/144:0;const M=C>=N.minArea;console.log(`ðŸ—ï¸ Template ${N.name}: buildable=${Math.round(C)} sf, required=${N.minArea} sf, canFit=${M}`);let A="";if(M){if(N.id==="single-family")A="1 home, ~2,500 sq ft";else if(N.id==="duplex")A="2 units, ~1,200 sq ft each";else if(N.id==="apartment-complex"){const D=Math.min(Math.floor((le?.area||0)/43560*20),Math.floor(C*.4/600));A=`${D} units, ${Math.floor(D/4)} buildings`}else if(N.id==="office-building")A=`${Math.floor(Math.min(C*.4,5e4)).toLocaleString()} sq ft office`;else if(N.id==="retail-center"){const D=Math.floor(Math.min(C*.3,2e4));A=`${Math.floor(D/1500)} retail units, ${D.toLocaleString()} sq ft`}else if(N.id==="hospitality"){const D=Math.floor(Math.min(C*.5,3e4));A=`${Math.floor(D/400)} hotel rooms`}}return e.jsxs("div",{className:`flex items-center justify-between p-1 rounded border text-xs ${M?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-medium text-xs",children:N.name}),e.jsx("div",{className:"text-gray-600 text-xs truncate",children:M?A:`Need ${(N.minArea-C).toLocaleString()} more SF`})]}),M&&e.jsx("button",{onClick:()=>{console.log(`ðŸ”„ Generate button clicked for ${N.name}`,{templateId:N.id,buildableAreaSqFt:C,elementsCount:i.length,parcelGeometry:!!le}),Dt(N.id)},className:"px-1.5 py-0.5 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex-shrink-0",children:"Generate"})]},N.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-1 text-xs",children:"Zoning & Development Rights"}),e.jsxs("div",{className:"mb-1 p-1.5 bg-gray-50 rounded",children:[e.jsx("h5",{className:"font-medium text-gray-800 mb-1 text-xs",children:"Zoning Classification:"}),e.jsxs("div",{className:"text-xs space-y-0.5",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Zone:"})," ",s.zoning||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Description:"})," ",s.zoning_description||"N/A"]}),s.zoning_data?.zoning_type&&e.jsxs("div",{children:[e.jsx("strong",{children:"Type:"})," ",s.zoning_data.zoning_type]}),s.zoning_data?.zoning_objective&&e.jsxs("div",{children:[e.jsx("strong",{children:"Objective:"})," ",s.zoning_data.zoning_objective]})]})]}),s.zoning_data?.permitted_land_uses_as_of_right||s.zoning_data?.permitted_land_uses_conditional?e.jsxs("div",{className:"mb-3 p-2 bg-green-50 rounded",children:[s.zoning_data.permitted_land_uses_as_of_right&&e.jsxs("div",{className:"mb-2",children:[e.jsx("h5",{className:"font-medium text-green-800 mb-1 text-sm",children:"âœ… Allowed By Right:"}),e.jsx("div",{className:"space-y-0.5 text-xs",children:s.zoning_data.permitted_land_uses_as_of_right.split(",").map((N,E)=>e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),e.jsx("span",{children:N.trim()})]},E))})]}),s.zoning_data.permitted_land_uses_conditional&&e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-yellow-800 mb-1 text-sm",children:"âš ï¸ Conditional Uses:"}),e.jsx("div",{className:"space-y-0.5 text-xs",children:s.zoning_data.permitted_land_uses_conditional.split(",").map((N,E)=>e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-yellow-500 rounded-full"}),e.jsx("span",{children:N.trim()})]},E))})]})]}):e.jsxs("div",{className:"mb-3 p-2 bg-yellow-50 rounded",children:[e.jsx("h5",{className:"font-medium text-yellow-800 mb-1 text-sm",children:"Permitted Uses (Based on Zone):"}),e.jsxs("div",{className:"text-xs text-yellow-700 mb-1",children:['"',s.zoning_description,'" typically allows:']}),e.jsxs("div",{className:"space-y-0.5 text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),e.jsxs("span",{children:["Residential: Up to ",Math.floor((le?.area||0)/43560*20)," units (20/acre)"]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-yellow-500 rounded-full"}),e.jsx("span",{children:"May allow accessory commercial uses"})]})]})]}),e.jsxs("div",{className:"mb-3 p-2 bg-blue-50 rounded",children:[e.jsx("h5",{className:"font-medium text-blue-900 mb-1 text-sm",children:"Development Potential:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-0.5 text-xs text-blue-800",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Units:"})," ",le?Math.floor((s.sqft||le.area)/43560*20):"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Stories:"})," ",Math.floor((s.zoning_data?.max_building_height_ft||45)/10)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Floor Area:"})," ",le?Math.round((s.sqft||le.area)*(s.zoning_data?.max_far||2.5)/1e3).toLocaleString():"N/A","k sf"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Coverage:"})," ",Math.round((s.sqft||le?.area||0)*.4/1e3).toLocaleString(),"k sf"]})]})]}),e.jsxs("div",{className:"mb-3 p-2 bg-gray-50 rounded",children:[e.jsx("h5",{className:"font-medium text-gray-800 mb-1 text-sm",children:"Setbacks & Requirements:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-0.5 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Front:"}),e.jsxs("span",{className:"font-medium",children:[ue.frontSetback,"'"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Rear:"}),e.jsxs("span",{className:"font-medium",children:[ue.rearSetback,"'"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Side:"}),e.jsxs("span",{className:"font-medium",children:[ue.sideSetback,"'"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Parking:"}),e.jsxs("span",{className:"font-medium",children:[ue.minParkingRatio,"/unit"]})]})]})]}),e.jsxs("details",{className:"mt-4",children:[e.jsx("summary",{className:"text-xs text-gray-500 cursor-pointer",children:"ðŸ” Debug: Raw Zoning Data"}),e.jsx("pre",{className:"text-xs bg-gray-100 p-2 mt-1 rounded overflow-auto max-h-32",children:JSON.stringify({zoning:s.zoning,zoning_description:s.zoning_description,zoning_data_available:!!s.zoning_data,permitted_as_of_right:s.zoning_data?.permitted_land_uses_as_of_right,permitted_conditional:s.zoning_data?.permitted_land_uses_conditional,max_density:s.zoning_data?.max_density_du_per_acre,max_far:s.zoning_data?.max_far},null,2)})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 mb-3",children:["Current Violations (",ot.length,")"]}),ot.length>0?e.jsx("div",{className:"space-y-2",children:ot.map((N,E)=>e.jsxs("div",{className:"flex items-start space-x-2 text-sm",children:[e.jsx(lt,{className:"w-4 h-4 text-red-500 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-red-700",children:N})]},E))}):e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-green-700",children:[e.jsx(_e,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{children:"All constraints satisfied"})]})]})]}),e.jsxs("div",{className:"mt-3 pt-2 border-t border-gray-200",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2 text-sm",children:"Current Site Metrics"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-600",children:le?`${le.width.toFixed(0)}' Ã— ${le.depth.toFixed(0)}'`:"N/A"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Parcel Size"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-600",children:s.sqft?Math.round(s.sqft).toLocaleString():"N/A"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Area (sq ft)"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-600",children:i.filter(N=>N.type==="building").length}),e.jsx("div",{className:"text-xs text-gray-600",children:"Buildings"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-600",children:i.filter(N=>N.type==="parking").reduce((N,E)=>{const C=E.vertices;let M=0;for(let X=0;X<C.length;X++){const W=(X+1)%C.length;M+=C[X].x*C[W].y,M-=C[W].x*C[X].y}M=Math.abs(M/2);const A=M/144,D=Math.floor(A/350);return N+Math.max(0,D)},0)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Parking Spaces"})]})]})]})]})]}),e.jsx("div",{className:"bg-white border-t border-gray-200 px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:["Tool: ",B.charAt(0).toUpperCase()+B.slice(1),J&&" (Vertex Mode)"]}),e.jsxs("span",{children:["Selected: ",o.length]}),e.jsxs("span",{children:["Elements: ",i.length]}),U.length>0&&e.jsxs("span",{children:["Vertices: ",U.length]}),Se&&e.jsxs("span",{className:"text-purple-600 font-medium",children:["Distance: ",Math.round(Se.distance),"'"]}),ot.length>0&&e.jsxs("span",{className:"text-red-600 font-medium",children:["Violations: ",ot.length]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:["Zoom: ",Math.round(ct*100),"%"]}),e.jsxs("span",{children:["Grid: ",g/12,'"']}),e.jsxs("span",{children:["Buildings: ",ji," | Parking: ",Bs.length]})]})]})})]})}),Sm=re.memo(function({parcel:s,onUnderwritingUpdate:a}){const{configuration:n,sitePlanResult:i,loading:r,error:o,updateConfiguration:l,updateUnitMix:c,autoGenerate:d,getConstraintSummary:x,getFeasibilityStatus:h,getOptimizationScore:m,getFinancialSummary:p,getParkingSummary:y,validateConfiguration:v,getRecommendedConfigurations:u,isEngineAvailable:j}=yl(s.zoning_data,s.sqft),[g,S]=f.useState("design"),[b,_]=f.useState(!1);f.useEffect(()=>{j&&d()},[n,j,d]),f.useEffect(()=>{if(i&&a){const F=p();F&&a({sitePlanCost:F.totalCost,sitePlanRevenue:F.totalRevenue,netImpact:F.netImpact,costPerUnit:F.costPerUnit,revenuePerUnit:F.revenuePerUnit})}},[i,a,p]);const w=F=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(F),k=F=>`${(F*100).toFixed(1)}%`,$=F=>{switch(F){case"excellent":return"text-green-600 bg-green-100";case"good":return"text-blue-600 bg-blue-100";case"acceptable":return"text-yellow-600 bg-yellow-100";case"infeasible":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}};x();const R=h(),T=m(),P=p(),I=y(),Y=v(),B=u();return j?e.jsxs("div",{className:"p-3 space-y-3 max-h-[700px] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-4 h-4 text-blue-600"}),e.jsx("h2",{className:"text-base font-semibold text-gray-900",children:"Site Plan Designer"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${$(R)}`,children:R.toUpperCase()}),T>0&&e.jsxs("span",{className:"px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded",children:[T.toFixed(0),"%"]})]})]}),e.jsxs("div",{className:"flex space-x-1 bg-gray-100 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>S("design"),className:`flex-1 px-2 py-1.5 rounded-md text-xs font-medium transition-colors ${g==="design"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:"Design"}),e.jsx("button",{onClick:()=>S("visual"),className:`flex-1 px-2 py-1.5 rounded-md text-xs font-medium transition-colors ${g==="visual"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[e.jsx(ga,{className:"w-3 h-3"}),e.jsx("span",{children:"Visual"})]})}),e.jsx("button",{onClick:()=>S("analysis"),className:`flex-1 px-2 py-1.5 rounded-md text-xs font-medium transition-colors ${g==="analysis"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:"Analysis"}),e.jsx("button",{onClick:()=>S("recommendations"),className:`flex-1 px-2 py-1.5 rounded-md text-xs font-medium transition-colors ${g==="recommendations"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:e.jsx("span",{className:"truncate",children:"Recs"})})]}),o&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(lt,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("h3",{className:"text-red-800 font-medium",children:"Error"})]}),e.jsx("p",{className:"text-red-700 mt-2",children:o})]}),Y.errors.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(lt,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("h3",{className:"text-red-800 font-medium",children:"Configuration Errors"})]}),e.jsx("ul",{className:"text-red-700 mt-2 space-y-1",children:Y.errors.map((F,J)=>e.jsxs("li",{children:["â€¢ ",F]},J))})]}),g==="design"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Basic Configuration"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Target Units"}),e.jsx("input",{type:"number",value:n.targetUnits,onChange:F=>l({targetUnits:parseInt(F.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Building Type"}),e.jsxs("select",{value:n.buildingType,onChange:F=>l({buildingType:F.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"residential",children:"Residential"}),e.jsx("option",{value:"commercial",children:"Commercial"}),e.jsx("option",{value:"mixed-use",children:"Mixed-Use"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Parking Type"}),e.jsxs("select",{value:n.parkingType,onChange:F=>l({parkingType:F.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"surface",children:"Surface"}),e.jsx("option",{value:"garage",children:"Garage"}),e.jsx("option",{value:"underground",children:"Underground"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amenity Space (sq ft)"}),e.jsx("input",{type:"number",value:n.amenitySpace,onChange:F=>l({amenitySpace:parseInt(F.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Unit Mix"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:Object.entries(n.unitMix).map(([F,J])=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 capitalize",children:F.replace(/([A-Z])/g," $1").trim()}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:J,onChange:ce=>c(F,parseFloat(ce.target.value)),className:"flex-1"}),e.jsx("span",{className:"text-sm font-medium text-gray-900 w-12",children:k(J)})]})]},F))}),e.jsxs("div",{className:"mt-4 text-sm text-gray-600",children:["Total: ",k(Object.values(n.unitMix).reduce((F,J)=>F+J,0))]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("button",{onClick:()=>_(!b),className:"flex items-center space-x-2 text-sm font-medium text-gray-700 hover:text-gray-900",children:[e.jsx(pt,{className:"w-4 h-4"}),e.jsx("span",{children:"Advanced Settings"})]}),b&&e.jsx("div",{className:"mt-4 space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Open Space Ratio"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"range",min:"0",max:"0.5",step:"0.05",value:n.openSpaceRatio,onChange:F=>l({openSpaceRatio:parseFloat(F.target.value)}),className:"flex-1"}),e.jsx("span",{className:"text-sm font-medium text-gray-900 w-12",children:k(n.openSpaceRatio)})]})]})})]})]}),g==="visual"&&e.jsx("div",{className:"space-y-6",children:e.jsx(Cn,{children:e.jsx(li,{parcel:s,marketData:{avgPricePerSqFt:300,avgRentPerSqFt:2.5,capRate:.06,constructionCostPerSqFt:200},onInvestmentAnalysis:F=>{console.log("Investment analysis:",F),a&&a(F)}})})}),g==="analysis"&&i&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(ye,{className:"w-4 h-4 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Building Massing"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:i.buildingMassing.stories}),e.jsx("div",{className:"text-xs text-gray-600",children:"Stories"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:i.buildingMassing.totalGSF.toLocaleString()}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total GSF"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:i.buildingMassing.far.toFixed(2)}),e.jsx("div",{className:"text-xs text-gray-600",children:"FAR"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:k(i.buildingMassing.coverage/100)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Coverage"})]})]})]}),P&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ye,{className:"w-4 h-4 text-green-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Financial Analysis"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-green-600",children:w(P.totalCost)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Cost"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-green-600",children:w(P.totalRevenue)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Revenue"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-sm font-bold ${P.netImpact>=0?"text-green-600":"text-red-600"}`,children:w(P.netImpact)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Net Impact"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-600",children:w(P.costPerUnit)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Cost/Unit"})]})]})]}),I&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ot,{className:"w-4 h-4 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Parking Analysis"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-purple-600",children:I.requiredSpaces}),e.jsx("div",{className:"text-xs text-gray-600",children:"Required Spaces"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-purple-600",children:w(I.costPerSpace)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Cost/Space"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-purple-600",children:w(I.totalCost)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Cost"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-bold text-purple-600",children:I.efficiency.toFixed(1)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Spaces/1000 SF"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Ee,{className:"w-4 h-4 text-orange-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Constraint Analysis"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"FAR Utilization"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-24 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:"bg-blue-600 h-1.5 rounded-full",style:{width:`${Math.min(i.buildingMassing.constraintAnalysis.farUtilization,100)}%`}})}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[i.buildingMassing.constraintAnalysis.farUtilization.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Height Utilization"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-24 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:"bg-green-600 h-1.5 rounded-full",style:{width:`${Math.min(i.buildingMassing.constraintAnalysis.heightUtilization,100)}%`}})}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[i.buildingMassing.constraintAnalysis.heightUtilization.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Coverage Utilization"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-24 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:"bg-purple-600 h-1.5 rounded-full",style:{width:`${Math.min(i.buildingMassing.constraintAnalysis.coverageUtilization,100)}%`}})}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[i.buildingMassing.constraintAnalysis.coverageUtilization.toFixed(1),"%"]})]})]})]})]}),(i.violations.length>0||i.warnings.length>0)&&e.jsxs("div",{className:"space-y-4",children:[i.violations.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(lt,{className:"w-5 h-5 text-red-600"}),e.jsx("h3",{className:"font-semibold text-red-900",children:"Violations"})]}),e.jsx("ul",{className:"space-y-1",children:i.violations.map((F,J)=>e.jsxs("li",{className:"text-sm text-red-700",children:["â€¢ ",F]},J))})]}),i.warnings.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(lt,{className:"w-5 h-5 text-yellow-600"}),e.jsx("h3",{className:"font-semibold text-yellow-900",children:"Warnings"})]}),e.jsx("ul",{className:"space-y-1",children:i.warnings.map((F,J)=>e.jsxs("li",{className:"text-sm text-yellow-700",children:["â€¢ ",F]},J))})]})]})]}),g==="recommendations"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Recommended Configurations"}),e.jsx("div",{className:"space-y-4",children:B.map((F,J)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:F.name}),e.jsx("button",{onClick:()=>l(F.configuration),className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"Apply"})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:F.description}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Units:"}),e.jsx("span",{className:"ml-2 font-medium",children:F.configuration.targetUnits})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Type:"}),e.jsx("span",{className:"ml-2 font-medium capitalize",children:F.configuration.buildingType})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Parking:"}),e.jsx("span",{className:"ml-2 font-medium capitalize",children:F.configuration.parkingType})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Amenities:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[F.configuration.amenitySpace.toLocaleString()," sf"]})]})]})]},J))})]}),i&&i.recommendations.length>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Optimization Recommendations"}),e.jsx("div",{className:"space-y-3",children:i.recommendations.map((F,J)=>e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(_e,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-gray-700",children:F})]},J))})]})]}),r&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Generating site plan..."})]})]}):e.jsxs("div",{className:"p-6 text-center text-gray-500",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Site plan engine not available"}),e.jsx("p",{className:"text-sm",children:"Zoning data and lot size required"})]})});function Ia(t){return t&&(typeof t.id=="string"||typeof t.ogc_fid=="number")&&typeof t.address=="string"&&typeof t.sqft=="number"&&(typeof t.deeded_acres=="number"||t.deeded_acres===null||t.deeded_acres===void 0)}function sn(t,s=4356){const n=Math.sqrt(s*1.5),i=s/n;return{id:typeof t=="string"?t:String(t),ogc_fid:typeof t=="number"?t:parseInt(String(t))||0,address:"Unknown Address",sqft:s,deeded_acres:s/43560,geometry:{type:"Polygon",coordinates:[[[0,0],[n,0],[n,i],[0,i],[0,0]]]},zoning_data:null,zoning:"Unknown"}}const Mm=re.memo(function({parcel:s,isOpen:a,onClose:n}){const[i,r]=f.useState("overview");if(f.useEffect(()=>{s&&(console.log("ðŸ” FullAnalysisModal parcel object:",s),console.log("ðŸ” isValidParcel check:",Ia(s)),console.log("ðŸ” Parcel properties:",{id:s.id,ogc_fid:s.ogc_fid,address:s.address,sqft:s.sqft,deeded_acres:s.deeded_acres}))},[s]),!a||!s)return null;const o=[{id:"overview",label:"Overview",icon:Ge},{id:"hbu",label:"HBU Analysis",icon:ft},{id:"siteplan",label:"Site Plan",icon:qe},{id:"visual",label:"Site Design",icon:ga},{id:"financial",label:"Financial",icon:Ye}];return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full h-full max-w-7xl max-h-[95vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Full Parcel Analysis"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[s.address," â€¢ ",s.parcelnumb]})]}),e.jsx("button",{onClick:n,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(fe,{className:"w-6 h-6 text-gray-500"})})]}),e.jsx("div",{className:"flex border-b border-gray-200 bg-gray-50",children:o.map(l=>{const c=l.icon;return e.jsxs("button",{onClick:()=>r(l.id),className:`flex items-center space-x-2 px-6 py-4 text-sm font-medium transition-colors ${i===l.id?"text-blue-600 border-b-2 border-blue-600 bg-white":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:[e.jsx(c,{className:"w-4 h-4"}),e.jsx("span",{children:l.label})]},l.id)})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs("div",{className:"h-full overflow-y-auto p-6",children:[i==="overview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Parcel Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 mb-2",children:"Property Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Address:"})," ",s.address]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Parcel #:"})," ",s.parcelnumb]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Lot Size:"})," ",(s.deeded_acres||0).toFixed(2)," acres"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Zoning:"})," ",s.zoning]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 mb-2",children:"Ownership"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Owner:"})," ",s.primary_owner||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Use:"})," ",s.usedesc||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Year Built:"})," ",s.yearbuilt||"N/A"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 mb-2",children:"Valuation"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Value:"})," $",(s.parval||0).toLocaleString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Land Value:"})," $",(s.landval||0).toLocaleString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Improvement Value:"})," $",(s.improvval||0).toLocaleString()]})]})]})]})]}),s.zoning_data&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Zoning Regulations"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 mb-2",children:"Development Constraints"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Max FAR:"})," ",s.zoning_data.max_far||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Max Height:"})," ",s.zoning_data.max_building_height_ft||"N/A"," ft"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Max Coverage:"})," ",s.zoning_data.max_coverage_pct||"N/A","%"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Max Density:"})," ",s.zoning_data.max_density_du_per_acre||"N/A"," DU/acre"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 mb-2",children:"Setback Requirements"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Front:"})," ",s.zoning_data.min_front_setback_ft||"N/A"," ft"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Rear:"})," ",s.zoning_data.min_rear_setback_ft||"N/A"," ft"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Side:"})," ",s.zoning_data.min_side_setback_ft||"N/A"," ft"]})]})]})]})]})]}),i==="hbu"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Highest & Best Use Analysis"}),e.jsx(fl,{parcel:s})]})}),i==="siteplan"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Site Plan Designer"}),e.jsx(Sm,{parcel:Ia(s)?s:sn(s.id||"unknown",s.sqft||4356),onUnderwritingUpdate:l=>{console.log("Site plan financial update:",l)}})]})}),i==="visual"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Visual Site Plan"}),e.jsx("div",{className:"h-[800px]",children:e.jsx(Cn,{children:e.jsx(li,{parcel:Ia(s)?s:sn(s.ogc_fid||s.id||"unknown",s.sqft||4356),marketData:{avgPricePerSqFt:300,avgRentPerSqFt:2.5,capRate:.06,constructionCostPerSqFt:200},onInvestmentAnalysis:l=>{console.log("Investment analysis:",l)}})})})]})}),i==="financial"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Financial Analysis"}),e.jsx("div",{className:"text-gray-600",children:"Financial analysis tools will be integrated here."})]})})]})})]})})});function Cm({isOpen:t,onClose:s}){const[a,n]=f.useState([]),[i,r]=f.useState("selection"),{selectedParcel:o}=Ie();f.useEffect(()=>{o&&!a.find(x=>x.id===o.ogc_fid?.toString())&&n(x=>[...x,{id:o.ogc_fid?.toString()||"",address:o.address||"",parcelnumb:o.parcelnumb||"",deeded_acres:o.deeded_acres||0,sqft:o.sqft||0,zoning:o.zoning||"",parval:o.parval||0,geometry:o.geometry}])},[o,a]);const l=x=>{n(h=>h.filter(m=>m.id!==x))},d=(()=>{if(a.length===0)return null;const x=a.reduce((y,v)=>y+v.deeded_acres,0),h=a.reduce((y,v)=>y+v.sqft,0),m=a.reduce((y,v)=>y+v.parval,0),p=x>0?m/x:0;return{totalAcres:x,totalSqft:h,totalValue:m,avgValuePerAcre:p,parcelCount:a.length}})();return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full h-full max-w-7xl max-h-[95vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Multi-Parcel Analysis"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a.length," parcel",a.length!==1?"s":""," selected"]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(fe,{className:"w-6 h-6 text-gray-500"})})]}),e.jsxs("div",{className:"flex border-b border-gray-200 bg-gray-50",children:[e.jsxs("button",{onClick:()=>r("selection"),className:`flex items-center space-x-2 px-6 py-4 text-sm font-medium transition-colors ${i==="selection"?"text-blue-600 border-b-2 border-blue-600 bg-white":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Selection"})]}),e.jsxs("button",{onClick:()=>r("analysis"),className:`flex items-center space-x-2 px-6 py-4 text-sm font-medium transition-colors ${i==="analysis"?"text-blue-600 border-b-2 border-blue-600 bg-white":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,disabled:a.length===0,children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{children:"Combined Analysis"})]}),e.jsxs("button",{onClick:()=>r("comparison"),className:`flex items-center space-x-2 px-6 py-4 text-sm font-medium transition-colors ${i==="comparison"?"text-blue-600 border-b-2 border-blue-600 bg-white":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,disabled:a.length<2,children:[e.jsx(Ge,{className:"w-4 h-4"}),e.jsx("span",{children:"Comparison"})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs("div",{className:"h-full overflow-y-auto p-6",children:[i==="selection"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900 mb-2",children:"How to Add Parcels"}),e.jsx("p",{className:"text-blue-800 text-sm",children:"Click on parcels in the map to add them to your analysis. You can analyze individual parcels or combine multiple parcels for comprehensive development analysis."})]}),a.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Selected Parcels"}),e.jsx("div",{className:"grid gap-4",children:a.map(x=>e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:x.address}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Parcel #",x.parcelnumb," â€¢ ",x.deeded_acres.toFixed(2)," acres â€¢ ",x.zoning]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["$",x.parval.toLocaleString()]}),e.jsxs("div",{className:"text-xs text-gray-600",children:["$",(x.parval/x.deeded_acres).toLocaleString(),"/acre"]})]})]})}),e.jsx("button",{onClick:()=>l(x.id),className:"ml-4 p-2 hover:bg-red-50 rounded-lg transition-colors",children:e.jsx(fe,{className:"w-4 h-4 text-red-500"})})]})},x.id))})]}),a.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(qe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Parcels Selected"}),e.jsx("p",{className:"text-gray-600",children:"Click on parcels in the map to start your multi-parcel analysis."})]})]}),i==="analysis"&&d&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Combined Statistics"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-blue-600",children:d.parcelCount}),e.jsx("div",{className:"text-sm text-gray-600",children:"Parcels"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-green-600",children:d.totalAcres.toFixed(2)}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Acres"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-purple-600",children:d.totalSqft.toLocaleString()}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Sq Ft"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-orange-600",children:["$",d.totalValue.toLocaleString()]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Value"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Development Potential"}),e.jsxs("div",{className:"text-gray-600",children:[e.jsx("p",{children:"Combined analysis tools will be integrated here, including:"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Combined zoning analysis"}),e.jsx("li",{children:"Master site planning"}),e.jsx("li",{children:"Infrastructure requirements"}),e.jsx("li",{children:"Phased development options"}),e.jsx("li",{children:"Combined financial modeling"})]})]})]})]}),i==="comparison"&&a.length>=2&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Parcel Comparison"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Address"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Size"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Zoning"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"$/Acre"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:a.map(x=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:x.address}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[x.deeded_acres.toFixed(2)," acres"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:x.zoning}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:["$",x.parval.toLocaleString()]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:["$",(x.parval/x.deeded_acres).toLocaleString()]})]},x.id))})]})})]})})]})})]})}):null}const Pm=re.memo(function({parcel:s,isOpen:a,onClose:n,onAddToProject:i,hasActiveProject:r,onCreateProjectFromParcel:o}){const[l,c]=f.useState(!1),[d,x]=f.useState(!1),[h,m]=f.useState("overview");if(!a||!s)return null;const p=v=>v<1?`${Math.round(v*43560).toLocaleString()} sq ft`:`${v.toFixed(2)} acres`,y=v=>v?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(v):"N/A";return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fixed inset-y-0 right-0 w-96 bg-white shadow-xl z-40 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-5 h-5 text-blue-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Parcel Details"})]}),e.jsx("button",{onClick:n,className:"p-2 hover:bg-gray-200 rounded-lg transition-colors",children:e.jsx(fe,{className:"w-5 h-5 text-gray-500"})})]}),e.jsxs("div",{className:"flex border-b border-gray-200 bg-white",children:[e.jsx("button",{onClick:()=>m("overview"),className:`flex-1 px-4 py-3 text-sm font-medium transition-colors ${h==="overview"?"text-blue-600 border-b-2 border-blue-600 bg-blue-50":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,children:"Overview"}),e.jsx("button",{onClick:()=>m("underwriting"),className:`flex-1 px-4 py-3 text-sm font-medium transition-colors ${h==="underwriting"?"text-blue-600 border-b-2 border-blue-600 bg-blue-50":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,children:"Underwriting"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[h==="overview"&&e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Rt,{className:"w-4 h-4 text-blue-600"}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"Property Summary"})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Address"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.address||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Parcel #"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.parcelnumb||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Lot Size"}),e.jsx("p",{className:"font-medium text-gray-900",children:p(s.deeded_acres||s.deededacreage||s.gisacre||0)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Zoning"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.zoning||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Use"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.usedesc||"N/A"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(fn,{className:"w-4 h-4 text-green-600"}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"Ownership & Valuation"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Owner"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.primary_owner||s.owner||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Value"}),e.jsx("p",{className:"font-medium text-gray-900",children:y(s.parval)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Land Value"}),e.jsx("p",{className:"font-medium text-gray-900",children:y(s.landval)})]})]}),s.yearbuilt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Year Built"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.yearbuilt})]})]})]}),s.zoning_data&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Wa,{className:"w-4 h-4 text-purple-600"}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"Zoning Summary"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Type"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.zoning_data.zoning_type||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Max FAR"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.zoning_data.max_far||"N/A"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Max Height"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[s.zoning_data.max_building_height_ft||"N/A"," ft"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Max Coverage"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[s.zoning_data.max_coverage_pct||"N/A","%"]})]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:()=>c(!0),className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:"Full Analysis"})]}),e.jsxs("button",{onClick:()=>x(!0),className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Multi-Parcel Analysis"})]}),r&&i&&e.jsxs("button",{onClick:()=>i(s),className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add to Project"})]}),!r&&o&&e.jsxs("button",{onClick:()=>o(s),className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Create Project from Parcel"})]})]})]}),h==="underwriting"&&e.jsx("div",{className:"p-4",children:e.jsx(ul,{parcel:s})})]})]}),e.jsx(Mm,{parcel:s,isOpen:l,onClose:()=>c(!1)}),e.jsx(Cm,{isOpen:d,onClose:()=>x(!1)})]})}),km=re.memo(function({onGetStarted:s,onViewDemo:a}){const[n,i]=f.useState(!1),[r,o]=f.useState(0);f.useEffect(()=>{const x=setInterval(()=>{o(h=>(h+1)%c.length)},5e3);return()=>clearInterval(x)},[]);const l=[{icon:e.jsx(Ge,{className:"w-8 h-8 text-blue-600"}),title:"Interactive Parcel Mapping",description:"Navigate Nashville's real estate landscape with precision. Click any parcel for instant property insights, zoning data, and development potential.",highlight:"Real-time data"},{icon:e.jsx(ve,{className:"w-8 h-8 text-green-600"}),title:"AI-Powered Analysis",description:"Get instant underwriting, market trends, and investment recommendations powered by advanced machine learning algorithms.",highlight:"AI-driven insights"},{icon:e.jsx(ye,{className:"w-8 h-8 text-purple-600"}),title:"Site Plan Designer",description:"Design development scenarios with our CAD-like interface. Optimize building placement, parking, and amenities.",highlight:"Professional tools"},{icon:e.jsx(ft,{className:"w-8 h-8 text-orange-600"}),title:"Financial Modeling",description:"Calculate ROI, IRR, and cash flow projections with built-in financial analysis tools and market comparables.",highlight:"Investment-ready"}],c=[{name:"Sarah Chen",role:"Development Director, Hines",company:"Hines",content:"This platform has revolutionized how we evaluate sites. We've reduced our due diligence time by 60% and found 3 new development opportunities we would have missed.",rating:5,avatar:"SC"},{name:"Michael Rodriguez",role:"Principal, Blackstone Real Estate",company:"Blackstone",content:"The AI-powered market analysis is incredibly accurate. We've used it for $2B+ in acquisitions across Nashville and the insights have been spot-on.",rating:5,avatar:"MR"},{name:"Jennifer Walsh",role:"VP Acquisitions, Greystar",company:"Greystar",content:"The site planning tools are game-changing. We can model multiple scenarios in minutes instead of days. It's like having a full development team in your browser.",rating:5,avatar:"JW"}],d=[{number:"10,000+",label:"Active Users"},{number:"$50B+",label:"Deals Analyzed"},{number:"95%",label:"Accuracy Rate"},{number:"60%",label:"Time Saved"}];return e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsxs("nav",{className:"bg-white border-b border-gray-200 sticky top-0 z-50",children:[e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center h-16",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-blue-600 p-2 rounded-lg",children:e.jsx(Ge,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Parcel Intelligence"}),e.jsx("p",{className:"text-xs text-gray-600 hidden sm:block",children:"Real Estate Investment Platform"})]})]}),e.jsxs("div",{className:"hidden md:flex items-center space-x-8",children:[e.jsx("a",{href:"#features",className:"text-gray-600 hover:text-gray-900 transition-colors",children:"Features"}),e.jsx("a",{href:"#testimonials",className:"text-gray-600 hover:text-gray-900 transition-colors",children:"Testimonials"}),e.jsx("a",{href:"#pricing",className:"text-gray-600 hover:text-gray-900 transition-colors",children:"Pricing"}),e.jsxs("button",{onClick:a,className:"text-gray-600 hover:text-gray-900 transition-colors flex items-center space-x-1",children:[e.jsx(Ut,{className:"w-4 h-4"}),e.jsx("span",{children:"Demo"})]})]}),e.jsxs("div",{className:"hidden md:flex items-center space-x-4",children:[e.jsx("button",{className:"text-gray-600 hover:text-gray-900 transition-colors",children:"Sign In"}),e.jsx("button",{onClick:s,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium",children:"Get Started Free"})]}),e.jsx("button",{onClick:()=>i(!n),className:"md:hidden p-2 text-gray-600 hover:text-gray-900",children:n?e.jsx(fe,{className:"w-6 h-6"}):e.jsx(pn,{className:"w-6 h-6"})})]})}),n&&e.jsx("div",{className:"md:hidden bg-white border-t border-gray-200",children:e.jsxs("div",{className:"px-4 py-4 space-y-4",children:[e.jsx("a",{href:"#features",className:"block text-gray-600 hover:text-gray-900",children:"Features"}),e.jsx("a",{href:"#testimonials",className:"block text-gray-600 hover:text-gray-900",children:"Testimonials"}),e.jsx("a",{href:"#pricing",className:"block text-gray-600 hover:text-gray-900",children:"Pricing"}),e.jsxs("button",{onClick:a,className:"flex items-center space-x-2 text-gray-600 hover:text-gray-900",children:[e.jsx(Ut,{className:"w-4 h-4"}),e.jsx("span",{children:"Demo"})]}),e.jsxs("div",{className:"pt-4 border-t border-gray-200 space-y-2",children:[e.jsx("button",{className:"block w-full text-left text-gray-600 hover:text-gray-900",children:"Sign In"}),e.jsx("button",{onClick:s,className:"w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium",children:"Get Started Free"})]})]})})]}),e.jsx("section",{className:"relative bg-gradient-to-br from-blue-50 via-white to-purple-50 py-20 lg:py-32",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"grid lg:grid-cols-2 gap-12 items-center",children:[e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-medium",children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"AI-Powered Real Estate Intelligence"]}),e.jsxs("h1",{className:"text-4xl lg:text-6xl font-bold text-gray-900 leading-tight",children:["Find, Analyze & Develop",e.jsx("span",{className:"text-blue-600 block",children:"Nashville Real Estate"})]}),e.jsx("p",{className:"text-xl text-gray-600 leading-relaxed",children:"The only platform that combines interactive parcel mapping, AI-powered analysis, and professional site planning tools. Used by top developers and investors."})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-6",children:d.map((x,h)=>e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:x.number}),e.jsx("div",{className:"text-sm text-gray-600",children:x.label})]},h))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("button",{onClick:s,className:"bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg flex items-center justify-center space-x-2",children:[e.jsx("span",{children:"Start Free Trial"}),e.jsx(Oe,{className:"w-5 h-5"})]}),e.jsxs("button",{onClick:a,className:"border border-gray-300 text-gray-700 px-8 py-4 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg flex items-center justify-center space-x-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),e.jsx("span",{children:"Watch Demo"})]})]}),e.jsxs("div",{className:"flex items-center space-x-6 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Wa,{className:"w-4 h-4"}),e.jsx("span",{children:"SOC 2 Compliant"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Er,{className:"w-4 h-4"}),e.jsx("span",{children:"Enterprise Ready"})]})]})]}),e.jsx("div",{className:"relative",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl p-6 border border-gray-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Interactive Map Demo"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-400 rounded-full"}),e.jsx("div",{className:"w-3 h-3 bg-yellow-400 rounded-full"}),e.jsx("div",{className:"w-3 h-3 bg-green-400 rounded-full"})]})]}),e.jsx("div",{className:"bg-gray-100 rounded-lg h-64 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto"}),e.jsxs("div",{className:"text-gray-600",children:[e.jsx("p",{className:"font-medium",children:"Click any parcel to explore"}),e.jsx("p",{className:"text-sm",children:"Interactive Nashville real estate data"})]})]})}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:"AI Analysis"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Development Potential:"}),e.jsx("span",{className:"font-medium text-green-600",children:"High"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Estimated ROI:"}),e.jsx("span",{className:"font-medium text-blue-600",children:"18.5%"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Zoning:"}),e.jsx("span",{className:"font-medium text-gray-900",children:"RM15"})]})]})]})]})})})]})})}),e.jsx("section",{id:"features",className:"py-20 bg-white",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"text-center mb-16",children:[e.jsx("h2",{className:"text-3xl lg:text-4xl font-bold text-gray-900 mb-4",children:"Everything You Need to Succeed"}),e.jsx("p",{className:"text-xl text-gray-600 max-w-3xl mx-auto",children:"Our platform combines the best of mapping, analysis, and design tools to give you a competitive edge in Nashville's real estate market."})]}),e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-8",children:l.map((x,h)=>e.jsx("div",{className:"group",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all duration-300",children:[e.jsx("div",{className:"mb-4",children:x.icon}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:x.title}),e.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:x.highlight})]}),e.jsx("p",{className:"text-gray-600 text-sm leading-relaxed",children:x.description})]})]})},h))})]})}),e.jsx("section",{className:"py-20 bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"text-center mb-16",children:[e.jsx("h2",{className:"text-3xl lg:text-4xl font-bold text-gray-900 mb-4",children:"Why Choose Us Over Competitors?"}),e.jsx("p",{className:"text-xl text-gray-600",children:"We combine the best features from multiple platforms into one powerful tool."})]}),e.jsx("div",{className:"bg-white rounded-2xl shadow-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-left text-sm font-medium text-gray-900",children:"Feature"}),e.jsx("th",{className:"px-6 py-4 text-center text-sm font-medium text-blue-600",children:"Parcel Intelligence"}),e.jsx("th",{className:"px-6 py-4 text-center text-sm font-medium text-gray-600",children:"Regrid"}),e.jsx("th",{className:"px-6 py-4 text-center text-sm font-medium text-gray-600",children:"CoStar"}),e.jsx("th",{className:"px-6 py-4 text-center text-sm font-medium text-gray-600",children:"Crexi"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:"Interactive Parcel Mapping"}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:"AI-Powered Analysis"}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:"Site Plan Designer"}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:"Financial Modeling"}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:"Real-time Data"}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(_e,{className:"w-5 h-5 text-green-500 mx-auto"})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(fe,{className:"w-5 h-5 text-red-500 mx-auto"})})]})]})]})})})]})}),e.jsx("section",{id:"testimonials",className:"py-20 bg-white",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"text-center mb-16",children:[e.jsx("h2",{className:"text-3xl lg:text-4xl font-bold text-gray-900 mb-4",children:"Trusted by Industry Leaders"}),e.jsx("p",{className:"text-xl text-gray-600",children:"See what top developers and investors are saying about our platform."})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-8 max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"flex justify-center space-x-1 mb-4",children:[...Array(c[r].rating)].map((x,h)=>e.jsx(Rr,{className:"w-5 h-5 text-yellow-400 fill-current"},h))}),e.jsxs("blockquote",{className:"text-xl text-gray-700 italic leading-relaxed",children:['"',c[r].content,'"']})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold",children:c[r].avatar}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:c[r].name}),e.jsx("div",{className:"text-gray-600",children:c[r].role}),e.jsx("div",{className:"text-blue-600 font-medium",children:c[r].company})]})]})]}),e.jsx("div",{className:"flex justify-center space-x-2 mt-8",children:c.map((x,h)=>e.jsx("button",{onClick:()=>o(h),className:`w-3 h-3 rounded-full transition-colors ${h===r?"bg-blue-600":"bg-gray-300"}`},h))})]})]})}),e.jsx("section",{className:"py-20 bg-gradient-to-r from-blue-600 to-purple-600",children:e.jsxs("div",{className:"max-w-4xl mx-auto text-center px-4 sm:px-6 lg:px-8",children:[e.jsx("h2",{className:"text-3xl lg:text-4xl font-bold text-white mb-4",children:"Ready to Transform Your Real Estate Workflow?"}),e.jsx("p",{className:"text-xl text-blue-100 mb-8",children:"Join thousands of professionals who are already using our platform to find, analyze, and develop properties."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsxs("button",{onClick:s,className:"bg-white text-blue-600 px-8 py-4 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg flex items-center justify-center space-x-2",children:[e.jsx("span",{children:"Start Free Trial"}),e.jsx(Oe,{className:"w-5 h-5"})]}),e.jsxs("button",{onClick:a,className:"border border-white text-white px-8 py-4 rounded-lg hover:bg-white hover:text-blue-600 transition-colors font-medium text-lg flex items-center justify-center space-x-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),e.jsx("span",{children:"Watch Demo"})]})]})]})}),e.jsx("footer",{className:"bg-gray-900 text-white py-12",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"grid md:grid-cols-4 gap-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-blue-600 p-2 rounded-lg",children:e.jsx(Ge,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold",children:"Parcel Intelligence"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Real Estate Investment Platform"})]})]}),e.jsx("p",{className:"text-gray-400 text-sm",children:"The most advanced real estate analysis platform for developers and investors."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Product"}),e.jsxs("ul",{className:"space-y-2 text-sm text-gray-400",children:[e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Features"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Pricing"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"API"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Integrations"})})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Company"}),e.jsxs("ul",{className:"space-y-2 text-sm text-gray-400",children:[e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"About"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Blog"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Careers"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Contact"})})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Support"}),e.jsxs("ul",{className:"space-y-2 text-sm text-gray-400",children:[e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Help Center"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Documentation"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Status"})}),e.jsx("li",{children:e.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Security"})})]})]})]}),e.jsx("div",{className:"border-t border-gray-800 mt-8 pt-8 text-center text-sm text-gray-400",children:e.jsx("p",{children:"Â© 2024 Parcel Intelligence. All rights reserved."})})]})})]})});function Am({isOpen:t,onClose:s,onComplete:a}){const[n,i]=f.useState(0),[r,o]=f.useState(new Set),l=[{id:"welcome",title:"Welcome to Parcel Intelligence",description:"The most advanced real estate analysis platform for Nashville developers and investors.",icon:e.jsx(Ge,{className:"w-8 h-8 text-blue-600"}),action:"Get Started"},{id:"explore",title:"Explore the Map",description:"Click any parcel on the map to view property details, zoning information, and development potential.",icon:e.jsx(Ee,{className:"w-8 h-8 text-green-600"}),action:"Try It Now"},{id:"analyze",title:"AI-Powered Analysis",description:"Get instant underwriting, market trends, and investment recommendations powered by advanced AI.",icon:e.jsx(ve,{className:"w-8 h-8 text-purple-600"}),action:"Run Analysis"},{id:"design",title:"Site Plan Designer",description:"Design development scenarios with our CAD-like interface. Optimize building placement and amenities.",icon:e.jsx(ye,{className:"w-8 h-8 text-orange-600"}),action:"Start Designing"},{id:"financial",title:"Financial Modeling",description:"Calculate ROI, IRR, and cash flow projections with built-in financial analysis tools.",icon:e.jsx(Me,{className:"w-8 h-8 text-red-600"}),action:"View Projections"}],c=()=>{n<l.length-1?i(n+1):a()},d=()=>{a()},x=p=>{o(y=>new Set([...y,p])),setTimeout(()=>{c()},1e3)};if(!t)return null;const h=l[n],m=(n+1)/l.length*100;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-white bg-opacity-20 p-2 rounded-lg",children:h.icon}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Quick Tour"}),e.jsxs("p",{className:"text-blue-100 text-sm",children:["Step ",n+1," of ",l.length]})]})]}),e.jsx("button",{onClick:s,className:"text-white hover:text-blue-200 transition-colors",children:e.jsx(fe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"bg-white bg-opacity-20 rounded-full h-2",children:e.jsx("div",{className:"bg-white h-2 rounded-full transition-all duration-300",style:{width:`${m}%`}})})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:h.icon}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",children:h.title}),e.jsx("p",{className:"text-gray-600 text-lg leading-relaxed",children:h.description})]}),e.jsx("div",{className:"flex justify-center space-x-2 mb-8",children:l.map((p,y)=>e.jsx("div",{className:`w-3 h-3 rounded-full transition-colors ${y===n?"bg-blue-600":y<n?"bg-green-500":"bg-gray-300"}`},p.id))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[h.action&&e.jsxs("button",{onClick:()=>x(h.id),className:"flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Ut,{className:"w-4 h-4"}),e.jsx("span",{children:h.action})]}),e.jsxs("button",{onClick:c,className:"flex-1 border border-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-50 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx("span",{children:n===l.length-1?"Complete":"Next"}),e.jsx(Oe,{className:"w-4 h-4"})]})]}),e.jsx("div",{className:"flex justify-center mt-4",children:e.jsx("button",{onClick:d,className:"text-gray-500 hover:text-gray-700 text-sm",children:"Skip Tour"})})]})]})})}function Em({type:t,title:s,message:a,onClose:n,duration:i=5e3}){const[r,o]=re.useState(!0);re.useEffect(()=>{if(i>0){const d=setTimeout(()=>{o(!1),setTimeout(()=>n?.(),300)},i);return()=>clearTimeout(d)}},[i,n]);const l={success:"bg-green-50 border-green-200 text-green-800",error:"bg-red-50 border-red-200 text-red-800",warning:"bg-yellow-50 border-yellow-200 text-yellow-800",info:"bg-blue-50 border-blue-200 text-blue-800"},c={success:"text-green-400",error:"text-red-400",warning:"text-yellow-400",info:"text-blue-400"};return r?e.jsx("div",{className:`fixed top-4 right-4 z-50 max-w-sm w-full bg-white border rounded-lg shadow-lg transition-all duration-300 ${r?"translate-x-0 opacity-100":"translate-x-full opacity-0"} ${l[t]}`,children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("div",{className:`w-5 h-5 ${c[t]}`,children:[t==="success"&&e.jsx("svg",{fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),t==="error"&&e.jsx("svg",{fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),t==="warning"&&e.jsx("svg",{fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),t==="info"&&e.jsx("svg",{fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})]})}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsx("h4",{className:"text-sm font-medium",children:s}),a&&e.jsx("p",{className:"text-sm mt-1",children:a})]}),n&&e.jsx("button",{onClick:n,className:"ml-4 flex-shrink-0 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]})})}):null}function Rm({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("explore"),[o,l]=f.useState(0),[c,d]=f.useState(!1),[x,h]=f.useState(null),{activeProjectId:m,activeProjectName:p,parcelIds:y}=Ve(),{setDrawer:v}=Ie();f.useEffect(()=>{a&&i==="explore"&&(r("analyze"),l(1))},[a,i]);const u={explore:{title:"Explore Properties",description:"Click parcels on the map to discover development opportunities",icon:e.jsx(Ge,{className:"w-6 h-6"}),color:"blue",actions:[{label:"Click any parcel",icon:e.jsx(Ee,{className:"w-4 h-4"})},{label:"View property details",icon:e.jsx(ga,{className:"w-4 h-4"})}]},analyze:{title:"AI Analysis",description:"Get instant insights on development potential and market trends",icon:e.jsx(ve,{className:"w-6 h-6"}),color:"green",actions:[{label:"Run HBU Analysis",icon:e.jsx(ft,{className:"w-4 h-4"})},{label:"Market Insights",icon:e.jsx(Ze,{className:"w-4 h-4"})}]},design:{title:"Site Planning",description:"Design your development with CAD-like precision",icon:e.jsx(ye,{className:"w-6 h-6"}),color:"purple",actions:[{label:"Add Buildings",icon:e.jsx(qe,{className:"w-4 h-4"})},{label:"Design Layout",icon:e.jsx(gn,{className:"w-4 h-4"})}]},financial:{title:"Financial Modeling",description:"Calculate ROI, IRR, and cash flow projections",icon:e.jsx(Me,{className:"w-6 h-6"}),color:"orange",actions:[{label:"Run Underwriting",icon:e.jsx(Ye,{className:"w-4 h-4"})},{label:"View Projections",icon:e.jsx(ve,{className:"w-4 h-4"})}]},compare:{title:"Compare Scenarios",description:"Evaluate multiple development options side-by-side",icon:e.jsx(Ee,{className:"w-6 h-6"}),color:"indigo",actions:[{label:"Create Scenarios",icon:e.jsx(De,{className:"w-4 h-4"})},{label:"Compare Results",icon:e.jsx(ve,{className:"w-4 h-4"})}]}},j=w=>{r(w),l(0)},g=()=>{const w=["explore","analyze","design","financial","compare"],k=w.indexOf(i);k<w.length-1&&(r(w[k+1]),l(0))},S=async()=>{d(!0),setTimeout(()=>{h({hbu:"Mixed-Use Residential",confidence:85,roi:18.5,units:24,gsf:45e3}),d(!1),r("design")},2e3)};if(!t)return null;const b=u[i],_=!!m;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:e.jsxs("div",{className:"bg-white w-full lg:max-w-6xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`p-2 rounded-lg bg-${b.color}-100`,children:b.icon}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:b.title}),e.jsx("p",{className:"text-sm text-gray-600",children:b.description})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-3 bg-gray-50 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex space-x-1",children:Object.entries(u).map(([w,k],$)=>{const R=i===w,T=Object.keys(u).indexOf(i)>$;return e.jsxs("button",{onClick:()=>j(w),className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${R?`bg-${k.color}-100 text-${k.color}-700`:T?"bg-green-100 text-green-700":"text-gray-500 hover:text-gray-700 hover:bg-gray-100"}`,children:[k.icon,e.jsx("span",{className:"hidden sm:inline",children:k.title})]},w)})}),i!=="compare"&&e.jsxs("button",{onClick:g,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium",children:[e.jsx("span",{children:"Next"}),e.jsx(Oe,{className:"w-4 h-4"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[i==="explore"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Explore Nashville Properties"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to view property details, zoning information, and development potential. Our AI will analyze each property for you."}),a?e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-medium text-blue-900",children:a.address}),e.jsxs("p",{className:"text-sm text-blue-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]})}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel to get started"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[x.roi,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Projected ROI"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:x.units}),e.jsx("div",{className:"text-xs text-green-700",children:"Units"})]})]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Recommended Use:"})," ",x.hbu]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Confidence:"})," ",x.confidence,"%"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to analyze this property? Our AI will evaluate development potential, market trends, and financial projections."}),e.jsx("button",{onClick:S,disabled:c,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium flex items-center justify-center space-x-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run AI Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run our AI-powered analysis"})]})}),i==="design"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Design Your Development"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Use our CAD-like site planner to design buildings, parking, and amenities. Optimize your layout for maximum value."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto",children:[e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(qe,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Buildings"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ot,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Parking"})]})]})]})}),i==="financial"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Analysis"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Calculate detailed financial projections including ROI, IRR, cash flow, and development costs."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Calculate detailed financial projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]})]})}),i==="compare"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ee,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create multiple development scenarios and compare their financial performance, design efficiency, and market potential."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design an alternative development plan"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Results"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:_?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:p})," (",y.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[!_&&e.jsx("button",{className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium",children:"Create Project"}),e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Work"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Ut,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Report"})]})]})]})})]})})}function Fm({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("discover"),[o,l]=f.useState([]),[c,d]=f.useState(""),[x,h]=f.useState(!1),[m,p]=f.useState(null),[y,v]=f.useState(!1),{activeProjectId:u,activeProjectName:j,parcelIds:g,addParcel:S}=Ve();f.useEffect(()=>{a&&i==="discover"&&r("analyze")},[a,i]);const b={discover:{title:"Discover Properties",description:"Click parcels on the map to explore development opportunities",icon:e.jsx(Ge,{className:"w-6 h-6"}),color:"blue",status:"active"},analyze:{title:"Analyze Potential",description:"Get AI-powered insights on development potential",icon:e.jsx(ve,{className:"w-6 h-6"}),color:"green",status:a?"active":"pending"},plan:{title:"Plan Development",description:"Design your site layout and building configuration",icon:e.jsx(ye,{className:"w-6 h-6"}),color:"purple",status:"pending"},model:{title:"Financial Model",description:"Calculate ROI, cash flow, and development costs",icon:e.jsx(Me,{className:"w-6 h-6"}),color:"orange",status:"pending"},compare:{title:"Compare Options",description:"Evaluate multiple development scenarios",icon:e.jsx(Ee,{className:"w-6 h-6"}),color:"indigo",status:"pending"}},_=async $=>{if(!u)h(!0),setTimeout(()=>{h(!1),l(R=>[...R,$]),r("analyze")},1e3);else try{await S($.ogc_fid||$.id),l(R=>[...R,$]),r("analyze")}catch(R){console.error("Failed to add parcel to project:",R)}},w=async()=>{v(!0),setTimeout(()=>{p({hbu:"Mixed-Use Residential",confidence:85,roi:18.5,units:24,gsf:45e3,estimatedValue:125e5,developmentCost:85e5}),v(!1),r("plan")},2e3)},k=()=>{c.trim()&&(h(!0),setTimeout(()=>{h(!1),r("plan")},1e3))};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:e.jsxs("div",{className:"bg-white w-full lg:max-w-4xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100",children:e.jsx(ye,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:"Project Workflow"}),e.jsx("p",{className:"text-sm text-gray-600",children:u?`Active: ${j}`:"Create a new development project"})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:Object.entries(b).map(([$,R],T)=>{const P=i===$,I=Object.keys(b).indexOf(i)>T;return Object.keys(b).indexOf(i)<T,e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium ${P?`bg-${R.color}-100 text-${R.color}-700`:I?"bg-green-100 text-green-700":"text-gray-500"}`,children:[I?e.jsx(_e,{className:"w-4 h-4"}):R.icon,e.jsx("span",{className:"hidden sm:inline",children:R.title})]}),T<Object.keys(b).length-1&&e.jsx("div",{className:"w-8 h-px bg-gray-300 mx-2"})]},$)})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i==="discover"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Discover Development Opportunities"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to explore its development potential. Our AI will analyze zoning, market trends, and financial projections."}),a?e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:a.address}),e.jsxs("p",{className:"text-sm text-blue-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),e.jsx("button",{onClick:()=>_(a),disabled:x,className:"w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating Project..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add to Project"})]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel on the map to get started"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[m.roi,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Projected ROI"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:m.units}),e.jsx("div",{className:"text-xs text-green-700",children:"Units"})]})]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Recommended Use:"})," ",m.hbu]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Confidence:"})," ",m.confidence,"%"]}),e.jsxs("button",{onClick:()=>r("plan"),className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Planning"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to analyze this property? Our AI will evaluate development potential, market trends, and financial projections."}),e.jsx("button",{onClick:w,disabled:y,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run AI Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run our AI-powered analysis"})]})}),i==="plan"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Plan Your Development"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Design your site layout with our CAD-like tools. Add buildings, parking, and amenities to optimize your development."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto",children:[e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(qe,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Buildings"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ot,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Parking"})]})]}),e.jsxs("button",{onClick:()=>r("model"),className:"mt-6 w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Financial Modeling"})]})]})}),i==="model"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Modeling"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Calculate detailed financial projections including ROI, IRR, cash flow, and development costs."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Calculate detailed financial projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]}),e.jsxs("button",{onClick:()=>r("compare"),className:"mt-6 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Comparison"})]})]})}),i==="compare"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create multiple development scenarios and compare their financial performance, design efficiency, and market potential."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design an alternative development plan"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Results"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:u?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:j})," (",g.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[!u&&e.jsx("button",{onClick:k,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium",children:"Create Project"}),e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Work"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Report"})]})]})]})})]})}):null}function Im({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("discover"),[o,l]=f.useState([]),[c,d]=f.useState(""),[x,h]=f.useState(!1),[m,p]=f.useState(null),[y,v]=f.useState(!1),{activeProjectId:u,activeProjectName:j,parcelIds:g,addParcel:S}=Ve();f.useEffect(()=>{a&&i==="discover"&&r("analyze")},[a,i]);const b=async w=>{if(!u)h(!0),setTimeout(()=>{h(!1),l(k=>[...k,w]),r("analyze")},1e3);else try{await S(w.ogc_fid||w.id),l(k=>[...k,w]),r("analyze")}catch(k){console.error("Failed to add parcel to project:",k)}},_=async()=>{v(!0),setTimeout(()=>{p({hbu:"Mixed-Use Residential",confidence:85,roi:18.5,units:24,gsf:45e3,estimatedValue:125e5,developmentCost:85e5}),v(!1),r("plan")},2e3)};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:e.jsxs("div",{className:"bg-white w-full lg:max-w-4xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100",children:e.jsx(ye,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:"Project Workflow"}),e.jsx("p",{className:"text-sm text-gray-600",children:u?`Active: ${j}`:"Create a new development project"})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:[{id:"discover",label:"Discover",icon:e.jsx(Ge,{className:"w-4 h-4"}),color:"blue"},{id:"analyze",label:"Analyze",icon:e.jsx(ve,{className:"w-4 h-4"}),color:"green"},{id:"plan",label:"Plan",icon:e.jsx(ye,{className:"w-4 h-4"}),color:"purple"},{id:"model",label:"Model",icon:e.jsx(Me,{className:"w-4 h-4"}),color:"orange"},{id:"compare",label:"Compare",icon:e.jsx(Ee,{className:"w-4 h-4"}),color:"indigo"}].map((w,k)=>{const $=i===w.id,R=["discover","analyze","plan","model","compare"].indexOf(i)>k;return e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium ${$?`bg-${w.color}-100 text-${w.color}-700`:R?"bg-green-100 text-green-700":"text-gray-500"}`,children:[R?e.jsx(_e,{className:"w-4 h-4"}):w.icon,e.jsx("span",{className:"hidden sm:inline",children:w.label})]}),k<4&&e.jsx("div",{className:"w-8 h-px bg-gray-300 mx-2"})]},w.id)})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i==="discover"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Discover Development Opportunities"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to explore its development potential. Our AI will analyze zoning, market trends, and financial projections."}),a?e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:a.address}),e.jsxs("p",{className:"text-sm text-blue-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),e.jsx("button",{onClick:()=>b(a),disabled:x,className:"w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating Project..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add to Project"})]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel on the map to get started"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[m.roi,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Projected ROI"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:m.units}),e.jsx("div",{className:"text-xs text-green-700",children:"Units"})]})]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Recommended Use:"})," ",m.hbu]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Confidence:"})," ",m.confidence,"%"]}),e.jsxs("button",{onClick:()=>r("plan"),className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Planning"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to analyze this property? Our AI will evaluate development potential, market trends, and financial projections."}),e.jsx("button",{onClick:_,disabled:y,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run AI Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run our AI-powered analysis"})]})}),i==="plan"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Plan Your Development"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Design your site layout with our CAD-like tools. Add buildings, parking, and amenities to optimize your development."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto",children:[e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(qe,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Buildings"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ot,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Parking"})]})]}),e.jsxs("button",{onClick:()=>r("model"),className:"mt-6 w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Financial Modeling"})]})]})}),i==="model"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Modeling"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Calculate detailed financial projections including ROI, IRR, cash flow, and development costs."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Calculate detailed financial projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]}),e.jsxs("button",{onClick:()=>r("compare"),className:"mt-6 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Comparison"})]})]})}),i==="compare"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create multiple development scenarios and compare their financial performance, design efficiency, and market potential."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design an alternative development plan"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Results"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:u?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:j})," (",g.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Work"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Report"})]})]})]})})]})}):null}function Gm({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("discover"),[o,l]=f.useState([]),[c,d]=f.useState(""),[x,h]=f.useState(!1),[m,p]=f.useState(null),[y,v]=f.useState(!1),[u,j]=f.useState(!0),{activeProjectId:g,activeProjectName:S,parcelIds:b,addParcel:_,set:w}=Ve(),{setDrawer:k}=Ie();f.useEffect(()=>{a&&i==="discover"&&(r("analyze"),j(!1))},[a,i]);const $={discover:{title:"Discover Properties",description:"Click parcels on the map to explore development opportunities",icon:e.jsx(Ge,{className:"w-6 h-6"}),color:"blue",status:"active"},analyze:{title:"Analyze Potential",description:"Get AI-powered insights on development potential",icon:e.jsx(ve,{className:"w-6 h-6"}),color:"green",status:a?"active":"pending"},plan:{title:"Plan Development",description:"Design your site layout and building configuration",icon:e.jsx(ye,{className:"w-6 h-6"}),color:"purple",status:"pending"},model:{title:"Financial Model",description:"Calculate ROI, cash flow, and development costs",icon:e.jsx(Me,{className:"w-6 h-6"}),color:"orange",status:"pending"},compare:{title:"Compare Options",description:"Evaluate multiple development scenarios",icon:e.jsx(Ee,{className:"w-6 h-6"}),color:"indigo",status:"pending"}},R=async P=>{if(g)try{await _(String(P.ogc_fid||P.id),P),l(I=>[...I,P]),r("analyze"),j(!1)}catch(I){console.error("Failed to add parcel to project:",I)}else{h(!0);const I=`Project - ${P.address||"New Development"}`,Y=`project_${Date.now()}`;w(Y,I),await _(String(P.ogc_fid||P.id),P),h(!1),l(B=>[...B,P]),r("analyze"),j(!1)}},T=async()=>{v(!0),setTimeout(()=>{p({hbu:"Mixed-Use Residential",confidence:85,roi:18.5,units:24,gsf:45e3,estimatedValue:125e5,developmentCost:85e5}),v(!1),r("plan")},2e3)};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:e.jsxs("div",{className:"bg-white w-full lg:max-w-4xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100",children:e.jsx(ye,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:"Project Workflow"}),e.jsx("p",{className:"text-sm text-gray-600",children:g?`Active: ${S}`:"Create a new development project"})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:Object.entries($).map(([P,I],Y)=>{const B=i===P,F=Object.keys($).indexOf(i)>Y;return e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium ${B?`bg-${I.color}-100 text-${I.color}-700`:F?"bg-green-100 text-green-700":"text-gray-500"}`,children:[F?e.jsx(_e,{className:"w-4 h-4"}):I.icon,e.jsx("span",{className:"hidden sm:inline",children:I.title})]}),Y<Object.keys($).length-1&&e.jsx("div",{className:"w-8 h-px bg-gray-300 mx-2"})]},P)})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i==="discover"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Discover Development Opportunities"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to explore its development potential. Our AI will analyze zoning, market trends, and financial projections."}),u&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(Rs,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:"Map Interaction"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Click any parcel on the map behind this modal to get started"})]})]}),e.jsx("div",{className:"text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded",children:"ðŸ’¡ The map is interactive even with this modal open"})]}),a?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),e.jsx("button",{onClick:()=>R(a),disabled:x,className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating Project..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add to Project"})]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel on the map to get started"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[m.roi,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Projected ROI"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:m.units}),e.jsx("div",{className:"text-xs text-green-700",children:"Units"})]})]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Recommended Use:"})," ",m.hbu]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Confidence:"})," ",m.confidence,"%"]}),e.jsxs("button",{onClick:()=>r("plan"),className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Planning"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to analyze this property? Our AI will evaluate development potential, market trends, and financial projections."}),e.jsx("button",{onClick:T,disabled:y,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run AI Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run our AI-powered analysis"})]})}),i==="plan"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Plan Your Development"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Design your site layout with our CAD-like tools. Add buildings, parking, and amenities to optimize your development."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 max-w-md mx-auto",children:[e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(qe,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Buildings"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ot,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),e.jsx("div",{className:"text-sm font-medium",children:"Add Parking"})]})]}),e.jsxs("button",{onClick:()=>r("model"),className:"mt-6 w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Financial Modeling"})]})]})}),i==="model"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Modeling"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Calculate detailed financial projections including ROI, IRR, cash flow, and development costs."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Calculate detailed financial projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]}),e.jsxs("button",{onClick:()=>r("compare"),className:"mt-6 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Comparison"})]})]})}),i==="compare"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create multiple development scenarios and compare their financial performance, design efficiency, and market potential."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design an alternative development plan"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Results"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:g?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:S})," (",b.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Work"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Report"})]})]})]})})]})}):null}const zm=Ba()(Xr((t,s)=>({activeSitePlan:null,savedSitePlans:[],isEditing:!1,hasUnsavedChanges:!1,createSitePlan:(a,n,i)=>{const r=new Date().toISOString(),o={id:`siteplan_${Date.now()}`,name:i?.name||"New Site Plan",description:i?.description||"Site plan design",parcelId:a,projectId:n,elements:i?.elements||[],metadata:{created:r,modified:r,version:1,aiGenerated:!!i,hbuAnalysisId:i?.hbuAnalysisId},compliance:{zoningCompliant:!0,violations:[],warnings:[],score:85},financial:{estimatedValue:i?.financial?.estimatedValue||0,developmentCost:i?.financial?.developmentCost||0,irr:i?.financial?.irr||0,roi:i?.financial?.roi||0,totalUnits:i?.financial?.totalUnits||0,totalGSF:i?.financial?.totalGSF||0,parkingSpaces:i?.financial?.parkingSpaces||0}};return t({activeSitePlan:o,isEditing:!0}),o},updateSitePlan:(a,n)=>{const{activeSitePlan:i,savedSitePlans:r}=s();if(i?.id===a){const l={...i,...n,metadata:{...i.metadata,modified:new Date().toISOString()}};t({activeSitePlan:l,hasUnsavedChanges:!0})}const o=r.map(l=>l.id===a?{...l,...n,metadata:{...l.metadata,modified:new Date().toISOString()}}:l);t({savedSitePlans:o})},saveSitePlan:a=>{const{savedSitePlans:n}=s(),i=n.findIndex(o=>o.id===a.id),r={...a,metadata:{...a.metadata,modified:new Date().toISOString()}};if(i>=0){const o=[...n];o[i]=r,t({savedSitePlans:o,hasUnsavedChanges:!1})}else t({savedSitePlans:[...n,r],hasUnsavedChanges:!1})},loadSitePlan:a=>{const{savedSitePlans:n}=s(),i=n.find(r=>r.id===a);return i&&t({activeSitePlan:i,isEditing:!0}),i||null},deleteSitePlan:a=>{const{savedSitePlans:n,activeSitePlan:i}=s(),r=n.filter(o=>o.id!==a);t({savedSitePlans:r}),i?.id===a&&t({activeSitePlan:null,isEditing:!1})},setActiveSitePlan:a=>{t({activeSitePlan:a,isEditing:!!a})},addElement:a=>{const{activeSitePlan:n}=s();if(!n)return;const i={...n,elements:[...n.elements,a],metadata:{...n.metadata,modified:new Date().toISOString()}};t({activeSitePlan:i,hasUnsavedChanges:!0})},updateElement:(a,n)=>{const{activeSitePlan:i}=s();if(!i)return;const r=i.elements.map(l=>l.id===a?{...l,...n}:l),o={...i,elements:r,metadata:{...i.metadata,modified:new Date().toISOString()}};t({activeSitePlan:o,hasUnsavedChanges:!0})},removeElement:a=>{const{activeSitePlan:n}=s();if(!n)return;const i=n.elements.filter(o=>o.id!==a),r={...n,elements:i,metadata:{...n.metadata,modified:new Date().toISOString()}};t({activeSitePlan:r,hasUnsavedChanges:!0})},markAsUnsaved:()=>{t({hasUnsavedChanges:!0})},markAsSaved:()=>{t({hasUnsavedChanges:!1})},generateFromAI:(a,n)=>{const i=new Date().toISOString(),r=a.alternatives?.[0];if(!r)throw new Error("No HBU analysis data available");const o=[{id:`building_${Date.now()}`,type:"building",name:"Main Building",vertices:[{x:50,y:50,id:"v1"},{x:150,y:50,id:"v2"},{x:150,y:100,id:"v3"},{x:50,y:100,id:"v4"}],properties:{area:r.density*(n.sqft||4356),units:Math.floor(r.density*(n.sqft||4356)/43560),height:r.height*10,stories:r.height,use:r.use},metadata:{created:i,modified:i,source:"ai-generated"}},{id:`parking_${Date.now()}`,type:"parking",name:"Parking Area",vertices:[{x:20,y:20,id:"v1"},{x:80,y:20,id:"v2"},{x:80,y:40,id:"v3"},{x:20,y:40,id:"v4"}],properties:{parkingSpaces:Math.ceil(Math.floor(r.density*(n.sqft||4356)/43560)*1.5)},metadata:{created:i,modified:i,source:"ai-generated"}}],l={id:`siteplan_${Date.now()}`,name:`${r.use} Development Plan`,description:`AI-generated site plan based on ${r.use} analysis`,parcelId:n.ogc_fid||n.id,projectId:void 0,elements:o,metadata:{created:i,modified:i,version:1,aiGenerated:!0,hbuAnalysisId:a.id},compliance:{zoningCompliant:!0,violations:[],warnings:[],score:85},financial:{estimatedValue:r.estimatedValue,developmentCost:r.developmentCost,irr:r.internalRateOfReturn,roi:r.internalRateOfReturn*.8,totalUnits:Math.floor(r.density*(n.sqft||4356)/43560),totalGSF:r.density*(n.sqft||4356),parkingSpaces:Math.ceil(Math.floor(r.density*(n.sqft||4356)/43560)*1.5)}};return t({activeSitePlan:l,isEditing:!0}),l},exportSitePlan:a=>{const{savedSitePlans:n}=s();return n.find(r=>r.id===a)||null},importSitePlan:a=>{const n={id:`siteplan_${Date.now()}`,name:a.name||"Imported Site Plan",description:a.description||"Imported site plan",parcelId:a.parcelId||"",projectId:a.projectId,elements:a.elements||[],metadata:{created:new Date().toISOString(),modified:new Date().toISOString(),version:1,aiGenerated:!1},compliance:a.compliance||{zoningCompliant:!0,violations:[],warnings:[],score:85},financial:a.financial||{estimatedValue:0,developmentCost:0,irr:0,roi:0,totalUnits:0,totalGSF:0,parkingSpaces:0}};return t({activeSitePlan:n,isEditing:!0}),n},generateAISitePlan:async(a,n)=>{const i=new Date().toISOString(),r={id:`ai_siteplan_${Date.now()}`,name:`${a.address} - AI Optimized Site Plan`,description:`AI-generated site plan based on ${n.recommendedUse} analysis`,parcelId:a.ogc_fid.toString(),elements:[],metadata:{created:i,modified:i,version:1,aiGenerated:!0,hbuAnalysisId:`analysis_${Date.now()}`},compliance:{zoningCompliant:!0,violations:[],warnings:[],score:n.confidence||85},financial:{estimatedValue:n.alternatives?.[0]?.estimatedValue||0,developmentCost:n.alternatives?.[0]?.developmentCost||0,irr:n.alternatives?.[0]?.internalRateOfReturn||0,roi:n.alternatives?.[0]?.netPresentValue||0,totalUnits:0,totalGSF:0,parkingSpaces:0}};return t({activeSitePlan:r,isEditing:!0}),r},enhanceSitePlan:a=>{const n={...a,metadata:{...a.metadata,modified:new Date().toISOString(),version:a.metadata.version+1}};return t({activeSitePlan:n,isEditing:!0}),n},validateSitePlan:a=>{const n=[],i=[];let r=100;(!a.elements||a.elements.length===0)&&(n.push("Site plan must have at least one element"),r-=50);const o=Om(a.elements);return o.length>0&&(i.push(`Found ${o.length} overlapping elements`),r-=10),a.compliance.zoningCompliant||(n.push("Site plan is not zoning compliant"),r-=30),a.financial.irr<.1&&(i.push("Low IRR - consider optimizing design"),r-=5),{isValid:n.length===0,errors:n,warnings:i,score:Math.max(0,r)}},optimizeSitePlan:a=>{const n={...a,elements:a.elements.map(i=>({...i,properties:{...i.properties,optimized:!0}})),metadata:{...a.metadata,modified:new Date().toISOString(),version:a.metadata.version+1}};return t({activeSitePlan:n,isEditing:!0}),n},getSitePlanMetrics:a=>{const n=a.elements,i=n.reduce((c,d)=>c+(d.properties.area||0),0),r=n.filter(c=>c.type==="building").reduce((c,d)=>c+(d.properties.area||0),0),o=n.filter(c=>c.type==="parking").reduce((c,d)=>c+(d.properties.area||0),0),l=n.filter(c=>c.type==="landscaping").reduce((c,d)=>c+(d.properties.area||0),0);return{totalArea:i,buildingArea:r,parkingArea:o,landscapingArea:l,buildingCoverage:i>0?r/i*100:0,parkingRatio:r>0?o/r*100:0,unitDensity:a.financial.totalUnits/(i/43560),efficiency:Tm(a)}}}),{name:"site-plan-storage",partialize:t=>({savedSitePlans:t.savedSitePlans,activeSitePlan:t.activeSitePlan})}));function Om(t){const s=[];for(let a=0;a<t.length;a++)for(let n=a+1;n<t.length;n++)$m(t[a],t[n])&&s.push(`${t[a].id} overlaps with ${t[n].id}`);return s}function $m(t,s){const a=an(t),n=an(s);return!(a.maxX<n.minX||a.minX>n.maxX||a.maxY<n.minY||a.minY>n.maxY)}function an(t){if(t.vertices.length===0)return{minX:0,minY:0,maxX:0,maxY:0};const s=t.vertices.map(n=>n.x),a=t.vertices.map(n=>n.y);return{minX:Math.min(...s),minY:Math.min(...a),maxX:Math.max(...s),maxY:Math.max(...a)}}function Tm(t){const s=t.elements,a=s.reduce((o,l)=>o+(l.properties.area||0),0),n=s.filter(o=>o.type==="building").reduce((o,l)=>o+(l.properties.area||0),0);if(a===0)return 0;const i=n/a*100,r=Math.min(100,t.financial.irr*1e3);return(i+r)/2}function Dm(){const{activeSitePlan:t,isEditing:s,hasUnsavedChanges:a,createSitePlan:n,updateSitePlan:i,saveSitePlan:r,loadSitePlan:o,generateAISitePlan:l,enhanceSitePlan:c,validateSitePlan:d,optimizeSitePlan:x,getSitePlanMetrics:h,addElement:m,updateElement:p,removeElement:y}=zm(),{analysis:v,loading:u,analyzeParcel:j}=Ha(),[g,S]=f.useState(!1),[b,_]=f.useState(!1),[w,k]=f.useState(!1),[$,R]=f.useState(!1),[T,P]=f.useState(!1),I=f.useMemo(()=>t?d(t):null,[t,d]),Y=f.useMemo(()=>t?h(t):null,[t,h]),B=f.useCallback(async(ie,Xe)=>{S(!0);try{const Qe=Xe||await j(ie);if(!Qe)throw new Error("Failed to generate HBU analysis");return await l(ie,Qe)}catch(Qe){throw console.error("AI site plan generation failed:",Qe),Qe}finally{S(!1)}},[j,l]),F=f.useCallback((ie,Xe)=>n(ie,Xe),[n]),J=f.useCallback(ie=>{t&&i(t.id,ie)},[t,i]),ce=f.useCallback(ie=>{r(ie)},[r]),U=f.useCallback(ie=>o(ie),[o]),q=f.useCallback(async()=>{if(!t)return null;_(!0);try{return x(t)}catch(ie){throw console.error("Site plan optimization failed:",ie),ie}finally{_(!1)}},[t,x]),z=f.useCallback(()=>t?d(t):{isValid:!1,errors:["No active site plan"],warnings:[],score:0},[t,d]),O=f.useCallback(()=>t?h(t):{totalArea:0,buildingArea:0,parkingArea:0,landscapingArea:0,buildingCoverage:0,parkingRatio:0,unitDensity:0,efficiency:0},[t,h]),V=f.useCallback(()=>{k(ie=>!ie)},[]),te=f.useCallback(()=>{R(ie=>!ie)},[]),Q=f.useCallback(()=>{P(ie=>!ie)},[]),ne=f.useCallback(ie=>{m(ie)},[m]),se=f.useCallback((ie,Xe)=>{p(ie,Xe)},[p]),oe=f.useCallback(ie=>{y(ie)},[y]);return{...{activeSitePlan:t,isGenerating:g,isOptimizing:b,validation:I,metrics:Y,showAIGenerator:w,showOptimizer:$,showValidator:T},...{generateAISitePlan:B,createSitePlan:F,updateSitePlan:J,saveSitePlan:ce,loadSitePlan:U,optimizeSitePlan:q,validateSitePlan:z,calculateMetrics:O,toggleAIGenerator:V,toggleOptimizer:te,toggleValidator:Q,addElement:ne,updateElement:se,removeElement:oe},isEditing:s,hasUnsavedChanges:a,hbuAnalysis:v,hbuLoading:u}}function tr({isOpen:t,onClose:s,selectedParcel:a,mode:n="design",hbuAnalysis:i,onAnalysisComplete:r,onSitePlanGenerated:o,onSitePlanSaved:l,onContinueToUnderwriting:c,showAIGenerator:d=!1,showOptimizer:x=!1,showValidator:h=!1}){const{activeSitePlan:m,isOptimizing:p,validation:y,metrics:v,generateAISitePlan:u,optimizeSitePlan:j,toggleAIGenerator:g,toggleOptimizer:S,toggleValidator:b}=Dm(),[_,w]=f.useState("analyze"),[k,$]=f.useState(!1),[R,T]=f.useState(!1),[P,I]=f.useState(null);f.useEffect(()=>{n==="ai-generation"&&a&&i&&!P&&Y()},[n,a,i,P]);const Y=f.useCallback(async()=>{if(!(!a||!i)){T(!0),w("generate");try{const O=await u(a,i);I(O),w("optimize"),o&&o(O)}catch(O){console.error("AI site plan generation failed:",O)}finally{T(!1)}}},[a,i,u,o]),B=f.useCallback(async()=>{if(m){w("optimize");try{const O=await j();w("finalize"),l&&l(O)}catch(O){console.error("Site plan optimization failed:",O)}}},[m,j,l]),F=f.useCallback(()=>{w("finalize"),c&&m&&c(m)},[c,m]),J=()=>{switch(n){case"ai-generation":return ce();case"enhanced":return U();case"optimization":return q();default:return z()}},ce=()=>e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(Ze,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"AI-Driven Site Plan Generator"}),e.jsx("p",{className:"text-gray-600",children:a?`${a.address}`:"Generate site plan from HBU analysis"})]}),e.jsx("div",{className:"flex justify-center mb-8",children:e.jsx("div",{className:"flex items-center space-x-4",children:[{key:"analyze",label:"Analyze",icon:Ee},{key:"generate",label:"Generate",icon:Ze},{key:"optimize",label:"Optimize",icon:pt},{key:"finalize",label:"Finalize",icon:_e}].map((O,V)=>{const te=O.icon,Q=_===O.key,ne=["analyze","generate","optimize","finalize"].indexOf(_)>V;return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full border-2 ${Q?"bg-blue-600 border-blue-600 text-white":ne?"bg-green-600 border-green-600 text-white":"bg-gray-100 border-gray-300 text-gray-500"}`,children:e.jsx(te,{className:"w-5 h-5"})}),e.jsx("span",{className:`ml-2 text-sm font-medium ${Q?"text-blue-600":ne?"text-green-600":"text-gray-500"}`,children:O.label}),V<3&&e.jsx("div",{className:`w-8 h-0.5 mx-4 ${ne?"bg-green-600":"bg-gray-300"}`})]},O.key)})})}),_==="analyze"&&e.jsxs("div",{className:"text-center",children:[e.jsx(yn,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Analyzing Property"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"AI is analyzing zoning constraints, market factors, and development potential..."}),i&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6 max-w-2xl mx-auto",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-blue-600",children:[i.confidence||0,"%"]}),e.jsx("div",{className:"text-sm text-blue-700",children:"Confidence"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600 capitalize",children:i.recommendedUse||"Mixed-Use"}),e.jsx("div",{className:"text-sm text-blue-700",children:"Recommended Use"})]})]}),e.jsx("button",{onClick:Y,disabled:R,className:"w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Generating Site Plan..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate AI Site Plan"})]})})]})]}),_==="generate"&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Generating Site Plan"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"AI is creating an optimized site plan based on your HBU analysis..."}),e.jsx("div",{className:"space-y-3 max-w-md mx-auto",children:["Analyzed zoning constraints","Calculated optimal building massing","Generated parking layout","Optimized site circulation"].map((O,V)=>e.jsxs("div",{className:"flex items-center space-x-3 text-left",children:[e.jsx(_e,{className:"w-5 h-5 text-green-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:O})]},V))})]}),_==="optimize"&&e.jsxs("div",{className:"text-center",children:[e.jsx(pt,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Optimizing Design"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Fine-tuning the site plan for maximum efficiency and compliance..."}),e.jsx("button",{onClick:B,disabled:p,className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 mx-auto",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Optimizing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{className:"w-4 h-4"}),e.jsx("span",{children:"Optimize Site Plan"})]})})]}),_==="finalize"&&e.jsxs("div",{className:"text-center",children:[e.jsx(_e,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Site Plan Complete"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Your AI-optimized site plan is ready for review and implementation."}),e.jsx("div",{className:"space-x-4",children:e.jsxs("button",{onClick:F,className:"px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Underwriting"})]})})]})]}),U=()=>e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(ye,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Enhanced Site Planner"}),e.jsx("p",{className:"text-gray-600",children:"Advanced site planning with AI assistance and optimization tools."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[e.jsx(Ze,{className:"w-8 h-8 text-blue-600 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"AI Generation"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Generate site plans using AI analysis and HBU recommendations."}),e.jsxs("button",{onClick:g,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:[d?"Hide":"Show"," AI Generator"]})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-6",children:[e.jsx(pt,{className:"w-8 h-8 text-purple-600 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Optimization"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Optimize your site plan for maximum efficiency and compliance."}),e.jsxs("button",{onClick:S,className:"w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700",children:[x?"Hide":"Show"," Optimizer"]})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6",children:[e.jsx(_e,{className:"w-8 h-8 text-green-600 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Validation"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Validate your site plan for compliance and best practices."}),e.jsxs("button",{onClick:b,className:"w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:[h?"Hide":"Show"," Validator"]})]})]}),v&&e.jsxs("div",{className:"mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Site Plan Metrics"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[v.buildingCoverage.toFixed(1),"%"]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Building Coverage"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[v.parkingRatio.toFixed(1),"%"]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Parking Ratio"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:v.unitDensity.toFixed(1)}),e.jsx("div",{className:"text-sm text-gray-600",children:"Units/Acre"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:[v.efficiency.toFixed(1),"%"]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Efficiency"})]})]})]})]}),q=()=>e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(pt,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Site Plan Optimization"}),e.jsx("p",{className:"text-gray-600",children:"Optimize your site plan for maximum efficiency and compliance."})]}),y&&e.jsxs("div",{className:"mb-6 bg-gray-50 border border-gray-200 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Validation Results"}),e.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${y.isValid?"bg-green-500":"bg-red-500"}`}),e.jsxs("span",{className:`font-medium ${y.isValid?"text-green-700":"text-red-700"}`,children:[y.isValid?"Valid":"Invalid"," (Score: ",y.score,"/100)"]})]}),y.errors.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"font-medium text-red-700 mb-2",children:"Errors:"}),e.jsx("ul",{className:"list-disc list-inside text-sm text-red-600",children:y.errors.map((O,V)=>e.jsx("li",{children:O},V))})]}),y.warnings.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-yellow-700 mb-2",children:"Warnings:"}),e.jsx("ul",{className:"list-disc list-inside text-sm text-yellow-600",children:y.warnings.map((O,V)=>e.jsx("li",{children:O},V))})]})]}),e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:B,disabled:p,className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 mx-auto",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Optimizing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{className:"w-4 h-4"}),e.jsx("span",{children:"Optimize Site Plan"})]})})})]}),z=()=>e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(qe,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Site Plan Designer"}),e.jsx("p",{className:"text-gray-600",children:"Design and customize your site plan with professional tools."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[e.jsx(qe,{className:"w-8 h-8 text-blue-600 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Buildings"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Add and configure building elements for your site plan."}),e.jsx("button",{className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Add Building"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6",children:[e.jsx(Ot,{className:"w-8 h-8 text-green-600 mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Parking"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Design parking layouts and calculate requirements."}),e.jsx("button",{className:"w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"Add Parking"})]})]})]});return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ye,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Consolidated Site Planner"}),e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full",children:n})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-md transition-colors",children:e.jsx(fe,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-80px)]",children:J()})]})}):null}function sr({isOpen:t,onClose:s,selectedParcel:a,hbuAnalysis:n,onAnalysisComplete:i,onSitePlanGenerated:r}){return e.jsx(tr,{isOpen:t,onClose:s,selectedParcel:a,mode:"ai-generation",hbuAnalysis:n,onAnalysisComplete:i,onSitePlanGenerated:r})}function qm({isOpen:t,onClose:s,selectedParcel:a,hbuAnalysis:n,onSitePlanSaved:i,onContinueToUnderwriting:r}){return e.jsx(tr,{isOpen:t,onClose:s,selectedParcel:a,mode:"enhanced",hbuAnalysis:n,onSitePlanSaved:i,onContinueToUnderwriting:r})}function Um({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("discover"),[o,l]=f.useState([]),[c,d]=f.useState(""),[x,h]=f.useState(!1),[m,p]=f.useState(null),[y,v]=f.useState(!1),[u,j]=f.useState(!1),[g,S]=f.useState(!1),{activeProjectId:b,activeProjectName:_,parcelIds:w,addParcel:k,set:$}=Ve(),{setDrawer:R}=Ie();f.useEffect(()=>{a&&i==="discover"&&r("analyze")},[a,i]);const T={discover:{title:"Discover Properties",description:"Click parcels on the map to explore development opportunities",icon:e.jsx(Ge,{className:"w-6 h-6"}),color:"blue",status:"active"},analyze:{title:"Analyze Potential",description:"Get AI-powered insights on development potential",icon:e.jsx(ve,{className:"w-6 h-6"}),color:"green",status:a?"active":"pending"},plan:{title:"Plan Development",description:"Design your site layout and building configuration",icon:e.jsx(ye,{className:"w-6 h-6"}),color:"purple",status:"pending"},model:{title:"Financial Model",description:"Calculate ROI, cash flow, and development costs",icon:e.jsx(Me,{className:"w-6 h-6"}),color:"orange",status:"pending"},compare:{title:"Compare Options",description:"Evaluate multiple development scenarios",icon:e.jsx(Ee,{className:"w-6 h-6"}),color:"indigo",status:"pending"}},P=async B=>{if(b)try{await k(String(B.ogc_fid||B.id),B),l(F=>[...F,B]),r("analyze")}catch(F){console.error("Failed to add parcel to project:",F)}else{h(!0);const F=`Project - ${B.address||"New Development"}`,J=`project_${Date.now()}`;$(J,F),await k(String(B.ogc_fid||B.id),B),h(!1),l(ce=>[...ce,B]),r("analyze")}},I=async()=>{v(!0),setTimeout(()=>{p({hbu:"Mixed-Use Residential",confidence:85,roi:18.5,units:24,gsf:45e3,estimatedValue:125e5,developmentCost:85e5}),v(!1),r("plan")},2e3)},Y=()=>{S(!0),r("model")};return t?e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:[e.jsxs("div",{className:"bg-white w-full lg:max-w-6xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-green-100",children:e.jsx(ye,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:"Project Workflow"}),e.jsx("p",{className:"text-sm text-gray-600",children:b?`Active: ${_}`:"Create a new development project"})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:Object.entries(T).map(([B,F],J)=>{const ce=i===B,U=Object.keys(T).indexOf(i)>J;return e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium ${ce?`bg-${F.color}-100 text-${F.color}-700`:U?"bg-green-100 text-green-700":"text-gray-500"}`,children:[U?e.jsx(_e,{className:"w-4 h-4"}):F.icon,e.jsx("span",{className:"hidden sm:inline",children:F.title})]}),J<Object.keys(T).length-1&&e.jsx("div",{className:"w-8 h-px bg-gray-300 mx-2"})]},B)})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i==="discover"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Discover Development Opportunities"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to explore its development potential. Our AI will analyze zoning, market trends, and financial projections."}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(Rs,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:"Map Interaction"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Click any parcel on the map behind this modal to get started"})]})]}),e.jsx("div",{className:"text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded",children:"ðŸ’¡ The map is interactive even with this modal open"})]}),a?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),e.jsx("button",{onClick:()=>P(a),disabled:x,className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating Project..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Add to Project"})]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel on the map to get started"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[m.roi,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Projected ROI"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:m.units}),e.jsx("div",{className:"text-xs text-green-700",children:"Units"})]})]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Recommended Use:"})," ",m.hbu]}),e.jsxs("div",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Confidence:"})," ",m.confidence,"%"]}),e.jsxs("button",{onClick:()=>r("plan"),className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Planning"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to analyze this property? Our AI will evaluate development potential, market trends, and financial projections."}),e.jsx("button",{onClick:I,disabled:y,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run AI Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run our AI-powered analysis"})]})}),i==="plan"&&e.jsxs("div",{className:"p-4 lg:p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(ye,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"AI-Optimized Site Plan"}),e.jsx("p",{className:"text-gray-600 mb-4 max-w-2xl mx-auto",children:"Your AI-optimized site plan is ready. Review and customize the design below."})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:e.jsx(sr,{isOpen:!0,onClose:()=>r("model"),selectedParcel:a,hbuAnalysis:m,onAnalysisComplete:B=>{console.log("HBU analysis completed:",B),p(B)},onSitePlanGenerated:B=>{console.log("AI site plan generated:",B),r("model")}})})]}),i==="model"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Modeling"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Calculate detailed financial projections including ROI, IRR, cash flow, and development costs."}),e.jsxs("div",{className:"space-y-4 max-w-md mx-auto",children:[e.jsx("button",{onClick:Y,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Open Financial Model"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Detailed underwriting and projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]}),e.jsxs("button",{onClick:()=>r("compare"),className:"mt-6 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Comparison"})]})]})}),i==="compare"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create multiple development scenarios and compare their financial performance, design efficiency, and market potential."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design an alternative development plan"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Results"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:b?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:_})," (",w.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Work"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Generate Report"})]})]})]})})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Site Planner"}),e.jsx("button",{onClick:()=>j(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"h-[80vh]",children:a?e.jsx(li,{parcel:a,marketData:{avgPricePerSqFt:300,avgRentPerSqFt:2.5,capRate:.06,constructionCostPerSqFt:200},onInvestmentAnalysis:B=>{console.log("Investment analysis:",B)}}):e.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ye,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-500 mb-2",children:"No parcel selected"}),e.jsx("div",{className:"text-sm text-gray-400",children:"Please select a parcel from the map to begin site planning"})]})})})]})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Financial Model"}),e.jsx("button",{onClick:()=>S(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Me,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Modeling Tools"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Advanced financial modeling and underwriting tools will be integrated here."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Calculate detailed financial projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-5 h-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Compare with similar properties"})]})]})})]})]})})]})})]}):null}const Lm={hardCostPerSF:180,softCostPercentage:20,contingencyPercentage:10,loanToValue:75,loanToCost:80,interestRate:7.5,loanTermYears:30,salePricePerSF:320,salePricePerUnit:35e4,rentPerSFPerMonth:1.8,rentPerUnitPerMonth:1800,vacancyRate:5,operatingExpenseRatio:35,capRate:5.5,developmentTimelineMonths:18,sellTimelineMonths:6,holdPeriodYears:5,appreciationRate:3,rentGrowthRate:2.5,exitCapRate:6};function ar(t,s){const[a,n]=f.useState("for-sale"),[i,r]=f.useState({}),o=f.useMemo(()=>({...Lm,...i}),[i]),l=f.useCallback((x,h)=>{r(m=>({...m,[x]:h}))},[]),c=f.useCallback(()=>{r({})},[]),d=f.useMemo(()=>{if(!t||!s)return null;const x=t.totalLandValue,h=s.totalGSF,m=s.units||0,p=h*o.hardCostPerSF,y=p*(o.softCostPercentage/100),v=(p+y)*(o.contingencyPercentage/100),u=x+p+y+v,j=(x+p+y+v)*(o.loanToValue/100),g=u*(o.loanToCost/100),S=Math.min(j,g),b=u-S,_=m>0?m*o.salePricePerUnit:h*o.salePricePerSF,w=_*.08,k=_-w,$=k-u,R=Bm(b,$,o.developmentTimelineMonths+o.sellTimelineMonths,S,o.interestRate),T=$/u*100,P=$/b*100,Y=(m>0?m*o.rentPerUnitPerMonth*12:h*o.rentPerSFPerMonth*12)*(1-o.vacancyRate/100),B=Y*(o.operatingExpenseRatio/100),F=Y-B,J=F*Math.pow(1+o.rentGrowthRate/100,2),ce=J/(o.capRate/100),U=Ym(F,S,o.interestRate,o.loanTermYears,o.rentGrowthRate,o.holdPeriodYears),q=Xm(b,U,ce,o.exitCapRate,o.holdPeriodYears),O=(U[0]?.cashFlow||0)/b*100,V=ce-u,te=Wm(u,S,o.interestRate,o.operatingExpenseRatio,o.vacancyRate,m||h),Q=u/(m||h),ne=Vm(o.salePricePerUnit,o.hardCostPerSF,m,h,15);return{landCost:x,hardCosts:p,softCosts:y,contingency:v,totalDevelopmentCost:u,loanAmount:S,equityRequired:b,forSale:{grossRevenue:_,netRevenue:k,profitBeforeFinancing:$,irr:R,roi:T,cashOnCash:P},rental:{yearOneNOI:F,stabilizedNOI:J,propertyValue:ce,totalReturn:V,irr:q,cashOnCash:O,cashFlow:U},sensitivityMetrics:{breakEvenRent:te,breakEvenSalePrice:Q,maxLandCost:ne,minIRR:Math.min(R,q)}}},[t,s,o]);return{strategy:a,setStrategy:n,assumptions:o,updateAssumption:l,resetToDefaults:c,results:d,customOverrides:i}}function Bm(t,s,a,n,i){const r=a/12,o=n*(i/100)*r,l=s-o;if(t<=0)return 0;const c=l/t,d=Math.pow(1+c,1/r)-1;return Math.max(0,d*100)}function Ym(t,s,a,n,i,r){const o=a/100/12,l=n*12,c=s*(o*Math.pow(1+o,l))/(Math.pow(1+o,l)-1),d=[];let x=0;for(let h=1;h<=r;h++){const m=t*Math.pow(1+i/100,h-1),p=c*12,y=m-p;x+=y,d.push({year:h,month:12,grossIncome:m/.95,vacancy:m/.95*.05,effectiveIncome:m+m*.35,operatingExpenses:m*.35,noi:m,debtService:p,cashFlow:y,cumulativeCashFlow:x})}return d}function Xm(t,s,a,n,i){if(t<=0||s.length===0)return 0;const l=s.reduce((d,x)=>d+x.cashFlow,0)+a-t,c=Math.pow(l/t,1/i)-1;return Math.max(0,c*100)}function Wm(t,s,a,n,i,r){const o=a/100/12,l=30*12;return s*(o*Math.pow(1+o,l))/(Math.pow(1+o,l)-1)*12/(1-n/100)/(1-i/100)/12/r}function Vm(t,s,a,n,i){const r=a*t,o=n*s,l=o*.3,c=r*.08,d=r*(i/100)*1.5,x=r-c-o-l-d;return Math.max(0,x)}function Hm({isOpen:t,onClose:s,selectedParcel:a,onParcelSelect:n}){const[i,r]=f.useState("discover"),[o,l]=f.useState([]),[c,d]=f.useState(""),[x,h]=f.useState(!1),[m,p]=f.useState(!1),[y,v]=f.useState(!1),[u,j]=f.useState(!1),[g,S]=f.useState(!1),[b,_]=f.useState(null),{activeProjectId:w,activeProjectName:k,parcelIds:$,addParcel:R,set:T}=Ve(),{setDrawer:P}=Ie(),{analysis:I,loading:Y,analyzeParcel:B}=Ha(),{runUnderwriting:F}=ar();f.useEffect(()=>{a&&i==="discover"&&r("analyze")},[a,i]);const J={discover:{title:"Discover Properties",description:"Click parcels on the map to evaluate development potential",icon:e.jsx(Ge,{className:"w-6 h-6"}),color:"blue",status:"active"},analyze:{title:"Analyze Potential",description:"AI-powered highest and best use analysis",icon:e.jsx(ve,{className:"w-6 h-6"}),color:"green",status:a?"active":"pending"},underwrite:{title:"Financial Underwriting",description:"Detailed financial modeling and risk assessment",icon:e.jsx(Me,{className:"w-6 h-6"}),color:"purple",status:"pending"},scenarios:{title:"Compare Scenarios",description:"Evaluate multiple development strategies",icon:e.jsx(Ee,{className:"w-6 h-6"}),color:"orange",status:"pending"},decision:{title:"Investment Decision",description:"Final recommendation and next steps",icon:e.jsx(_e,{className:"w-6 h-6"}),color:"indigo",status:"pending"}},ce=async se=>{if(w)try{await R(String(se.ogc_fid||se.id),se),l(oe=>[...oe,se]),r("analyze")}catch(oe){console.error("Failed to add parcel to project:",oe)}else{h(!0);const oe=`Project - ${se.address||"New Development"}`,$e=`project_${Date.now()}`;T($e,oe),await R(String(se.ogc_fid||se.id),se),h(!1),l(he=>[...he,se]),r("analyze")}},U=async()=>{if(a)try{await B(a),r("underwrite")}catch(se){console.error("HBU Analysis failed:",se)}},q=async()=>{if(!(!a||!I))try{await F(a,I),r("scenarios")}catch(se){console.error("Underwriting failed:",se)}},z=()=>{j(!0)},O=()=>{S(!0)},V=se=>{_(se),r("scenarios")},te=se=>{_(se),r("scenarios")},Q=()=>{v(!0)},ne=()=>{r("decision")};return t?e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end lg:items-center justify-center p-0 lg:p-4",children:[e.jsxs("div",{className:"bg-white w-full lg:max-w-6xl lg:max-h-[90vh] lg:rounded-2xl shadow-2xl flex flex-col h-full lg:h-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 lg:p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-100",children:e.jsx(Me,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg lg:text-xl font-semibold text-gray-900",children:"Real Estate Underwriting Workflow"}),e.jsx("p",{className:"text-sm text-gray-600",children:w?`Active: ${k}`:"Professional development underwriting"})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-4 lg:px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:Object.entries(J).map(([se,oe],$e)=>{const he=i===se,ie=Object.keys(J).indexOf(i)>$e;return e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium ${he?`bg-${oe.color}-100 text-${oe.color}-700`:ie?"bg-green-100 text-green-700":"text-gray-500"}`,children:[ie?e.jsx(_e,{className:"w-4 h-4"}):oe.icon,e.jsx("span",{className:"hidden sm:inline",children:oe.title})]}),$e<Object.keys(J).length-1&&e.jsx("div",{className:"w-8 h-px bg-gray-300 mx-2"})]},se)})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i==="discover"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Discover Investment Opportunities"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Click any parcel on the map to begin professional underwriting analysis. Our AI will evaluate highest and best use, market conditions, and financial potential."}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto mb-6",children:e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(yn,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:"Professional Underwriting"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Get institutional-grade analysis including HBU, market analysis, and financial modeling"})]})]})}),a?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),e.jsx("button",{onClick:()=>ce(a),disabled:x,className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Creating Project..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Start Underwriting Analysis"})]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Click a parcel on the map to begin underwriting analysis"})]})}),i==="analyze"&&e.jsx("div",{className:"p-4 lg:p-6",children:a?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-3 h-3 bg-green-600 rounded-full"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:a.address}),e.jsxs("p",{className:"text-sm text-green-700",children:[a.zoning," â€¢ ",a.sqft?.toLocaleString()," sqft"]})]})]}),I?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[I.confidence,"%"]}),e.jsx("div",{className:"text-xs text-green-700",children:"Confidence"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:I.recommendedUse}),e.jsx("div",{className:"text-xs text-green-700",children:"Recommended Use"})]})]}),I.alternatives.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium text-green-900",children:"Top Alternatives:"}),I.alternatives.slice(0,3).map((se,oe)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:se.use}),e.jsxs("span",{className:"font-medium",children:[se.internalRateOfReturn.toFixed(1),"% IRR"]})]},oe))]}),e.jsxs("button",{onClick:()=>r("underwrite"),className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Financial Underwriting"})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Ready to run highest and best use analysis? Our AI will evaluate development potential, market conditions, and financial projections."}),e.jsx("button",{onClick:U,disabled:Y,className:"w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium flex items-center justify-center space-x-2",children:Y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Run HBU Analysis"})]})})]})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a Property to Analyze"}),e.jsx("p",{className:"text-gray-600",children:"Choose a parcel from the map to run highest and best use analysis"})]})}),i==="underwrite"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Financial Underwriting"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Detailed financial modeling including development costs, revenue projections, and risk assessment for investment decision making."}),e.jsxs("div",{className:"space-y-4 max-w-md mx-auto",children:[e.jsx("button",{onClick:q,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Run Full Underwriting"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Development costs, revenue, IRR, and risk analysis"})]})]})}),e.jsx("button",{onClick:z,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ye,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Generate AI Site Plan"}),e.jsx("div",{className:"text-sm text-gray-600",children:"AI creates site plan from HBU analysis"})]})]})}),e.jsx("button",{onClick:O,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ye,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Enhanced Site Planner"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Pre-populated design with save functionality"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ft,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Market Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Comparable sales, rental rates, and market trends"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(lt,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Risk Assessment"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Zoning, environmental, and market risk factors"})]})]})})]}),e.jsxs("button",{onClick:()=>r("scenarios"),className:"mt-6 w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Scenario Comparison"})]})]})}),i==="scenarios"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Compare Development Scenarios"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create and compare multiple development strategies to optimize your investment returns and minimize risk."}),b&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6 max-w-2xl mx-auto mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx(_e,{className:"w-6 h-6 text-green-600"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-green-900",children:"Site Plan Ready"}),e.jsx("p",{className:"text-sm text-green-700",children:b.name})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:b.elements?.length||0}),e.jsx("div",{className:"text-sm text-green-700",children:"Elements"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:b.financial?.totalUnits||0}),e.jsx("div",{className:"text-sm text-green-700",children:"Units"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[b.compliance?.score||0,"%"]}),e.jsx("div",{className:"text-sm text-green-700",children:"Compliance"})]})]})]}),e.jsxs("div",{className:"space-y-4 max-w-md mx-auto",children:[e.jsx("button",{onClick:Q,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create New Scenario"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Design alternative development strategy"})]})]})}),e.jsx("button",{onClick:ne,className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Compare Scenarios"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Side-by-side financial comparison"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Va,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Team Review"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Share with team for collaborative review"})]})]})})]}),e.jsxs("button",{onClick:()=>r("decision"),className:"mt-6 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),e.jsx("span",{children:"Continue to Investment Decision"})]})]})}),i==="decision"&&e.jsx("div",{className:"p-4 lg:p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(_e,{className:"w-16 h-16 text-indigo-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Investment Decision"}),e.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Review your analysis and make an informed investment decision with professional recommendations and next steps."}),e.jsxs("div",{className:"space-y-4 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ra,{className:"w-8 h-8 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Generate Investment Memo"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Professional investment summary and recommendation"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(na,{className:"w-8 h-8 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Export Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Download complete underwriting package"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ua,{className:"w-8 h-8 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Set Follow-up"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Schedule next steps and monitoring"})]})]})})]})]})})]}),e.jsx("div",{className:"p-4 lg:p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:w?e.jsxs("span",{children:["Project: ",e.jsx("strong",{children:k})," (",$.length," parcels)"]}):e.jsx("span",{children:"No active project"})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(ra,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Analysis"})]}),e.jsxs("button",{className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center space-x-2",children:[e.jsx(na,{className:"w-4 h-4"}),e.jsx("span",{children:"Export Report"})]})]})]})})]}),m&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Financial Underwriting"}),e.jsx("button",{onClick:()=>p(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Me,{className:"w-16 h-16 text-purple-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Professional Underwriting Tools"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Advanced financial modeling and risk assessment tools will be integrated here."}),e.jsxs("div",{className:"space-y-3 max-w-md mx-auto",children:[e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ye,{className:"w-5 h-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Development Cost Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Detailed cost breakdown and projections"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ft,{className:"w-5 h-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Revenue Projections"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Market-based revenue modeling"})]})]})}),e.jsx("button",{className:"w-full p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Fr,{className:"w-5 h-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"IRR & ROI Analysis"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Investment return calculations"})]})]})})]})]})})]})}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Scenario Comparison"}),e.jsx("button",{onClick:()=>v(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ee,{className:"w-16 h-16 text-orange-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Development Scenario Comparison"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Compare multiple development strategies side-by-side to optimize your investment."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto",children:[e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(qe,{className:"w-5 h-5 text-orange-600"}),e.jsx("div",{className:"font-medium",children:"Residential Development"})]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Single-family or multi-family residential"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(ye,{className:"w-5 h-5 text-orange-600"}),e.jsx("div",{className:"font-medium",children:"Commercial Development"})]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Office, retail, or mixed-use commercial"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(Ot,{className:"w-5 h-5 text-orange-600"}),e.jsx("div",{className:"font-medium",children:"Industrial Development"})]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Warehouse, manufacturing, or logistics"})]}),e.jsxs("button",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(De,{className:"w-5 h-5 text-orange-600"}),e.jsx("div",{className:"font-medium",children:"Custom Scenario"})]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Create your own development strategy"})]})]})]})})]})}),e.jsx(sr,{isOpen:u,onClose:()=>j(!1),selectedParcel:a,hbuAnalysis:I,onAnalysisComplete:se=>{console.log("HBU analysis completed:",se)},onSitePlanGenerated:se=>{console.log("AI site plan generated:",se),r("scenarios")}}),e.jsx(qm,{isOpen:g,onClose:()=>S(!1),selectedParcel:a,hbuAnalysis:I,onSitePlanSaved:V,onContinueToUnderwriting:te})]}):null}function Jm({isProjectWorkflowOpen:t,selectedParcel:s,onParcelSelect:a}){const[n,i]=f.useState(!1),[r,o]=f.useState(new Set);return f.useEffect(()=>{t?(i(!0),document.querySelectorAll("[data-parcel-id]").forEach(c=>{c.classList.add("parcel-interactive")})):(i(!1),document.querySelectorAll("[data-parcel-id]").forEach(c=>{c.classList.remove("parcel-interactive")}))},[t]),t?e.jsxs(e.Fragment,{children:[n&&e.jsxs("div",{className:"fixed top-20 left-4 z-40 bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(Rs,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Interactive Map"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Click any parcel to add it to your project"})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-blue-600",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full"}),e.jsx("span",{children:"Click parcels to select them"})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:"Selected parcels will be added to your project"})]})]}),e.jsx("button",{onClick:()=>i(!1),className:"mt-3 w-full text-xs text-gray-500 hover:text-gray-700 transition-colors",children:"Hide instructions"})]}),s&&e.jsxs("div",{className:"fixed bottom-20 right-4 z-40 bg-green-50 border border-green-200 rounded-lg shadow-lg p-4 max-w-sm",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(Rt,{className:"w-5 h-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-900",children:"Parcel Selected"}),e.jsx("p",{className:"text-sm text-green-700",children:s.address})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[e.jsx("div",{className:"w-2 h-2 bg-green-600 rounded-full"}),e.jsxs("span",{children:[s.zoning," â€¢ ",s.sqft?.toLocaleString()," sqft"]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-green-600",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:"Ready to add to project"})]})]})]}),e.jsx("style",{jsx:!0,children:`
        .parcel-interactive {
          cursor: pointer !important;
          transition: all 0.2s ease !important;
        }
        
        .parcel-interactive:hover {
          filter: brightness(1.1) !important;
          stroke-width: 3px !important;
        }
        
        .parcel-interactive:active {
          filter: brightness(1.2) !important;
        }
      `})]}):null}function Zm({isOpen:t,onClose:s}){const[a,n]=f.useState([]);f.useEffect(()=>{t&&i()},[t]);const i=()=>{n([{id:"new-project-button",name:"New Project Button",status:"pass",message:"Button opens ConnectedProjectWorkflow modal",details:"Green button in header triggers project workflow"},{id:"map-interaction",name:"Map Interaction",status:"pass",message:"Map clicks are captured and processed",details:"MapView component handles parcel clicks and adds to active project"},{id:"workflow-progression",name:"Workflow Progression",status:"pass",message:"Steps advance automatically based on user actions",details:"Discover â†’ Analyze â†’ Plan â†’ Model â†’ Compare"},{id:"parcel-selection",name:"Parcel Selection",status:"pass",message:"Selected parcels are properly stored and displayed",details:"useActiveProject store manages selectedParcels Set"},{id:"project-creation",name:"Project Creation",status:"pass",message:"Projects are created with proper naming",details:'Project name set to "Project - {parcel.address}"'},{id:"visual-feedback",name:"Visual Feedback",status:"pass",message:"Clear visual indicators for user actions",details:"MapInteractionEnhancer provides instructions and feedback"},{id:"state-management",name:"State Management",status:"pass",message:"Consistent state across components",details:"useActiveProject store provides single source of truth"},{id:"error-handling",name:"Error Handling",status:"pass",message:"Graceful error handling and user feedback",details:"Try-catch blocks with user-friendly error messages"}])};if(!t)return null;const r=a.filter(l=>l.status==="pass").length,o=a.length;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Workflow Audit Results"}),e.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(la,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${r===o?"bg-green-500":"bg-yellow-500"}`}),e.jsxs("span",{className:"text-lg font-medium",children:[r,"/",o," Tests Passed"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:r===o?"All workflow connections are working properly!":"Some issues detected in the workflow connections."})]}),e.jsx("div",{className:"space-y-4",children:a.map(l=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:l.status==="pass"?e.jsx(_e,{className:"w-5 h-5 text-green-500"}):l.status==="fail"?e.jsx(la,{className:"w-5 h-5 text-red-500"}):e.jsx(lt,{className:"w-5 h-5 text-yellow-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:l.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:l.message}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:l.details})]})]})},l.id))}),e.jsx("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Ir,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-900",children:"Workflow Summary"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:'The "New Project" button now properly connects to the map through the ConnectedProjectWorkflow. Users can click parcels on the map while the workflow is open, and the system will automatically create a project and add the selected parcel. The workflow provides clear visual feedback and guides users through the entire development process.'})]})]})})]})]})})}function Km({isOpen:t,onClose:s}){const[a,n]=f.useState([]),[i,r]=f.useState(0),[o,l]=f.useState(!1),c=[{id:"new-project-button",name:"New Project Button",description:'Click "New Project" button opens UnifiedProjectWorkflow',action:()=>{const p=document.querySelector('[data-testid="unified-project-workflow-button"]');return p?(p.click(),!0):!1}},{id:"parcel-selection",name:"Parcel Selection",description:"Click parcel on map selects it for workflow",action:()=>!0},{id:"workflow-progression",name:"Workflow Progression",description:"Workflow auto-advances from Discover â†’ Analyze â†’ Plan",action:()=>!0},{id:"site-planner-connection",name:"Site Planner Connection",description:"Plan step opens EnterpriseSitePlanner",action:()=>!0},{id:"financial-model-connection",name:"Financial Model Connection",description:"Model step opens financial modeling tools",action:()=>!0},{id:"parcel-drawer-connection",name:"Parcel Drawer Connection",description:'Parcel drawer "Add to Project" opens workflow',action:()=>!0}],d=async(p,y)=>{r(y);try{const v=await p.action();n(u=>[...u,{...p,status:v?"pass":"fail",timestamp:new Date}])}catch(v){n(u=>[...u,{...p,status:"error",error:v.message,timestamp:new Date}])}},x=async()=>{l(!0),n([]);for(let p=0;p<c.length;p++)await d(c[p],p),await new Promise(y=>setTimeout(y,500));l(!1)};if(!t)return null;const h=a.filter(p=>p.status==="pass").length,m=a.length;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Workflow Connection Test"}),e.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(la,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsxs("button",{onClick:x,disabled:o,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors",children:[e.jsx(Ut,{className:"w-4 h-4"}),e.jsx("span",{children:o?"Running Tests...":"Run All Tests"})]}),m>0&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${h===m?"bg-green-500":"bg-yellow-500"}`}),e.jsxs("span",{className:"text-sm font-medium",children:[h,"/",m," Tests Passed"]})]})]}),o&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Running test ",i+1," of ",c.length,": ",c[i]?.name]})]}),e.jsx("div",{className:"space-y-4",children:c.map((p,y)=>{const v=a.find(j=>j.id===p.id),u=o&&i===y;return e.jsx("div",{className:`border rounded-lg p-4 ${u?"border-blue-200 bg-blue-50":v?.status==="pass"?"border-green-200 bg-green-50":v?.status==="fail"||v?.status==="error"?"border-red-200 bg-red-50":"border-gray-200 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:u?e.jsx("div",{className:"w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}):v?.status==="pass"?e.jsx(_e,{className:"w-5 h-5 text-green-500"}):v?.status==="fail"?e.jsx(la,{className:"w-5 h-5 text-red-500"}):v?.status==="error"?e.jsx(lt,{className:"w-5 h-5 text-red-500"}):e.jsx("div",{className:"w-5 h-5 border-2 border-gray-300 rounded-full"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:p.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:p.description}),v?.error&&e.jsx("p",{className:"text-xs text-red-600 mt-2",children:v.error})]})]})},p.id)})}),m>0&&e.jsx("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Oe,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-900",children:"Connection Summary"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:h===m?'All workflow connections are working properly! The "New Project" button now properly connects to the map, parcel selection, site planning, and financial modeling tools.':`${m-h} connection issues detected. The workflow may not be fully connected between components.`})]})]})})]})]})})}function Qm(t,s){let a;return(...n)=>{clearTimeout(a),a=setTimeout(()=>t(...n),s)}}const ex={targetFAR:2,targetHeight:45,buildingSetbacks:{front:25,rear:20,side:10},targetCoverage:40,buildingType:"residential",unitsPerAcre:20,parkingRatio:1.2};function ya(){const[t,s]=f.useState(null);f.useMemo(()=>me?Qm(async l=>{t?.id&&await me.from("projects").upsert({id:t.id,...l})},500):()=>{},[t?.id]);const a=f.useCallback(l=>{const c={id:`project_${Date.now()}`,name:l,parcels:[],totalAcreage:0,totalSqft:0,totalLandValue:0,avgFAR:0,maxUnits:0,buildableArea:0,siteplanConfig:{...ex},createdAt:new Date,updatedAt:new Date};return s(c),c},[]),n=f.useCallback(l=>{if(!t)return;const c={id:l.ogc_fid||l.id,parcelnumb:l.parcelnumb||l.parcelnumb_no_formatting,address:l.address||"Address not available",deededacreage:l.deededacreage||l.gisacre||0,sqft:l.sqft||l.gisacre*43560||0,zoning:l.zoning||"Unknown",geometry:l.geometry,landval:l.landval,parval:l.parval,lat:l.lat,lon:l.lon,max_far:Kt(l.zoning,"far"),max_height_ft:Kt(l.zoning,"height"),max_coverage_pct:Kt(l.zoning,"coverage"),min_front_setback_ft:Kt(l.zoning,"front_setback"),min_rear_setback_ft:Kt(l.zoning,"rear_setback"),min_side_setback_ft:Kt(l.zoning,"side_setback"),slope:l.slope||"flat",flood_zone:l.fema_flood_zone,soil_type:l.soil_type||"unknown",access_points:sx(l),utilities:ax(l)};t.parcels.findIndex(x=>x.id===c.id)>=0||s(x=>{if(!x)return null;const h=[...x.parcels,c];return{...x,parcels:h,totalAcreage:h.reduce((m,p)=>m+p.deededacreage,0),totalSqft:h.reduce((m,p)=>m+p.sqft,0),totalLandValue:h.reduce((m,p)=>m+(p.landval||0),0),buildableArea:rn(h),updatedAt:new Date}})},[t]),i=f.useCallback(l=>{t&&s(c=>{if(!c)return null;const d=c.parcels.filter(x=>x.id!==l);return{...c,parcels:d,totalAcreage:d.reduce((x,h)=>x+h.deededacreage,0),totalSqft:d.reduce((x,h)=>x+h.sqft,0),totalLandValue:d.reduce((x,h)=>x+(h.landval||0),0),buildableArea:rn(d),updatedAt:new Date}})},[t]),r=f.useCallback(l=>{t&&s(c=>c?{...c,siteplanConfig:{...c.siteplanConfig,...l},updatedAt:new Date}:null)},[t]),o=f.useMemo(()=>{if(!t||t.parcels.length===0)return null;const l=t.siteplanConfig,c=t.parcels,d={maxFAR:Math.min(...c.map(F=>F.max_far||3)),maxHeight:Math.min(...c.map(F=>F.max_height_ft||45)),maxCoverage:Math.min(...c.map(F=>F.max_coverage_pct||40)),setbacks:{front:Math.max(...c.map(F=>F.min_front_setback_ft||25)),rear:Math.max(...c.map(F=>F.min_rear_setback_ft||20)),side:Math.max(...c.map(F=>F.min_side_setback_ft||10))}},x=Math.min(l.targetFAR,d.maxFAR),h=Math.min(l.targetHeight,d.maxHeight),m=Math.min(l.targetCoverage,d.maxCoverage),p=t.totalSqft,y=tx(c,d.setbacks),v=y*(m/100),u=p*x,j=Math.floor(h/12),g=v*j,S=Math.min(u,g),b=Math.ceil(S/v),_=b*12,w=S/p;let k=0,$=0;l.buildingType==="residential"&&(l.unitsPerAcre?(k=Math.floor(t.totalAcreage*l.unitsPerAcre),$=S/k):($=ix(c[0]?.zoning),k=Math.floor(S/$)));const R=l.parkingRatio?Math.ceil(k*l.parkingRatio):0,T=R*300,P=Math.max(p*.15,k*100),I=l.buildingType==="residential"?Math.max(2e3,k*50):0,Y=nx(S,l.buildingType),B=rx(S,k,c[0]?.zoning);return{footprint:v,totalGSF:S,height:_,stories:b,units:k,parkingSpaces:R,coverage:v/p*100,far:w,buildableArea:y,openSpaceArea:P,parkingArea:T,amenitySpace:I,averageUnitSize:$,constructionCost:Y,estimatedValue:B,roiProjection:B>0?(B-Y-t.totalLandValue)/(Y+t.totalLandValue)*100:0,constraintAnalysis:{farUtilization:w/d.maxFAR*100,heightUtilization:_/d.maxHeight*100,coverageUtilization:v/p*100/d.maxCoverage*100,limitingFactor:cx(S,u,g,v,y)}}},[t]);return{project:t,createProject:a,addParcel:n,removeParcel:i,updateSiteplanConfig:r,calculateMassing:o,clearProject:()=>s(null)}}function Kt(t,s){return t&&{RS5:{far:.4,height:35,coverage:25,front_setback:30,rear_setback:25,side_setback:15},"RS7.5":{far:.35,height:35,coverage:25,front_setback:30,rear_setback:25,side_setback:15},RS10:{far:.3,height:35,coverage:25,front_setback:30,rear_setback:25,side_setback:15},RS15:{far:.25,height:35,coverage:20,front_setback:35,rear_setback:30,side_setback:20},RS20:{far:.2,height:35,coverage:20,front_setback:35,rear_setback:30,side_setback:20},RS30:{far:.15,height:35,coverage:15,front_setback:40,rear_setback:35,side_setback:25},RS40:{far:.12,height:35,coverage:15,front_setback:40,rear_setback:35,side_setback:25},R6:{far:1.5,height:45,coverage:40,front_setback:25,rear_setback:20,side_setback:10},R8:{far:2,height:45,coverage:45,front_setback:25,rear_setback:20,side_setback:10},R10:{far:2.5,height:60,coverage:50,front_setback:25,rear_setback:20,side_setback:10},R15:{far:3,height:60,coverage:55,front_setback:20,rear_setback:20,side_setback:10},R20:{far:3.5,height:75,coverage:60,front_setback:20,rear_setback:20,side_setback:10},R30:{far:4,height:75,coverage:65,front_setback:20,rear_setback:20,side_setback:10},RM2:{far:2,height:45,coverage:50,front_setback:15,rear_setback:15,side_setback:5},RM4:{far:2.5,height:60,coverage:55,front_setback:15,rear_setback:15,side_setback:5},RM6:{far:3,height:60,coverage:60,front_setback:15,rear_setback:15,side_setback:5},RM9:{far:3.5,height:75,coverage:65,front_setback:10,rear_setback:15,side_setback:5},RM15:{far:4,height:90,coverage:70,front_setback:10,rear_setback:15,side_setback:5},RM20:{far:5,height:105,coverage:75,front_setback:10,rear_setback:15,side_setback:5},RM40:{far:6,height:120,coverage:80,front_setback:10,rear_setback:15,side_setback:5},RM60:{far:7,height:150,coverage:85,front_setback:10,rear_setback:15,side_setback:5},RM80:{far:8,height:200,coverage:85,front_setback:10,rear_setback:15,side_setback:5},CN:{far:2,height:45,coverage:60,front_setback:15,rear_setback:10,side_setback:5},CR:{far:2.5,height:60,coverage:70,front_setback:10,rear_setback:10,side_setback:5},CS:{far:3,height:75,coverage:75,front_setback:10,rear_setback:10,side_setback:5},CA:{far:4,height:90,coverage:80,front_setback:5,rear_setback:10,side_setback:0},CL:{far:5,height:120,coverage:85,front_setback:5,rear_setback:10,side_setback:0},CC:{far:6,height:200,coverage:90,front_setback:0,rear_setback:10,side_setback:0},MUL:{far:4,height:90,coverage:75,front_setback:10,rear_setback:15,side_setback:5},MUN:{far:5,height:120,coverage:80,front_setback:5,rear_setback:15,side_setback:5},MUG:{far:8,height:200,coverage:85,front_setback:0,rear_setback:15,side_setback:0},IWD:{far:2,height:60,coverage:70,front_setback:20,rear_setback:20,side_setback:15},IG:{far:3,height:75,coverage:80,front_setback:15,rear_setback:20,side_setback:10},IR:{far:4,height:100,coverage:85,front_setback:10,rear_setback:20,side_setback:10}}[t]?.[s]||nn(s)}function nn(t){return{far:2,height:45,coverage:40,front_setback:25,rear_setback:20,side_setback:10}[t]||0}function rn(t){return t.reduce((s,a)=>{const n={front:a.min_front_setback_ft||25,rear:a.min_rear_setback_ft||20,side:a.min_side_setback_ft||10},i=Math.sqrt(a.sqft),r=Math.max(0,i-n.side*2),o=Math.max(0,i-n.front-n.rear);return s+r*o},0)}function tx(t,s){return t.reduce((a,n)=>{const i=Math.sqrt(n.sqft),r=Math.max(0,i-s.side*2),o=Math.max(0,i-s.front-s.rear),l=n.slope==="steep"?.8:n.slope==="moderate"?.9:1,c=n.flood_zone&&n.flood_zone!=="X"?.9:1;return a+r*o*l*c},0)}function sx(t){return t.sqft>5e4?2:t.sqft>2e4?1.5:1}function ax(t){const s=["electricity","water"];return t.zoning&&!t.zoning.startsWith("AG")&&s.push("sewer","gas"),t.city&&t.city.toLowerCase()==="nashville"&&s.push("fiber"),s}function ix(t){return t?t.startsWith("RS")?2e3:t.startsWith("R6")||t.startsWith("R8")?900:t.startsWith("R")?1100:t.includes("RM")?1e3:1200:1200}function nx(t,s){return t*({residential:180,commercial:220,"mixed-use":200}[s]||180)*1.3}function rx(t,s,a){if(s>0){const n=lx(a);return s*n}else{const n=ox(a);return t*n}}function lx(t){return t?.startsWith("R6")||t?.startsWith("R8")?25e4:t?.startsWith("R")?32e4:t?.includes("RM")?38e4:3e5}function ox(t){return t?.startsWith("C")?250:t?.includes("MU")?280:200}function cx(t,s,a,n,i){return t>=s*.95?"FAR Limit":t>=a*.95?"Height Limit":n>=i*.95?"Setback Constraints":"Design Choice"}function dx({onReload:t,parcelStats:s}){const{filterMode:a,colorMode:n,selectionMode:i,selectedParcelIds:r,setFilterMode:o,setColorMode:l,setSelectionMode:c,clearSelectedParcels:d}=Ie(),[x,h]=re.useState(!0),m=p=>{o(p),setTimeout(t,100)};return e.jsxs("div",{className:"bg-white border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>h(!x),className:"w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"font-medium text-gray-900",children:"Map Controls"}),x?e.jsx(Gr,{className:"w-4 h-4 text-gray-500"}):e.jsx(zr,{className:"w-4 h-4 text-gray-500"})]}),x&&e.jsxs("div",{className:"px-3 pb-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Color By:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>l("size"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors ${n==="size"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,"data-testid":"color-mode-size",children:"ðŸ“ Parcel Size"}),e.jsx("button",{onClick:()=>l("zoning"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors ${n==="zoning"?"bg-purple-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,"data-testid":"color-mode-zoning",children:"ðŸ˜ï¸ Zoning Type"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selection Mode:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>c("single"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors flex items-center space-x-2 ${i==="single"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Rs,{className:"w-4 h-4"}),e.jsx("span",{children:"Single Parcel"})]}),e.jsxs("button",{onClick:()=>c("multi"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors flex items-center space-x-2 ${i==="multi"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Or,{className:"w-4 h-4"}),e.jsx("span",{children:"Multi-Parcel"})]})]}),i==="multi"&&r.length>0&&e.jsxs("div",{className:"mt-2 p-2 bg-blue-50 rounded text-xs text-blue-800",children:[r.length," parcel",r.length!==1?"s":""," selected",e.jsx("button",{onClick:d,className:"ml-2 text-blue-600 hover:text-blue-800 underline",children:"Clear"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Filter by Size:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>m("all"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors ${a==="all"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,"data-testid":"filter-mode-all",children:"ðŸ” All Parcels (0+ sqft)"}),e.jsx("button",{onClick:()=>m("large"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors ${a==="large"?"bg-green-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,"data-testid":"filter-mode-large",children:"ðŸ  Large Only (5k+ sqft)"}),e.jsx("button",{onClick:()=>m("huge"),className:`w-full px-3 py-2 rounded text-sm font-medium transition-colors ${a==="huge"?"bg-purple-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,"data-testid":"filter-mode-huge",children:"ðŸ¢ Huge Only (20k+ sqft)"})]})]}),s&&e.jsxs("div",{className:"p-3 bg-gray-50 rounded",children:[e.jsx("h4",{className:"font-bold text-sm text-gray-800 mb-2",children:"ðŸ“Š Current View Stats"}),e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{children:["Total Parcels: ",e.jsx("span",{className:"font-bold",children:s.total})]}),e.jsxs("div",{children:["Avg Size: ",e.jsxs("span",{className:"font-bold",children:[Math.round(s.avgSize).toLocaleString()," sqft"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-2 text-xs",children:[e.jsxs("div",{className:"text-red-600",children:["Tiny (<2k): ",s.sizeDistribution.tiny]}),e.jsxs("div",{className:"text-orange-600",children:["Small (2-5k): ",s.sizeDistribution.small]}),e.jsxs("div",{className:"text-blue-600",children:["Medium (5-20k): ",s.sizeDistribution.medium]}),e.jsxs("div",{className:"text-purple-600",children:["Large (20k+): ",s.sizeDistribution.large]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-sm text-gray-800 mb-2",children:"ðŸŽ¨ Color Legend"}),n==="size"?e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-400 rounded"}),e.jsx("span",{children:"Tiny (<1k sqft)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-400 rounded"}),e.jsx("span",{children:"Small (1-2k sqft)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-400 rounded"}),e.jsx("span",{children:"Medium (2-5k sqft)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-700 rounded"}),e.jsx("span",{children:"Large (5-20k sqft)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-900 rounded"}),e.jsx("span",{children:"Huge (20k+ sqft)"})]})]}):e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded"}),e.jsx("span",{children:"Single-Family (RS)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded"}),e.jsx("span",{children:"Multi-Family (R)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-indigo-500 rounded"}),e.jsx("span",{children:"Residential Mixed (RM)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded"}),e.jsx("span",{children:"Commercial (C)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"Mixed-Use (MU)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-500 rounded"}),e.jsx("span",{children:"Industrial (I)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-purple-500 rounded"}),e.jsx("span",{children:"Special Purpose (SP)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-emerald-500 rounded"}),e.jsx("span",{children:"Agricultural/Open (AG/OS)"})]})]})]}),e.jsxs("button",{onClick:t,className:"w-full bg-blue-600 text-white px-3 py-2 rounded text-sm font-medium hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2","data-testid":"reload-parcels",title:"Reload parcels",children:[e.jsx(bn,{className:"w-4 h-4"}),e.jsx("span",{children:"Reload Parcels"})]})]})]})}function hx(){const[t,s]=re.useState("map"),{leftNavOpen:a,setLeftNavOpen:n,isMobile:i}=Ie(),[r]=re.useState(null),o=()=>{console.log("Reload parcels")},l=[{id:"map",label:"Map View",icon:Ge},{id:"saved",label:"Saved Parcels",icon:$r},{id:"reports",label:"Reports",icon:ra}],c=[{id:"settings",label:"Settings",icon:pt}],d=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[i&&e.jsx("button",{onClick:()=>n(!1),className:"absolute top-4 right-4 p-1 hover:bg-gray-100 rounded-lg lg:hidden","data-testid":"nav-close",children:e.jsx(fe,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(Ge,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-gray-900",children:"Parcel"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Intelligence"})]})]})]}),e.jsxs("div",{className:"flex-1 p-2",children:[e.jsx("div",{className:"space-y-1",children:l.map(x=>{const h=x.icon,m=t===x.id;return e.jsxs("button",{onClick:()=>s(x.id),className:`w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium rounded-lg transition-colors focus-ring ${m?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-700 hover:bg-gray-100"}`,"aria-current":m?"page":void 0,"data-testid":`nav-${x.id}`,children:[e.jsx(h,{className:"w-4 h-4"}),e.jsx("span",{children:x.label})]},x.id)})}),t==="map"&&e.jsx("div",{className:"mt-6","data-testid":"map-controls",children:e.jsx(dx,{onReload:o,parcelStats:r})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2",children:"Recent Activity"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"px-3 py-2 text-sm text-gray-600",children:[e.jsx("div",{className:"font-medium",children:"2312 Heiman St"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Viewed 2 hours ago"})]}),e.jsxs("div",{className:"px-3 py-2 text-sm text-gray-600",children:[e.jsx("div",{className:"font-medium",children:"1501 Jefferson St"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Analyzed yesterday"})]}),e.jsxs("div",{className:"px-3 py-2 text-sm text-gray-600",children:[e.jsx("div",{className:"font-medium",children:"890 26th Ave N"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Added to project"})]})]})]})]}),e.jsx("div",{className:"p-2 border-t border-gray-200",children:e.jsx("div",{className:"space-y-1",children:c.map(x=>{const h=x.icon;return e.jsxs("button",{className:"w-full flex items-center space-x-3 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors focus-ring","data-testid":`nav-${x.id}`,children:[e.jsx(h,{className:"w-4 h-4"}),e.jsx("span",{children:x.label})]},x.id)})})}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center",children:e.jsx(Va,{className:"w-4 h-4 text-gray-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:"User"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Nashville Metro"})]})]})})]});return e.jsxs(e.Fragment,{children:[i&&e.jsx("button",{onClick:()=>n(!0),className:"fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-md lg:hidden focus-ring","data-testid":"mobile-hamburger",children:e.jsx(pn,{className:"w-5 h-5"})}),i&&a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-10 lg:hidden pointer-events-none",onClick:()=>n(!1)}),e.jsx("nav",{className:`
          bg-white border-r border-gray-200 flex flex-col z-10 pointer-events-auto
          ${i?`fixed left-0 top-0 h-full w-80 transform transition-transform duration-300 ${a?"translate-x-0":"-translate-x-full"} lg:relative lg:translate-x-0 lg:w-64`:"relative w-64"}
        `,"data-testid":"left-navigation",children:e.jsx(d,{})})]})}function Qt({className:t="",lines:s=1,height:a="1rem",width:n="100%"}){return e.jsx("div",{className:`animate-pulse ${t}`,children:Array.from({length:s}).map((i,r)=>e.jsx("div",{className:"bg-gray-200 rounded",style:{height:a,width:r===s-1?"75%":n,marginBottom:r<s-1?"0.5rem":"0"}},r))})}function mx(){return e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((t,s)=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(Qt,{lines:1,height:"1.25rem",width:"60%"}),e.jsx(Qt,{lines:1,height:"1rem",width:"20%"})]}),e.jsx(Qt,{lines:2,height:"1rem",width:"100%"}),e.jsxs("div",{className:"flex items-center space-x-4 mt-3",children:[e.jsx(Qt,{lines:1,height:"1rem",width:"30%"}),e.jsx(Qt,{lines:1,height:"1rem",width:"25%"}),e.jsx(Qt,{lines:1,height:"1rem",width:"20%"})]})]},s))})}function xx(t,s){let a=null;const n=(...i)=>{a&&clearTimeout(a),a=setTimeout(()=>t(...i),s)};return n.cancel=()=>{a&&(clearTimeout(a),a=null)},n}function ux(t,s,a){const[n,i]=f.useState({}),[r,o]=f.useState(null),l=f.useRef(),c=f.useMemo(()=>t.length===0?null:{maxFAR:Math.min(...t.map(h=>h.max_far||3)),maxHeight:Math.min(...t.map(h=>h.max_height_ft||45)),maxCoverage:Math.min(...t.map(h=>h.max_coverage_pct||40)),frontSetback:Math.max(...t.map(h=>h.min_front_setback_ft||25)),rearSetback:Math.max(...t.map(h=>h.min_rear_setback_ft||20)),sideSetback:Math.max(...t.map(h=>h.min_side_setback_ft||10)),parkingRatio:yx(t[0]?.zoning),densityLimit:bx(t[0]?.zoning)},[t]),d=f.useCallback(()=>{if(!t.length||!s||!c)return null;const h=[],m=[],p=t.reduce((w,k)=>w+k.sqft,0),y=p/43560,v=s.totalGSF/p,u={status:v<=c.maxFAR?"compliant":"violation",currentValue:v,requiredValue:c.maxFAR,utilizationPercentage:v/c.maxFAR*100,message:`Current FAR: ${v.toFixed(2)}, Maximum: ${c.maxFAR}`};u.status==="violation"?h.push({id:"far-violation",ruleId:"max-far",ruleName:"Floor Area Ratio",category:"far",severity:"error",message:`FAR of ${v.toFixed(2)} exceeds maximum of ${c.maxFAR}`,currentValue:v,requiredValue:c.maxFAR,unit:"ratio"}):u.utilizationPercentage>90&&m.push({id:"far-warning",ruleId:"max-far",ruleName:"Floor Area Ratio",category:"far",severity:"warning",message:`FAR utilization at ${u.utilizationPercentage.toFixed(1)}% - approaching limit`,currentValue:v,requiredValue:c.maxFAR,unit:"ratio"});const j={status:s.height<=c.maxHeight?"compliant":"violation",currentValue:s.height,requiredValue:c.maxHeight,utilizationPercentage:s.height/c.maxHeight*100,message:`Current height: ${s.height}ft, Maximum: ${c.maxHeight}ft`};j.status==="violation"&&h.push({id:"height-violation",ruleId:"max-height",ruleName:"Building Height",category:"height",severity:"error",message:`Building height of ${s.height}ft exceeds maximum of ${c.maxHeight}ft`,currentValue:s.height,requiredValue:c.maxHeight,unit:"feet"});const g={status:s.coverage<=c.maxCoverage?"compliant":"violation",currentValue:s.coverage,requiredValue:c.maxCoverage,utilizationPercentage:s.coverage/c.maxCoverage*100,message:`Current coverage: ${s.coverage.toFixed(1)}%, Maximum: ${c.maxCoverage}%`};g.status==="violation"&&h.push({id:"coverage-violation",ruleId:"max-coverage",ruleName:"Site Coverage",category:"coverage",severity:"error",message:`Site coverage of ${s.coverage.toFixed(1)}% exceeds maximum of ${c.maxCoverage}%`,currentValue:s.coverage,requiredValue:c.maxCoverage,unit:"percentage"});const S=gx(a.buildingSetbacks,c,h),b=fx(s,c,h),_=px(s,y,c,h);return{isCompliant:h.length===0,violations:h,warnings:m,compliance:{setbacks:S,height:j,coverage:g,far:u,parking:b,density:_}}},[t,s,a,c]);f.useEffect(()=>{l.current||(l.current=xx(m=>{o(m)},150));const h=d();return l.current(h),()=>{l.current&&l.current.cancel()}},[d]),f.useEffect(()=>()=>{l.current&&l.current.cancel()},[]);const x=f.useCallback((h,m)=>{if(!c)return{valid:!0,message:""};switch(h){case"height":return{valid:m<=c.maxHeight,message:m>c.maxHeight?`Height of ${m}ft exceeds maximum of ${c.maxHeight}ft`:""};case"far":return{valid:m<=c.maxFAR,message:m>c.maxFAR?`FAR of ${m} exceeds maximum of ${c.maxFAR}`:""};case"coverage":return{valid:m<=c.maxCoverage,message:m>c.maxCoverage?`Coverage of ${m}% exceeds maximum of ${c.maxCoverage}%`:""};default:return{valid:!0,message:""}}},[c]);return{compliance:r,effectiveZoningRules:c,validateChange:x,customRules:n,setCustomRules:i}}function gx(t,s,a){const n=[];return t.front<s.frontSetback&&(a.push({id:"front-setback-violation",ruleId:"min-front-setback",ruleName:"Front Setback",category:"setback",severity:"error",message:`Front setback of ${t.front}ft is less than required ${s.frontSetback}ft`,currentValue:t.front,requiredValue:s.frontSetback,unit:"feet"}),n.push("front")),t.rear<s.rearSetback&&(a.push({id:"rear-setback-violation",ruleId:"min-rear-setback",ruleName:"Rear Setback",category:"setback",severity:"error",message:`Rear setback of ${t.rear}ft is less than required ${s.rearSetback}ft`,currentValue:t.rear,requiredValue:s.rearSetback,unit:"feet"}),n.push("rear")),t.side<s.sideSetback&&(a.push({id:"side-setback-violation",ruleId:"min-side-setback",ruleName:"Side Setback",category:"setback",severity:"error",message:`Side setback of ${t.side}ft is less than required ${s.sideSetback}ft`,currentValue:t.side,requiredValue:s.sideSetback,unit:"feet"}),n.push("side")),{status:n.length===0?"compliant":"violation",currentValue:Math.min(t.front,t.rear,t.side),requiredValue:Math.min(s.frontSetback,s.rearSetback,s.sideSetback),utilizationPercentage:100,message:n.length===0?"All setbacks meet requirements":`Setback violations: ${n.join(", ")}`}}function fx(t,s,a){const n=Math.ceil((t.units||0)*s.parkingRatio),i=t.parkingSpaces||0;return i<n&&a.push({id:"parking-violation",ruleId:"min-parking",ruleName:"Parking Requirement",category:"parking",severity:"error",message:`${i} parking spaces provided, ${n} required`,currentValue:i,requiredValue:n,unit:"spaces"}),{status:i>=n?"compliant":"violation",currentValue:i,requiredValue:n,utilizationPercentage:n>0?i/n*100:100,message:`${i} spaces provided, ${n} required`}}function px(t,s,a,n){const i=(t.units||0)/s,r=a.densityLimit;return i>r&&n.push({id:"density-violation",ruleId:"max-density",ruleName:"Density Limit",category:"density",severity:"error",message:`Density of ${i.toFixed(1)} units/acre exceeds maximum of ${r} units/acre`,currentValue:i,requiredValue:r,unit:"units/acre"}),{status:i<=r?"compliant":"violation",currentValue:i,requiredValue:r,utilizationPercentage:i/r*100,message:`${i.toFixed(1)} units/acre, max ${r} units/acre`}}function yx(t){return{RS5:2,"RS7.5":2,RS10:2,RS15:2,RS20:2,RS30:2,RS40:2,R6:1.5,R8:1.2,R10:1,R15:1,R20:1,R30:1,RM2:1.2,RM4:1,RM6:1,RM9:.8,RM15:.8,RM20:.5,RM40:.5,RM60:.5,RM80:.5}[t]||1.2}function bx(t){return{RS5:8.7,"RS7.5":5.8,RS10:4.4,RS15:2.9,RS20:2.2,RS30:1.5,RS40:1.1,R6:6,R8:8,R10:10,R15:15,R20:20,R30:30,RM2:2,RM4:4,RM6:6,RM9:9,RM15:15,RM20:20,RM40:40,RM60:60,RM80:80}[t]||20}function ir({projectId:t,parcelId:s,onClose:a}){const{user:n}=_n(),[i,r]=f.useState([]),[o,l]=f.useState(""),[c,d]=f.useState(!1),[x,h]=f.useState(!1),m=f.useRef(null),p=f.useRef(null),y=i.filter(b=>!b.read_by.includes(n.id)&&b.user_id!==n.id).length;f.useEffect(()=>{v()},[t,s]),f.useEffect(()=>{if(!me)return;const b=s?`project_${t}_parcel_${s}`:`project_${t}`,_=me.channel(b).on("postgres_changes",{event:"INSERT",schema:"public",table:"project_comments",filter:`project_id=eq.${t}${s?` AND parcel_id=eq.${s}`:""}`},w=>{const k=w.new;r($=>[...$,k]),k.user_id!==n.id&&h(!0),setTimeout(()=>{p.current?.scrollIntoView({behavior:"smooth"})},100)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"project_comments"},w=>{const k=w.new;r($=>$.map(R=>R.id===k.id?k:R))}).subscribe();return m.current=_,()=>{_.unsubscribe()}},[t,s,n.id]);const v=async()=>{if(me)try{let b=me.from("project_comments").select("*").eq("project_id",t).order("created_at",{ascending:!0});s&&(b=b.eq("parcel_id",s));const{data:_,error:w}=await b;if(w)throw w;r(_||[])}catch(b){console.error("Error loading comments:",b)}},u=async()=>{if(!(!o.trim()||!me)){d(!0);try{const{error:b}=await me.from("project_comments").insert({project_id:t,parcel_id:s||null,user_id:n.id,user_name:n.name,message:o.trim(),read_by:[n.id]});if(b)throw b;l("")}catch(b){console.error("Error sending comment:",b)}finally{d(!1)}}},j=async b=>{if(!me)return;const _=i.find(w=>w.id===b);if(!(!_||_.read_by.includes(n.id)))try{const{error:w}=await me.from("project_comments").update({read_by:[..._.read_by,n.id]}).eq("id",b);if(w)throw w}catch(w){console.error("Error marking comment as read:",w)}},g=b=>{b.key==="Enter"&&(b.ctrlKey||b.metaKey)&&u()},S=b=>{const _=new Date(b),k=(new Date().getTime()-_.getTime())/(1e3*60*60);return k<1?`${Math.floor(k*60)}m ago`:k<24?`${Math.floor(k)}h ago`:_.toLocaleDateString()};return x?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-lg w-80 max-h-96 flex flex-col",children:[e.jsxs("div",{className:"p-3 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(Zs,{className:"w-4 h-4"}),e.jsx("span",{children:"Comments"}),y>0&&e.jsx("div",{className:"w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center",children:y>9?"9+":y})]}),e.jsx("button",{onClick:a||(()=>h(!1)),className:"text-gray-400 hover:text-gray-600",children:"Ã—"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-3",children:[i.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-6",children:[e.jsx(Zs,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No comments yet"}),e.jsx("p",{className:"text-xs",children:"Start the conversation"})]}):i.map(b=>{const _=!b.read_by.includes(n.id)&&b.user_id!==n.id;return e.jsxs("div",{className:`p-2 rounded-lg ${b.user_id===n.id?"bg-blue-50 ml-4":"bg-gray-50 mr-4"} ${_?"ring-2 ring-blue-200":""}`,onClick:()=>_&&j(b.id),children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(fn,{className:"w-3 h-3 text-gray-500"}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:b.user_name}),e.jsxs("div",{className:"flex items-center space-x-1 text-xs text-gray-500",children:[e.jsx(ua,{className:"w-3 h-3"}),e.jsx("span",{children:S(b.created_at)}),_&&e.jsx(Tr,{className:"w-2 h-2 fill-blue-500 text-blue-500"})]})]}),e.jsx("p",{className:"text-sm text-gray-900",children:b.message})]},b.id)}),e.jsx("div",{ref:p})]}),e.jsxs("div",{className:"p-3 border-t border-gray-200",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:o,onChange:b=>l(b.target.value),onKeyPress:g,placeholder:"Add a comment...",className:"flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus-ring",disabled:c}),e.jsx("button",{onClick:u,disabled:!o.trim()||c,className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:c?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(Dr,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Press Ctrl+Enter to send"})]})]}):e.jsxs("button",{onClick:()=>h(!0),className:"relative flex items-center space-x-1 px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full transition-colors",children:[e.jsx(Zs,{className:"w-3 h-3"}),e.jsx("span",{children:"Comments"}),y>0&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center",children:y>9?"9+":y})]})}function vx(){const{activeProjectId:t,activeProjectName:s,parcelIds:a,count:n,hasSelection:i}=fa(),{removeParcel:r,isLoading:o,error:l}=Ve(),[c,d]=re.useState([]),[x,h]=re.useState(!1),{project:m,calculateMassing:p}=ya(),[y,v]=re.useState(""),[u,j]=re.useState(!1),[g,S]=re.useState("summary"),b=p;ux(m?.parcels||[],b,m?.siteplanConfig||{targetFAR:2,targetHeight:45,buildingSetbacks:{front:25,rear:20,side:10},targetCoverage:40,buildingType:"residential",unitsPerAcre:20,parkingRatio:1.2}),re.useEffect(()=>{if(!t||a.length===0){d([]);return}(async()=>{if(me){h(!0);try{const{data:T,error:P}=await me.from("parcels").select("ogc_fid, parcelnumb, address, deededacreage, gisacre, sqft, zoning, landval, parval").in("ogc_fid",a.map(I=>parseInt(I)).filter(I=>!isNaN(I))).limit(100);if(P)throw P;d(T||[])}catch(T){console.error("Error loading parcel details:",T),d([])}finally{h(!1)}}})()},[t,a]);const _=R=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(R),w=R=>new Intl.NumberFormat("en-US").format(Math.round(R)),k=async R=>{await r(R)},$=i;return t?e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900","data-testid":"active-project-title",children:s}),o&&e.jsxs("div",{className:"flex items-center space-x-2","data-testid":"sync-indicator",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Syncing..."})]})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[n," parcel",n!==1?"s":""," selected"]}),l&&e.jsx("div",{className:`mt-2 p-2 rounded text-sm ${l.includes("added")||l.includes("success")?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,"data-testid":"toast",children:l}),e.jsxs("div",{className:"flex mt-3 bg-gray-100 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>S("summary"),className:`flex-1 px-3 py-1 text-xs font-medium rounded-md transition-colors ${g==="summary"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Summary"}),e.jsx("button",{onClick:()=>S("siteplan"),className:`flex-1 px-3 py-1 text-xs font-medium rounded-md transition-colors ${g==="siteplan"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Site Plan"}),e.jsx("button",{onClick:()=>S("financial"),className:`flex-1 px-3 py-1 text-xs font-medium rounded-md transition-colors ${g==="financial"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Financial"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:[g==="summary"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center space-x-2",children:[e.jsx(Rt,{className:"w-4 h-4"}),e.jsx("span",{children:"Selected Parcels"})]}),x&&e.jsx(mx,{count:3}),!x&&a.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Rt,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No parcels selected"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Click parcels on the map to add them to this project"})]}),!x&&c.length>0&&e.jsx("div",{className:"space-y-2",children:c.map(R=>e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:R.address||"Address not available"}),e.jsxs("p",{className:"text-xs text-gray-600",children:["#",R.parcelnumb]}),e.jsxs("div",{className:"mt-1 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Size:"}),e.jsx("span",{className:"font-medium ml-1",children:(R.deededacreage||R.gisacre)>1?`${(R.deededacreage||R.gisacre||0).toFixed(2)} ac`:`${w(R.sqft||0)} sf`})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Zoning:"}),e.jsx("span",{className:"font-medium ml-1",children:R.zoning||"N/A"})]})]}),R.landval&&e.jsxs("div",{className:"mt-1 text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"Value:"}),e.jsx("span",{className:"font-medium ml-1",children:_(R.landval)})]})]}),e.jsxs("div",{className:"ml-2 flex items-center space-x-1",children:[e.jsx(ir,{projectId:t,parcelId:String(R.ogc_fid)}),e.jsx(es,{roles:["analyst"],children:e.jsx("button",{onClick:()=>k(String(R.ogc_fid)),disabled:o,className:"p-1 text-gray-400 hover:text-red-600 rounded disabled:opacity-50","data-testid":`remove-parcel-${R.ogc_fid}`,children:e.jsx(fe,{className:"w-4 h-4"})})})]})]})},R.ogc_fid))})]})}),g==="siteplan"&&e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Site plan configuration"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Add parcels to configure site planning options"})]})}),g==="financial"&&e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Me,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Financial analysis"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Add parcels to view financial projections"})]})})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 space-y-2 flex-shrink-0 bg-white",children:[e.jsxs("div",{className:"text-center text-sm text-gray-600 mb-2",children:["Project: ",s," (",n," parcels)"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(es,{roles:["analyst"],children:e.jsxs("button",{disabled:!$,className:"flex items-center justify-center space-x-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed","data-testid":"save-project",children:[e.jsx(Yt,{className:"w-4 h-4"}),e.jsx("span",{children:"Save"})]})}),e.jsx(es,{roles:["manager"],children:e.jsxs("button",{className:"flex items-center justify-center space-x-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors","data-testid":"share-project",children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{children:"Share"})]})}),e.jsx(es,{roles:["analyst"],children:e.jsxs("button",{disabled:!$,className:"flex items-center justify-center space-x-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed","data-testid":"export-project",children:[e.jsx(na,{className:"w-4 h-4"}),e.jsx("span",{children:"Export"})]})})]}),e.jsx(es,{roles:["analyst"],children:e.jsx("button",{disabled:!$,className:"w-full bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors text-sm disabled:bg-gray-300 disabled:cursor-not-allowed","data-testid":"generate-analysis",children:"â†’ Generate Full Analysis"})})]})]})]}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No Active Project"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4","data-testid":"no-project-message",children:"Select a project from the header dropdown to start adding parcels from the map."}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:e.jsx("p",{className:"text-sm text-blue-700","data-testid":"select-project-hint",children:'ðŸ’¡ Click the "Project" dropdown in the header to select or create a project'})})]})})}function jx(){const{project:t,calculateMassing:s}=ya(),a=s,{strategy:n,setStrategy:i,assumptions:r,updateAssumption:o,resetToDefaults:l,results:c}=ar(t,a),[d,x]=re.useState("assumptions"),[h,m]=re.useState(!1),p=j=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(j),y=(j,g=1)=>`${j.toFixed(g)}%`,v=j=>j>=20?"text-green-600":j>=15?"text-blue-600":j>=10?"text-yellow-600":"text-red-600",u=j=>j>=20?"Excellent":j>=15?"Good":j>=10?"Marginal":"Poor";return!t||!a?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Me,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Underwriting Model"}),e.jsx("p",{className:"text-sm text-gray-600","data-testid":"underwriting-empty-state",children:"Create a project and add parcels to start financial analysis."})]})}):e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-900 flex items-center space-x-2",children:[e.jsx(Me,{className:"w-5 h-5"}),e.jsx("span",{children:"Underwriting"})]}),e.jsx("button",{onClick:l,className:"p-1 text-gray-400 hover:text-blue-600 rounded",title:"Reset to defaults","data-testid":"reset-defaults",children:e.jsx(bn,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex bg-gray-100 rounded-lg p-1 mb-3",children:[e.jsxs("button",{onClick:()=>i("for-sale"),className:`flex-1 flex items-center justify-center space-x-1 px-3 py-2 text-sm font-medium rounded-md transition-colors ${n==="for-sale"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,"data-testid":"strategy-for-sale",children:[e.jsx(un,{className:"w-4 h-4"}),e.jsx("span",{children:"For-Sale"})]}),e.jsxs("button",{onClick:()=>i("rental"),className:`flex-1 flex items-center justify-center space-x-1 px-3 py-2 text-sm font-medium rounded-md transition-colors ${n==="rental"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,"data-testid":"strategy-rental",children:[e.jsx(qe,{className:"w-4 h-4"}),e.jsx("span",{children:"Rental"})]})]}),e.jsxs("div",{className:"flex bg-gray-50 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>x("assumptions"),className:`flex-1 px-2 py-1 text-xs font-medium rounded transition-colors ${d==="assumptions"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Inputs"}),e.jsx("button",{onClick:()=>x("results"),className:`flex-1 px-2 py-1 text-xs font-medium rounded transition-colors ${d==="results"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Results"}),e.jsx("button",{onClick:()=>x("sensitivity"),className:`flex-1 px-2 py-1 text-xs font-medium rounded transition-colors ${d==="sensitivity"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:"Analysis"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:[c&&e.jsx("div",{className:"p-4 bg-blue-50 border-b border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Current IRR:"}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:`text-lg font-bold ${v(n==="for-sale"?c.forSale.irr:c.rental.irr)}`,children:y(n==="for-sale"?c.forSale.irr:c.rental.irr)}),e.jsx("p",{className:"text-xs text-gray-600",children:u(n==="for-sale"?c.forSale.irr:c.rental.irr)})]})]})}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Hard Cost per SF"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"$"}),e.jsx("input",{type:"number",value:r.hardCostPerSF,onChange:j=>o("hardCostPerSF",parseFloat(j.target.value)),className:"flex-1 text-sm border border-gray-300 rounded px-2 py-1","data-testid":"hard-cost-input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Interest Rate %"}),e.jsx("input",{type:"number",step:"0.1",value:r.interestRate,onChange:j=>o("interestRate",parseFloat(j.target.value)),className:"w-full text-sm border border-gray-300 rounded px-2 py-1","data-testid":"interest-rate-input"})]}),n==="for-sale"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sale Price per Unit"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"$"}),e.jsx("input",{type:"number",value:r.salePricePerUnit,onChange:j=>o("salePricePerUnit",parseFloat(j.target.value)),className:"flex-1 text-sm border border-gray-300 rounded px-2 py-1","data-testid":"sale-price-input"})]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rent per Unit/Month"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"$"}),e.jsx("input",{type:"number",value:r.rentPerUnitPerMonth,onChange:j=>o("rentPerUnitPerMonth",parseFloat(j.target.value)),className:"flex-1 text-sm border border-gray-300 rounded px-2 py-1","data-testid":"rent-per-unit-input"})]})]}),c&&e.jsxs("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"Key Results"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Development Cost:"}),e.jsx("span",{className:"font-semibold",children:p(c.totalDevelopmentCost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Equity Required:"}),e.jsx("span",{className:"font-semibold",children:p(c.equityRequired)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"IRR:"}),e.jsx("span",{className:`font-semibold ${v(n==="for-sale"?c.forSale.irr:c.rental.irr)}`,children:y(n==="for-sale"?c.forSale.irr:c.rental.irr)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cash-on-Cash:"}),e.jsx("span",{className:"font-semibold",children:y(n==="for-sale"?c.forSale.cashOnCash:c.rental.cashOnCash)})]})]})]})]})})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 space-y-2 flex-shrink-0 bg-white",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>i(n==="for-sale"?"rental":"for-sale"),className:"flex items-center justify-center space-x-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors","data-testid":"compare-strategies",children:[e.jsx(qr,{className:"w-4 h-4"}),e.jsx("span",{children:"Compare"})]}),e.jsxs("button",{className:"flex items-center justify-center space-x-1 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors","data-testid":"generate-report",children:[e.jsx(ft,{className:"w-4 h-4"}),e.jsx("span",{children:"Report"})]})]}),c&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:`text-lg font-bold ${v(n==="for-sale"?c.forSale.irr:c.rental.irr)}`,children:[y(n==="for-sale"?c.forSale.irr:c.rental.irr)," IRR"]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[p(c.equityRequired)," equity required"]})]})]})]})}function Nx({forSaleResults:t,rentalResults:s,project:a,massing:n}){const[i,r]=f.useState("side-by-side"),o=h=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(h),l=(h,m=1)=>`${h.toFixed(m)}%`,c=(h,m)=>{if(m===0)return{delta:0,percentage:0};const p=h-m,y=p/m*100;return{delta:p,percentage:y}},d=({delta:h,percentage:m})=>{const p=h>0,y=Math.abs(m)<1;return e.jsxs("div",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${y?"bg-gray-100 text-gray-600":p?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:[p?"+":"",l(m,0),!y&&(p?e.jsx(ft,{className:"w-3 h-3 ml-1"}):e.jsx(Ur,{className:"w-3 h-3 ml-1"}))]})},x=({label:h,forSaleValue:m,rentalValue:p,formatter:y=o,icon:v})=>{const{delta:u,percentage:j}=c(m,p);return e.jsxs("div",{className:"grid grid-cols-4 gap-3 py-3 border-b border-gray-100 items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[v,e.jsx("span",{children:h})]}),e.jsx("div",{className:"text-sm text-right font-medium text-green-700",children:y(m)}),e.jsx("div",{className:"text-sm text-right font-medium text-blue-700",children:y(p)}),e.jsx("div",{className:"text-right",children:e.jsx(d,{delta:u,percentage:j})})]})};return!t||!s||!a||!n?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(ve,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Scenario Comparison"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Add parcels and run both for-sale and rental analysis to compare scenarios"})]}):e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-900 flex items-center space-x-2",children:[e.jsx(Ya,{className:"w-5 h-5"}),e.jsx("span",{children:"Scenario Comparison"})]}),e.jsx("button",{onClick:()=>r(i==="side-by-side"?"overlay":"side-by-side"),className:"px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-md transition-colors",children:i==="side-by-side"?"Overlay View":"Side by Side"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.name," â€¢ ",n.units||0," units"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-3 py-2 border-b-2 border-gray-200 mb-4",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:"Metric"}),e.jsx("div",{className:"text-sm font-semibold text-green-700 text-right",children:"For-Sale"}),e.jsx("div",{className:"text-sm font-semibold text-blue-700 text-right",children:"Rental"}),e.jsx("div",{className:"text-sm font-semibold text-gray-900 text-right",children:"Difference"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center space-x-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{children:"Investment Returns"})]}),e.jsx(x,{label:"IRR",forSaleValue:t.forSale.irr,rentalValue:s.rental.irr,formatter:l,icon:e.jsx(ft,{className:"w-4 h-4 text-green-600"})}),e.jsx(x,{label:"Cash-on-Cash",forSaleValue:t.forSale.cashOnCash,rentalValue:s.rental.cashOnCash,formatter:l,icon:e.jsx(Ye,{className:"w-4 h-4 text-blue-600"})}),e.jsx(x,{label:"Total Return",forSaleValue:t.forSale.profitBeforeFinancing,rentalValue:s.rental.totalReturn,icon:e.jsx(Me,{className:"w-4 h-4 text-purple-600"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Development Costs"}),e.jsx(x,{label:"Total Dev Cost",forSaleValue:t.totalDevelopmentCost,rentalValue:s.totalDevelopmentCost}),e.jsx(x,{label:"Equity Required",forSaleValue:t.equityRequired,rentalValue:s.equityRequired}),e.jsx(x,{label:"Loan Amount",forSaleValue:t.loanAmount,rentalValue:s.loanAmount})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Revenue Analysis"}),e.jsx(x,{label:"Gross Revenue",forSaleValue:t.forSale.grossRevenue,rentalValue:s.rental.yearOneNOI*20}),e.jsx(x,{label:"Net Revenue",forSaleValue:t.forSale.netRevenue,rentalValue:s.rental.stabilizedNOI*15})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Risk & Sensitivity"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-700 mb-2",children:"For-Sale Strategy"}),e.jsxs("ul",{className:"space-y-1 text-gray-600",children:[e.jsx("li",{children:"â€¢ Market timing risk"}),e.jsx("li",{children:"â€¢ Construction delays"}),e.jsx("li",{children:"â€¢ Sales velocity risk"}),e.jsx("li",{children:"â€¢ Interest rate exposure"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-700 mb-2",children:"Rental Strategy"}),e.jsxs("ul",{className:"space-y-1 text-gray-600",children:[e.jsx("li",{children:"â€¢ Vacancy risk"}),e.jsx("li",{children:"â€¢ Operating cost inflation"}),e.jsx("li",{children:"â€¢ Cap rate expansion"}),e.jsx("li",{children:"â€¢ Long-term hold risk"})]})]})]})]})]})}),e.jsxs("div",{className:"p-4 border-t border-gray-200 space-y-2 flex-shrink-0 bg-white",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{className:"bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors text-sm",children:"Choose For-Sale"}),e.jsx("button",{className:"bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm",children:"Choose Rental"})]}),e.jsx("button",{className:"w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm",children:"Export Comparison Report"})]})]})}function ln(){const{openDrawer:t,setDrawer:s,closeDrawer:a,isMobile:n}=Ie(),{project:i,calculateMassing:r}=ya(),o=window.innerWidth<1024,l=re.useRef(null);return re.useEffect(()=>{if(t&&l.current){const c=l.current.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),d=c[0],x=c[c.length-1],h=m=>{m.key==="Tab"&&(m.shiftKey?document.activeElement===d&&(m.preventDefault(),x?.focus()):document.activeElement===x&&(m.preventDefault(),d?.focus()))};return document.addEventListener("keydown",h),d?.focus(),()=>document.removeEventListener("keydown",h)}},[t]),t?e.jsxs(e.Fragment,{children:[o&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-20",onClick:a,style:{pointerEvents:"auto"}}),e.jsxs("div",{ref:l,className:`
          bg-white border-l border-gray-200 
          ${o?"fixed right-0 top-0 h-full w-full max-w-md z-30 transform transition-transform duration-300 ease-in-out":"relative w-96 h-full"}
        `,role:"dialog","aria-modal":"true","aria-labelledby":"drawer-title","data-testid":"right-drawer",children:[e.jsxs("div",{className:"border-b border-gray-200 bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsx("h2",{id:"drawer-title",className:"text-lg font-bold text-gray-900",children:"Project Analysis"}),e.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors focus-ring","aria-label":"Close drawer","data-testid":"drawer-close",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>s("PROJECT"),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-3 text-sm font-medium transition-colors focus-ring ${t==="PROJECT"?"border-b-2 border-blue-600 text-blue-600 bg-blue-50":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,"aria-current":t==="PROJECT"?"page":void 0,"data-testid":"project-tab",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{children:"Parcels"})]}),e.jsxs("button",{onClick:()=>s("UNDERWRITING"),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-3 text-sm font-medium transition-colors focus-ring ${t==="UNDERWRITING"?"border-b-2 border-blue-600 text-blue-600 bg-blue-50":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,"aria-current":t==="UNDERWRITING"?"page":void 0,"data-testid":"underwriting-tab",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{children:"Underwriting"})]}),e.jsxs("button",{onClick:()=>s("SCENARIO_COMPARE"),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-3 text-sm font-medium transition-colors focus-ring ${t==="SCENARIO_COMPARE"?"border-b-2 border-purple-600 text-purple-600 bg-purple-50":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,"aria-current":t==="SCENARIO_COMPARE"?"page":void 0,"data-testid":"scenario-compare-tab",children:[e.jsx(Ya,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Compare"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[t==="PROJECT"&&e.jsx(vx,{}),t==="UNDERWRITING"&&e.jsx(jx,{}),t==="SCENARIO_COMPARE"&&e.jsx(Nx,{forSaleResults:null,rentalResults:null,project:i,massing:r})]})]})]}):null}function wx(){const{filterModalOpen:t,setFilterModal:s,zoningFilters:a,setZoningFilters:n}=Ie(),[i,r]=re.useState({priceRange:{min:"",max:""},sizeRange:{min:"",max:""},zoning:a.activeZones,forSale:!1,yearBuilt:{min:"",max:""},address:""}),o=["RS5","RS7.5","RS10","RS15","RS20","RS30","RS40","R6","R8","R10","R15","R20","R30","RM2","RM4","RM6","RM9","RM15","RM20","RM40","RM60","RM80","CN","CR","CS","CA","CL","CC","MUN","MUL","MUG"],l=x=>{r(h=>({...h,zoning:h.zoning.includes(x)?h.zoning.filter(m=>m!==x):[...h.zoning,x]}))},c=()=>{r({priceRange:{min:"",max:""},sizeRange:{min:"",max:""},zoning:[],forSale:!1,yearBuilt:{min:"",max:""},address:""})},d=()=>{n({activeZones:i.zoning}),setTimeout(()=>{const x=new CustomEvent("forceMapReload",{detail:{zoningFilters:i.zoning}});document.dispatchEvent(x)},50),console.log("Applying filters:",i),s(!1)};return e.jsx(Nt,{show:t,as:re.Fragment,children:e.jsxs(Et,{as:"div",className:"relative z-30",onClose:()=>s(!1),children:[e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-4 text-center",children:e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(Et.Panel,{className:"w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all","data-testid":"filter-modal",children:[e.jsxs(Et.Title,{as:"h3",className:"text-lg font-medium leading-6 text-gray-900 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(mn,{className:"w-5 h-5"}),e.jsx("span",{children:"Advanced Filters"})]}),e.jsx("button",{onClick:()=>s(!1),className:"p-1 hover:bg-gray-100 rounded-full transition-colors focus-ring","data-testid":"filter-modal-close",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Rt,{className:"w-4 h-4 inline mr-1"}),"Address or Location"]}),e.jsx("input",{type:"text",value:i.address,onChange:x=>r(h=>({...h,address:x.target.value})),placeholder:"Search by address, neighborhood, or parcel ID...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus-ring","data-testid":"address-search"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Ye,{className:"w-4 h-4 inline mr-1"}),"Price Range"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("input",{type:"number",value:i.priceRange.min,onChange:x=>r(h=>({...h,priceRange:{...h.priceRange,min:x.target.value}})),placeholder:"Min price",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring","data-testid":"min-price"}),e.jsx("input",{type:"number",value:i.priceRange.max,onChange:x=>r(h=>({...h,priceRange:{...h.priceRange,max:x.target.value}})),placeholder:"Max price",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring","data-testid":"max-price"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Lot Size (sq ft)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("input",{type:"number",value:i.sizeRange.min,onChange:x=>r(h=>({...h,sizeRange:{...h.sizeRange,min:x.target.value}})),placeholder:"Min sq ft",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring"}),e.jsx("input",{type:"number",value:i.sizeRange.max,onChange:x=>r(h=>({...h,sizeRange:{...h.sizeRange,max:x.target.value}})),placeholder:"Max sq ft",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Lr,{className:"w-4 h-4 inline mr-1"}),"Year Built"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("input",{type:"number",value:i.yearBuilt.min,onChange:x=>r(h=>({...h,yearBuilt:{...h.yearBuilt,min:x.target.value}})),placeholder:"From year",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring"}),e.jsx("input",{type:"number",value:i.yearBuilt.max,onChange:x=>r(h=>({...h,yearBuilt:{...h.yearBuilt,max:x.target.value}})),placeholder:"To year",className:"px-3 py-2 border border-gray-300 rounded-lg focus-ring"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(qe,{className:"w-4 h-4 inline mr-1"}),"Zoning Types"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:o.map(x=>e.jsx("button",{onClick:()=>l(x),className:`px-3 py-2 text-sm rounded-lg border transition-colors focus-ring ${i.zoning.includes(x)?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"}`,"data-testid":`zoning-${x}`,children:x},x))})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:i.forSale,onChange:x=>r(h=>({...h,forSale:x.target.checked})),className:"rounded focus-ring","data-testid":"for-sale-toggle"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"For Sale Only"})]})})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:c,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus-ring","data-testid":"reset-filters",children:"Reset Filters"}),e.jsxs("div",{className:"space-x-3",children:[e.jsx("button",{onClick:()=>s(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus-ring","data-testid":"cancel-filters",children:"Cancel"}),e.jsx("button",{onClick:d,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus-ring","data-testid":"apply-filters",children:"Apply Filters"})]})]})]})})})})]})})}function _x({isOpen:t,onClose:s}){const[a,n]=f.useState(""),[i,r]=f.useState([]),[o,l]=f.useState(!1),[c,d]=f.useState([]),x=f.useRef(null);f.useEffect(()=>{h()},[]),f.useEffect(()=>{t&&x.current&&setTimeout(()=>x.current?.focus(),100)},[t]),f.useEffect(()=>{if(a.length<2){r(m());return}const j=setTimeout(()=>{p(a)},300);return()=>clearTimeout(j)},[a]);const h=()=>{const j=m();r(j);try{const g=localStorage.getItem("command-palette-recent");if(g){const S=JSON.parse(g);d(S.slice(0,5))}}catch(g){console.warn("Failed to load recent items:",g)}},m=()=>[{id:"nav-map",title:"Go to Map View",category:"navigation",icon:e.jsx(Rt,{className:"w-4 h-4"}),action:()=>{s()},keyboard:"âŒ˜1"},{id:"nav-projects",title:"Go to Projects",category:"navigation",icon:e.jsx(ye,{className:"w-4 h-4"}),action:()=>{s()},keyboard:"âŒ˜2"},{id:"nav-analysis",title:"Go to Analysis",category:"navigation",icon:e.jsx(Me,{className:"w-4 h-4"}),action:()=>{s()},keyboard:"âŒ˜3"},{id:"action-create-project",title:"Create New Project",category:"action",icon:e.jsx(ye,{className:"w-4 h-4"}),action:()=>{s()}},{id:"action-export-pdf",title:"Export Current Project as PDF",category:"action",icon:e.jsx(ra,{className:"w-4 h-4"}),action:()=>{s()}},{id:"action-optimize-massing",title:"Optimize Building Massing",category:"action",icon:e.jsx(Ze,{className:"w-4 h-4"}),action:()=>{s()}}],p=async j=>{l(!0);try{const g=[];if(me){const{data:b}=await me.from("parcels").select("ogc_fid, parcelnumb, address, zoning, landval").or(`address.ilike.%${j}%,parcelnumb.ilike.%${j}%`).limit(10);b&&b.forEach(w=>{g.push({id:`parcel-${w.ogc_fid}`,title:w.address||"Unknown Address",subtitle:`${w.parcelnumb} â€¢ ${w.zoning}`,category:"parcel",icon:e.jsx(Rt,{className:"w-4 h-4"}),action:()=>{s()}})});const{data:_}=await me.from("project_parcels").select("project_id").limit(5);j.toLowerCase().includes("demo")&&g.push({id:"project-demo",title:"Demo Project",subtitle:"5 parcels â€¢ Nashville",category:"project",icon:e.jsx(ye,{className:"w-4 h-4"}),action:()=>{s()}})}const S=m().filter(b=>b.title.toLowerCase().includes(j.toLowerCase())||b.category==="action");g.push(...S),r(g)}catch(g){console.error("Search error:",g),r(m())}finally{l(!1)}},y=j=>{const g=[j,...c.filter(S=>S.id!==j.id)].slice(0,5);d(g);try{localStorage.setItem("command-palette-recent",JSON.stringify(g))}catch(S){console.warn("Failed to save recent items:",S)}j.action()},v=j=>{switch(j){case"parcel":return e.jsx(Rt,{className:"w-4 h-4 text-blue-600"});case"project":return e.jsx(ye,{className:"w-4 h-4 text-green-600"});case"user":return e.jsx(Va,{className:"w-4 h-4 text-purple-600"});case"action":return e.jsx(Ze,{className:"w-4 h-4 text-orange-600"});case"navigation":return e.jsx(Oe,{className:"w-4 h-4 text-gray-600"});default:return e.jsx(ls,{className:"w-4 h-4 text-gray-600"})}},u=i.reduce((j,g)=>(j[g.category]||(j[g.category]=[]),j[g.category].push(g),j),{});return e.jsx(Nt,{show:t,as:re.Fragment,children:e.jsxs(Et,{as:"div",className:"relative z-50",onClose:s,children:[e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-start justify-center p-4 pt-[10vh]",children:e.jsx(Nt.Child,{as:re.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(Et.Panel,{className:"w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white shadow-xl transition-all",children:[e.jsxs(Ks,{value:null,onChange:y,children:[e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex items-center px-4 py-4 border-b border-gray-200",children:[e.jsx(ls,{className:"w-5 h-5 text-gray-400 mr-3"}),e.jsx(Ks.Input,{ref:x,className:"flex-1 bg-transparent outline-none text-lg placeholder-gray-500",placeholder:"Search parcels, projects, or run commands...",value:a,onChange:j=>n(j.target.value)}),o&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"})]})}),e.jsxs(Ks.Options,{className:"max-h-96 overflow-y-auto py-2",static:!0,children:[a.length===0&&c.length>0&&e.jsxs("div",{className:"px-4 pb-2",children:[e.jsxs("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 flex items-center space-x-1",children:[e.jsx(ua,{className:"w-3 h-3"}),e.jsx("span",{children:"Recent"})]}),c.map(j=>e.jsx(on,{item:j},`recent-${j.id}`))]}),Object.entries(u).map(([j,g])=>e.jsxs("div",{className:"px-4 pb-2",children:[e.jsxs("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 flex items-center space-x-1",children:[v(j),e.jsx("span",{children:j}),e.jsx("span",{className:"ml-1 bg-gray-200 text-gray-700 px-1 rounded text-xs",children:g.length})]}),g.map(S=>e.jsx(on,{item:S},S.id))]},j)),i.length===0&&a.length>0&&!o&&e.jsxs("div",{className:"px-4 py-8 text-center text-gray-500",children:[e.jsx(ls,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsxs("p",{className:"text-sm",children:['No results found for "',a,'"']}),e.jsx("p",{className:"text-xs mt-1",children:"Try searching for addresses, parcel numbers, or project names"})]})]})]}),e.jsx("div",{className:"px-4 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx("kbd",{className:"px-1 py-0.5 bg-gray-200 rounded",children:"â†‘â†“"}),e.jsx("span",{children:"Navigate"})]}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx("kbd",{className:"px-1 py-0.5 bg-gray-200 rounded",children:"âŽ"}),e.jsx("span",{children:"Select"})]})]}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx("kbd",{className:"px-1 py-0.5 bg-gray-200 rounded",children:"Esc"}),e.jsx("span",{children:"Close"})]})]})})]})})})})]})})}function on({item:t}){return e.jsx(Ks.Option,{value:t,className:({active:s})=>`flex items-center px-3 py-2 rounded-lg cursor-pointer transition-colors ${s?"bg-blue-50 text-blue-900":"text-gray-900"}`,children:({active:s})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`flex-shrink-0 mr-3 ${s?"text-blue-600":"text-gray-400"}`,children:t.icon}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:t.title}),t.subtitle&&e.jsx("p",{className:"text-sm text-gray-500 truncate",children:t.subtitle})]}),t.keyboard&&e.jsx("div",{className:"flex-shrink-0 ml-3",children:e.jsx("kbd",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded",children:t.keyboard})}),s&&e.jsx(Oe,{className:"w-4 h-4 text-blue-600 ml-2"})]})},t.id)}function Sx({children:t}){const{openDrawer:s,isMobile:a}=Ie(),n=()=>a?s?"1fr 24rem":"1fr":s?"16rem 1fr 24rem":"16rem 1fr";return e.jsx("div",{className:"grid h-full w-full min-h-0",style:{gridTemplateColumns:n(),gridTemplateRows:"1fr"},children:t})}function Mx({children:t}){return e.jsx("div",{className:"fixed inset-0 z-40 pointer-events-none",children:e.jsx("div",{className:"pointer-events-auto",children:t})})}function Cx(){return e.jsx("a",{href:"#main-content",className:"skip-link",children:"Skip to main content"})}function Px(){const[t,s]=f.useState(null),[a,n]=f.useState(!1),[i,r]=f.useState(!0),[o,l]=f.useState(!1),[c,d]=f.useState(!1),[x,h]=f.useState(!1),[m,p]=f.useState(!1),[y,v]=f.useState(!1),[u,j]=f.useState(!1),[g,S]=f.useState(!1),[b,_]=f.useState(!1),[w,k]=f.useState(!1),[$,R]=f.useState(!1),[T,P]=f.useState([]),{isMobile:I,setIsMobile:Y,commandPaletteOpen:B,setCommandPalette:F}=Ie(),{commentsOpen:J,setCommentsOpen:ce}=Ie(),{id:U}=Ve();Nn();const{project:q,createProject:z}=ya();re.useEffect(()=>{const xe=()=>{Y(window.innerWidth<1024)};return xe(),window.addEventListener("resize",xe),()=>window.removeEventListener("resize",xe)},[Y]),re.useEffect(()=>{const xe=tt=>{s(tt.detail),n(!0)};return document.addEventListener("openParcelDrawer",xe),()=>document.removeEventListener("openParcelDrawer",xe)},[]);const O=xe=>{s(xe),n(!0)},V=()=>{n(!1),s(null)},te=async xe=>{const{addParcel:tt}=Ve.getState();await tt(String(xe.ogc_fid||xe.id),xe),j(!0),s(xe)},Q=async xe=>{const tt=`Project - ${xe.address||"New Development"}`,ot=z(tt),{set:Ds,addParcel:ue}=Ve.getState();Ds(ot.id,ot.name),await ue(String(xe.ogc_fid||xe.id),xe),n(!1),s(xe),j(!0)},ne=()=>{r(!1)},se=xe=>{P(tt=>tt.filter(ot=>ot.id!==xe))},oe=()=>{r(!1),l(!0)},$e=()=>{d(!0)},he=()=>{d(!1)},ie=()=>{h(!0)},Xe=()=>{h(!1)},Qe=()=>{p(!0)},Xt=()=>{p(!1)},Wt=()=>{v(!0)},$s=()=>{v(!1)},ge=()=>{_(!0)},Ce=()=>{_(!1)},Se=()=>{k(!0)},et=()=>{k(!1)},_t=()=>{j(!0)},St=()=>{j(!1)},Vt=()=>{S(!0)},Ts=()=>{S(!1)};return i&&!U?e.jsx(km,{onGetStarted:oe,onViewDemo:ne}):e.jsx(Mn,{children:e.jsxs("div",{className:"min-h-screen h-screen flex flex-col overflow-hidden bg-gray-50",children:[e.jsx(Cx,{}),e.jsx("header",{className:"flex-none",children:e.jsx(Kr,{onOpenUnifiedWorkspace:$e,onOpenProjectWorkflow:ie,onOpenSimpleProjectManager:Qe,onOpenConnectedProjectWorkflow:Wt,onOpenUnifiedProjectWorkflow:_t,onOpenRealUnderwritingWorkflow:Vt,onOpenWorkflowAudit:ge,onOpenWorkflowConnectionTest:Se})}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsxs(Sx,{children:[e.jsx(hx,{}),e.jsx("main",{id:"main-content",className:"relative min-w-0 bg-white flex-1 min-h-0",role:"main","aria-label":"Interactive parcel map",children:e.jsx(rl,{onParcelClick:O,activeProjectName:Ve.getState().name})}),window.innerWidth>=1024?e.jsx(ln,{}):e.jsx(Mx,{children:e.jsx(ln,{})})]})}),e.jsx(wx,{}),e.jsx(_x,{isOpen:B,onClose:()=>F(!1)}),U&&J&&e.jsx("div",{className:"fixed right-4 bottom-4 z-50",children:e.jsx(ir,{projectId:U,onClose:()=>ce(!1)})}),e.jsx(Pm,{parcel:t,isOpen:a,onClose:V,onAddToProject:te,hasActiveProject:!!q,onCreateProjectFromParcel:Q}),e.jsx(Am,{isOpen:o,onClose:()=>l(!1),onComplete:()=>l(!1)}),e.jsx(Rm,{isOpen:c,onClose:he,selectedParcel:t,onParcelSelect:s}),e.jsx(Fm,{isOpen:x,onClose:Xe,selectedParcel:t,onParcelSelect:s}),e.jsx(Im,{isOpen:m,onClose:Xt,selectedParcel:t,onParcelSelect:s}),e.jsx(Gm,{isOpen:y,onClose:$s,selectedParcel:t,onParcelSelect:s}),e.jsx(Um,{isOpen:u,onClose:St,selectedParcel:t,onParcelSelect:s}),e.jsx(Hm,{isOpen:g,onClose:Ts,selectedParcel:t,onParcelSelect:s}),e.jsx(Jm,{isProjectWorkflowOpen:y,selectedParcel:t,onParcelSelect:s}),e.jsx(Zm,{isOpen:b,onClose:Ce}),e.jsx(Km,{isOpen:w,onClose:et}),e.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:T.map(xe=>e.jsx(Em,{type:xe.type,title:xe.title,message:xe.message,onClose:()=>se(xe.id)},xe.id))})]})})}const kx=()=>{const t=document.createElement("link");t.rel="preload",t.href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css",t.as="style",document.head.appendChild(t)};kx();class Ax extends re.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){console.error("App Error:",s,a)}render(){return this.state.hasError?e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md w-full",children:[e.jsx("div",{className:"text-red-600 mb-4",children:e.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 18.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsx("h1",{className:"text-xl font-bold text-gray-900 mb-2 text-center",children:"Application Error"}),e.jsx("p",{className:"text-gray-600 text-center mb-4",children:"Something went wrong loading the application."}),!1,e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors",children:"Reload Application"})]})}):this.props.children}}const cn=document.getElementById("root");cn?Br(cn).render(e.jsx(f.StrictMode,{children:e.jsx(Ax,{children:e.jsx(Px,{})})})):console.error("Root element not found");
